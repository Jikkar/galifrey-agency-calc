<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokeMMO Player Team Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase App (the core)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, arrayRemove, arrayUnion, query, orderBy, writeBatch, serverTimestamp, increment, runTransaction, collectionGroup, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Your web app's Firebase configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDsacPQOqciPdM5SLHMh0muDH9GXswnyU0",
            authDomain: "pokemmo-team.firebaseapp.com",
            projectId: "pokemmo-team",
            storageBucket: "pokemmo-team.appspot.com",
            messagingSenderId: "538474033829",
            appId: "1:538474033829:web:26b62ba96efa1901ead34c",
            measurementId: "G-HWFL88XH7H"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- App State ---
        let currentUserId = null;
        let currentUsername = null;
        let currentUserRole = 'Guest';
        let currentTeamSpaceId = null;
        let teamSpacePermissions = {};
        let unsubscribeListeners = [];
        const usernameCache = {};
        const SUPERADMIN_UID = "G9MP7oe0cTQsu92SEXB6wqy1nQs1";

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const teamSpaceIdDisplay = document.getElementById('team-space-id-display');
        const teamSpaceIdInput = document.getElementById('team-space-id-input');
        const changeTeamSpaceBtn = document.getElementById('change-team-space-btn');
        const createTeamSpaceBtn = document.getElementById('create-team-space-btn');
        const mainContent = document.getElementById('main-content');
        const loadingOverlay = document.getElementById('loading-overlay');
        const navButtons = document.querySelectorAll('.nav-button');
        const userProfileDisplay = document.getElementById('user-profile-display');
        const logoutBtn = document.getElementById('logout-btn');
        const genericModal = document.getElementById('generic-modal');
        const genericModalTitle = document.getElementById('generic-modal-title');
        const genericModalContent = document.getElementById('generic-modal-content');
        const genericModalCloseBtn = document.getElementById('generic-modal-close-btn');
        const officialTeamSpaceContainer = document.getElementById('official-team-space-container');

        // --- Core Functions ---
        function showLoading(show) { loadingOverlay.style.display = show ? 'flex' : 'none'; }
        
        function showGenericModal(title, content, formSubmitHandler = null, size = '2xl') {
            const modalDialog = genericModal.querySelector('.modal-dialog');
            modalDialog.classList.remove('max-w-md', 'max-w-2xl', 'max-w-4xl');
            modalDialog.classList.add(`max-w-${size}`);
            genericModalTitle.textContent = title;
            genericModalContent.innerHTML = content;
            genericModal.classList.remove('hidden');
            const form = genericModalContent.querySelector('form');
            if (form) {
                form.onsubmit = (e) => {
                    e.preventDefault();
                    if(formSubmitHandler) formSubmitHandler(e);
                    hideGenericModal();
                };
            }
        }
        
        function hideGenericModal() {
            genericModal.classList.add('hidden');
        }
        
        genericModalCloseBtn.addEventListener('click', hideGenericModal);

        function checkPermission(action) {
            if (currentUserRole === 'Superadmin') return true;
            return teamSpacePermissions[currentUserRole]?.[action] === true;
        }

        async function getUsername(userId) {
            if (!userId) return "Unknown";
            if (usernameCache[userId]) return usernameCache[userId];
            try {
                const userRef = doc(db, "users", userId);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) { const username = userSnap.data().username; usernameCache[userId] = username; return username; }
            } catch (error) { console.error("Error fetching username:", error); }
            return "Anonymous";
        }
        
        async function seedDefaultResources(teamSpaceId) {
            const batch = writeBatch(db);
            const pokedexRef = doc(db, `team_spaces/${teamSpaceId}/resources/pokedex`);
            const moneyRef = doc(db, `team_spaces/${teamSpaceId}/resources/moneyGuide`);
            const evRef = doc(db, `team_spaces/${teamSpaceId}/resources/evHotspots`);
            batch.set(pokedexRef, { entries: { "Garchomp": { name: "Garchomp", stats: "108/130/95/80/85/102", abilities: "Sand Veil, Rough Skin (HA)", builds: [{ name: "Swords Dance", nature: "Jolly", evs: "252 Atk / 4 SpD / 252 Spe", moves: "Swords Dance, Earthquake, Outrage"}] } }});
            batch.set(moneyRef, { entries: [ { id: "gym_reruns", name: 'Gym Rebattles', details: 'Most consistent endgame income.', potential: 'High (~400k/hr)' } ]});
            batch.set(evRef, { entries: [ { id: "hp_marill", stat: 'HP', pokemon: 'Marill (x5)', location: 'Route 114, Hoenn (Surf)', yield: '10' } ]});
            await batch.commit();
        }

        function switchView(viewName) {
            navButtons.forEach(btn => btn.classList.remove('bg-teal-600', 'text-white'));
            const button = document.querySelector(`.nav-button[data-view="${viewName}"]`);
            if (button) button.classList.add('bg-teal-600', 'text-white');
            mainContent.innerHTML = '';
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            const viewRenderers = { 
                'dashboard': renderDashboard, 
                'pokemon-teams': renderPokemonTeams, 
                'tasks': renderTasks, 
                'breeding': renderBreedingProjects, 
                'hunts': renderShinyHunts, 
                'pokedex': renderPokedex, 
                'ev-hotspots': renderEvHotspots, 
                'money-guide': renderMoneyGuide, 
                'admin-panel': renderAdminPanel 
            };
            if (viewRenderers[viewName]) viewRenderers[viewName]();
        }

        async function setupTeamSpace(userId) {
            let teamSpaceId = localStorage.getItem('currentTeamSpaceId');
            
            // --- NEW: Default to "ExCorp" for new users ---
            if (!teamSpaceId) {
                teamSpaceId = "ExCorp";
                localStorage.setItem('currentTeamSpaceId', teamSpaceId);
                
                const teamSpaceRef = doc(db, "team_spaces", teamSpaceId);
                const teamSpaceSnap = await getDoc(teamSpaceRef);

                // If the default "ExCorp" space doesn't exist, create it.
                if (!teamSpaceSnap.exists()) {
                    await setDoc(teamSpaceRef, {
                        owner: userId, // First user becomes owner
                        name: "ExCorp Main Team",
                        members: [userId],
                        createdAt: serverTimestamp(),
                        permissions: {
                            Admin: { canManagePokemonTeams: true, canManageTasks: true, canManageProjects: true, canEditResources: true, canMarkStaffPick: true },
                            Staff: { canManageTasks: true, canManageProjects: true, canMarkStaffPick: true },
                            Member: {}
                        }
                    });
                    await seedDefaultResources(teamSpaceId);
                }
            }
            
            currentTeamSpaceId = teamSpaceId;
            teamSpaceIdDisplay.textContent = currentTeamSpaceId;
            teamSpaceIdInput.value = currentTeamSpaceId;
            
            const teamSpaceRef = doc(db, "team_spaces", currentTeamSpaceId);
            const unsub = onSnapshot(teamSpaceRef, async (teamSpaceSnap) => {
                if(teamSpaceSnap.exists()) {
                    teamSpacePermissions = teamSpaceSnap.data().permissions || {};
                    if(!teamSpaceSnap.data().members?.includes(userId)) {
                        await updateDoc(teamSpaceRef, { members: arrayUnion(userId) });
                    }
                } else {
                    alert(`Team Space with ID "${currentTeamSpaceId}" not found. You can create a new one.`);
                    localStorage.removeItem('currentTeamSpaceId');
                    // Don't reload, let them create a new one.
                }
            });
            unsubscribeListeners.push(unsub);
            switchView('dashboard');
        }

        // --- NEW: Render Official Team Space Button ---
        async function renderOfficialTeamSpaceButton() {
            const settingsRef = doc(db, "system_settings", "official_team_space");
            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    const { id, name } = docSnap.data();
                    officialTeamSpaceContainer.innerHTML = `
                        <h4 class="font-bold mb-2">Official Team Space</h4>
                        <button id="join-official-team-btn" data-id="${id}" class="w-full bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600 font-bold">
                            Join ${name}
                        </button>`;
                    document.getElementById('join-official-team-btn').onclick = (e) => {
                        const officialId = e.currentTarget.dataset.id;
                        if (officialId !== currentTeamSpaceId) {
                            localStorage.setItem('currentTeamSpaceId', officialId);
                            location.reload();
                        }
                    };
                } else {
                    officialTeamSpaceContainer.innerHTML = '';
                }
            });
        }


        // --- Render Functions ---
        async function renderDashboard() {
            mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800 mb-6">Player Team Dashboard</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-xl mb-3">Active Breeding Projects</h3><div id="dashboard-breeding" class="space-y-2"></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-xl mb-3">Active Shiny Hunts</h3><div id="dashboard-hunts" class="space-y-2"></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-xl mb-3">Player Team Members</h3><div id="dashboard-members" class="space-y-2"></div></div></div>`;
            const renderList = async (q, containerId, formatter) => {
                const unsub = onSnapshot(q, async (snapshot) => {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    container.innerHTML = snapshot.empty ? `<p class="text-gray-500">Nothing here yet.</p>` : (await Promise.all(snapshot.docs.map(doc => formatter(doc.data(), doc.id)))).join('');
                });
                unsubscribeListeners.push(unsub);
            };
            await renderList(query(collection(db, `team_spaces/${currentTeamSpaceId}/breeding`), orderBy("createdAt", "desc")), 'dashboard-breeding', async (data) => `<p>${data.targetPokemon} <span class="text-xs text-gray-400">by ${await getUsername(data.createdBy)}</span></p>`);
            await renderList(query(collection(db, `team_spaces/${currentTeamSpaceId}/hunts`), orderBy("createdAt", "desc")), 'dashboard-hunts', async (data) => `<div class="flex justify-between"><span>${data.target} <span class="text-xs text-gray-400">by ${await getUsername(data.createdBy)}</span></span><span class="font-mono font-bold">${(data.count || 0).toLocaleString()}</span></div>`);
            const teamSpaceUnsub = onSnapshot(doc(db, "team_spaces", currentTeamSpaceId), async (teamSpaceSnap) => {
                const membersContainer = document.getElementById('dashboard-members');
                if (!membersContainer || !teamSpaceSnap.exists()) return;
                const memberIds = teamSpaceSnap.data().members || [];
                const memberNames = await Promise.all(memberIds.map(id => getUsername(id)));
                membersContainer.innerHTML = memberNames.map(name => `<p class="text-gray-700">${name}</p>`).join('');
            });
            unsubscribeListeners.push(teamSpaceUnsub);
        }

        // --- POKEMON TEAMS MODULE ---
        function renderPokemonTeams() {
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Pokémon Team Locker</h2>
                    <div class="flex gap-4">
                        ${checkPermission('canManagePokemonTeams') ? `<button id="add-pokemon-team-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">New Pokémon Team</button>` : ''}
                    </div>
                </div>
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex space-x-4" id="teams-filter-nav">
                        <button data-filter="all" class="teams-filter-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:text-teal-600 hover:border-teal-600 active">All Teams</button>
                        <button data-filter="staff" class="teams-filter-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:text-teal-600 hover:border-teal-600">Staff Picks</button>
                        <button data-filter="personal" class="teams-filter-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:text-teal-600 hover:border-teal-600">My Teams</button>
                    </nav>
                </div>
                <div id="pokemon-teams-container" class="space-y-6"></div>`;

            let currentFilter = 'all';
            const q = query(collection(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`), orderBy("createdAt", "desc"));

            const renderFilteredTeams = (snapshot) => {
                const container = document.getElementById('pokemon-teams-container');
                if (!container) return;
                let teams = snapshot.docs;
                if (currentFilter === 'staff') teams = teams.filter(t => t.data().isStaffPick);
                else if (currentFilter === 'personal') teams = teams.filter(t => t.data().createdBy === currentUserId);
                
                if(teams.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center mt-8">No Pokémon teams match the filter.</p>`;
                    return;
                }
                Promise.all(teams.map(renderPokemonTeamCard)).then(html => {
                    container.innerHTML = html.join('');
                    attachPokemonTeamCardListeners();
                });
            };

            const unsub = onSnapshot(q, renderFilteredTeams);
            unsubscribeListeners.push(unsub);

            document.querySelectorAll('.teams-filter-btn').forEach(btn => btn.onclick = (e) => {
                document.querySelectorAll('.teams-filter-btn').forEach(b => b.classList.remove('active', 'text-teal-600', 'border-teal-600'));
                e.target.classList.add('active', 'text-teal-600', 'border-teal-600');
                currentFilter = e.target.dataset.filter;
                onSnapshot(q, renderFilteredTeams); // Re-render on filter change
            });

            if (checkPermission('canManagePokemonTeams')) {
                document.getElementById('add-pokemon-team-btn').onclick = () => {
                    showGenericModal('New Pokémon Team', `
                        <form class="space-y-4">
                            <input type="text" name="name" placeholder="Team Name" class="w-full p-2 border rounded-lg" required>
                            <input type="text" name="purpose" placeholder="Purpose (e.g., Hoenn E4, Kanto Story)" class="w-full p-2 border rounded-lg">
                            <button type="submit" class="w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600">Create Team</button>
                        </form>`, 
                        async (e) => {
                            if(e.target.name.value) {
                                await addDoc(collection(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`), { 
                                    name: e.target.name.value, 
                                    purpose: e.target.purpose.value,
                                    pokemon: [], 
                                    notes: [], 
                                    createdBy: currentUserId, 
                                    createdAt: serverTimestamp(), 
                                    isStaffPick: false 
                                });
                            }
                        });
                };
            }
        }

        async function renderPokemonTeamCard(doc) {
            const team = doc.data();
            const teamId = doc.id;
            const creatorName = await getUsername(team.createdBy);
            const pokemonHtml = (await Promise.all((team.pokemon || []).map(async (p, i) => {
                const addedByName = await getUsername(p.addedBy);
                return `
                    <div class="bg-gray-50 p-4 rounded-md border relative">
                        ${checkPermission('canManagePokemonTeams') ? `<button data-team-id="${teamId}" data-pokemon-index="${i}" class="delete-pokemon-btn absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold text-xl">&times;</button>`:''}
                        <p class="font-bold text-lg">${p.species}</p>
                        <p class="text-sm"><strong>Nature:</strong> ${p.nature}</p>
                        <p class="text-sm"><strong>EVs:</strong> ${p.evs}</p>
                        <p class="text-sm"><strong>Moves:</strong> ${p.moves.join(', ')}</p>
                        <p class="text-xs text-gray-400 mt-2">Added by ${addedByName}</p>
                    </div>`;
            }))).join('');

            const notesHtml = (await Promise.all((team.notes || []).map(async note => {
                const authorName = await getUsername(note.authorId);
                return `<div class="text-sm bg-gray-100 p-2 rounded"><strong>${authorName}</strong>: ${note.text}</div>`;
            }))).join('');

            return `
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold">${team.name}</h3>
                            ${team.purpose ? `<p class="text-md font-semibold text-teal-700">${team.purpose}</p>` : ''}
                            <p class="text-sm text-gray-500">Created by ${creatorName}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            ${checkPermission('canMarkStaffPick') ? `<label class="flex items-center gap-2 text-sm"><input type="checkbox" data-team-id="${teamId}" class="staff-pick-checkbox" ${team.isStaffPick ? 'checked' : ''}> Staff Pick</label>` : ''}
                            ${checkPermission('canManagePokemonTeams') ? `<button data-team-id="${teamId}" class="delete-pokemon-team-btn text-red-500 hover:text-red-700">Delete Team</button>` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        ${pokemonHtml}
                        ${(team.pokemon || []).length < 6 && checkPermission('canManagePokemonTeams') ? `<button data-team-id="${teamId}" class="add-pokemon-btn flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold p-3 rounded-md transition">+</button>` : ''}
                    </div>
                    <div class="border-t pt-4">
                        <h4 class="font-semibold mb-2">Notes</h4>
                        <div class="space-y-2 max-h-40 overflow-y-auto mb-2 pr-2">${notesHtml}</div>
                        <div class="flex gap-2">
                            <input type="text" data-team-id="${teamId}" class="note-input flex-grow border rounded p-2" placeholder="Add a note...">
                            <button data-team-id="${teamId}" class="add-note-btn bg-gray-600 text-white px-4 rounded-lg">Post</button>
                        </div>
                    </div>
                </div>`;
        }

        function attachPokemonTeamCardListeners() {
            document.querySelectorAll('.add-pokemon-btn').forEach(btn => btn.onclick = e => {
                const teamId = e.target.dataset.teamId;
                const formHtml = `
                    <form class="space-y-4">
                        <input type="text" name="species" placeholder="Species" class="w-full p-2 border rounded-lg" required>
                        <input type="text" name="nature" placeholder="Nature" class="w-full p-2 border rounded-lg">
                        <input type="text" name="evs" placeholder="EVs (e.g., 252 Atk / 252 Spe)" class="w-full p-2 border rounded-lg">
                        <input type="text" name="moves" placeholder="Moves (comma-separated)" class="w-full p-2 border rounded-lg">
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" class="generic-modal-close-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
                            <button type="submit" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg">Add Pokémon</button>
                        </div>
                    </form>`;
                showGenericModal('Add Pokémon to Team', formHtml, async (event) => {
                    const { species, nature, evs, moves } = event.target;
                    if(species.value) {
                        await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId), { 
                            pokemon: arrayUnion({ 
                                species: species.value, 
                                nature: nature.value, 
                                evs: evs.value, 
                                moves: moves.value.split(',').map(m => m.trim()), 
                                addedBy: currentUserId 
                            }) 
                        });
                    }
                });
                genericModal.querySelector('.generic-modal-close-btn').onclick = hideGenericModal;
            });

            document.querySelectorAll('.add-note-btn').forEach(btn => btn.onclick = async e => {
                const teamId = e.target.dataset.teamId;
                const input = document.querySelector(`.note-input[data-team-id="${teamId}"]`);
                if (input.value.trim()) { 
                    await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId), { 
                        notes: arrayUnion({ text: input.value, authorId: currentUserId, createdAt: serverTimestamp() }) 
                    }); 
                    input.value = ''; 
                }
            });

            document.querySelectorAll('.delete-pokemon-team-btn').forEach(btn => btn.onclick = e => showModal('Delete this entire Pokémon team?', () => deleteDoc(doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, e.target.dataset.teamId))));
            
            document.querySelectorAll('.delete-pokemon-btn').forEach(btn => btn.onclick = async e => {
                const { teamId, pokemonIndex } = e.target.dataset;
                const teamRef = doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId); 
                const teamSnap = await getDoc(teamRef); 
                const pokemonToRemove = teamSnap.data().pokemon[pokemonIndex];
                showModal(`Delete ${pokemonToRemove.species}?`, () => updateDoc(teamRef, { pokemon: arrayRemove(pokemonToRemove) }));
            });

            document.querySelectorAll('.staff-pick-checkbox').forEach(box => box.onchange = async e => await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, e.target.dataset.teamId), { isStaffPick: e.target.checked }));
        }

        // --- TASKS MODULE (REFINED) ---
        function renderTasks() {
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Task Board</h2>
                </div>
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex space-x-4" id="tasks-tab-nav">
                        <button data-tab="shared" class="tasks-tab-btn py-2 px-4 font-semibold text-teal-600 border-b-2 border-teal-600">Shared Tasks</button>
                        <button data-tab="personal" class="tasks-tab-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent">My Tasks</button>
                    </nav>
                </div>
                <div id="tasks-content"></div>`;

            const renderTabContent = (tab) => {
                const container = document.getElementById('tasks-content');
                if (tab === 'shared') {
                    container.innerHTML = `
                        ${checkPermission('canManageTasks') ? `
                        <div class="bg-white p-6 rounded-lg shadow mb-6">
                            <button id="add-task-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg">Create New Shared Task</button>
                        </div>` : ''}
                        <div id="shared-tasks-container" class="space-y-4"></div>`;
                    
                    if (checkPermission('canManageTasks')) {
                        document.getElementById('add-task-btn').onclick = () => showNewTaskModal();
                    }

                    const q = query(collection(db, `team_spaces/${currentTeamSpaceId}/tasks`), orderBy("createdAt", "desc"));
                    const unsub = onSnapshot(q, async (snapshot) => {
                        const taskContainer = document.getElementById('shared-tasks-container');
                        if (!taskContainer) return;
                        taskContainer.innerHTML = snapshot.empty 
                            ? '<p class="text-gray-500 text-center mt-8">No shared tasks.</p>' 
                            : (await Promise.all(snapshot.docs.map(renderTaskCard))).join('');
                        attachTaskCardListeners();
                    });
                    unsubscribeListeners.push(unsub);
                } else { // Personal tasks
                    container.innerHTML = `
                        <div class="bg-white p-6 rounded-lg shadow mb-6">
                            <form id="add-personal-task-form" class="flex gap-4">
                                <input type="text" name="taskText" placeholder="New personal task..." class="flex-grow p-2 border rounded-lg" required>
                                <button type="submit" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">Add Task</button>
                            </form>
                        </div>
                        <div id="personal-tasks-container" class="space-y-4"></div>`;
                    document.getElementById('add-personal-task-form').onsubmit = async e => { e.preventDefault(); const text = e.target.taskText.value; if(text) await addDoc(collection(db, `users/${currentUserId}/tasks`), { text, completed: false, createdAt: serverTimestamp() }); e.target.reset(); };
                    const q = query(collection(db, `users/${currentUserId}/tasks`), orderBy("createdAt", "desc"));
                    const unsub = onSnapshot(q, (snapshot) => {
                        const taskContainer = document.getElementById('personal-tasks-container'); if (!taskContainer) return;
                        taskContainer.innerHTML = snapshot.empty ? '<p class="text-gray-500 text-center mt-8">No personal tasks.</p>' : snapshot.docs.map(doc => {
                            const task = doc.data(); const taskId = doc.id;
                            return `<div class="bg-white p-4 rounded-lg shadow flex items-center justify-between"><div class="flex items-center gap-4"><input type="checkbox" data-task-id="${taskId}" class="personal-task-checkbox h-6 w-6" ${task.completed ? 'checked' : ''}><p class="${task.completed ? 'line-through text-gray-400' : ''}">${task.text}</p></div><button data-task-id="${taskId}" class="delete-personal-task-btn text-xs text-red-500 hover:underline">Delete</button></div>`;
                        }).join('');
                        document.querySelectorAll('.personal-task-checkbox').forEach(el => el.onchange = async e => await updateDoc(doc(db, `users/${currentUserId}/tasks`, e.target.dataset.taskId), { completed: e.target.checked }));
                        document.querySelectorAll('.delete-personal-task-btn').forEach(btn => btn.onclick = () => showModal('Delete this task?', () => deleteDoc(doc(db, `users/${currentUserId}/tasks`, btn.dataset.taskId))));
                    });
                    unsubscribeListeners.push(unsub);
                }
            };
            document.querySelectorAll('.tasks-tab-btn').forEach(btn => btn.onclick = (e) => { document.querySelectorAll('.tasks-tab-btn').forEach(b => b.classList.remove('text-teal-600', 'border-teal-600')); e.target.classList.add('text-teal-600', 'border-teal-600'); renderTabContent(e.target.dataset.tab); });
            renderTabContent('shared');
        }

        function showNewTaskModal() {
            const formHtml = `
                <form id="add-task-form-modal" class="space-y-4">
                    <input type="text" name="text" placeholder="Task Title" class="w-full p-2 border rounded-lg" required>
                    <textarea name="details" placeholder="Details & Instructions..." class="w-full p-2 border rounded-lg h-24"></textarea>
                    <input type="text" name="reward" placeholder="Reward / Incentive" class="w-full p-2 border rounded-lg">
                    <select name="type" class="w-full p-2 border rounded-lg">
                        <option value="checklist">Simple Checklist Task</option>
                        <option value="goal">Collaborative Goal</option>
                    </select>
                    <div id="goal-fields" class="hidden space-y-2">
                        <input type="number" name="goalTarget" placeholder="Target Value (e.g., 10000)" class="w-full p-2 border rounded-lg">
                    </div>
                    <button type="submit" class="w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600">Create Task</button>
                </form>`;
            
            showGenericModal('New Shared Task', formHtml, async (e) => {
                const form = e.target;
                const taskData = {
                    text: form.text.value,
                    details: form.details.value,
                    reward: form.reward.value,
                    type: form.type.value,
                    completed: false,
                    createdBy: currentUserId,
                    createdAt: serverTimestamp(),
                    contributors: {}
                };
                if (taskData.type === 'goal') {
                    taskData.goalTarget = Number(form.goalTarget.value) || 0;
                    taskData.goalProgress = 0;
                }
                await addDoc(collection(db, `team_spaces/${currentTeamSpaceId}/tasks`), taskData);
            }, 'md');

            const typeSelect = document.getElementById('add-task-form-modal').querySelector('select[name="type"]');
            typeSelect.onchange = () => {
                document.getElementById('goal-fields').classList.toggle('hidden', typeSelect.value !== 'goal');
            };
        }

        async function renderTaskCard(doc) {
            const task = doc.data();
            const taskId = doc.id;
            const creatorName = await getUsername(task.createdBy);
            
            let contentHtml = '';
            if (task.type === 'goal') {
                const progress = (task.goalProgress || 0);
                const target = (task.goalTarget || 1);
                const progressPercent = Math.min(100, (progress / target) * 100);
                contentHtml = `
                    <div class="mt-4">
                        <div class="flex justify-between text-sm font-semibold text-gray-600 mb-1">
                            <span>Progress</span>
                            <span>${progress.toLocaleString()} / ${target.toLocaleString()}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-teal-500 h-4 rounded-full text-white text-xs flex items-center justify-center" style="width: ${progressPercent}%">
                                ${progressPercent.toFixed(0)}%
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <input type="number" data-task-id="${taskId}" class="goal-contribution-input flex-grow p-2 border rounded-lg" placeholder="Add to progress...">
                            <button data-task-id="${taskId}" class="add-contribution-btn bg-gray-600 text-white px-4 rounded-lg">Log</button>
                        </div>
                    </div>`;
            } else { // Checklist
                contentHtml = `
                    <div class="mt-4 flex items-center gap-4">
                        <input type="checkbox" data-task-id="${taskId}" class="task-checkbox h-6 w-6" ${task.completed ? 'checked' : ''}>
                        <label class="font-semibold ${task.completed ? 'line-through text-gray-400' : ''}">Mark as Complete</label>
                    </div>`;
            }

            return `
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold ${task.completed ? 'line-through text-gray-400' : ''}">${task.text}</h3>
                            <p class="text-sm text-gray-500">Added by ${creatorName}</p>
                        </div>
                        ${checkPermission('canManageTasks') ? `<button data-task-id="${taskId}" class="delete-task-btn text-red-500 hover:text-red-700">&times;</button>` : ''}
                    </div>
                    ${task.details ? `<p class="text-gray-700 mt-2 p-2 bg-gray-50 rounded">${task.details}</p>` : ''}
                    ${task.reward ? `<p class="text-sm font-semibold text-yellow-600 mt-2">Reward: ${task.reward}</p>` : ''}
                    ${contentHtml}
                </div>`;
        }
        
        function attachTaskCardListeners() {
            document.querySelectorAll('.task-checkbox').forEach(el => el.onchange = async e => {
                await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/tasks`, e.target.dataset.taskId), { completed: e.target.checked });
            });
            if (checkPermission('canManageTasks')) {
                document.querySelectorAll('.delete-task-btn').forEach(btn => btn.onclick = () => {
                    showModal('Delete this task?', () => deleteDoc(doc(db, `team_spaces/${currentTeamSpaceId}/tasks`, btn.dataset.taskId)));
                });
            }
            document.querySelectorAll('.add-contribution-btn').forEach(btn => btn.onclick = async e => {
                const taskId = e.target.dataset.taskId;
                const input = document.querySelector(`.goal-contribution-input[data-task-id="${taskId}"]`);
                const value = Number(input.value);
                if (value > 0) {
                    const taskRef = doc(db, `team_spaces/${currentTeamSpaceId}/tasks`, taskId);
                    await updateDoc(taskRef, {
                        goalProgress: increment(value),
                        [`contributors.${currentUserId}`]: increment(value)
                    });
                    input.value = '';
                }
            });
        }
        
        // --- MODAL (Confirmation) ---
        const modal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('confirmation-modal-message');
        const modalConfirmBtn = document.getElementById('confirmation-modal-confirm-btn');
        const modalCancelBtn = document.getElementById('confirmation-modal-cancel-btn');

        function showModal(message, onConfirm) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            modalConfirmBtn.onclick = () => {
                onConfirm();
                hideModal();
            };
        }
        function hideModal() {
            modal.classList.add('hidden');
            modalConfirmBtn.onclick = null;
        }
        modalCancelBtn.addEventListener('click', hideModal);

        // --- OTHER MODULES (Breeding, Hunts, Pokedex, etc.) ---
        function renderBreedingProjects() { 
            mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">Breeding Projects</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        function renderShinyHunts() {
            mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">Shiny Hunts</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        function renderPokedex() {
             mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">Pokédex & Builds</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        function renderEvHotspots() {
             mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">EV Hotspots</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        function renderMoneyGuide() {
             mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">Money Guide</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        async function renderAdminPanel() {
            if (currentUserRole !== 'Superadmin') { mainContent.innerHTML = `<p class="text-red-500">Access Denied.</p>`; return; }
            mainContent.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Admin Panel</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">User Role Management</h3>
                        <div id="user-roles-container" class="space-y-3">Loading...</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">Player Team Permission Settings</h3>
                        <div id="permissions-container" class="space-y-4"></div>
                        <button id="save-perms-btn" class="mt-6 w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600">Save Permissions</button>
                    </div>
                    <!-- NEW: Superadmin Controls -->
                    <div class="bg-white p-6 rounded-lg shadow lg:col-span-2">
                        <h3 class="text-xl font-bold mb-4 text-red-600">Superadmin Controls</h3>
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold">Official Team Space</h4>
                                <p class="text-sm text-gray-600 mb-2">Mark the current Team Space (${currentTeamSpaceId}) as the official one for all users.</p>
                                <button id="mark-official-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg">Mark as Official</button>
                            </div>
                            <div class="border-t pt-4">
                                <h4 class="font-semibold">Rename Current Team Space ID</h4>
                                <p class="text-sm text-gray-600 mb-2">This is a complex operation. Change '${currentTeamSpaceId}' to a new custom ID. All data will be migrated.</p>
                                <div class="flex gap-2">
                                    <input type="text" id="new-team-space-id-input" placeholder="New ID (e.g., ExCorp)" class="flex-grow p-2 border rounded-lg">
                                    <button id="rename-team-space-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Rename</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // --- Admin Panel Logic ---
            const teamSpaceRef = doc(db, "team_spaces", currentTeamSpaceId); 
            const teamSpaceSnap = await getDoc(teamSpaceRef); 
            const memberIds = teamSpaceSnap.exists() ? teamSpaceSnap.data().members || [] : [];
            
            const usersHtml = await Promise.all(memberIds.map(async (uid) => {
                const userDoc = await getDoc(doc(db, "users", uid)); if (!userDoc.exists()) return ''; const { username, role } = userDoc.data();
                if (uid === SUPERADMIN_UID) return `<div class="flex justify-between items-center"><p>${username} <span class="text-xs font-bold text-yellow-500">Superadmin</span></p></div>`;
                return `<div class="flex justify-between items-center"><p>${username}</p><select data-uid="${uid}" class="role-selector p-1 border rounded"><option value="Member" ${role === 'Member' ? 'selected' : ''}>Member</option><option value="Staff" ${role === 'Staff' ? 'selected' : ''}>Staff</option><option value="Admin" ${role === 'Admin' ? 'selected' : ''}>Admin</option></select></div>`;
            }));
            document.getElementById('user-roles-container').innerHTML = usersHtml.join('');
            document.querySelectorAll('.role-selector').forEach(sel => { sel.onchange = async (e) => await updateDoc(doc(db, "users", e.target.dataset.uid), { role: e.target.value }); });
            
            const permsContainer = document.getElementById('permissions-container');
            const rolesToManage = ['Admin', 'Staff', 'Member'];
            const actions = { 
                canManagePokemonTeams: "Manage Pokémon Teams", 
                canManageProjects: "Manage Projects", 
                canManageTasks: "Manage Shared Tasks", 
                canEditResources: "Edit Resources", 
                canMarkStaffPick: "Mark Staff Picks" 
            };
            permsContainer.innerHTML = rolesToManage.map(role => `
                <div class="border p-4 rounded-lg">
                    <h4 class="font-bold text-lg">${role}</h4>
                    <div class="space-y-2 mt-2">
                        ${Object.entries(actions).map(([key, label]) => `
                            <label class="flex items-center gap-2">
                                <input type="checkbox" data-role="${role}" data-action="${key}" class="perm-checkbox h-4 w-4" ${teamSpacePermissions[role]?.[key] === true ? 'checked' : ''}> ${label}
                            </label>`).join('')}
                    </div>
                </div>`).join('');
            
            document.getElementById('save-perms-btn').onclick = async () => {
                showLoading(true);
                const newPermissions = JSON.parse(JSON.stringify(teamSpacePermissions));
                document.querySelectorAll('.perm-checkbox').forEach(box => {
                    const { role, action } = box.dataset;
                    if (!newPermissions[role]) newPermissions[role] = {};
                    newPermissions[role][action] = box.checked;
                });
                try {
                    await updateDoc(doc(db, "team_spaces", currentTeamSpaceId), { permissions: newPermissions });
                    alert("Permissions saved successfully!");
                } catch (error) {
                    alert("Error saving permissions: " + error.message);
                } finally {
                    showLoading(false);
                }
            };

            // Superadmin button listeners
            document.getElementById('mark-official-btn').onclick = async () => {
                if (confirm(`Are you sure you want to mark "${currentTeamSpaceId}" as the official Team Space?`)) {
                    const teamSnap = await getDoc(doc(db, "team_spaces", currentTeamSpaceId));
                    const teamName = teamSnap.exists() ? teamSnap.data().name || currentTeamSpaceId : currentTeamSpaceId;
                    await setDoc(doc(db, "system_settings", "official_team_space"), {
                        id: currentTeamSpaceId,
                        name: teamName
                    });
                    alert("Official Team Space has been set.");
                }
            };
            document.getElementById('rename-team-space-btn').onclick = async () => {
                const newId = document.getElementById('new-team-space-id-input').value.trim();
                if (newId && newId !== currentTeamSpaceId) {
                    if (confirm(`This is a major action. Are you sure you want to rename '${currentTeamSpaceId}' to '${newId}'?`)) {
                        await renameTeamSpace(currentTeamSpaceId, newId);
                    }
                } else {
                    alert("Please enter a new, valid ID.");
                }
            };
        }

        // --- NEW: Superadmin Functions ---
        async function renameTeamSpace(oldId, newId) {
            showLoading(true);
            try {
                const newDocRef = doc(db, "team_spaces", newId);
                const newDocSnap = await getDoc(newDocRef);
                if (newDocSnap.exists()) {
                    throw new Error(`Team Space with ID "${newId}" already exists.`);
                }

                // Use a transaction to move the main document
                await runTransaction(db, async (transaction) => {
                    const oldDocRef = doc(db, "team_spaces", oldId);
                    const oldDocSnap = await transaction.get(oldDocRef);
                    if (!oldDocSnap.exists()) {
                        throw new Error("Original document not found.");
                    }
                    transaction.set(newDocRef, oldDocSnap.data());
                    transaction.delete(oldDocRef);
                });

                // Move subcollections
                const subcollections = ['pokemon_teams', 'tasks', 'breeding', 'hunts', 'resources'];
                for (const sub of subcollections) {
                    const oldSubCollectionRef = collection(db, `team_spaces/${oldId}/${sub}`);
                    const snapshot = await getDocs(oldSubCollectionRef);
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(d => {
                        const oldDocRef = doc(db, `team_spaces/${oldId}/${sub}`, d.id);
                        const newDocRef = doc(db, `team_spaces/${newId}/${sub}`, d.id);
                        batch.set(newDocRef, d.data());
                        batch.delete(oldDocRef);
                    });
                    await batch.commit();
                }
                
                // Update official team space if it was the one renamed
                const officialTeamRef = doc(db, "system_settings", "official_team_space");
                const officialTeamSnap = await getDoc(officialTeamRef);
                if (officialTeamSnap.exists() && officialTeamSnap.data().id === oldId) {
                    await updateDoc(officialTeamRef, { id: newId });
                }

                alert(`Team Space successfully renamed to ${newId}. The page will now reload.`);
                localStorage.setItem('currentTeamSpaceId', newId);
                location.reload();

            } catch (error) {
                console.error("Error renaming Team Space:", error);
                alert("Failed to rename Team Space: " + error.message);
            } finally {
                showLoading(false);
            }
        }


        // --- Event Listeners ---
        onAuthStateChanged(auth, async (user) => {
            try {
                showLoading(true);
                if (user) {
                    currentUserId = user.uid;
                    const userRef = doc(db, "users", currentUserId);
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        const userData = userSnap.data();
                        currentUsername = userData.username;
                        currentUserRole = user.uid === SUPERADMIN_UID ? 'Superadmin' : userData.role;
                        if (user.uid === SUPERADMIN_UID && userData.role !== 'Superadmin') {
                            await updateDoc(userRef, { role: 'Superadmin' });
                        }
                        userProfileDisplay.textContent = `${currentUsername} (${currentUserRole})`;
                        document.getElementById('admin-panel-btn').style.display = currentUserRole === 'Superadmin' ? 'block' : 'none';
                        authContainer.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        await setupTeamSpace(currentUserId);
                        await renderOfficialTeamSpaceButton(); // Render the button after login
                    } else { await signOut(auth); }
                } else {
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            } catch (error) { console.error("Authentication Error:", error); } 
            finally { showLoading(false); }
        });

        document.getElementById('login-form').onsubmit = async (e) => { e.preventDefault(); showLoading(true); const email = e.target.email.value; const password = e.target.password.value; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { alert(error.message); } finally { showLoading(false); } };
        
        document.getElementById('signup-form').onsubmit = async (e) => {
            e.preventDefault(); showLoading(true); const email = e.target.signup_email.value; const password = e.target.signup_password.value; const username = e.target.signup_username.value;
            if (password.length < 6) { alert("Password must be at least 6 characters."); showLoading(false); return; }
            if (username.length < 3) { alert("Username must be at least 3 characters."); showLoading(false); return; }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password); const user = userCredential.user;
                let role = user.uid === SUPERADMIN_UID ? 'Superadmin' : 'Member';
                await setDoc(doc(db, "users", user.uid), { username, email, role });
            } catch (error) { alert(error.message); } finally { showLoading(false); }
        };
        
        logoutBtn.onclick = () => signOut(auth);
        navButtons.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
        changeTeamSpaceBtn.addEventListener('click', () => { const newTeamSpaceId = teamSpaceIdInput.value.trim(); if (newTeamSpaceId && newTeamSpaceId !== currentTeamSpaceId) { localStorage.setItem('currentTeamSpaceId', newTeamSpaceId); location.reload(); } });
        createTeamSpaceBtn.addEventListener('click', () => { 
            const randomId = `team-${Math.random().toString(36).substring(2, 9)}`;
            localStorage.setItem('currentTeamSpaceId', randomId);
            location.reload();
        });

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tasks-tab-btn.active, .teams-filter-btn.active { color: #0d9488; border-color: #0d9488; }
        .modal-dialog { transition: all 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-teal-500"></div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container">
        <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-4xl w-full grid md:grid-cols-2 gap-8 p-8">
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">Login</h2>
                    <form id="login-form" class="space-y-4">
                        <input type="email" name="email" placeholder="Email" class="w-full p-3 border rounded-lg" required>
                        <input type="password" name="password" placeholder="Password" class="w-full p-3 border rounded-lg" required>
                        <button type="submit" class="w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600">Login</button>
                    </form>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">Sign Up</h2>
                    <form id="signup-form" class="space-y-4">
                        <input type="text" name="signup_username" placeholder="Username" class="w-full p-3 border rounded-lg" required>
                        <input type="email" name="signup_email" placeholder="Email" class="w-full p-3 border rounded-lg" required>
                        <input type="password" name="signup_password" placeholder="Password" class="w-full p-3 border rounded-lg" required>
                        <p class="text-xs text-red-600 text-center">Warning: For your security, do NOT use the same password as your PokeMMO game account.</p>
                        <button type="submit" class="w-full bg-gray-700 text-white p-3 rounded-lg font-bold hover:bg-gray-800">Create Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden">
        <!-- Generic Modal -->
        <div id="generic-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full z-50 flex items-center justify-center">
            <div class="modal-dialog bg-white p-8 rounded-lg shadow-xl w-full mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="generic-modal-title" class="text-2xl font-bold">Modal Title</h3>
                    <button id="generic-modal-close-btn" class="text-gray-500 hover:text-gray-800 font-bold text-2xl">&times;</button>
                </div>
                <div id="generic-modal-content" class="max-h-[60vh] overflow-y-auto"></div>
            </div>
        </div>
        
        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full z-50 flex items-center justify-center">
           <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <p id="confirmation-modal-message" class="text-xl mb-6 text-center"></p>
            <div class="flex justify-center gap-4">
             <button id="confirmation-modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
             <button id="confirmation-modal-confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Confirm</button>
            </div>
           </div>
        </div>

        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside class="w-64 bg-white shadow-md flex flex-col">
                <div class="p-6 text-center border-b">
                    <h1 class="text-2xl font-bold text-teal-700">Player Team Hub</h1>
                </div>
                <nav class="flex-grow p-4 space-y-2">
                    <button data-view="dashboard" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Dashboard</button>
                    <button data-view="pokemon-teams" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Pokémon Team Locker</button>
                    <button data-view="tasks" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Task Board</button>
                    <button data-view="breeding" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Breeding Projects</button>
                    <button data-view="hunts" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Shiny Hunts</button>
                    <button data-view="pokedex" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Pokédex & Builds</button>
                    <button data-view="ev-hotspots" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">EV Hotspots</button>
                    <button data-view="money-guide" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Money Guide</button>
                    <button data-view="admin-panel" id="admin-panel-btn" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition" style="display: none;">Admin Panel</button>
                </nav>
                <div class="p-4 border-t space-y-3">
                    <div id="user-profile-display" class="text-sm text-center text-gray-600 font-semibold"></div>
                    <button id="logout-btn" class="w-full text-sm text-red-500 hover:underline">Logout</button>
                    
                    <!-- NEW: Official Team Space Section -->
                    <div id="official-team-space-container" class="border-t pt-3"></div>

                    <div class="border-t pt-3">
                        <h4 class="font-bold mb-2">My Team Spaces</h4>
                        <p class="text-sm text-gray-600 mb-2">Your current Team ID is:</p>
                        <p id="team-space-id-display" class="bg-gray-100 p-2 rounded text-center font-mono break-words"></p>
                        <input id="team-space-id-input" type="text" placeholder="Enter Team ID to join" class="w-full p-2 border rounded mt-3">
                        <button id="change-team-space-btn" class="w-full bg-teal-500 text-white p-2 rounded mt-2 hover:bg-teal-600">Join Team Space</button>
                        <button id="create-team-space-btn" class="w-full text-sm text-gray-500 mt-2 hover:underline">Create a New Private Space</button>
                    </div>
                </div>
            </aside>
            <!-- Main Content -->
            <main class="flex-1 p-8 overflow-y-auto bg-gray-100">
                <div id="main-content">
                    <!-- Dynamic Content Rendered Here -->
                </div>
            </main>
        </div>
    </div>
</body>
</html>
