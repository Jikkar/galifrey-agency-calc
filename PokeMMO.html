<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokeMMO Player Team Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Added Chart.js for leaderboards -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        // Firebase App (the core)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, arrayRemove, arrayUnion, query, orderBy, writeBatch, serverTimestamp, increment, runTransaction, getDocs, Timestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDsacPQOqciPdM5SLHMh0muDH9GXswnyU0",
            authDomain: "pokemmo-team.firebaseapp.com",
            projectId: "pokemmo-team",
            storageBucket: "pokemmo-team.appspot.com",
            messagingSenderId: "538474033829",
            appId: "1:538474033829:web:26b62ba96efa1901ead34c",
            measurementId: "G-HWFL88XH7H"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- App State ---
        let currentUserId = null;
        let currentUsername = null;
        let currentUserRole = 'Guest';
        let currentTeamSpaceId = null;
        let teamSpacePermissions = {};
        let unsubscribeListeners = [];
        const usernameCache = {};
        const SUPERADMIN_UID = "G9MP7oe0cTQsu92SEXB6wqy1nQs1";
        let leaderboardChart = null; // To hold the chart instance

        // --- DOM Elements ---
        let authContainer, appContainer, teamSpaceIdDisplay, teamSpaceIdInput, changeTeamSpaceBtn, createTeamSpaceBtn, mainContent, loadingOverlay, userProfileDisplay, logoutBtn, genericModal, genericModalTitle, genericModalContent, genericModalCloseBtn, officialTeamSpaceContainer, confirmationModal;

        function initializeDOMElements() {
            authContainer = document.getElementById('auth-container');
            appContainer = document.getElementById('app-container');
            teamSpaceIdDisplay = document.getElementById('team-space-id-display');
            teamSpaceIdInput = document.getElementById('team-space-id-input');
            changeTeamSpaceBtn = document.getElementById('change-team-space-btn');
            createTeamSpaceBtn = document.getElementById('create-team-space-btn');
            mainContent = document.getElementById('main-content');
            loadingOverlay = document.getElementById('loading-overlay');
            userProfileDisplay = document.getElementById('user-profile-display');
            logoutBtn = document.getElementById('logout-btn');
            genericModal = document.getElementById('generic-modal');
            genericModalTitle = document.getElementById('generic-modal-title');
            genericModalContent = document.getElementById('generic-modal-content');
            genericModalCloseBtn = document.getElementById('generic-modal-close-btn');
            officialTeamSpaceContainer = document.getElementById('official-team-space-container');
            confirmationModal = document.getElementById('confirmation-modal');
        }


        // --- Core Functions ---
        function showLoading(show) { if(loadingOverlay) loadingOverlay.style.display = show ? 'flex' : 'none'; }
        
        function showGenericModal(title, content, formSubmitHandler = null, size = '2xl') {
            const modalDialog = genericModal.querySelector('.modal-dialog');
            modalDialog.classList.remove('max-w-md', 'max-w-2xl', 'max-w-4xl');
            modalDialog.classList.add(`max-w-${size}`);
            genericModalTitle.textContent = title;
            genericModalContent.innerHTML = content;
            genericModal.classList.remove('hidden');
            
            genericModalCloseBtn.onclick = hideGenericModal;

            const form = genericModalContent.querySelector('form');
            if (form) {
                form.onsubmit = (e) => {
                    e.preventDefault();
                    if(formSubmitHandler) formSubmitHandler(e);
                    // Do not automatically hide modal, let the handler decide
                };
            }
        }
        
        function hideGenericModal() {
            genericModal.classList.add('hidden');
        }
        
        function checkPermission(action) {
            if (currentUserRole === 'Superadmin') return true;
            return teamSpacePermissions[currentUserRole]?.[action] === true;
        }

        async function getUsername(userId) {
            if (!userId) return "Unknown";
            if (usernameCache[userId]) return usernameCache[userId];
            try {
                const userRef = doc(db, "users", userId);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) { const username = userSnap.data().username; usernameCache[userId] = username; return username; }
            } catch (error) { console.error("Error fetching username:", error); }
            return "Anonymous";
        }
        
        async function seedDefaultResources(teamSpaceId) {
            const batch = writeBatch(db);
            const pokedexRef = doc(db, `team_spaces/${teamSpaceId}/resources/pokedex`);
            const moneyRef = doc(db, `team_spaces/${teamSpaceId}/resources/moneyGuide`);
            const evRef = doc(db, `team_spaces/${teamSpaceId}/resources/evHotspots`);
            batch.set(pokedexRef, { entries: { "Garchomp": { name: "Garchomp", stats: "108/130/95/80/85/102", abilities: "Sand Veil, Rough Skin (HA)", builds: [{ name: "Swords Dance", nature: "Jolly", evs: "252 Atk / 4 SpD / 252 Spe", moves: "Swords Dance, Earthquake, Outrage"}] } }});
            batch.set(moneyRef, { entries: [ { id: "gym_reruns", name: 'Gym Rebattles', details: 'Most consistent endgame income.', potential: 'High (~400k/hr)' } ]});
            batch.set(evRef, { entries: [ { id: "hp_marill", stat: 'HP', pokemon: 'Marill (x5)', location: 'Route 114, Hoenn (Surf)', yield: '10' } ]});
            await batch.commit();
        }

        function switchView(viewName) {
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('bg-teal-600', 'text-white'));
            const button = document.querySelector(`.nav-button[data-view="${viewName}"]`);
            if (button) button.classList.add('bg-teal-600', 'text-white');
            if (mainContent) mainContent.innerHTML = '';
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            const viewRenderers = { 
                'dashboard': renderDashboard, 
                'pokemon-teams': renderPokemonTeams, 
                'tasks': renderTasks, 
                'breeding': renderBreedingProjects, 
                'hunts': renderShinyHunts, 
                'pokedex': renderPokedex, 
                'ev-hotspots': renderEvHotspots, 
                'money-guide': renderMoneyGuide, 
                'admin-panel': renderAdminPanel 
            };
            if (viewRenderers[viewName]) viewRenderers[viewName]();
        }

        function refreshCurrentView() {
            const activeNav = document.querySelector('.nav-button.bg-teal-600');
            if (activeNav) {
                switchView(activeNav.dataset.view);
            }
        }

        function setupTeamSpace(userId) {
            return new Promise(async (resolve, reject) => {
                let teamSpaceId = localStorage.getItem('currentTeamSpaceId');
                if (!teamSpaceId) {
                    teamSpaceId = "ExCorp";
                    localStorage.setItem('currentTeamSpaceId', teamSpaceId);
                }
                
                const teamSpaceRef = doc(db, "team_spaces", teamSpaceId);
                
                const defaultPermissions = {
                    Admin: { canManagePokemonTeams: true, canManageTasks: true, canManageProjects: true, canEditResources: true, canMarkStaffPick: true, canCreatePublicTeams: true, canVoteOnTeams: true, canVerifyContributions: true, canDeletePublicTeams: true },
                    Staff: { canManagePokemonTeams: true, canManageTasks: true, canManageProjects: true, canMarkStaffPick: true, canCreatePublicTeams: true, canVoteOnTeams: true, canVerifyContributions: true, canDeletePublicTeams: false },
                    Member: { canCreatePublicTeams: true, canVoteOnTeams: true, canManagePokemonTeams: false, canManageTasks: false, canManageProjects: false, canEditResources: false, canMarkStaffPick: false, canVerifyContributions: false, canDeletePublicTeams: false }
                };

                try {
                    const teamSpaceSnap = await getDoc(teamSpaceRef);

                    if (!teamSpaceSnap.exists()) {
                        await setDoc(teamSpaceRef, {
                            owner: userId,
                            name: teamSpaceId === "ExCorp" ? "ExCorp Main Team" : "New Team Space",
                            members: [userId],
                            createdAt: serverTimestamp(),
                            permissions: defaultPermissions
                        });
                        if (teamSpaceId === "ExCorp") {
                            await seedDefaultResources(teamSpaceId);
                        }
                    }
                
                    currentTeamSpaceId = teamSpaceId;
                    teamSpaceIdDisplay.textContent = currentTeamSpaceId;
                    teamSpaceIdInput.value = currentTeamSpaceId;
                    
                    let isFirstLoad = true;
                    const unsub = onSnapshot(teamSpaceRef, async (snap) => {
                        if(snap.exists()) {
                            const loadedData = snap.data();
                            const loadedPermissions = loadedData.permissions || {};
                            
                            const finalPermissions = {
                                Admin: { ...defaultPermissions.Admin, ...loadedPermissions.Admin },
                                Staff: { ...defaultPermissions.Staff, ...loadedPermissions.Staff },
                                Member: { ...defaultPermissions.Member, ...loadedPermissions.Member }
                            };

                            teamSpacePermissions = finalPermissions;

                            if (JSON.stringify(finalPermissions) !== JSON.stringify(loadedPermissions)) {
                                console.log("Permissions mismatch detected. Healing Firestore document.");
                                await updateDoc(teamSpaceRef, { permissions: finalPermissions }).catch(err => console.error("Error self-healing permissions:", err));
                            }

                            if(!loadedData.members?.includes(userId)) {
                                await updateDoc(teamSpaceRef, { members: arrayUnion(userId) });
                            }
                            
                            if (isFirstLoad) {
                                isFirstLoad = false;
                                resolve(); 
                            } else {
                                refreshCurrentView(); 
                            }

                        } else {
                            alert(`Team Space with ID "${currentTeamSpaceId}" not found. You can create a new one.`);
                            localStorage.removeItem('currentTeamSpaceId');
                            reject(new Error("Team space not found."));
                        }
                    }, (error) => {
                        console.error("Snapshot listener error:", error);
                        reject(error);
                    });
                    unsubscribeListeners.push(unsub);
                } catch (error) {
                    console.error("Error in setupTeamSpace:", error);
                    reject(error);
                }
            });
        }

        async function renderOfficialTeamSpaceButton() {
            const settingsRef = doc(db, "system_settings", "official_team_space");
            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    const { id, name } = docSnap.data();
                    officialTeamSpaceContainer.innerHTML = `
                        <h4 class="font-bold mb-2">Official Team Space</h4>
                        <button id="join-official-team-btn" data-id="${id}" class="w-full bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600 font-bold">
                            Join ${name}
                        </button>`;
                    document.getElementById('join-official-team-btn').onclick = (e) => {
                        const officialId = e.currentTarget.dataset.id;
                        if (officialId !== currentTeamSpaceId) {
                            localStorage.setItem('currentTeamSpaceId', officialId);
                            location.reload();
                        }
                    };
                } else {
                    officialTeamSpaceContainer.innerHTML = '';
                }
            });
        }


        // --- Render Functions ---
        async function renderDashboard() {
            mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800 mb-6">Player Team Dashboard</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-xl mb-3">Active Breeding Projects</h3><div id="dashboard-breeding" class="space-y-2"></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-xl mb-3">Active Shiny Hunts</h3><div id="dashboard-hunts" class="space-y-2"></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-xl mb-3">Player Team Members</h3><div id="dashboard-members" class="space-y-2"></div></div></div>`;
            const renderList = async (q, containerId, formatter) => {
                const unsub = onSnapshot(q, async (snapshot) => {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    container.innerHTML = snapshot.empty ? `<p class="text-gray-500">Nothing here yet.</p>` : (await Promise.all(snapshot.docs.map(doc => formatter(doc.data(), doc.id)))).join('');
                });
                unsubscribeListeners.push(unsub);
            };
            await renderList(query(collection(db, `team_spaces/${currentTeamSpaceId}/breeding`), orderBy("createdAt", "desc")), 'dashboard-breeding', async (data) => `<p>${data.targetPokemon} <span class="text-xs text-gray-400">by ${await getUsername(data.createdBy)}</span></p>`);
            await renderList(query(collection(db, `team_spaces/${currentTeamSpaceId}/hunts`), orderBy("createdAt", "desc")), 'dashboard-hunts', async (data) => `<div class="flex justify-between"><span>${data.target} <span class="text-xs text-gray-400">by ${await getUsername(data.createdBy)}</span></span><span class="font-mono font-bold">${(data.count || 0).toLocaleString()}</span></div>`);
            
            const teamSpaceUnsub = onSnapshot(doc(db, "team_spaces", currentTeamSpaceId), async (teamSpaceSnap) => {
                const membersContainer = document.getElementById('dashboard-members');
                if (!membersContainer || !teamSpaceSnap.exists()) return;
                const memberIds = teamSpaceSnap.data().members || [];
                const memberNames = await Promise.all(memberIds.map(id => getUsername(id)));
                
                let membersHtml = memberNames.slice(0, 5).map(name => `<p class="text-gray-700">${name}</p>`).join('');
                if (memberNames.length > 5) {
                    membersHtml += `<button id="see-all-members-btn" class="text-sm text-teal-600 hover:underline mt-2">See all ${memberNames.length} members...</button>`;
                }
                membersContainer.innerHTML = membersHtml;

                if (memberNames.length > 5) {
                    document.getElementById('see-all-members-btn').onclick = () => {
                        const allMembersHtml = `<div class="grid grid-cols-2 md:grid-cols-3 gap-4">${memberNames.map(name => `<p class="p-2 bg-gray-100 rounded">${name}</p>`).join('')}</div>`;
                        showGenericModal('All Team Members', allMembersHtml, null, '4xl');
                    };
                }
            });
            unsubscribeListeners.push(teamSpaceUnsub);
        }

        // --- POKEMON TEAMS MODULE ---
        // --- MODIFICATION START: IV/EV Formatting Helpers ---
        function formatIVs(ivString) {
            if (!ivString) return 'N/A';
            const parts = ivString.split(/[\s/,-]+/); // Split by space, slash, comma, or hyphen
            return parts.map(part => {
                const num = parseInt(part, 10);
                if (!isNaN(num)) {
                    let colorClass = 'text-red-600';
                    if (num === 31) colorClass = 'text-green-600 font-bold';
                    else if (num >= 25) colorClass = 'text-yellow-500';
                    else if (num >= 20) colorClass = 'text-orange-500';
                    return `<span class="${colorClass}">${num}</span>`;
                }
                return `<span>${part.toUpperCase()}</span>`; // Keep non-numeric parts like 'x'
            }).join('/');
        }

        function formatEVs(evString) {
            if (!evString) return 'N/A';
            // Regex to find numbers and the text that follows them
            return evString.replace(/(\d+)\s*([a-zA-Z]+)/g, (match, num, stat) => {
                const numVal = parseInt(num, 10);
                const statUpper = stat.toUpperCase();
                if (numVal === 252) {
                    return `<span class="text-green-600 font-bold">${numVal}</span> ${statUpper}`;
                }
                return `${numVal} ${statUpper}`;
            });
        }
        // --- MODIFICATION END ---

        function renderPokemonTeams() {
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Pokémon Team Locker</h2>
                    <div class="flex gap-4">
                        <button id="add-pokemon-team-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">New Pokémon Team</button>
                    </div>
                </div>
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex justify-between items-center" id="teams-filter-nav">
                        <div class="flex space-x-4">
                            <button data-filter="all" class="teams-filter-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:text-teal-600 hover:border-teal-600 active">All Teams</button>
                            <button data-filter="staff" class="teams-filter-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:text-teal-600 hover:border-teal-600">Staff Picks</button>
                            <button data-filter="public" class="teams-filter-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:text-teal-600 hover:border-teal-600">Public Teams</button>
                            <button data-filter="personal" class="teams-filter-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:text-teal-600 hover:border-teal-600">My Teams</button>
                        </div>
                        <div id="public-sort-options" class="hidden">
                            <span class="text-sm font-semibold mr-2">Sort by:</span>
                            <button data-sort="votes" class="sort-btn bg-teal-500 text-white px-3 py-1 rounded-l-md text-sm">Top Voted</button>
                            <button data-sort="latest" class="sort-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-r-md text-sm">Latest</button>
                        </div>
                    </nav>
                </div>
                <div id="pokemon-teams-container" class="space-y-6"></div>`;

            let currentFilter = 'all';
            let publicSortOrder = 'votes'; // 'votes' or 'latest'
            const q = query(collection(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`));

            const renderFilteredTeams = (snapshot) => {
                const container = document.getElementById('pokemon-teams-container');
                if (!container) return;
                let teams = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                if (currentFilter === 'staff') teams = teams.filter(t => t.isStaffPick);
                else if (currentFilter === 'public') teams = teams.filter(t => t.isPublic);
                else if (currentFilter === 'personal') teams = teams.filter(t => t.createdBy === currentUserId);
                
                // Apply sorting
                if (currentFilter === 'public') {
                    if (publicSortOrder === 'votes') {
                        teams.sort((a, b) => {
                            const scoreA = (a.upvotes?.length || 0) - (a.downvotes?.length || 0);
                            const scoreB = (b.upvotes?.length || 0) - (b.downvotes?.length || 0);
                            return scoreB - scoreA;
                        });
                    } else { // latest
                        teams.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                    }
                } else {
                    teams.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                }

                if(teams.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center mt-8">No Pokémon teams match the filter.</p>`;
                    return;
                }
                Promise.all(teams.map(renderPokemonTeamCard)).then(html => {
                    container.innerHTML = html.join('');
                    attachPokemonTeamCardListeners();
                });
            };

            const unsub = onSnapshot(q, renderFilteredTeams);
            unsubscribeListeners.push(unsub);

            document.querySelectorAll('.teams-filter-btn').forEach(btn => btn.onclick = (e) => {
                document.querySelectorAll('.teams-filter-btn').forEach(b => b.classList.remove('active', 'text-teal-600', 'border-teal-600'));
                e.target.classList.add('active', 'text-teal-600', 'border-teal-600');
                currentFilter = e.target.dataset.filter;
                document.getElementById('public-sort-options').classList.toggle('hidden', currentFilter !== 'public');
                onSnapshot(q, renderFilteredTeams);
            });

            document.querySelectorAll('.sort-btn').forEach(btn => btn.onclick = (e) => {
                publicSortOrder = e.target.dataset.sort;
                document.querySelectorAll('.sort-btn').forEach(b => {
                    b.classList.toggle('bg-teal-500', b.dataset.sort === publicSortOrder);
                    b.classList.toggle('text-white', b.dataset.sort === publicSortOrder);
                    b.classList.toggle('bg-gray-200', b.dataset.sort !== publicSortOrder);
                    b.classList.toggle('text-gray-700', b.dataset.sort !== publicSortOrder);
                });
                onSnapshot(q, renderFilteredTeams);
            });

            document.getElementById('add-pokemon-team-btn').onclick = () => {
                let formHtml = `
                    <form class="space-y-4">
                        <input type="text" name="name" placeholder="Team Name" class="w-full p-2 border rounded-lg" required>
                        <input type="text" name="purpose" placeholder="Purpose (e.g., Hoenn E4, Kanto Story)" class="w-full p-2 border rounded-lg">`;
                if(checkPermission('canCreatePublicTeams')) {
                    formHtml += `<label class="flex items-center gap-2"><input type="checkbox" name="isPublic"> Make Public</label>`;
                }
                formHtml += `<button type="submit" class="w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600">Create Team</button></form>`;
                
                showGenericModal('New Pokémon Team', formHtml, async (e) => {
                    if(e.target.name.value) {
                        await addDoc(collection(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`), { 
                            name: e.target.name.value, 
                            purpose: e.target.purpose.value,
                            pokemon: [], 
                            creatorNotes: "", // New field
                            comments: [], // Renamed from 'notes'
                            createdBy: currentUserId, 
                            createdAt: serverTimestamp(), 
                            isStaffPick: false,
                            isPublic: checkPermission('canCreatePublicTeams') ? e.target.isPublic.checked : false,
                            upvotes: [],
                            downvotes: []
                        });
                    }
                });
            };
        }

        async function renderPokemonTeamCard(team) {
            const teamId = team.id;
            const creatorName = await getUsername(team.createdBy);
            const upvotes = team.upvotes?.length || 0;
            const downvotes = team.downvotes?.length || 0;
            const score = upvotes - downvotes;
            const userVote = team.upvotes?.includes(currentUserId) ? 'up' : team.downvotes?.includes(currentUserId) ? 'down' : null;
            const isStaffPlus = ['Staff', 'Admin', 'Superadmin'].includes(currentUserRole);

            let borderClass = "border-gray-200";
            if (score <= -15) { /* Redacted */ }
            else if (score < 0) borderClass = "border-red-500 border-2";
            else if (score >= 100) borderClass = "border-yellow-400 border-4 p-1 bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-500 shadow-2xl";
            else if (score >= 75) borderClass = "border-purple-500 border-4 shadow-xl";
            else if (score >= 60) borderClass = "border-indigo-500 border-2 shadow-lg";
            else if (score >= 40) borderClass = "border-blue-500 border-2 shadow-md";
            else if (score >= 25) borderClass = "border-green-500 border-2 shadow-md";
            else if (score >= 10) borderClass = "border-green-300 border-2";

            const pokemonHtml = (await Promise.all((team.pokemon || []).map(async (p, i) => {
                const addedByName = await getUsername(p.addedBy);
                const canEditPokemon = team.createdBy === currentUserId || isStaffPlus;

                let wrapperClasses = 'rounded-lg'; // Default wrapper
                if (p.isShiny && p.isAlpha) {
                    wrapperClasses += ' p-1 bg-gradient-to-r from-yellow-400 to-red-500';
                } else if (p.isShiny) {
                    wrapperClasses += ' p-1 bg-yellow-400';
                } else if (p.isAlpha) {
                    wrapperClasses += ' p-1 bg-red-500';
                }

                const contentHtml = `
                    <div class="bg-gray-50 p-4 rounded-md relative group h-full">
                        ${canEditPokemon ? `
                        <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button data-team-id="${teamId}" data-pokemon-index="${i}" class="edit-pokemon-btn text-blue-500 hover:text-blue-700 p-1 bg-white rounded-full shadow">✏️</button>
                            <button data-team-id="${teamId}" data-pokemon-index="${i}" class="delete-pokemon-btn text-red-500 hover:text-red-700 p-1 bg-white rounded-full shadow font-bold">&times;</button>
                        </div>` : ''}
                        <div class="flex items-center gap-2">
                            <h4 class="font-bold text-lg">${p.species || 'N/A'}</h4>
                            ${p.isShiny ? `<span class="text-yellow-500 font-bold text-xs" title="Shiny">⭐</span>` : ''}
                            ${p.isAlpha ? `<span class="text-red-500 font-bold text-xs" title="Alpha">α</span>` : ''}
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 text-sm mt-2">
                            <p><strong>Lvl:</strong> ${p.level || 'N/A'}</p>
                            <p><strong>Nature:</strong> ${p.nature || 'N/A'}</p>
                            <p><strong>Item:</strong> ${p.heldItem || 'None'}</p>
                            <p><strong>Ability:</strong> ${p.hasHiddenAbility ? 'Hidden' : 'Standard'}</p>
                        </div>
                        <p class="text-sm mt-1"><strong>EVs:</strong> ${formatEVs(p.evs) || 'N/A'}</p>
                        <p class="text-sm mt-1"><strong>IVs:</strong> ${formatIVs(p.ivs) || 'N/A'}</p>
                        <p class="text-sm mt-1"><strong>Moves:</strong> ${(p.moves || []).join(', ') || 'N/A'}</p>
                        <p class="text-xs text-gray-400 mt-2 pt-2 border-t">Added by ${addedByName}</p>
                    </div>`;

                if (p.isShiny || p.isAlpha) {
                    return `<div class="${wrapperClasses}">${contentHtml}</div>`;
                } else {
                    return `<div class="bg-gray-50 p-4 rounded-md border relative group">${contentHtml.replace('<div class="bg-gray-50 p-4 rounded-md relative group h-full">', '<div>')}</div>`;
                }

            }))).join('');

            const commentsHtml = (await Promise.all((team.comments || []).map(async (comment, index) => {
                const authorName = await getUsername(comment.authorId);
                const canDeleteComment = comment.authorId === currentUserId || isStaffPlus;
                const commentTimestamp = comment.createdAt ? new Date(comment.createdAt).toLocaleString() : '';
                const isOp = comment.authorId === team.createdBy;

                return `<div class="text-sm bg-gray-100 p-2 rounded group relative">
                            <div class="flex justify-between items-start">
                                <div>
                                    <strong>${authorName} ${isOp ? '<span class="text-xs bg-blue-500 text-white font-bold px-1.5 py-0.5 rounded-full">OP</span>' : ''}</strong>: ${comment.text}
                                </div>
                                ${canDeleteComment ? `<button data-team-id="${teamId}" data-comment-index="${index}" class="delete-comment-btn absolute top-1 right-1 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>` : ''}
                            </div>
                            <div class="text-xs text-gray-400 mt-1 text-right">${commentTimestamp}</div>
                        </div>`;
            }))).join('');


            if (score <= -15) {
                return `
                    <div class="bg-black p-6 rounded-lg shadow border-4 border-red-800 text-center relative">
                        ${checkPermission('canDeletePublicTeams') ? `<button data-team-id="${teamId}" data-is-public="${team.isPublic}" class="delete-pokemon-team-btn absolute top-2 right-2 text-white hover:text-red-400">Delete Team</button>` : ''}
                        <h3 class="text-2xl font-bold text-gray-400">[REDACTED BY ORDER OF STAFF]</h3>
                        <p class="text-gray-500 mt-4">This team build was deemed a public nuisance.</p>
                        <p class="text-gray-600 mt-2 text-sm">Original creator: ${creatorName}</p>
                    </div>`;
            }

            const canManageTeam = team.createdBy === currentUserId || isStaffPlus;
            const canTogglePublic = (team.createdBy === currentUserId && checkPermission('canCreatePublicTeams')) || isStaffPlus;

            return `
                <div class="bg-white p-5 rounded-lg shadow transition-all ${borderClass}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold">${team.name}</h3>
                            ${team.purpose ? `<p class="text-md font-semibold text-teal-700">${team.purpose}</p>` : ''}
                            <p class="text-sm text-gray-500">Created by ${creatorName}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            ${canTogglePublic ? `
                            <label class="flex items-center gap-2 text-sm cursor-pointer">
                                <input type="checkbox" data-team-id="${teamId}" class="public-toggle-checkbox" ${team.isPublic ? 'checked' : ''}> Public
                            </label>` : ''}
                            ${checkPermission('canMarkStaffPick') && team.isPublic ? `<label class="flex items-center gap-2 text-sm"><input type="checkbox" data-team-id="${teamId}" class="staff-pick-checkbox" ${team.isStaffPick ? 'checked' : ''}> Staff Pick</label>` : ''}
                            ${canManageTeam ? `<button data-team-id="${teamId}" class="delete-pokemon-team-btn text-red-500 hover:text-red-700">Delete Team</button>` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        ${pokemonHtml}
                        ${(team.pokemon || []).length < 6 && canManageTeam ? `<button data-team-id="${teamId}" class="add-pokemon-btn flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold p-3 rounded-md transition">+</button>` : ''}
                    </div>
                    <div class="border-t pt-4 flex flex-col md:flex-row justify-between items-start gap-6">
                         <div class="w-full md:w-1/2">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold">Creator's Notes</h4>
                                ${canManageTeam ? `<button data-team-id="${teamId}" class="edit-creator-notes-btn text-sm text-blue-600 hover:underline">Edit</button>` : ''}
                            </div>
                            <div data-team-id="${teamId}" class="creator-notes-display text-sm bg-gray-50 p-3 rounded-md min-h-[100px] whitespace-pre-wrap">${team.creatorNotes || '<span class="text-gray-400">No notes from the creator yet.</span>'}</div>
                        </div>
                        <div class="w-full md:w-1/2">
                            <h4 class="font-semibold mb-2">Comments</h4>
                            <div class="space-y-2 max-h-40 overflow-y-auto mb-2 pr-2">${commentsHtml}</div>
                            <div class="flex gap-2">
                                <input type="text" data-team-id="${teamId}" class="comment-input flex-grow border rounded p-2 text-sm" placeholder="Add a comment...">
                                <button data-team-id="${teamId}" class="add-comment-btn bg-gray-600 text-white px-4 rounded-lg text-sm">Post</button>
                            </div>
                        </div>
                        ${checkPermission('canVoteOnTeams') ? `
                        <div class="flex items-center gap-2 w-full md:w-auto justify-center">
                            <button data-team-id="${teamId}" data-vote="up" class="vote-btn p-2 rounded-full ${userVote === 'up' ? 'bg-green-500 text-white' : 'bg-gray-200 hover:bg-green-200'}">▲</button>
                            <span class="font-bold text-lg">${score}</span>
                            <button data-team-id="${teamId}" data-vote="down" class="vote-btn p-2 rounded-full ${userVote === 'down' ? 'bg-red-500 text-white' : 'bg-gray-200 hover:bg-red-200'}">▼</button>
                        </div>` : ''}
                    </div>
                </div>`;
        }

        function showPokemonFormModal(title, teamId, pokemon = {}, index = -1) {
            const isEditing = index > -1;
            const formHtml = `
                <form class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" name="species" placeholder="Species" value="${pokemon.species || ''}" class="w-full p-2 border rounded-lg" required>
                        <input type="number" name="level" placeholder="Level" value="${pokemon.level || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" name="nature" placeholder="Nature" value="${pokemon.nature || ''}" class="w-full p-2 border rounded-lg">
                        <input type="text" name="heldItem" placeholder="Held Item" value="${pokemon.heldItem || ''}" class="w-full p-2 border rounded-lg">
                    </div>
                    <input type="text" name="ivs" placeholder="IVs (e.g., 31/x/31/31/x/31)" value="${pokemon.ivs || ''}" class="w-full p-2 border rounded-lg" oninput="this.value = this.value.toUpperCase()">
                    <input type="text" name="evs" placeholder="EVs (e.g., 252 Atk / 252 Spe)" value="${pokemon.evs || ''}" class="w-full p-2 border rounded-lg" oninput="this.value = this.value.toUpperCase()">
                    <input type="text" name="moves" placeholder="Moves (comma-separated)" value="${(pokemon.moves || []).join(', ')}" class="w-full p-2 border rounded-lg">
                    <div class="flex gap-6 pt-2">
                        <label class="flex items-center gap-2"><input type="checkbox" name="hasHiddenAbility" ${pokemon.hasHiddenAbility ? 'checked' : ''}> Hidden Ability</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="isShiny" ${pokemon.isShiny ? 'checked' : ''}> Shiny</label>
                        <label class="flex items-center gap-2"><input type="checkbox" name="isAlpha" ${pokemon.isAlpha ? 'checked' : ''}> Alpha</label>
                    </div>
                    <div class="flex justify-end gap-4 pt-4 border-t">
                        <button type="button" class="generic-modal-close-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
                        <button type="submit" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg">${isEditing ? 'Save Changes' : 'Add Pokémon'}</button>
                    </div>
                </form>`;
            
            showGenericModal(title, formHtml, async (event) => {
                const form = event.target;
                const pokemonData = {
                    species: form.species.value,
                    level: Number(form.level.value) || null,
                    nature: form.nature.value,
                    heldItem: form.heldItem.value,
                    ivs: form.ivs.value,
                    evs: form.evs.value,
                    moves: form.moves.value.split(',').map(m => m.trim()).filter(Boolean),
                    hasHiddenAbility: form.hasHiddenAbility.checked,
                    isShiny: form.isShiny.checked,
                    isAlpha: form.isAlpha.checked,
                    addedBy: pokemon.addedBy || currentUserId, // Preserve original adder on edit
                };
                
                if (isEditing) {
                    const teamRef = doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId);
                    await runTransaction(db, async (transaction) => {
                        const teamDoc = await transaction.get(teamRef);
                        if (!teamDoc.exists()) return;
                        const teamData = teamDoc.data();
                        const newPokemonArray = [...teamData.pokemon];
                        newPokemonArray[index] = pokemonData;
                        transaction.update(teamRef, { pokemon: newPokemonArray });
                    });
                } else {
                    await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId), { 
                        pokemon: arrayUnion(pokemonData) 
                    });
                }
                hideGenericModal();
            });
            genericModal.querySelector('.generic-modal-close-btn').onclick = hideGenericModal;
        }

        function attachPokemonTeamCardListeners() {
            document.querySelectorAll('.add-pokemon-btn').forEach(btn => btn.onclick = e => {
                const teamId = e.target.dataset.teamId;
                showPokemonFormModal('Add Pokémon to Team', teamId);
            });

            document.querySelectorAll('.edit-pokemon-btn').forEach(btn => btn.onclick = async e => {
                const { teamId, pokemonIndex } = e.currentTarget.dataset;
                const teamRef = doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId);
                const teamSnap = await getDoc(teamRef);
                if (teamSnap.exists()) {
                    const pokemonData = teamSnap.data().pokemon[pokemonIndex];
                    showPokemonFormModal('Edit Pokémon', teamId, pokemonData, pokemonIndex);
                }
            });
            
            document.querySelectorAll('.public-toggle-checkbox').forEach(box => box.onchange = async e => {
                const teamId = e.target.dataset.teamId;
                const isPublic = e.target.checked;
                await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId), { isPublic });
            });

            document.querySelectorAll('.add-comment-btn').forEach(btn => btn.onclick = async e => {
                const teamId = e.target.dataset.teamId;
                const input = document.querySelector(`.comment-input[data-team-id="${teamId}"]`);
                if (input && input.value.trim()) { 
                    try {
                        const commentData = { 
                            text: input.value, 
                            authorId: currentUserId, 
                            createdAt: new Date().toISOString() 
                        };
                        await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId), { 
                            comments: arrayUnion(commentData) 
                        }); 
                        input.value = ''; 
                    } catch (error) {
                        console.error("Error adding comment:", error);
                        alert("Could not add comment.");
                    }
                }
            });

            document.querySelectorAll('.delete-comment-btn').forEach(btn => btn.onclick = async e => {
                const { teamId, commentIndex } = e.target.dataset;
                const teamRef = doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId);
                const teamSnap = await getDoc(teamRef);
                if (teamSnap.exists()) {
                    const teamData = teamSnap.data();
                    const commentToRemove = teamData.comments[commentIndex];
                    if (commentToRemove) {
                        const canDeleteComment = commentToRemove.authorId === currentUserId || ['Staff', 'Admin', 'Superadmin'].includes(currentUserRole);
                        if (canDeleteComment) {
                            showModal('Delete this comment?', () => {
                                updateDoc(teamRef, { comments: arrayRemove(commentToRemove) });
                            });
                        } else {
                            alert("You don't have permission to delete this comment.");
                        }
                    }
                }
            });

            document.querySelectorAll('.edit-creator-notes-btn').forEach(btn => btn.onclick = async e => {
                const teamId = e.target.dataset.teamId;
                const teamRef = doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId);
                const teamSnap = await getDoc(teamRef);
                if (!teamSnap.exists()) return;

                const currentNotes = teamSnap.data().creatorNotes || "";
                const formHtml = `
                    <form>
                        <textarea name="creatorNotes" class="w-full h-48 p-2 border rounded-lg">${currentNotes}</textarea>
                        <div class="flex justify-end gap-4 mt-4">
                            <button type="button" class="generic-modal-close-btn bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                            <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg">Save Notes</button>
                        </div>
                    </form>
                `;
                showGenericModal('Edit Creator Notes', formHtml, async (event) => {
                    const newNotes = event.target.creatorNotes.value;
                    await updateDoc(teamRef, { creatorNotes: newNotes });
                    hideGenericModal();
                });
                genericModal.querySelector('.generic-modal-close-btn').onclick = hideGenericModal;
            });

            document.querySelectorAll('.delete-pokemon-team-btn').forEach(btn => btn.onclick = e => {
                const teamId = e.target.dataset.teamId;
                const teamRef = doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId);
                showModal('Delete this entire Pokémon team?', () => deleteDoc(teamRef));
            });
            
            document.querySelectorAll('.delete-pokemon-btn').forEach(btn => btn.onclick = async e => {
                const { teamId, pokemonIndex } = e.currentTarget.dataset;
                const teamRef = doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId); 
                const teamSnap = await getDoc(teamRef); 
                const pokemonToRemove = teamSnap.data().pokemon[pokemonIndex];
                showModal(`Delete ${pokemonToRemove.species}?`, () => updateDoc(teamRef, { pokemon: arrayRemove(pokemonToRemove) }));
            });

            document.querySelectorAll('.staff-pick-checkbox').forEach(box => box.onchange = async e => await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, e.target.dataset.teamId), { isStaffPick: e.target.checked }));

            document.querySelectorAll('.vote-btn').forEach(btn => btn.onclick = async e => {
                const { teamId, vote } = e.currentTarget.dataset;
                const teamRef = doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId);
                
                if (currentUserRole === 'Superadmin') {
                    if (vote === 'up') {
                        await updateDoc(teamRef, { upvotes: arrayUnion(currentUserId + Math.random()) });
                    } else {
                        await updateDoc(teamRef, { downvotes: arrayUnion(currentUserId + Math.random()) });
                    }
                    return;
                }

                await runTransaction(db, async (transaction) => {
                    const teamDoc = await transaction.get(teamRef);
                    if (!teamDoc.exists()) return;

                    const data = teamDoc.data();
                    const upvotes = data.upvotes || [];
                    const downvotes = data.downvotes || [];
                    
                    const hasUpvoted = upvotes.includes(currentUserId);
                    const hasDownvoted = downvotes.includes(currentUserId);

                    let newUpvotes = [...upvotes];
                    let newDownvotes = [...downvotes];

                    if (vote === 'up') {
                        if (hasUpvoted) { newUpvotes = newUpvotes.filter(id => id !== currentUserId); } 
                        else { newUpvotes.push(currentUserId); newDownvotes = newDownvotes.filter(id => id !== currentUserId); }
                    } else if (vote === 'down') {
                        if (hasDownvoted) { newDownvotes = newDownvotes.filter(id => id !== currentUserId); } 
                        else { newDownvotes.push(currentUserId); newUpvotes = newUpvotes.filter(id => id !== currentUserId); }
                    }
                    transaction.update(teamRef, { upvotes: newUpvotes, downvotes: newDownvotes });
                });
            });
        }

        // --- TASKS MODULE (REFINED & FIXED) ---
        function renderTasks() {
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Task Board</h2>
                </div>
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex space-x-4" id="tasks-tab-nav">
                        <button data-tab="shared" class="tasks-tab-btn py-2 px-4 font-semibold text-teal-600 border-b-2 border-teal-600">Active Tasks</button>
                        <button data-tab="completed" class="tasks-tab-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent">Completed</button>
                        <button data-tab="personal" class="tasks-tab-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent">My Tasks</button>
                        <button data-tab="leaderboard" class="tasks-tab-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent">Leaderboard</button>
                    </nav>
                </div>
                <div id="tasks-content"></div>`;

            const renderTabContent = (tab) => {
                const container = document.getElementById('tasks-content');
                if (!container) return;
                
                let q;
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];

                if (tab === 'shared' || tab === 'completed') {
                    const isCompleted = tab === 'completed';
                    container.innerHTML = `
                        ${tab === 'shared' && checkPermission('canManageTasks') ? `
                        <div class="bg-white p-6 rounded-lg shadow mb-6">
                            <button id="add-task-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg">Create New Shared Task</button>
                        </div>` : ''}
                        <div id="shared-tasks-container" class="space-y-4"></div>`;
                    
                    if (tab === 'shared' && checkPermission('canManageTasks')) {
                        document.getElementById('add-task-btn').onclick = () => showNewTaskModal();
                    }

                    q = query(collection(db, `team_spaces/${currentTeamSpaceId}/tasks`), where("completed", "==", isCompleted));
                    const unsub = onSnapshot(q, async (snapshot) => {
                        const taskContainer = document.getElementById('shared-tasks-container');
                        if (!taskContainer) return;
                        
                        const docs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toDate() || 0) - (a.data().createdAt?.toDate() || 0));

                        taskContainer.innerHTML = docs.length === 0
                            ? `<p class="text-gray-500 text-center mt-8">No ${isCompleted ? 'completed' : 'active'} tasks.</p>` 
                            : (await Promise.all(docs.map(isCompleted ? renderCompletedTaskCard : renderTaskCard))).join('');
                        attachTaskCardListeners();
                    });
                    unsubscribeListeners.push(unsub);
                } else if (tab === 'personal') {
                    container.innerHTML = `
                        <div class="bg-white p-6 rounded-lg shadow mb-6">
                             <button id="add-personal-task-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">Create New Personal Task</button>
                        </div>
                        <div id="personal-tasks-container" class="space-y-4"></div>`;
                    
                    document.getElementById('add-personal-task-btn').onclick = () => showNewPersonalTaskModal();
                    
                    q = query(collection(db, `users/${currentUserId}/tasks`), where("completed", "==", false));
                    const unsub = onSnapshot(q, async (snapshot) => {
                        const taskContainer = document.getElementById('personal-tasks-container'); if (!taskContainer) return;
                        
                        const docs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toDate() || 0) - (a.data().createdAt?.toDate() || 0));

                        taskContainer.innerHTML = docs.length === 0
                            ? '<p class="text-gray-500 text-center mt-8">No personal tasks.</p>' 
                            : (await Promise.all(docs.map(renderPersonalTaskCard))).join('');
                        attachPersonalTaskCardListeners();
                    });
                    unsubscribeListeners.push(unsub);
                } else if (tab === 'leaderboard') {
                    renderLeaderboard(container);
                }
            };
            document.querySelectorAll('.tasks-tab-btn').forEach(btn => btn.onclick = (e) => { document.querySelectorAll('.tasks-tab-btn').forEach(b => b.classList.remove('text-teal-600', 'border-teal-600')); e.target.classList.add('text-teal-600', 'border-teal-600'); renderTabContent(e.target.dataset.tab); });
            renderTabContent('shared');
        }

        function showNewTaskModal() {
            const formHtml = `
                <form id="add-task-form-modal" class="space-y-4">
                    <input type="text" name="text" placeholder="Task Title" class="w-full p-2 border rounded-lg" required>
                    <textarea name="details" placeholder="Details & Instructions..." class="w-full p-2 border rounded-lg h-24"></textarea>
                    <input type="text" name="reward" placeholder="Reward / Incentive" class="w-full p-2 border rounded-lg">
                    <select name="type" class="w-full p-2 border rounded-lg">
                        <option value="checklist">Simple Checklist Task</option>
                        <option value="goal">Collaborative Goal</option>
                    </select>
                    <div id="goal-fields" class="hidden space-y-2">
                        <div id="goal-items-container">
                             <div class="flex gap-2 items-center">
                                <input type="text" name="goalItemName" placeholder="Item Name (e.g., Ultra Balls, PokeYen)" class="flex-grow p-2 border rounded-lg">
                                <input type="number" name="goalItemTarget" placeholder="Target" class="w-28 p-2 border rounded-lg">
                            </div>
                        </div>
                        <button type="button" id="add-goal-item-btn" class="text-sm text-teal-600 hover:underline">+ Add another item</button>
                    </div>
                    <div class="flex items-center gap-2">
                         <input type="checkbox" name="isRecurring" id="isRecurring">
                         <label for="isRecurring">Is this a recurring task?</label>
                         <select name="recurrencePeriod" id="recurrencePeriod" class="p-1 border rounded-lg hidden">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                         </select>
                    </div>
                    <button type="submit" class="w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600">Create Task</button>
                </form>`;
            
            showGenericModal('New Shared Task', formHtml, async (e) => {
                const form = e.target;
                const taskData = {
                    text: form.text.value,
                    details: form.details.value,
                    reward: form.reward.value,
                    type: form.type.value,
                    completed: false,
                    createdBy: currentUserId,
                    createdAt: serverTimestamp(),
                    isRecurring: form.isRecurring.checked,
                    recurrencePeriod: form.isRecurring.checked ? form.recurrencePeriod.value : null,
                    lastReset: form.isRecurring.checked ? serverTimestamp() : null,
                };
                if (taskData.type === 'goal') {
                    taskData.goalItems = [];
                    const itemNames = form.querySelectorAll('input[name="goalItemName"]');
                    const itemTargets = form.querySelectorAll('input[name="goalItemTarget"]');
                    itemNames.forEach((nameInput, index) => {
                        if (nameInput.value) {
                            taskData.goalItems.push({
                                name: nameInput.value,
                                target: Number(itemTargets[index].value) || 0,
                                progress: 0
                            });
                        }
                    });
                }
                await addDoc(collection(db, `team_spaces/${currentTeamSpaceId}/tasks`), taskData);
            }, 'md');

            const modalForm = document.getElementById('add-task-form-modal');
            modalForm.querySelector('select[name="type"]').onchange = (e) => {
                modalForm.querySelector('#goal-fields').classList.toggle('hidden', e.target.value !== 'goal');
            };
            modalForm.querySelector('#add-goal-item-btn').onclick = () => {
                const container = modalForm.querySelector('#goal-items-container');
                const newItemHtml = `
                    <div class="flex gap-2 items-center mt-2">
                        <input type="text" name="goalItemName" placeholder="Item Name (e.g., Ultra Balls, PokeYen)" class="flex-grow p-2 border rounded-lg">
                        <input type="number" name="goalItemTarget" placeholder="Target" class="w-28 p-2 border rounded-lg">
                    </div>`;
                container.insertAdjacentHTML('beforeend', newItemHtml);
            };
            modalForm.querySelector('#isRecurring').onchange = (e) => {
                modalForm.querySelector('#recurrencePeriod').classList.toggle('hidden', !e.target.checked);
            };
        }

        // --- MODIFICATION START: New Personal Task Modal ---
        function showNewPersonalTaskModal() {
            const formHtml = `
                <form id="add-personal-task-form-modal" class="space-y-4">
                    <input type="text" name="text" placeholder="Task Title (e.g., Daily EV Training)" class="w-full p-2 border rounded-lg" required>
                    <textarea name="details" placeholder="Details (optional)..." class="w-full p-2 border rounded-lg h-24"></textarea>
                    
                    <div id="personal-goal-fields" class="space-y-2">
                        <label class="font-semibold text-gray-700">Items to Track (Optional)</label>
                        <div id="personal-goal-items-container">
                             <div class="flex gap-2 items-center">
                                <input type="text" name="goalItemName" placeholder="Item Name (e.g., Garchomp EVs)" class="flex-grow p-2 border rounded-lg">
                                <input type="number" name="goalItemTarget" placeholder="Target" class="w-28 p-2 border rounded-lg">
                            </div>
                        </div>
                        <button type="button" id="add-personal-goal-item-btn" class="text-sm text-blue-600 hover:underline">+ Add another item</button>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600">Create Personal Task</button>
                </form>`;
            
            showGenericModal('New Personal Task', formHtml, async (e) => {
                const form = e.target;
                const taskData = {
                    text: form.text.value,
                    details: form.details.value,
                    completed: false,
                    createdBy: currentUserId,
                    createdAt: serverTimestamp(),
                    goalItems: []
                };

                const itemNames = form.querySelectorAll('input[name="goalItemName"]');
                const itemTargets = form.querySelectorAll('input[name="goalItemTarget"]');
                itemNames.forEach((nameInput, index) => {
                    if (nameInput.value) {
                        taskData.goalItems.push({
                            name: nameInput.value,
                            target: Number(itemTargets[index].value) || 0,
                            progress: 0
                        });
                    }
                });

                await addDoc(collection(db, `users/${currentUserId}/tasks`), taskData);
            }, 'md');

            const modalForm = document.getElementById('add-personal-task-form-modal');
            modalForm.querySelector('#add-personal-goal-item-btn').onclick = () => {
                const container = modalForm.querySelector('#personal-goal-items-container');
                const newItemHtml = `
                    <div class="flex gap-2 items-center mt-2">
                        <input type="text" name="goalItemName" placeholder="Item Name" class="flex-grow p-2 border rounded-lg">
                        <input type="number" name="goalItemTarget" placeholder="Target" class="w-28 p-2 border rounded-lg">
                    </div>`;
                container.insertAdjacentHTML('beforeend', newItemHtml);
            };
        }
        // --- MODIFICATION END ---

        async function renderTaskCard(doc) {
            const task = doc.data();
            const taskId = doc.id;
            const creatorName = await getUsername(task.createdBy);
            
            let contentHtml = '';
            if (task.type === 'goal') {
                contentHtml += `<div class="mt-4 space-y-3">`;
                (task.goalItems || []).forEach((item, index) => {
                    const progressPercent = item.target > 0 ? Math.min(100, (item.progress / item.target) * 100) : 0;
                    contentHtml += `
                        <div>
                            <div class="flex justify-between text-sm font-semibold text-gray-600 mb-1">
                                <span>${item.name}</span>
                                <span>${item.progress.toLocaleString()} / ${item.target.toLocaleString()}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="bg-teal-500 h-4 rounded-full text-white text-xs flex items-center justify-center" style="width: ${progressPercent}%">
                                    ${progressPercent.toFixed(0)}%
                                </div>
                            </div>
                        </div>`;
                });
                contentHtml += `
                    <div class="mt-4 flex gap-2 border-t pt-4">
                        <input type="number" data-task-id="${taskId}" class="goal-contribution-input flex-grow p-2 border rounded-lg" placeholder="Amount...">
                        <select data-task-id="${taskId}" class="goal-item-select p-2 border rounded-lg">
                            ${(task.goalItems || []).map(item => `<option value="${item.name}">${item.name}</option>`).join('')}
                        </select>
                        <button data-task-id="${taskId}" class="add-contribution-btn bg-gray-600 text-white px-4 rounded-lg">Log</button>
                    </div>
                </div>`;
            }

            let logHtml = `<div class="mt-4 border-t pt-4">
                <h4 class="font-semibold mb-2">Contribution Log</h4>
                <div id="log-${taskId}" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                    <p class="text-sm text-gray-500">Loading log...</p>
                </div>
            </div>`;
            
            const contributionsQuery = query(collection(db, `team_spaces/${currentTeamSpaceId}/tasks/${taskId}/contributions`), orderBy('timestamp', 'desc'));
            const unsub = onSnapshot(contributionsQuery, async (snapshot) => {
                const logContainer = document.getElementById(`log-${taskId}`);
                if (!logContainer) return;

                const contributions = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                if (contributions.length === 0) {
                    logContainer.innerHTML = `<p class="text-sm text-gray-500">No contributions yet.</p>`;
                } else {
                    logContainer.innerHTML = (await Promise.all(contributions.map(async c => {
                        const contributorName = await getUsername(c.userId);
                        const contributionTime = c.timestamp ? new Timestamp(c.timestamp.seconds, c.timestamp.nanoseconds).toDate().toLocaleString() : '...';
                        const itemEntries = Object.entries(c.items).map(([key, val]) => `${val.toLocaleString()} ${key}`).join(', ');
                        return `
                            <div class="text-sm p-2 rounded ${c.status === 'verified' ? 'bg-green-50' : 'bg-yellow-50'}">
                                <div class="flex justify-between items-center">
                                    <span><strong>${contributorName}</strong> logged ${itemEntries}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500">${contributionTime}</span>
                                        ${c.status === 'pending' && checkPermission('canVerifyContributions') ? `<button data-task-id="${taskId}" data-contrib-id="${c.id}" class="verify-contribution-btn text-xs bg-green-500 text-white px-2 py-1 rounded">Verify</button>` : `<span class="text-xs font-bold ${c.status === 'verified' ? 'text-green-600' : 'text-yellow-600'}">${c.status}</span>`}
                                    </div>
                                </div>
                            </div>`;
                    }))).join('');
                }
                attachTaskCardListeners();
            });
            unsubscribeListeners.push(unsub);


            return `
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold ${task.completed ? 'line-through text-gray-400' : ''}">${task.text}</h3>
                            <p class="text-sm text-gray-500">Added by ${creatorName}</p>
                        </div>
                        <div class="flex items-center gap-2">
                             ${task.isRecurring ? `<span class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${task.recurrencePeriod}</span>` : ''}
                             ${checkPermission('canManageTasks') ? `<button data-task-id="${taskId}" class="delete-task-btn text-red-500 hover:text-red-700">&times;</button>` : ''}
                        </div>
                    </div>
                    ${task.details ? `<p class="text-gray-700 mt-2 p-2 bg-gray-50 rounded">${task.details}</p>` : ''}
                    ${task.reward ? `<p class="text-sm font-semibold text-yellow-600 mt-2">Reward: ${task.reward}</p>` : ''}
                    ${contentHtml}
                    ${task.type === 'goal' ? logHtml : ''}
                    ${checkPermission('canManageTasks') ? `
                        <div class="mt-4 pt-4 border-t flex justify-end">
                            <button data-task-id="${taskId}" class="task-complete-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Mark as Complete</button>
                        </div>
                    ` : ''}
                </div>`;
        }
        
        async function renderCompletedTaskCard(doc) {
            const task = doc.data();
            const taskId = doc.id;
            const creatorName = await getUsername(task.createdBy);

            return `
                <div class="bg-gray-100 p-4 rounded-lg shadow-inner opacity-80">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold text-gray-500 line-through">${task.text}</h3>
                            <p class="text-xs text-gray-400">Completed Task (Created by ${creatorName})</p>
                        </div>
                        <button data-task-id="${taskId}" class="view-breakdown-btn bg-gray-300 text-gray-700 text-sm font-semibold py-1 px-3 rounded-lg hover:bg-gray-400">View Breakdown</button>
                    </div>
                </div>
            `;
        }

        // --- MODIFICATION START: New Personal Task Card ---
        async function renderPersonalTaskCard(doc) {
            const task = doc.data();
            const taskId = doc.id;
            
            let contentHtml = '';
            if (task.goalItems && task.goalItems.length > 0) {
                contentHtml += `<div class="mt-4 space-y-3">`;
                task.goalItems.forEach((item) => {
                    const progressPercent = item.target > 0 ? Math.min(100, (item.progress / item.target) * 100) : 0;
                    contentHtml += `
                        <div>
                            <div class="flex justify-between text-sm font-semibold text-gray-600 mb-1">
                                <span>${item.name}</span>
                                <span>${item.progress.toLocaleString()} / ${item.target.toLocaleString()}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="bg-blue-500 h-4 rounded-full text-white text-xs flex items-center justify-center" style="width: ${progressPercent}%">
                                    ${progressPercent.toFixed(0)}%
                                </div>
                            </div>
                        </div>`;
                });
                contentHtml += `
                    <div class="mt-4 flex gap-2 border-t pt-4">
                        <input type="number" data-task-id="${taskId}" class="personal-contribution-input flex-grow p-2 border rounded-lg" placeholder="Amount...">
                        <select data-task-id="${taskId}" class="personal-item-select p-2 border rounded-lg">
                            ${(task.goalItems || []).map(item => `<option value="${item.name}">${item.name}</option>`).join('')}
                        </select>
                        <button data-task-id="${taskId}" class="add-personal-contribution-btn bg-gray-600 text-white px-4 rounded-lg">Log</button>
                    </div>
                </div>`;
            }

            return `
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold">${task.text}</h3>
                        </div>
                        <div class="flex items-center gap-2">
                             <button data-task-id="${taskId}" class="personal-task-complete-btn text-green-500 hover:text-green-700 text-sm">✓ Complete</button>
                             <button data-task-id="${taskId}" class="personal-task-delete-btn text-red-500 hover:text-red-700 font-bold">&times;</button>
                        </div>
                    </div>
                    ${task.details ? `<p class="text-gray-700 mt-2 p-2 bg-gray-50 rounded">${task.details}</p>` : ''}
                    ${contentHtml}
                </div>`;
        }
        // --- MODIFICATION END ---
        
        // --- FIX START: Created missing function ---
        function attachPersonalTaskCardListeners() {
            document.querySelectorAll('.personal-task-complete-btn').forEach(btn => {
                btn.onclick = async (e) => {
                    const taskId = e.target.dataset.taskId;
                    const taskRef = doc(db, `users/${currentUserId}/tasks`, taskId);
                    await updateDoc(taskRef, { completed: true });
                };
            });

            document.querySelectorAll('.personal-task-delete-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const taskId = e.target.dataset.taskId;
                    const taskRef = doc(db, `users/${currentUserId}/tasks`, taskId);
                    showModal('Delete this personal task?', () => deleteDoc(taskRef));
                };
            });

            document.querySelectorAll('.add-personal-contribution-btn').forEach(btn => btn.onclick = async e => {
                const taskId = e.target.dataset.taskId;
                const input = document.querySelector(`.personal-contribution-input[data-task-id="${taskId}"]`);
                const select = document.querySelector(`.personal-item-select[data-task-id="${taskId}"]`);
                const value = Number(input.value);
                const itemName = select.value;

                if (value > 0 && itemName) {
                    const taskRef = doc(db, `users/${currentUserId}/tasks`, taskId);
                    try {
                        await runTransaction(db, async (transaction) => {
                            const taskDoc = await transaction.get(taskRef);
                            if (!taskDoc.exists()) return;

                            const taskData = taskDoc.data();
                            const newGoalItems = [...taskData.goalItems];
                            const itemIndex = newGoalItems.findIndex(item => item.name === itemName);
                            
                            if (itemIndex > -1) {
                                newGoalItems[itemIndex].progress += value;
                                transaction.update(taskRef, { goalItems: newGoalItems });
                            }
                        });
                        input.value = '';
                    } catch (error) {
                        console.error("Failed to log personal progress:", error);
                        alert("Could not log progress.");
                    }
                }
            });
        }
        // --- FIX END ---
        
        function attachTaskCardListeners() {
            // Shared Task Listeners
            document.querySelectorAll('.task-complete-btn').forEach(el => el.onclick = async e => {
                if (checkPermission('canManageTasks')) {
                    try {
                        await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/tasks`, e.target.dataset.taskId), { completed: true });
                    } catch (error) { console.error("Error completing task:", error); alert("Could not complete task."); }
                }
            });

            if (checkPermission('canManageTasks')) {
                document.querySelectorAll('.delete-task-btn').forEach(btn => btn.onclick = () => {
                    showModal('Delete this task?', () => deleteDoc(doc(db, `team_spaces/${currentTeamSpaceId}/tasks`, btn.dataset.taskId)));
                });
            }
            document.querySelectorAll('.add-contribution-btn').forEach(btn => btn.onclick = async e => {
                const taskId = e.target.dataset.taskId;
                const input = document.querySelector(`.goal-contribution-input[data-task-id="${taskId}"]`);
                const select = document.querySelector(`.goal-item-select[data-task-id="${taskId}"]`);
                const value = Number(input.value);
                const itemName = select.value;

                if (value > 0 && itemName) {
                    await addDoc(collection(db, `team_spaces/${currentTeamSpaceId}/tasks/${taskId}/contributions`), {
                        userId: currentUserId,
                        timestamp: serverTimestamp(),
                        items: { [itemName]: value },
                        status: 'pending'
                    });
                    input.value = '';
                }
            });

            document.querySelectorAll('.verify-contribution-btn').forEach(btn => btn.onclick = async e => {
                const { taskId, contribId } = e.currentTarget.dataset;
                showLoading(true);
                try {
                    const taskRef = doc(db, `team_spaces/${currentTeamSpaceId}/tasks`, taskId);
                    const contribRef = doc(db, `team_spaces/${currentTeamSpaceId}/tasks/${taskId}/contributions`, contribId);

                    await runTransaction(db, async (transaction) => {
                        const taskDoc = await transaction.get(taskRef);
                        const contribDoc = await transaction.get(contribRef);
                        if (!taskDoc.exists() || !contribDoc.exists()) return;

                        const taskData = taskDoc.data();
                        const contribData = contribDoc.data();
                        if (contribData.status === 'verified') return;

                        const newGoalItems = [...taskData.goalItems];
                        Object.entries(contribData.items).forEach(([name, value]) => {
                            const itemIndex = newGoalItems.findIndex(item => item.name === name);
                            if (itemIndex > -1) {
                                newGoalItems[itemIndex].progress += value;
                            }
                        });

                        transaction.update(taskRef, { goalItems: newGoalItems });
                        transaction.update(contribRef, { status: 'verified' });
                    });
                } catch (error) { console.error("Verification failed:", error); alert("Could not verify contribution."); } 
                finally { showLoading(false); }
            });

            document.querySelectorAll('.view-breakdown-btn').forEach(btn => btn.onclick = async e => {
                const taskId = e.target.dataset.taskId;
                const taskRef = doc(db, `team_spaces/${currentTeamSpaceId}/tasks`, taskId);
                const taskSnap = await getDoc(taskRef);
                if (!taskSnap.exists()) return;
                const task = taskSnap.data();

                const contribsQuery = query(collection(db, `team_spaces/${currentTeamSpaceId}/tasks/${taskId}/contributions`));
                const contribsSnap = await getDocs(contribsQuery);
                
                const userTotals = {};
                contribsSnap.docs.forEach(d => {
                    const c = d.data();
                    if (c.status !== 'verified') return;
                    if (!userTotals[c.userId]) userTotals[c.userId] = {};
                    Object.entries(c.items).forEach(([name, value]) => {
                        if (!userTotals[c.userId][name]) userTotals[c.userId][name] = 0;
                        userTotals[c.userId][name] += value;
                    });
                });

                let breakdownHtml = `<div class="space-y-4">`;
                const userIds = Object.keys(userTotals);
                if (userIds.length > 0) {
                    breakdownHtml += `<h4 class="font-bold">Top Contributors</h4>`;
                    const userNames = await Promise.all(userIds.map(getUsername));
                    const sortedContributors = userIds.map((id, index) => ({ id, name: userNames[index], totals: userTotals[id] }))
                        .sort((a, b) => Object.values(b.totals).reduce((s, v) => s + v, 0) - Object.values(a.totals).reduce((s, v) => s + v, 0));

                    sortedContributors.forEach(user => {
                        breakdownHtml += `<div class="p-2 bg-gray-100 rounded"><strong>${user.name}</strong>: ${Object.entries(user.totals).map(([name, val]) => `${val.toLocaleString()} ${name}`).join(', ')}</div>`;
                    });
                } else {
                    breakdownHtml += `<p>No verified contributions for this task.</p>`;
                }
                breakdownHtml += `</div>`;
                showGenericModal(`Breakdown for: ${task.text}`, breakdownHtml, null, 'md');
            });

            // Personal Task Listeners (now handled by its own function)
            attachPersonalTaskCardListeners();
        }
        
        const modalMessage = document.getElementById('confirmation-modal-message');
        const modalConfirmBtn = document.getElementById('confirmation-modal-confirm-btn');
        const modalCancelBtn = document.getElementById('confirmation-modal-cancel-btn');

        function showModal(message, onConfirm) {
            modalMessage.textContent = message;
            confirmationModal.classList.remove('hidden');
            modalConfirmBtn.onclick = () => {
                onConfirm();
                hideModal();
            };
        }
        function hideModal() {
            confirmationModal.classList.add('hidden');
            modalConfirmBtn.onclick = null;
        }
        
        // --- MODIFICATION START: Expanded and Fixed Leaderboard ---
        async function renderLeaderboard(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                     <div class="relative">
                        <input type="text" id="leaderboard-search" placeholder="Search for a player..." class="pl-8 pr-4 py-2 border border-gray-300 rounded-full text-sm w-64">
                        <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <div class="flex rounded-md bg-gray-200 p-1" id="leaderboard-period-selector">
                        <button data-period="day" class="px-3 py-1 text-sm font-semibold rounded-md">Day</button>
                        <button data-period="week" class="px-3 py-1 text-sm font-semibold rounded-md">Week</button>
                        <button data-period="month" class="px-3 py-1 text-sm font-semibold rounded-md">Month</button>
                        <button data-period="all" class="px-3 py-1 text-sm font-semibold rounded-md bg-white text-gray-800">All Time</button>
                    </div>
                </div>
                <div id="leaderboard-content" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow xl:col-span-2">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Team Contribution Breakdown</h3>
                        <div class="relative h-80">
                            <canvas id="leaderboard-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Community Inventory</h3>
                            <button class="text-sm text-blue-600 hover:underline" data-leaderboard-type="inventory">See More</button>
                        </div>
                        <div id="leaderboard-inventory" class="space-y-2 max-h-64 overflow-y-auto pr-2">Loading...</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Overall Top Contributors</h3>
                            <button class="text-sm text-blue-600 hover:underline" data-leaderboard-type="overall">See More</button>
                        </div>
                        <div id="leaderboard-overall" class="space-y-2">Loading...</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Most PokeYen Contributed</h3>
                            <button class="text-sm text-blue-600 hover:underline" data-leaderboard-type="pokeyen">See More</button>
                        </div>
                        <div id="leaderboard-pokeyen" class="space-y-2">Loading...</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Rising Stars</h3>
                        <div id="leaderboard-rising">Loading...</div>
                    </div>
                </div>`;

            const getPokeyenTitle = (rank) => {
                const titles = [
                    "Poké Tycoon",      // Rank 1
                    "GTL Baron",        // Rank 2
                    "Item Magnate",     // Rank 3
                    "Berry Boss",       // Rank 4
                    "Charm Collector"   // Rank 5
                ];
                return titles[rank] || "";
            };

            const processLeaderboardData = async (period = 'all') => {
                document.querySelectorAll('#leaderboard-period-selector button').forEach(b => {
                    b.classList.toggle('bg-white', b.dataset.period === period);
                    b.classList.toggle('text-gray-800', b.dataset.period === period);
                });
                
                const containers = {
                    overall: document.getElementById('leaderboard-overall'),
                    pokeyen: document.getElementById('leaderboard-pokeyen'),
                    inventory: document.getElementById('leaderboard-inventory'),
                    rising: document.getElementById('leaderboard-rising')
                };

                Object.values(containers).forEach(c => { if(c) c.innerHTML = 'Loading...'; });

                showLoading(true);
                try {
                    let startDate = null;
                    const now = new Date();
                    if (period === 'day') {
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    } else if (period === 'week') {
                        startDate = new Date();
                        startDate.setDate(startDate.getDate() - 7);
                    } else if (period === 'month') {
                        startDate = new Date();
                        startDate.setMonth(startDate.getMonth() - 1);
                    }

                    const tasksQuery = query(collection(db, `team_spaces/${currentTeamSpaceId}/tasks`));
                    const tasksSnapshot = await getDocs(tasksQuery);

                    let allContributions = [];
                    const contributionPromises = tasksSnapshot.docs.map(taskDoc => {
                        const contribsQuery = query(collection(db, `team_spaces/${currentTeamSpaceId}/tasks/${taskDoc.id}/contributions`), where("status", "==", "verified"));
                        return getDocs(contribsQuery);
                    });
                    
                    const allContributionsSnapshots = await Promise.all(contributionPromises);
                    
                    let filteredContributions = [];
                    allContributionsSnapshots.forEach(snapshot => {
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (startDate) {
                                if (data.timestamp && data.timestamp.toDate() >= startDate) {
                                    filteredContributions.push(data);
                                }
                            } else {
                                filteredContributions.push(data);
                            }
                        });
                    });
                    
                    // --- Full Data for Modals ---
                    const fullData = {};

                    // Process Overall
                    const overallScores = filteredContributions.reduce((acc, c) => { acc[c.userId] = (acc[c.userId] || 0) + 1; return acc; }, {});
                    fullData.overall = Object.entries(overallScores).sort((a, b) => b[1] - a[1]);
                    containers.overall.innerHTML = (await Promise.all(fullData.overall.slice(0, 5).map(async ([userId, score], index) => {
                        const username = await getUsername(userId);
                        return `<div data-user-id="${userId}" data-user-name="${username.toLowerCase()}" class="leaderboard-item flex justify-between items-center p-2 rounded-md transition-all ${index === 0 ? 'bg-yellow-100' : ''}"><span class="font-semibold">${index+1}. ${username}</span><span class="font-bold text-teal-600">${score.toLocaleString()} contributions</span></div>`
                    }))).join('') || '<p class="text-gray-500">No data.</p>';

                    // Process PokeYen
                    const pokeyenScores = filteredContributions.reduce((acc, c) => {
                        const yen = c.items?.PokeYen || 0;
                        if (yen > 0) { acc[c.userId] = (acc[c.userId] || 0) + yen; }
                        return acc;
                    }, {});
                    fullData.pokeyen = Object.entries(pokeyenScores).sort((a, b) => b[1] - a[1]);
                    containers.pokeyen.innerHTML = (await Promise.all(fullData.pokeyen.slice(0, 5).map(async ([userId, score], index) => {
                        const username = await getUsername(userId);
                        const title = getPokeyenTitle(index);
                        const titleColor = ['text-yellow-500', 'text-gray-400', 'text-orange-400', 'text-green-500', 'text-blue-500'][index] || 'text-gray-500';
                        return `<div data-user-id="${userId}" data-user-name="${username.toLowerCase()}" class="leaderboard-item flex justify-between items-center p-2 rounded-md transition-all"><span class="font-semibold">${index+1}. ${username} - <em class="font-bold ${titleColor}">${title}</em></span><span class="font-bold text-yellow-600">${score.toLocaleString()} ¥</span></div>`
                    }))).join('') || '<p class="text-gray-500">No PokeYen data.</p>';

                    // Process Community Inventory
                    const inventory = filteredContributions.reduce((acc, c) => {
                        Object.entries(c.items || {}).forEach(([item, qty]) => { acc[item] = (acc[item] || 0) + qty; });
                        return acc;
                    }, {});
                    fullData.inventory = Object.entries(inventory).sort((a, b) => b[1] - a[1]);
                    containers.inventory.innerHTML = fullData.inventory.slice(0, 10).map(([item, qty]) => `<div class="flex justify-between text-sm p-1"><span class="text-gray-600">${item}</span><span class="font-semibold">${qty.toLocaleString()}</span></div>`).join('') || '<p class="text-gray-500">No items contributed.</p>';
                    
                    // Process Rising Stars
                    containers.rising.innerHTML = '<p class="text-gray-500">Feature under development.</p>';
                    
                    // Render Chart
                    renderLeaderboardCharts(inventory);

                    // Attach "See More" listeners
                    document.querySelectorAll('[data-leaderboard-type]').forEach(btn => {
                        btn.onclick = () => showLeaderboardDetailModal(btn.dataset.leaderboardType, fullData);
                    });

                } catch (error) {
                    console.error("Error building leaderboard:", error);
                    const contentContainer = document.getElementById('leaderboard-content');
                    if (contentContainer) {
                       contentContainer.innerHTML = '<p class="text-red-500 col-span-full">Could not load leaderboard data. This may be due to a missing database index.</p>';
                    }
                } finally {
                    showLoading(false);
                }
            };
            
            document.getElementById('leaderboard-period-selector').onclick = (e) => {
                if(e.target.tagName === 'BUTTON') {
                    processLeaderboardData(e.target.dataset.period);
                }
            };

            document.getElementById('leaderboard-search').oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.leaderboard-item').forEach(item => {
                    const userName = item.dataset.userName;
                    if (searchTerm && userName.includes(searchTerm)) {
                        item.classList.add('bg-yellow-200', 'ring-2', 'ring-yellow-500');
                    } else {
                        item.classList.remove('bg-yellow-200', 'ring-2', 'ring-yellow-500');
                    }
                });
            };

            processLeaderboardData('all');
        }

        function renderLeaderboardCharts(inventoryData) {
            const ctx = document.getElementById('leaderboard-chart')?.getContext('2d');
            if (!ctx) return;
            if (leaderboardChart) {
                leaderboardChart.destroy();
            }

            const otherCategoryThreshold = 0.03; // Items making up less than 3% of total go into "Other"
            const totalItems = Object.values(inventoryData).reduce((sum, val) => sum + val, 0);
            
            const chartData = { labels: [], data: [] };
            let otherValue = 0;

            Object.entries(inventoryData).forEach(([item, qty]) => {
                if ((qty / totalItems) < otherCategoryThreshold) {
                    otherValue += qty;
                } else {
                    chartData.labels.push(item);
                    chartData.data.push(qty);
                }
            });

            if (otherValue > 0) {
                chartData.labels.push('Other Items');
                chartData.data.push(otherValue);
            }

            leaderboardChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Contribution Count',
                        data: chartData.data,
                        backgroundColor: [
                            '#10B981', '#3B82F6', '#EC4899', '#F59E0B', '#8B5CF6',
                            '#6366F1', '#D946EF', '#0EA5E9', '#F43F5E', '#6B7280'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        async function showLeaderboardDetailModal(type, fullData) {
            let title = '';
            let data = [];
            let formatter = async (item, index) => '';

            if (type === 'overall') {
                title = 'Overall Top Contributors (All)';
                data = fullData.overall;
                formatter = async ([userId, score], index) => `<div class="leaderboard-modal-item flex justify-between items-center p-2" data-user-name="${(await getUsername(userId)).toLowerCase()}"><span class="font-semibold">${index+1}. ${await getUsername(userId)}</span><span class="font-bold text-teal-600">${score.toLocaleString()} contributions</span></div>`;
            } else if (type === 'pokeyen') {
                title = 'Most PokeYen Contributed (All)';
                data = fullData.pokeyen;
                formatter = async ([userId, score], index) => `<div class="leaderboard-modal-item flex justify-between items-center p-2" data-user-name="${(await getUsername(userId)).toLowerCase()}"><span class="font-semibold">${index+1}. ${await getUsername(userId)}</span><span class="font-bold text-yellow-600">${score.toLocaleString()} ¥</span></div>`;
            } else if (type === 'inventory') {
                title = 'Community Inventory (All)';
                data = fullData.inventory;
                formatter = async ([item, qty], index) => `<div class="leaderboard-modal-item flex justify-between items-center p-2" data-user-name="${item.toLowerCase()}"><span class="font-semibold">${item}</span><span class="font-bold">${qty.toLocaleString()}</span></div>`;
            }
            
            const listHtml = (await Promise.all(data.map(formatter))).join('');

            const modalContent = `
                <div class="relative mb-4">
                    <input type="text" id="leaderboard-modal-search" placeholder="Search..." class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-full text-sm">
                    <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <div class="space-y-1 max-h-[50vh] overflow-y-auto pr-2" id="leaderboard-modal-list">
                    ${listHtml}
                </div>
            `;
            
            showGenericModal(title, modalContent, null, '2xl');

            document.getElementById('leaderboard-modal-search').oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.leaderboard-modal-item').forEach(item => {
                    const name = item.dataset.userName;
                    item.style.display = name.includes(searchTerm) ? 'flex' : 'none';
                });
            };
        }
        // --- MODIFICATION END ---
        
        function renderBreedingProjects() { 
            mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">Breeding Projects</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        function renderShinyHunts() {
            mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">Shiny Hunts</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        function renderPokedex() {
             mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">Pokédex & Builds</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        function renderEvHotspots() {
             mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">EV Hotspots</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        function renderMoneyGuide() {
             mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">Money Guide</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        async function renderAdminPanel() {
            if (!['Superadmin', 'Admin'].includes(currentUserRole)) { 
                mainContent.innerHTML = `<p class="text-red-500">Access Denied.</p>`; 
                return; 
            }
            mainContent.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Admin Panel</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">User Role Management</h3>
                        <div id="user-roles-container" class="space-y-3">Loading...</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">Player Team Permission Settings</h3>
                        <div id="permissions-container" class="space-y-4"></div>
                        <button id="save-perms-btn" class="mt-6 w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600">Save Permissions</button>
                    </div>
                    ${currentUserRole === 'Superadmin' ? `
                    <div class="bg-white p-6 rounded-lg shadow lg:col-span-2">
                        <h3 class="text-xl font-bold mb-4 text-red-600">Superadmin Controls</h3>
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold">Official Team Space</h4>
                                <p class="text-sm text-gray-600 mb-2">Mark the current Team Space (${currentTeamSpaceId}) as the official one for all users.</p>
                                <button id="mark-official-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg">Mark as Official</button>
                            </div>
                            <div class="border-t pt-4">
                                <h4 class="font-semibold">Rename Current Team Space ID</h4>
                                <p class="text-sm text-gray-600 mb-2">This is a complex operation. Change '${currentTeamSpaceId}' to a new custom ID. All data will be migrated.</p>
                                <div class="flex gap-2">
                                    <input type="text" id="new-team-space-id-input" placeholder="New ID (e.g., ExCorp)" class="flex-grow p-2 border rounded-lg">
                                    <button id="rename-team-space-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Rename</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>`;
            
            const allUsersQuery = query(collection(db, "users"));
            const allUsersSnapshot = await getDocs(allUsersQuery);
            const allUsers = allUsersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

            const usersContainer = document.getElementById('user-roles-container');
            if(usersContainer) {
                usersContainer.innerHTML = allUsers.map(user => {
                    if (user.id === SUPERADMIN_UID) return `<div class="flex justify-between items-center"><p>${user.username} <span class="text-xs font-bold text-yellow-500">Superadmin</span></p></div>`;
                    return `<div class="flex justify-between items-center"><p>${user.username}</p><select data-uid="${user.id}" class="role-selector p-1 border rounded"><option value="Member" ${user.role === 'Member' ? 'selected' : ''}>Member</option><option value="Staff" ${user.role === 'Staff' ? 'selected' : ''}>Staff</option><option value="Admin" ${user.role === 'Admin' ? 'selected' : ''}>Admin</option></select></div>`;
                }).join('');
                document.querySelectorAll('.role-selector').forEach(sel => { sel.onchange = async (e) => await updateDoc(doc(db, "users", e.target.dataset.uid), { role: e.target.value }); });
            }
            
            const permsContainer = document.getElementById('permissions-container');
            const rolesToManage = ['Admin', 'Staff', 'Member'];
            const actions = { 
                canManagePokemonTeams: "Manage Pokémon Teams", 
                canManageProjects: "Manage Projects", 
                canManageTasks: "Manage Shared Tasks", 
                canEditResources: "Edit Resources", 
                canMarkStaffPick: "Mark Staff Picks",
                canCreatePublicTeams: "Create Public Pokémon Teams",
                canVoteOnTeams: "Upvote/Downvote Pokémon Teams",
                canVerifyContributions: "Verify Task Contributions",
                canDeletePublicTeams: "Delete Public Pokémon Teams"
            };
            if(permsContainer) {
                permsContainer.innerHTML = rolesToManage.map(role => `
                    <div class="border p-4 rounded-lg">
                        <h4 class="font-bold text-lg">${role}</h4>
                        <div class="space-y-2 mt-2">
                            ${Object.entries(actions).map(([key, label]) => `
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" data-role="${role}" data-action="${key}" class="perm-checkbox h-4 w-4" ${teamSpacePermissions[role]?.[key] === true ? 'checked' : ''}> ${label}
                                </label>`).join('')}
                        </div>
                    </div>`).join('');
            }
            
            const savePermsBtn = document.getElementById('save-perms-btn');
            if(savePermsBtn) {
                savePermsBtn.onclick = async () => {
                    showLoading(true);
                    const newPermissions = JSON.parse(JSON.stringify(teamSpacePermissions));
                    document.querySelectorAll('.perm-checkbox').forEach(box => {
                        const { role, action } = box.dataset;
                        if (!newPermissions[role]) newPermissions[role] = {};
                        newPermissions[role][action] = box.checked;
                    });

                    try {
                        const teamSpaceDoc = doc(db, "team_spaces", currentTeamSpaceId);
                        await updateDoc(teamSpaceDoc, { permissions: newPermissions });
                        alert("Permissions saved successfully! The view will now update based on the new data from Firebase.");
                    } catch (error) {
                        alert("Error saving permissions: " + error.message);
                        console.error("Permissions save error:", error);
                    } finally {
                        showLoading(false);
                    }
                };
            }

            if (currentUserRole === 'Superadmin') {
                document.getElementById('mark-official-btn').onclick = async () => {
                    if (confirm(`Are you sure you want to mark "${currentTeamSpaceId}" as the official Team Space?`)) {
                        const teamSnap = await getDoc(doc(db, "team_spaces", currentTeamSpaceId));
                        const teamName = teamSnap.exists() ? teamSnap.data().name || currentTeamSpaceId : currentTeamSpaceId;
                        await setDoc(doc(db, "system_settings", "official_team_space"), {
                            id: currentTeamSpaceId,
                            name: teamName
                        });
                        alert("Official Team Space has been set.");
                    }
                };
                document.getElementById('rename-team-space-btn').onclick = async () => {
                    const newId = document.getElementById('new-team-space-id-input').value.trim();
                    if (newId && newId !== currentTeamSpaceId) {
                        if (confirm(`This is a major action. Are you sure you want to rename '${currentTeamSpaceId}' to '${newId}'?`)) {
                            await renameTeamSpace(currentTeamSpaceId, newId);
                        }
                    } else {
                        alert("Please enter a new, valid ID.");
                    }
                };
            }
        }

        async function renameTeamSpace(oldId, newId) {
            showLoading(true);
            try {
                const newDocRef = doc(db, "team_spaces", newId);
                const newDocSnap = await getDoc(newDocRef);
                if (newDocSnap.exists()) {
                    throw new Error(`Team Space with ID "${newId}" already exists.`);
                }

                await runTransaction(db, async (transaction) => {
                    const oldDocRef = doc(db, "team_spaces", oldId);
                    const oldDocSnap = await transaction.get(oldDocRef);
                    if (!oldDocSnap.exists()) {
                        throw new Error("Original document not found.");
                    }
                    transaction.set(newDocRef, oldDocSnap.data());
                    transaction.delete(oldDocRef);
                });

                const subcollections = ['pokemon_teams', 'tasks', 'breeding', 'hunts', 'resources'];
                for (const sub of subcollections) {
                    const oldSubCollectionRef = collection(db, `team_spaces/${oldId}/${sub}`);
                    const snapshot = await getDocs(oldSubCollectionRef);
                    for (const d of snapshot.docs) {
                        const oldDocRef = doc(db, `team_spaces/${oldId}/${sub}`, d.id);
                        const newDocRef = doc(db, `team_spaces/${newId}/${sub}`, d.id);
                        await setDoc(newDocRef, d.data());
                        
                        const nestedSubs = ['contributions'];
                        for (const nested of nestedSubs) {
                            const oldNestedRef = collection(oldDocRef, nested);
                            const nestedSnapshot = await getDocs(oldNestedRef);
                            for (const nestedDoc of nestedSnapshot.docs) {
                                await setDoc(doc(newDocRef, nested, nestedDoc.id), nestedDoc.data());
                                await deleteDoc(doc(oldDocRef, nested, nestedDoc.id));
                            }
                        }
                        await deleteDoc(oldDocRef);
                    }
                }
                
                const officialTeamRef = doc(db, "system_settings", "official_team_space");
                const officialTeamSnap = await getDoc(officialTeamRef);
                if (officialTeamSnap.exists() && officialTeamSnap.data().id === oldId) {
                    await updateDoc(officialTeamRef, { id: newId });
                }

                alert(`Team Space successfully renamed to ${newId}. The page will now reload.`);
                localStorage.setItem('currentTeamSpaceId', newId);
                location.reload();

            } catch (error) {
                console.error("Error renaming Team Space:", error);
                alert("Failed to rename Team Space: " + error.message);
            } finally {
                showLoading(false);
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeDOMElements();
            
            onAuthStateChanged(auth, async (user) => {
                try {
                    showLoading(true);
                    if (user) {
                        currentUserId = user.uid;
                        const userRef = doc(db, "users", currentUserId);
                        const userSnap = await getDoc(userRef);
                        if (userSnap.exists()) {
                            const userData = userSnap.data();
                            currentUsername = userData.username;
                            currentUserRole = user.uid === SUPERADMIN_UID ? 'Superadmin' : userData.role;
                            if (user.uid === SUPERADMIN_UID && userData.role !== 'Superadmin') {
                                await updateDoc(userRef, { role: 'Superadmin' });
                            }
                            userProfileDisplay.textContent = `${currentUsername} (${currentUserRole})`;
                            document.getElementById('admin-panel-btn').style.display = ['Superadmin', 'Admin'].includes(currentUserRole) ? 'block' : 'none';
                            authContainer.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                            
                            await setupTeamSpace(currentUserId);
                            
                            await renderOfficialTeamSpaceButton();
                            switchView('dashboard');

                        } else { await signOut(auth); }
                    } else {
                        authContainer.classList.remove('hidden');
                        appContainer.classList.add('hidden');
                    }
                } catch (error) { console.error("Authentication Error:", error); } 
                finally { showLoading(false); }
            });

            document.getElementById('login-form').onsubmit = async (e) => { e.preventDefault(); showLoading(true); const email = e.target.email.value; const password = e.target.password.value; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { alert(error.message); } finally { showLoading(false); } };
            
            document.getElementById('signup-form').onsubmit = async (e) => {
                e.preventDefault(); showLoading(true); const email = e.target.signup_email.value; const password = e.target.signup_password.value; const username = e.target.signup_username.value;
                if (password.length < 6) { alert("Password must be at least 6 characters."); showLoading(false); return; }
                if (username.length < 3) { alert("Username must be at least 3 characters."); showLoading(false); return; }
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password); const user = userCredential.user;
                    let role = user.uid === SUPERADMIN_UID ? 'Superadmin' : 'Member';
                    await setDoc(doc(db, "users", user.uid), { username, email, role });
                } catch (error) { alert(error.message); } finally { showLoading(false); }
            };
            
            logoutBtn.onclick = () => signOut(auth);
            document.querySelectorAll('.nav-button').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
            changeTeamSpaceBtn.addEventListener('click', () => { const newTeamSpaceId = teamSpaceIdInput.value.trim(); if (newTeamSpaceId && newTeamSpaceId !== currentTeamSpaceId) { localStorage.setItem('currentTeamSpaceId', newTeamSpaceId); location.reload(); } });
            createTeamSpaceBtn.addEventListener('click', () => { 
                const randomId = `team-${Math.random().toString(36).substring(2, 9)}`;
                localStorage.setItem('currentTeamSpaceId', randomId);
                location.reload();
            });
            modalCancelBtn.addEventListener('click', hideModal);
        });

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tasks-tab-btn.active, .teams-filter-btn.active { color: #0d9488; border-color: #0d9488; }
        .modal-dialog { transition: all 0.3s ease-out; }
        #app-container > .flex {
            min-height: 100vh;
        }
        aside {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        aside nav {
            flex-grow: 1;
        }
        .sidebar-bottom {
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-teal-500"></div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container">
        <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-4xl w-full grid md:grid-cols-2 gap-8 p-8">
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">Login</h2>
                    <form id="login-form" class="space-y-4">
                        <input type="email" name="email" placeholder="Email" class="w-full p-3 border rounded-lg" required>
                        <input type="password" name="password" placeholder="Password" class="w-full p-3 border rounded-lg" required>
                        <button type="submit" class="w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600">Login</button>
                    </form>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">Sign Up</h2>
                    <form id="signup-form" class="space-y-4">
                        <input type="text" name="signup_username" placeholder="Username" class="w-full p-3 border rounded-lg" required>
                        <input type="email" name="signup_email" placeholder="Email" class="w-full p-3 border rounded-lg" required>
                        <input type="password" name="signup_password" placeholder="Password" class="w-full p-3 border rounded-lg" required>
                        <p class="text-xs text-red-600 text-center">Warning: For your security, do NOT use the same password as your PokeMMO game account.</p>
                        <button type="submit" class="w-full bg-gray-700 text-white p-3 rounded-lg font-bold hover:bg-gray-800">Create Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden">
        <!-- Generic Modal -->
        <div id="generic-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full z-50 flex items-center justify-center">
            <div class="modal-dialog bg-white p-8 rounded-lg shadow-xl w-full mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="generic-modal-title" class="text-2xl font-bold">Modal Title</h3>
                    <button id="generic-modal-close-btn" class="text-gray-500 hover:text-gray-800 font-bold text-2xl">&times;</button>
                </div>
                <div id="generic-modal-content" class="max-h-[60vh] overflow-y-auto"></div>
            </div>
        </div>
        
        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full z-50 flex items-center justify-center">
           <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <p id="confirmation-modal-message" class="text-xl mb-6 text-center"></p>
            <div class="flex justify-center gap-4">
             <button id="confirmation-modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
             <button id="confirmation-modal-confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Confirm</button>
            </div>
           </div>
        </div>

        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside class="w-64 bg-white shadow-md flex flex-col">
                <div class="p-6 text-center border-b">
                    <h1 class="text-2xl font-bold text-teal-700">Player Team Hub</h1>
                </div>
                <nav class="flex-grow p-4 space-y-2">
                    <button data-view="dashboard" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Dashboard</button>
                    <button data-view="pokemon-teams" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Pokémon Team Locker</button>
                    <button data-view="tasks" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Task Board</button>
                    <button data-view="breeding" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Breeding Projects</button>
                    <button data-view="hunts" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Shiny Hunts</button>
                    <button data-view="pokedex" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Pokédex & Builds</button>
                    <button data-view="ev-hotspots" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">EV Hotspots</button>
                    <button data-view="money-guide" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Money Guide</button>
                    <button data-view="admin-panel" id="admin-panel-btn" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition" style="display: none;">Admin Panel</button>
                </nav>
                <div class="sidebar-bottom p-4 border-t space-y-3">
                    <div id="user-profile-display" class="text-sm text-center text-gray-600 font-semibold"></div>
                    <button id="logout-btn" class="w-full text-sm text-red-500 hover:underline">Logout</button>
                    
                    <!-- Official Team Space Section -->
                    <div id="official-team-space-container" class="border-t pt-3"></div>

                    <div class="border-t pt-3">
                        <h4 class="font-bold mb-2">My Team Spaces</h4>
                        <p class="text-sm text-gray-600 mb-2">Your current Team ID is:</p>
                        <p id="team-space-id-display" class="bg-gray-100 p-2 rounded text-center font-mono break-words"></p>
                        <input id="team-space-id-input" type="text" placeholder="Enter Team ID to join" class="w-full p-2 border rounded mt-3">
                        <button id="change-team-space-btn" class="w-full bg-teal-500 text-white p-2 rounded mt-2 hover:bg-teal-600">Join Team Space</button>
                        <button id="create-team-space-btn" class="w-full text-sm text-gray-500 mt-2 hover:underline">Create a New Private Space</button>
                    </div>
                </div>
            </aside>
            <!-- Main Content -->
            <main class="flex-1 p-8 overflow-y-auto bg-gray-100">
                <div id="main-content">
                    <!-- Dynamic Content Rendered Here -->
                </div>
            </main>
        </div>
    </div>
</body>
</html>