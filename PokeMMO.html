<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokeMMO Player Team Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase App (the core)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, arrayRemove, arrayUnion, query, orderBy, writeBatch, serverTimestamp, increment, runTransaction, getDocs, Timestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Your web app's Firebase configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDsacPQOqciPdM5SLHMh0muDH9GXswnyU0",
            authDomain: "pokemmo-team.firebaseapp.com",
            projectId: "pokemmo-team",
            storageBucket: "pokemmo-team.appspot.com",
            messagingSenderId: "538474033829",
            appId: "1:538474033829:web:26b62ba96efa1901ead34c",
            measurementId: "G-HWFL88XH7H"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- App State ---
        let currentUserId = null;
        let currentUsername = null;
        let currentUserRole = 'Guest';
        let currentTeamSpaceId = null;
        let teamSpacePermissions = {};
        let unsubscribeListeners = [];
        const usernameCache = {};
        const SUPERADMIN_UID = "G9MP7oe0cTQsu92SEXB6wqy1nQs1";

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const teamSpaceIdDisplay = document.getElementById('team-space-id-display');
        const teamSpaceIdInput = document.getElementById('team-space-id-input');
        const changeTeamSpaceBtn = document.getElementById('change-team-space-btn');
        const createTeamSpaceBtn = document.getElementById('create-team-space-btn');
        const mainContent = document.getElementById('main-content');
        const loadingOverlay = document.getElementById('loading-overlay');
        const navButtons = document.querySelectorAll('.nav-button');
        const userProfileDisplay = document.getElementById('user-profile-display');
        const logoutBtn = document.getElementById('logout-btn');
        const genericModal = document.getElementById('generic-modal');
        const genericModalTitle = document.getElementById('generic-modal-title');
        const genericModalContent = document.getElementById('generic-modal-content');
        const genericModalCloseBtn = document.getElementById('generic-modal-close-btn');
        const officialTeamSpaceContainer = document.getElementById('official-team-space-container');

        // --- Core Functions ---
        function showLoading(show) { loadingOverlay.style.display = show ? 'flex' : 'none'; }
        
        function showGenericModal(title, content, formSubmitHandler = null, size = '2xl') {
            const modalDialog = genericModal.querySelector('.modal-dialog');
            modalDialog.classList.remove('max-w-md', 'max-w-2xl', 'max-w-4xl');
            modalDialog.classList.add(`max-w-${size}`);
            genericModalTitle.textContent = title;
            genericModalContent.innerHTML = content;
            genericModal.classList.remove('hidden');
            const form = genericModalContent.querySelector('form');
            if (form) {
                form.onsubmit = (e) => {
                    e.preventDefault();
                    if(formSubmitHandler) formSubmitHandler(e);
                    hideGenericModal();
                };
            }
        }
        
        function hideGenericModal() {
            genericModal.classList.add('hidden');
        }
        
        genericModalCloseBtn.addEventListener('click', hideGenericModal);

        function checkPermission(action) {
            if (currentUserRole === 'Superadmin') return true;
            return teamSpacePermissions[currentUserRole]?.[action] === true;
        }

        async function getUsername(userId) {
            if (!userId) return "Unknown";
            if (usernameCache[userId]) return usernameCache[userId];
            try {
                const userRef = doc(db, "users", userId);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) { const username = userSnap.data().username; usernameCache[userId] = username; return username; }
            } catch (error) { console.error("Error fetching username:", error); }
            return "Anonymous";
        }
        
        async function seedDefaultResources(teamSpaceId) {
            const batch = writeBatch(db);
            const pokedexRef = doc(db, `team_spaces/${teamSpaceId}/resources/pokedex`);
            const moneyRef = doc(db, `team_spaces/${teamSpaceId}/resources/moneyGuide`);
            const evRef = doc(db, `team_spaces/${teamSpaceId}/resources/evHotspots`);
            batch.set(pokedexRef, { entries: { "Garchomp": { name: "Garchomp", stats: "108/130/95/80/85/102", abilities: "Sand Veil, Rough Skin (HA)", builds: [{ name: "Swords Dance", nature: "Jolly", evs: "252 Atk / 4 SpD / 252 Spe", moves: "Swords Dance, Earthquake, Outrage"}] } }});
            batch.set(moneyRef, { entries: [ { id: "gym_reruns", name: 'Gym Rebattles', details: 'Most consistent endgame income.', potential: 'High (~400k/hr)' } ]});
            batch.set(evRef, { entries: [ { id: "hp_marill", stat: 'HP', pokemon: 'Marill (x5)', location: 'Route 114, Hoenn (Surf)', yield: '10' } ]});
            await batch.commit();
        }

        function switchView(viewName) {
            navButtons.forEach(btn => btn.classList.remove('bg-teal-600', 'text-white'));
            const button = document.querySelector(`.nav-button[data-view="${viewName}"]`);
            if (button) button.classList.add('bg-teal-600', 'text-white');
            mainContent.innerHTML = '';
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            const viewRenderers = { 
                'dashboard': renderDashboard, 
                'pokemon-teams': renderPokemonTeams, 
                'tasks': renderTasks, 
                'breeding': renderBreedingProjects, 
                'hunts': renderShinyHunts, 
                'pokedex': renderPokedex, 
                'ev-hotspots': renderEvHotspots, 
                'money-guide': renderMoneyGuide, 
                'admin-panel': renderAdminPanel 
            };
            if (viewRenderers[viewName]) viewRenderers[viewName]();
        }

        async function setupTeamSpace(userId) {
            let teamSpaceId = localStorage.getItem('currentTeamSpaceId');
            
            if (!teamSpaceId) {
                teamSpaceId = "ExCorp";
                localStorage.setItem('currentTeamSpaceId', teamSpaceId);
            }
            
            const teamSpaceRef = doc(db, "team_spaces", teamSpaceId);
            const teamSpaceSnap = await getDoc(teamSpaceRef);

            if (!teamSpaceSnap.exists()) {
                await setDoc(teamSpaceRef, {
                    owner: userId,
                    name: teamSpaceId === "ExCorp" ? "ExCorp Main Team" : "New Team Space",
                    members: [userId],
                    createdAt: serverTimestamp(),
                    permissions: {
                        Admin: { canManagePokemonTeams: true, canManageTasks: true, canManageProjects: true, canEditResources: true, canMarkStaffPick: true, canCreatePublicTeams: true, canVoteOnTeams: true, canVerifyContributions: true, canDeletePublicTeams: true },
                        Staff: { canManageTasks: true, canManageProjects: true, canMarkStaffPick: true, canCreatePublicTeams: true, canVoteOnTeams: true, canVerifyContributions: true, canDeletePublicTeams: false },
                        Member: { canCreatePublicTeams: true, canVoteOnTeams: true }
                    }
                });
                if (teamSpaceId === "ExCorp") {
                    await seedDefaultResources(teamSpaceId);
                }
            }
            
            currentTeamSpaceId = teamSpaceId;
            teamSpaceIdDisplay.textContent = currentTeamSpaceId;
            teamSpaceIdInput.value = currentTeamSpaceId;
            
            const unsub = onSnapshot(teamSpaceRef, async (snap) => {
                if(snap.exists()) {
                    teamSpacePermissions = snap.data().permissions || {};
                    if(!snap.data().members?.includes(userId)) {
                        await updateDoc(teamSpaceRef, { members: arrayUnion(userId) });
                    }
                } else {
                    alert(`Team Space with ID "${currentTeamSpaceId}" not found. You can create a new one.`);
                    localStorage.removeItem('currentTeamSpaceId');
                }
            });
            unsubscribeListeners.push(unsub);
            switchView('dashboard');
        }

        async function renderOfficialTeamSpaceButton() {
            const settingsRef = doc(db, "system_settings", "official_team_space");
            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    const { id, name } = docSnap.data();
                    officialTeamSpaceContainer.innerHTML = `
                        <h4 class="font-bold mb-2">Official Team Space</h4>
                        <button id="join-official-team-btn" data-id="${id}" class="w-full bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600 font-bold">
                            Join ${name}
                        </button>`;
                    document.getElementById('join-official-team-btn').onclick = (e) => {
                        const officialId = e.currentTarget.dataset.id;
                        if (officialId !== currentTeamSpaceId) {
                            localStorage.setItem('currentTeamSpaceId', officialId);
                            location.reload();
                        }
                    };
                } else {
                    officialTeamSpaceContainer.innerHTML = '';
                }
            });
        }


        // --- Render Functions ---
        async function renderDashboard() {
            mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800 mb-6">Player Team Dashboard</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-xl mb-3">Active Breeding Projects</h3><div id="dashboard-breeding" class="space-y-2"></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-xl mb-3">Active Shiny Hunts</h3><div id="dashboard-hunts" class="space-y-2"></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-xl mb-3">Player Team Members</h3><div id="dashboard-members" class="space-y-2"></div></div></div>`;
            const renderList = async (q, containerId, formatter) => {
                const unsub = onSnapshot(q, async (snapshot) => {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    container.innerHTML = snapshot.empty ? `<p class="text-gray-500">Nothing here yet.</p>` : (await Promise.all(snapshot.docs.map(doc => formatter(doc.data(), doc.id)))).join('');
                });
                unsubscribeListeners.push(unsub);
            };
            await renderList(query(collection(db, `team_spaces/${currentTeamSpaceId}/breeding`), orderBy("createdAt", "desc")), 'dashboard-breeding', async (data) => `<p>${data.targetPokemon} <span class="text-xs text-gray-400">by ${await getUsername(data.createdBy)}</span></p>`);
            await renderList(query(collection(db, `team_spaces/${currentTeamSpaceId}/hunts`), orderBy("createdAt", "desc")), 'dashboard-hunts', async (data) => `<div class="flex justify-between"><span>${data.target} <span class="text-xs text-gray-400">by ${await getUsername(data.createdBy)}</span></span><span class="font-mono font-bold">${(data.count || 0).toLocaleString()}</span></div>`);
            
            const teamSpaceUnsub = onSnapshot(doc(db, "team_spaces", currentTeamSpaceId), async (teamSpaceSnap) => {
                const membersContainer = document.getElementById('dashboard-members');
                if (!membersContainer || !teamSpaceSnap.exists()) return;
                const memberIds = teamSpaceSnap.data().members || [];
                const memberNames = await Promise.all(memberIds.map(id => getUsername(id)));
                
                let membersHtml = memberNames.slice(0, 5).map(name => `<p class="text-gray-700">${name}</p>`).join('');
                if (memberNames.length > 5) {
                    membersHtml += `<button id="see-all-members-btn" class="text-sm text-teal-600 hover:underline mt-2">See all ${memberNames.length} members...</button>`;
                }
                membersContainer.innerHTML = membersHtml;

                if (memberNames.length > 5) {
                    document.getElementById('see-all-members-btn').onclick = () => {
                        const allMembersHtml = `<div class="grid grid-cols-2 md:grid-cols-3 gap-4">${memberNames.map(name => `<p class="p-2 bg-gray-100 rounded">${name}</p>`).join('')}</div>`;
                        showGenericModal('All Team Members', allMembersHtml, null, '4xl');
                    };
                }
            });
            unsubscribeListeners.push(teamSpaceUnsub);
        }

        // --- POKEMON TEAMS MODULE ---
        function renderPokemonTeams() {
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Pokémon Team Locker</h2>
                    <div class="flex gap-4">
                        <button id="add-pokemon-team-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">New Pokémon Team</button>
                    </div>
                </div>
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex space-x-4" id="teams-filter-nav">
                        <button data-filter="all" class="teams-filter-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:text-teal-600 hover:border-teal-600 active">All Teams</button>
                        <button data-filter="staff" class="teams-filter-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:text-teal-600 hover:border-teal-600">Staff Picks</button>
                        <button data-filter="public" class="teams-filter-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:text-teal-600 hover:border-teal-600">Public Teams</button>
                        <button data-filter="personal" class="teams-filter-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent hover:text-teal-600 hover:border-teal-600">My Teams</button>
                    </nav>
                </div>
                <div id="pokemon-teams-container" class="space-y-6"></div>`;

            let currentFilter = 'all';
            const q = query(collection(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`), orderBy("createdAt", "desc"));

            const renderFilteredTeams = (snapshot) => {
                const container = document.getElementById('pokemon-teams-container');
                if (!container) return;
                let teams = snapshot.docs;
                if (currentFilter === 'staff') teams = teams.filter(t => t.data().isStaffPick);
                else if (currentFilter === 'public') teams = teams.filter(t => t.data().isPublic);
                else if (currentFilter === 'personal') teams = teams.filter(t => t.data().createdBy === currentUserId);
                
                if(teams.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center mt-8">No Pokémon teams match the filter.</p>`;
                    return;
                }
                Promise.all(teams.map(renderPokemonTeamCard)).then(html => {
                    container.innerHTML = html.join('');
                    attachPokemonTeamCardListeners();
                });
            };

            const unsub = onSnapshot(q, renderFilteredTeams);
            unsubscribeListeners.push(unsub);

            document.querySelectorAll('.teams-filter-btn').forEach(btn => btn.onclick = (e) => {
                document.querySelectorAll('.teams-filter-btn').forEach(b => b.classList.remove('active', 'text-teal-600', 'border-teal-600'));
                e.target.classList.add('active', 'text-teal-600', 'border-teal-600');
                currentFilter = e.target.dataset.filter;
                onSnapshot(q, renderFilteredTeams);
            });

            document.getElementById('add-pokemon-team-btn').onclick = () => {
                let formHtml = `
                    <form class="space-y-4">
                        <input type="text" name="name" placeholder="Team Name" class="w-full p-2 border rounded-lg" required>
                        <input type="text" name="purpose" placeholder="Purpose (e.g., Hoenn E4, Kanto Story)" class="w-full p-2 border rounded-lg">`;
                if(checkPermission('canCreatePublicTeams')) {
                    formHtml += `<label class="flex items-center gap-2"><input type="checkbox" name="isPublic"> Make Public</label>`;
                }
                formHtml += `<button type="submit" class="w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600">Create Team</button></form>`;
                
                showGenericModal('New Pokémon Team', formHtml, async (e) => {
                    if(e.target.name.value) {
                        await addDoc(collection(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`), { 
                            name: e.target.name.value, 
                            purpose: e.target.purpose.value,
                            pokemon: [], 
                            notes: [], 
                            createdBy: currentUserId, 
                            createdAt: serverTimestamp(), 
                            isStaffPick: false,
                            isPublic: checkPermission('canCreatePublicTeams') ? e.target.isPublic.checked : false,
                            upvotes: [],
                            downvotes: []
                        });
                    }
                });
            };
        }

        async function renderPokemonTeamCard(doc) {
            const team = doc.data();
            const teamId = doc.id;
            const creatorName = await getUsername(team.createdBy);
            const upvotes = team.upvotes?.length || 0;
            const downvotes = team.downvotes?.length || 0;
            const score = upvotes - downvotes;
            const userVote = team.upvotes?.includes(currentUserId) ? 'up' : team.downvotes?.includes(currentUserId) ? 'down' : null;

            // --- Tiered Border Logic ---
            let borderClass = "border-gray-200";
            if (score <= -15) { /* Redacted */ }
            else if (score < 0) borderClass = "border-red-500 border-2";
            else if (score >= 100) borderClass = "border-yellow-400 border-4 p-1 bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-500 shadow-2xl"; // Legendary
            else if (score >= 75) borderClass = "border-purple-500 border-4 shadow-xl"; // Mythic
            else if (score >= 60) borderClass = "border-indigo-500 border-2 shadow-lg"; // Epic
            else if (score >= 40) borderClass = "border-blue-500 border-2 shadow-md"; // Rare
            else if (score >= 25) borderClass = "border-green-500 border-2 shadow-md"; // Uncommon
            else if (score >= 10) borderClass = "border-green-300 border-2"; // Common

            const pokemonHtml = (await Promise.all((team.pokemon || []).map(async (p, i) => {
                const addedByName = await getUsername(p.addedBy);
                return `
                    <div class="bg-gray-50 p-4 rounded-md border relative">
                        ${(checkPermission('canManagePokemonTeams') || team.createdBy === currentUserId) ? `<button data-team-id="${teamId}" data-pokemon-index="${i}" class="delete-pokemon-btn absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold text-xl">&times;</button>`:''}
                        <p class="font-bold text-lg">${p.species}</p>
                        <p class="text-sm"><strong>Nature:</strong> ${p.nature}</p>
                        <p class="text-sm"><strong>EVs:</strong> ${p.evs}</p>
                        <p class="text-sm"><strong>Moves:</strong> ${p.moves.join(', ')}</p>
                        <p class="text-xs text-gray-400 mt-2">Added by ${addedByName}</p>
                    </div>`;
            }))).join('');

            const notesHtml = (await Promise.all((team.notes || []).map(async note => {
                const authorName = await getUsername(note.authorId);
                return `<div class="text-sm bg-gray-100 p-2 rounded"><strong>${authorName}</strong>: ${note.text}</div>`;
            }))).join('');

            if (score <= -15) {
                return `
                    <div class="bg-black p-6 rounded-lg shadow border-4 border-red-800 text-center">
                        <h3 class="text-2xl font-bold text-gray-400">[REDACTED BY ORDER OF STAFF]</h3>
                        <p class="text-gray-500 mt-4">This team build was deemed a public nuisance.</p>
                        <p class="text-gray-600 mt-2 text-sm">Original creator: ${creatorName}</p>
                    </div>`;
            }

            return `
                <div class="bg-white p-5 rounded-lg shadow transition-all ${borderClass}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold">${team.name}</h3>
                            ${team.purpose ? `<p class="text-md font-semibold text-teal-700">${team.purpose}</p>` : ''}
                            <p class="text-sm text-gray-500">Created by ${creatorName}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            ${checkPermission('canMarkStaffPick') && team.isPublic ? `<label class="flex items-center gap-2 text-sm"><input type="checkbox" data-team-id="${teamId}" class="staff-pick-checkbox" ${team.isStaffPick ? 'checked' : ''}> Staff Pick</label>` : ''}
                            ${(team.createdBy === currentUserId || (team.isPublic && checkPermission('canDeletePublicTeams'))) ? `<button data-team-id="${teamId}" data-is-public="${team.isPublic}" class="delete-pokemon-team-btn text-red-500 hover:text-red-700">Delete Team</button>` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        ${pokemonHtml}
                        ${(team.pokemon || []).length < 6 && (checkPermission('canManagePokemonTeams') || team.createdBy === currentUserId) ? `<button data-team-id="${teamId}" class="add-pokemon-btn flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold p-3 rounded-md transition">+</button>` : ''}
                    </div>
                    <div class="border-t pt-4 flex justify-between items-end">
                        <div class="w-2/3">
                            <h4 class="font-semibold mb-2">Notes</h4>
                            <div class="space-y-2 max-h-40 overflow-y-auto mb-2 pr-2">${notesHtml}</div>
                            <div class="flex gap-2">
                                <input type="text" data-team-id="${teamId}" class="note-input flex-grow border rounded p-2" placeholder="Add a note...">
                                <button data-team-id="${teamId}" class="add-note-btn bg-gray-600 text-white px-4 rounded-lg">Post</button>
                            </div>
                        </div>
                        ${checkPermission('canVoteOnTeams') ? `
                        <div class="flex items-center gap-2">
                            <button data-team-id="${teamId}" data-vote="up" class="vote-btn p-2 rounded-full ${userVote === 'up' ? 'bg-green-500 text-white' : 'bg-gray-200 hover:bg-green-200'}">▲</button>
                            <span class="font-bold text-lg">${score}</span>
                            <button data-team-id="${teamId}" data-vote="down" class="vote-btn p-2 rounded-full ${userVote === 'down' ? 'bg-red-500 text-white' : 'bg-gray-200 hover:bg-red-200'}">▼</button>
                        </div>` : ''}
                    </div>
                </div>`;
        }

        function attachPokemonTeamCardListeners() {
            document.querySelectorAll('.add-pokemon-btn').forEach(btn => btn.onclick = e => {
                const teamId = e.target.dataset.teamId;
                const formHtml = `
                    <form class="space-y-4">
                        <input type="text" name="species" placeholder="Species" class="w-full p-2 border rounded-lg" required>
                        <input type="text" name="nature" placeholder="Nature" class="w-full p-2 border rounded-lg">
                        <input type="text" name="evs" placeholder="EVs (e.g., 252 Atk / 252 Spe)" class="w-full p-2 border rounded-lg">
                        <input type="text" name="moves" placeholder="Moves (comma-separated)" class="w-full p-2 border rounded-lg">
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" class="generic-modal-close-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
                            <button type="submit" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg">Add Pokémon</button>
                        </div>
                    </form>`;
                showGenericModal('Add Pokémon to Team', formHtml, async (event) => {
                    const { species, nature, evs, moves } = event.target;
                    if(species.value) {
                        await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId), { 
                            pokemon: arrayUnion({ 
                                species: species.value, 
                                nature: nature.value, 
                                evs: evs.value, 
                                moves: moves.value.split(',').map(m => m.trim()), 
                                addedBy: currentUserId 
                            }) 
                        });
                    }
                });
                genericModal.querySelector('.generic-modal-close-btn').onclick = hideGenericModal;
            });

            document.querySelectorAll('.add-note-btn').forEach(btn => btn.onclick = async e => {
                const teamId = e.target.dataset.teamId;
                const input = document.querySelector(`.note-input[data-team-id="${teamId}"]`);
                if (input.value.trim()) { 
                    await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId), { 
                        notes: arrayUnion({ text: input.value, authorId: currentUserId, createdAt: serverTimestamp() }) 
                    }); 
                    input.value = ''; 
                }
            });

            document.querySelectorAll('.delete-pokemon-team-btn').forEach(btn => btn.onclick = e => {
                const teamId = e.target.dataset.teamId;
                const isPublic = e.target.dataset.isPublic === 'true';
                const canDelete = (isPublic && checkPermission('canDeletePublicTeams')) || !isPublic;
                if(canDelete) {
                    showModal('Delete this entire Pokémon team?', () => deleteDoc(doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId)));
                } else {
                    alert("You don't have permission to delete this public team.");
                }
            });
            
            document.querySelectorAll('.delete-pokemon-btn').forEach(btn => btn.onclick = async e => {
                const { teamId, pokemonIndex } = e.target.dataset;
                const teamRef = doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId); 
                const teamSnap = await getDoc(teamRef); 
                const pokemonToRemove = teamSnap.data().pokemon[pokemonIndex];
                showModal(`Delete ${pokemonToRemove.species}?`, () => updateDoc(teamRef, { pokemon: arrayRemove(pokemonToRemove) }));
            });

            document.querySelectorAll('.staff-pick-checkbox').forEach(box => box.onchange = async e => await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, e.target.dataset.teamId), { isStaffPick: e.target.checked }));

            document.querySelectorAll('.vote-btn').forEach(btn => btn.onclick = async e => {
                const { teamId, vote } = e.currentTarget.dataset;
                const teamRef = doc(db, `team_spaces/${currentTeamSpaceId}/pokemon_teams`, teamId);
                
                // Superadmin multi-vote logic
                if (currentUserRole === 'Superadmin') {
                    if (vote === 'up') {
                        await updateDoc(teamRef, { upvotes: arrayUnion(currentUserId + Math.random()) });
                    } else {
                        await updateDoc(teamRef, { downvotes: arrayUnion(currentUserId + Math.random()) });
                    }
                    return;
                }

                await runTransaction(db, async (transaction) => {
                    const teamDoc = await transaction.get(teamRef);
                    if (!teamDoc.exists()) return;

                    const data = teamDoc.data();
                    const upvotes = data.upvotes || [];
                    const downvotes = data.downvotes || [];
                    
                    const hasUpvoted = upvotes.includes(currentUserId);
                    const hasDownvoted = downvotes.includes(currentUserId);

                    let newUpvotes = [...upvotes];
                    let newDownvotes = [...downvotes];

                    if (vote === 'up') {
                        if (hasUpvoted) { newUpvotes = newUpvotes.filter(id => id !== currentUserId); } 
                        else { newUpvotes.push(currentUserId); newDownvotes = newDownvotes.filter(id => id !== currentUserId); }
                    } else if (vote === 'down') {
                        if (hasDownvoted) { newDownvotes = newDownvotes.filter(id => id !== currentUserId); } 
                        else { newDownvotes.push(currentUserId); newUpvotes = newUpvotes.filter(id => id !== currentUserId); }
                    }
                    transaction.update(teamRef, { upvotes: newUpvotes, downvotes: newDownvotes });
                });
            });
        }

        // --- TASKS MODULE (REFINED) ---
        function renderTasks() {
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Task Board</h2>
                </div>
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex space-x-4" id="tasks-tab-nav">
                        <button data-tab="shared" class="tasks-tab-btn py-2 px-4 font-semibold text-teal-600 border-b-2 border-teal-600">Active Tasks</button>
                        <button data-tab="completed" class="tasks-tab-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent">Completed</button>
                        <button data-tab="personal" class="tasks-tab-btn py-2 px-4 font-semibold text-gray-500 border-b-2 border-transparent">My Tasks</button>
                    </nav>
                </div>
                <div id="tasks-content"></div>`;

            const renderTabContent = (tab) => {
                const container = document.getElementById('tasks-content');
                let q;
                if (tab === 'shared' || tab === 'completed') {
                    const isCompleted = tab === 'completed';
                    container.innerHTML = `
                        ${tab === 'shared' && checkPermission('canManageTasks') ? `
                        <div class="bg-white p-6 rounded-lg shadow mb-6">
                            <button id="add-task-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg">Create New Shared Task</button>
                        </div>` : ''}
                        <div id="shared-tasks-container" class="space-y-4"></div>`;
                    
                    if (tab === 'shared' && checkPermission('canManageTasks')) {
                        document.getElementById('add-task-btn').onclick = () => showNewTaskModal();
                    }

                    q = query(collection(db, `team_spaces/${currentTeamSpaceId}/tasks`), where("completed", "==", isCompleted));
                    const unsub = onSnapshot(q, async (snapshot) => {
                        const taskContainer = document.getElementById('shared-tasks-container');
                        if (!taskContainer) return;
                        
                        const docs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toDate() || 0) - (a.data().createdAt?.toDate() || 0));

                        taskContainer.innerHTML = docs.length === 0
                            ? `<p class="text-gray-500 text-center mt-8">No ${isCompleted ? 'completed' : 'active'} tasks.</p>` 
                            : (await Promise.all(docs.map(isCompleted ? renderCompletedTaskCard : renderTaskCard))).join('');
                        attachTaskCardListeners();
                    });
                    unsubscribeListeners.push(unsub);
                } else { // Personal tasks
                    container.innerHTML = `
                        <div class="bg-white p-6 rounded-lg shadow mb-6">
                            <form id="add-personal-task-form" class="flex gap-4">
                                <input type="text" name="taskText" placeholder="New personal task..." class="flex-grow p-2 border rounded-lg" required>
                                <button type="submit" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">Add Task</button>
                            </form>
                        </div>
                        <div id="personal-tasks-container" class="space-y-4"></div>`;
                    document.getElementById('add-personal-task-form').onsubmit = async e => { e.preventDefault(); const text = e.target.taskText.value; if(text) await addDoc(collection(db, `users/${currentUserId}/tasks`), { text, completed: false, createdAt: serverTimestamp() }); e.target.reset(); };
                    q = query(collection(db, `users/${currentUserId}/tasks`), orderBy("createdAt", "desc"));
                    const unsub = onSnapshot(q, (snapshot) => {
                        const taskContainer = document.getElementById('personal-tasks-container'); if (!taskContainer) return;
                        taskContainer.innerHTML = snapshot.empty ? '<p class="text-gray-500 text-center mt-8">No personal tasks.</p>' : snapshot.docs.map(doc => {
                            const task = doc.data(); const taskId = doc.id;
                            return `<div class="bg-white p-4 rounded-lg shadow flex items-center justify-between"><div class="flex items-center gap-4"><input type="checkbox" data-task-id="${taskId}" class="personal-task-checkbox h-6 w-6" ${task.completed ? 'checked' : ''}><p class="${task.completed ? 'line-through text-gray-400' : ''}">${task.text}</p></div><button data-task-id="${taskId}" class="delete-personal-task-btn text-xs text-red-500 hover:underline">Delete</button></div>`;
                        }).join('');
                        document.querySelectorAll('.personal-task-checkbox').forEach(el => el.onchange = async e => await updateDoc(doc(db, `users/${currentUserId}/tasks`, e.target.dataset.taskId), { completed: e.target.checked }));
                        document.querySelectorAll('.delete-personal-task-btn').forEach(btn => btn.onclick = () => showModal('Delete this task?', () => deleteDoc(doc(db, `users/${currentUserId}/tasks`, btn.dataset.taskId))));
                    });
                    unsubscribeListeners.push(unsub);
                }
            };
            document.querySelectorAll('.tasks-tab-btn').forEach(btn => btn.onclick = (e) => { document.querySelectorAll('.tasks-tab-btn').forEach(b => b.classList.remove('text-teal-600', 'border-teal-600')); e.target.classList.add('text-teal-600', 'border-teal-600'); renderTabContent(e.target.dataset.tab); });
            renderTabContent('shared');
        }

        function showNewTaskModal() {
            const formHtml = `
                <form id="add-task-form-modal" class="space-y-4">
                    <input type="text" name="text" placeholder="Task Title" class="w-full p-2 border rounded-lg" required>
                    <textarea name="details" placeholder="Details & Instructions..." class="w-full p-2 border rounded-lg h-24"></textarea>
                    <input type="text" name="reward" placeholder="Reward / Incentive" class="w-full p-2 border rounded-lg">
                    <select name="type" class="w-full p-2 border rounded-lg">
                        <option value="checklist">Simple Checklist Task</option>
                        <option value="goal">Collaborative Goal</option>
                    </select>
                    <div id="goal-fields" class="hidden space-y-2">
                        <div id="goal-items-container">
                             <div class="flex gap-2 items-center">
                                <input type="text" name="goalItemName" placeholder="Item Name (e.g., Ultra Balls)" class="flex-grow p-2 border rounded-lg">
                                <input type="number" name="goalItemTarget" placeholder="Target" class="w-28 p-2 border rounded-lg">
                            </div>
                        </div>
                        <button type="button" id="add-goal-item-btn" class="text-sm text-teal-600 hover:underline">+ Add another item</button>
                    </div>
                    <div class="flex items-center gap-2">
                         <input type="checkbox" name="isRecurring" id="isRecurring">
                         <label for="isRecurring">Is this a recurring task?</label>
                         <select name="recurrencePeriod" id="recurrencePeriod" class="p-1 border rounded-lg hidden">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                         </select>
                    </div>
                    <button type="submit" class="w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600">Create Task</button>
                </form>`;
            
            showGenericModal('New Shared Task', formHtml, async (e) => {
                const form = e.target;
                const taskData = {
                    text: form.text.value,
                    details: form.details.value,
                    reward: form.reward.value,
                    type: form.type.value,
                    completed: false,
                    createdBy: currentUserId,
                    createdAt: serverTimestamp(),
                    isRecurring: form.isRecurring.checked,
                    recurrencePeriod: form.isRecurring.checked ? form.recurrencePeriod.value : null,
                    lastReset: form.isRecurring.checked ? serverTimestamp() : null,
                };
                if (taskData.type === 'goal') {
                    taskData.goalItems = [];
                    const itemNames = form.querySelectorAll('input[name="goalItemName"]');
                    const itemTargets = form.querySelectorAll('input[name="goalItemTarget"]');
                    itemNames.forEach((nameInput, index) => {
                        if (nameInput.value) {
                            taskData.goalItems.push({
                                name: nameInput.value,
                                target: Number(itemTargets[index].value) || 0,
                                progress: 0
                            });
                        }
                    });
                }
                await addDoc(collection(db, `team_spaces/${currentTeamSpaceId}/tasks`), taskData);
            }, 'md');

            // Add event listeners for the modal form
            const modalForm = document.getElementById('add-task-form-modal');
            modalForm.querySelector('select[name="type"]').onchange = (e) => {
                modalForm.querySelector('#goal-fields').classList.toggle('hidden', e.target.value !== 'goal');
            };
            modalForm.querySelector('#add-goal-item-btn').onclick = () => {
                const container = modalForm.querySelector('#goal-items-container');
                const newItemHtml = `
                    <div class="flex gap-2 items-center mt-2">
                        <input type="text" name="goalItemName" placeholder="Item Name" class="flex-grow p-2 border rounded-lg">
                        <input type="number" name="goalItemTarget" placeholder="Target" class="w-28 p-2 border rounded-lg">
                    </div>`;
                container.insertAdjacentHTML('beforeend', newItemHtml);
            };
            modalForm.querySelector('#isRecurring').onchange = (e) => {
                modalForm.querySelector('#recurrencePeriod').classList.toggle('hidden', !e.target.checked);
            };
        }

        async function renderTaskCard(doc) {
            const task = doc.data();
            const taskId = doc.id;
            const creatorName = await getUsername(task.createdBy);
            
            let contentHtml = '';
            if (task.type === 'goal') {
                contentHtml += `<div class="mt-4 space-y-3">`;
                (task.goalItems || []).forEach((item, index) => {
                    const progressPercent = Math.min(100, (item.progress / item.target) * 100);
                    contentHtml += `
                        <div>
                            <div class="flex justify-between text-sm font-semibold text-gray-600 mb-1">
                                <span>${item.name}</span>
                                <span>${item.progress.toLocaleString()} / ${item.target.toLocaleString()}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="bg-teal-500 h-4 rounded-full text-white text-xs flex items-center justify-center" style="width: ${progressPercent}%">
                                    ${progressPercent.toFixed(0)}%
                                </div>
                            </div>
                        </div>`;
                });
                contentHtml += `
                    <div class="mt-4 flex gap-2 border-t pt-4">
                        <input type="number" data-task-id="${taskId}" class="goal-contribution-input flex-grow p-2 border rounded-lg" placeholder="Amount...">
                        <select data-task-id="${taskId}" class="goal-item-select p-2 border rounded-lg">
                            ${(task.goalItems || []).map(item => `<option value="${item.name}">${item.name}</option>`).join('')}
                        </select>
                        <button data-task-id="${taskId}" class="add-contribution-btn bg-gray-600 text-white px-4 rounded-lg">Log</button>
                    </div>
                </div>`;
            } else { // Checklist
                contentHtml = `
                    <div class="mt-4 flex items-center gap-4">
                        <input type="checkbox" data-task-id="${taskId}" class="task-checkbox h-6 w-6" ${task.completed ? 'checked' : ''}>
                        <label class="font-semibold ${task.completed ? 'line-through text-gray-400' : ''}">Mark as Complete</label>
                    </div>`;
            }

            // Contribution Log
            let logHtml = `<div class="mt-4 border-t pt-4">
                <h4 class="font-semibold mb-2">Contribution Log</h4>
                <div id="log-${taskId}" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                    <p class="text-sm text-gray-500">Loading log...</p>
                </div>
            </div>`;
            
            // Real-time listener for contributions
            const contributionsQuery = query(collection(db, `team_spaces/${currentTeamSpaceId}/tasks/${taskId}/contributions`), orderBy('timestamp', 'desc'));
            const unsub = onSnapshot(contributionsQuery, async (snapshot) => {
                const logContainer = document.getElementById(`log-${taskId}`);
                if (!logContainer) return;

                const contributions = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                if (contributions.length === 0) {
                    logContainer.innerHTML = `<p class="text-sm text-gray-500">No contributions yet.</p>`;
                } else {
                    logContainer.innerHTML = (await Promise.all(contributions.map(async c => {
                        const contributorName = await getUsername(c.userId);
                        const contributionTime = c.timestamp ? new Timestamp(c.timestamp.seconds, c.timestamp.nanoseconds).toDate().toLocaleString() : '...';
                        const itemEntries = Object.entries(c.items).map(([key, val]) => `${val.toLocaleString()} ${key}`).join(', ');
                        return `
                            <div class="text-sm p-2 rounded ${c.status === 'verified' ? 'bg-green-50' : 'bg-yellow-50'}">
                                <div class="flex justify-between items-center">
                                    <span><strong>${contributorName}</strong> logged ${itemEntries}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500">${contributionTime}</span>
                                        ${c.status === 'pending' && checkPermission('canVerifyContributions') ? `<button data-task-id="${taskId}" data-contrib-id="${c.id}" class="verify-contribution-btn text-xs bg-green-500 text-white px-2 py-1 rounded">Verify</button>` : `<span class="text-xs font-bold ${c.status === 'verified' ? 'text-green-600' : 'text-yellow-600'}">${c.status}</span>`}
                                    </div>
                                </div>
                            </div>`;
                    }))).join('');
                }
                 // Re-attach listeners for newly rendered buttons
                attachTaskCardListeners();
            });
            unsubscribeListeners.push(unsub);


            return `
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold ${task.completed ? 'line-through text-gray-400' : ''}">${task.text}</h3>
                            <p class="text-sm text-gray-500">Added by ${creatorName}</p>
                        </div>
                        <div class="flex items-center gap-2">
                             ${task.isRecurring ? `<span class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${task.recurrencePeriod}</span>` : ''}
                             ${checkPermission('canManageTasks') ? `<button data-task-id="${taskId}" class="delete-task-btn text-red-500 hover:text-red-700">&times;</button>` : ''}
                        </div>
                    </div>
                    ${task.details ? `<p class="text-gray-700 mt-2 p-2 bg-gray-50 rounded">${task.details}</p>` : ''}
                    ${task.reward ? `<p class="text-sm font-semibold text-yellow-600 mt-2">Reward: ${task.reward}</p>` : ''}
                    ${contentHtml}
                    ${task.type === 'goal' ? logHtml : ''}
                </div>`;
        }
        
        async function renderCompletedTaskCard(doc) {
            const task = doc.data();
            const taskId = doc.id;
            const creatorName = await getUsername(task.createdBy);

            return `
                <div class="bg-gray-100 p-4 rounded-lg shadow-inner opacity-80">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold text-gray-500 line-through">${task.text}</h3>
                            <p class="text-xs text-gray-400">Completed Task (Created by ${creatorName})</p>
                        </div>
                        <button data-task-id="${taskId}" class="view-breakdown-btn bg-gray-300 text-gray-700 text-sm font-semibold py-1 px-3 rounded-lg hover:bg-gray-400">View Breakdown</button>
                    </div>
                </div>
            `;
        }
        
        function attachTaskCardListeners() {
            document.querySelectorAll('.task-checkbox').forEach(el => el.onchange = async e => {
                await updateDoc(doc(db, `team_spaces/${currentTeamSpaceId}/tasks`, e.target.dataset.taskId), { completed: e.target.checked });
            });
            if (checkPermission('canManageTasks')) {
                document.querySelectorAll('.delete-task-btn').forEach(btn => btn.onclick = () => {
                    showModal('Delete this task?', () => deleteDoc(doc(db, `team_spaces/${currentTeamSpaceId}/tasks`, btn.dataset.taskId)));
                });
            }
            document.querySelectorAll('.add-contribution-btn').forEach(btn => btn.onclick = async e => {
                const taskId = e.target.dataset.taskId;
                const input = document.querySelector(`.goal-contribution-input[data-task-id="${taskId}"]`);
                const select = document.querySelector(`.goal-item-select[data-task-id="${taskId}"]`);
                const value = Number(input.value);
                const itemName = select.value;

                if (value > 0 && itemName) {
                    await addDoc(collection(db, `team_spaces/${currentTeamSpaceId}/tasks/${taskId}/contributions`), {
                        userId: currentUserId,
                        timestamp: serverTimestamp(),
                        items: { [itemName]: value },
                        status: 'pending' // pending, verified
                    });
                    input.value = '';
                }
            });

            document.querySelectorAll('.verify-contribution-btn').forEach(btn => btn.onclick = async e => {
                const { taskId, contribId } = e.currentTarget.dataset;
                showLoading(true);
                try {
                    const taskRef = doc(db, `team_spaces/${currentTeamSpaceId}/tasks`, taskId);
                    const contribRef = doc(db, `team_spaces/${currentTeamSpaceId}/tasks/${taskId}/contributions`, contribId);

                    await runTransaction(db, async (transaction) => {
                        const taskDoc = await transaction.get(taskRef);
                        const contribDoc = await transaction.get(contribRef);
                        if (!taskDoc.exists() || !contribDoc.exists()) return;

                        const taskData = taskDoc.data();
                        const contribData = contribDoc.data();
                        if (contribData.status === 'verified') return; // Already done

                        const newGoalItems = [...taskData.goalItems];
                        Object.entries(contribData.items).forEach(([name, value]) => {
                            const itemIndex = newGoalItems.findIndex(item => item.name === name);
                            if (itemIndex > -1) {
                                newGoalItems[itemIndex].progress += value;
                            }
                        });

                        transaction.update(taskRef, { goalItems: newGoalItems });
                        transaction.update(contribRef, { status: 'verified' });
                    });
                } catch (error) {
                    console.error("Verification failed:", error);
                    alert("Could not verify contribution.");
                } finally {
                    showLoading(false);
                }
            });

            document.querySelectorAll('.view-breakdown-btn').forEach(btn => btn.onclick = async e => {
                const taskId = e.target.dataset.taskId;
                const taskRef = doc(db, `team_spaces/${currentTeamSpaceId}/tasks`, taskId);
                const taskSnap = await getDoc(taskRef);
                if (!taskSnap.exists()) return;
                const task = taskSnap.data();

                const contribsQuery = query(collection(db, `team_spaces/${currentTeamSpaceId}/tasks/${taskId}/contributions`));
                const contribsSnap = await getDocs(contribsQuery);
                
                const userTotals = {};
                contribsSnap.docs.forEach(d => {
                    const c = d.data();
                    if (c.status !== 'verified') return;
                    if (!userTotals[c.userId]) userTotals[c.userId] = {};
                    Object.entries(c.items).forEach(([name, value]) => {
                        if (!userTotals[c.userId][name]) userTotals[c.userId][name] = 0;
                        userTotals[c.userId][name] += value;
                    });
                });

                let breakdownHtml = `<div class="space-y-4">`;
                const userIds = Object.keys(userTotals);
                if (userIds.length > 0) {
                    breakdownHtml += `<h4 class="font-bold">Top Contributors</h4>`;
                    const userNames = await Promise.all(userIds.map(getUsername));
                    const sortedContributors = userIds.map((id, index) => ({
                        id,
                        name: userNames[index],
                        totals: userTotals[id]
                    })).sort((a, b) => {
                        const totalA = Object.values(a.totals).reduce((s, v) => s + v, 0);
                        const totalB = Object.values(b.totals).reduce((s, v) => s + v, 0);
                        return totalB - totalA;
                    });

                    sortedContributors.forEach(user => {
                        breakdownHtml += `<div class="p-2 bg-gray-100 rounded"><strong>${user.name}</strong>: ${Object.entries(user.totals).map(([name, val]) => `${val.toLocaleString()} ${name}`).join(', ')}</div>`;
                    });
                } else {
                    breakdownHtml += `<p>No verified contributions for this task.</p>`;
                }
                breakdownHtml += `</div>`;
                showGenericModal(`Breakdown for: ${task.text}`, breakdownHtml, null, 'md');
            });
        }
        
        // --- MODAL (Confirmation) ---
        const modal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('confirmation-modal-message');
        const modalConfirmBtn = document.getElementById('confirmation-modal-confirm-btn');
        const modalCancelBtn = document.getElementById('confirmation-modal-cancel-btn');

        function showModal(message, onConfirm) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            modalConfirmBtn.onclick = () => {
                onConfirm();
                hideModal();
            };
        }
        function hideModal() {
            modal.classList.add('hidden');
            modalConfirmBtn.onclick = null;
        }
        modalCancelBtn.addEventListener('click', hideModal);

        // --- OTHER MODULES (Breeding, Hunts, Pokedex, etc.) ---
        function renderBreedingProjects() { 
            mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">Breeding Projects</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        function renderShinyHunts() {
            mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">Shiny Hunts</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        function renderPokedex() {
             mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">Pokédex & Builds</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        function renderEvHotspots() {
             mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">EV Hotspots</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        function renderMoneyGuide() {
             mainContent.innerHTML = `<h2 class="text-3xl font-bold text-gray-800">Money Guide</h2><p class="text-gray-500">Feature coming soon.</p>`; 
        }
        async function renderAdminPanel() {
            if (currentUserRole !== 'Superadmin') { mainContent.innerHTML = `<p class="text-red-500">Access Denied.</p>`; return; }
            mainContent.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Admin Panel</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">User Role Management</h3>
                        <div id="user-roles-container" class="space-y-3">Loading...</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">Player Team Permission Settings</h3>
                        <div id="permissions-container" class="space-y-4"></div>
                        <button id="save-perms-btn" class="mt-6 w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600">Save Permissions</button>
                    </div>
                    <!-- NEW: Superadmin Controls -->
                    <div class="bg-white p-6 rounded-lg shadow lg:col-span-2">
                        <h3 class="text-xl font-bold mb-4 text-red-600">Superadmin Controls</h3>
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold">Official Team Space</h4>
                                <p class="text-sm text-gray-600 mb-2">Mark the current Team Space (${currentTeamSpaceId}) as the official one for all users.</p>
                                <button id="mark-official-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg">Mark as Official</button>
                            </div>
                            <div class="border-t pt-4">
                                <h4 class="font-semibold">Rename Current Team Space ID</h4>
                                <p class="text-sm text-gray-600 mb-2">This is a complex operation. Change '${currentTeamSpaceId}' to a new custom ID. All data will be migrated.</p>
                                <div class="flex gap-2">
                                    <input type="text" id="new-team-space-id-input" placeholder="New ID (e.g., ExCorp)" class="flex-grow p-2 border rounded-lg">
                                    <button id="rename-team-space-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Rename</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // --- Admin Panel Logic ---
            const teamSpaceRef = doc(db, "team_spaces", currentTeamSpaceId); 
            const teamSpaceSnap = await getDoc(teamSpaceRef); 
            const memberIds = teamSpaceSnap.exists() ? teamSpaceSnap.data().members || [] : [];
            
            const usersHtml = await Promise.all(memberIds.map(async (uid) => {
                const userDoc = await getDoc(doc(db, "users", uid)); if (!userDoc.exists()) return ''; const { username, role } = userDoc.data();
                if (uid === SUPERADMIN_UID) return `<div class="flex justify-between items-center"><p>${username} <span class="text-xs font-bold text-yellow-500">Superadmin</span></p></div>`;
                return `<div class="flex justify-between items-center"><p>${username}</p><select data-uid="${uid}" class="role-selector p-1 border rounded"><option value="Member" ${role === 'Member' ? 'selected' : ''}>Member</option><option value="Staff" ${role === 'Staff' ? 'selected' : ''}>Staff</option><option value="Admin" ${role === 'Admin' ? 'selected' : ''}>Admin</option></select></div>`;
            }));
            document.getElementById('user-roles-container').innerHTML = usersHtml.join('');
            document.querySelectorAll('.role-selector').forEach(sel => { sel.onchange = async (e) => await updateDoc(doc(db, "users", e.target.dataset.uid), { role: e.target.value }); });
            
            const permsContainer = document.getElementById('permissions-container');
            const rolesToManage = ['Admin', 'Staff', 'Member'];
            const actions = { 
                canManagePokemonTeams: "Manage Pokémon Teams", 
                canManageProjects: "Manage Projects", 
                canManageTasks: "Manage Shared Tasks", 
                canEditResources: "Edit Resources", 
                canMarkStaffPick: "Mark Staff Picks",
                canCreatePublicTeams: "Create Public Pokémon Teams",
                canVoteOnTeams: "Upvote/Downvote Pokémon Teams",
                canVerifyContributions: "Verify Task Contributions",
                canDeletePublicTeams: "Delete Public Pokémon Teams"
            };
            permsContainer.innerHTML = rolesToManage.map(role => `
                <div class="border p-4 rounded-lg">
                    <h4 class="font-bold text-lg">${role}</h4>
                    <div class="space-y-2 mt-2">
                        ${Object.entries(actions).map(([key, label]) => `
                            <label class="flex items-center gap-2">
                                <input type="checkbox" data-role="${role}" data-action="${key}" class="perm-checkbox h-4 w-4" ${teamSpacePermissions[role]?.[key] === true ? 'checked' : ''}> ${label}
                            </label>`).join('')}
                    </div>
                </div>`).join('');
            
            document.getElementById('save-perms-btn').onclick = async () => {
                showLoading(true);
                const newPermissions = JSON.parse(JSON.stringify(teamSpacePermissions));
                document.querySelectorAll('.perm-checkbox').forEach(box => {
                    const { role, action } = box.dataset;
                    if (!newPermissions[role]) newPermissions[role] = {};
                    newPermissions[role][action] = box.checked;
                });
                try {
                    const teamSpaceDoc = doc(db, "team_spaces", currentTeamSpaceId);
                    const docSnap = await getDoc(teamSpaceDoc);
                    if (docSnap.exists()) {
                        await updateDoc(teamSpaceDoc, { permissions: newPermissions });
                        teamSpacePermissions = newPermissions; // FIX: Update local state immediately
                        alert("Permissions saved successfully!");
                    } else {
                        throw new Error("Team Space document does not exist.");
                    }
                } catch (error) {
                    alert("Error saving permissions: " + error.message);
                    console.error("Permissions save error:", error);
                } finally {
                    showLoading(false);
                }
            };

            // Superadmin button listeners
            document.getElementById('mark-official-btn').onclick = async () => {
                if (confirm(`Are you sure you want to mark "${currentTeamSpaceId}" as the official Team Space?`)) {
                    const teamSnap = await getDoc(doc(db, "team_spaces", currentTeamSpaceId));
                    const teamName = teamSnap.exists() ? teamSnap.data().name || currentTeamSpaceId : currentTeamSpaceId;
                    await setDoc(doc(db, "system_settings", "official_team_space"), {
                        id: currentTeamSpaceId,
                        name: teamName
                    });
                    alert("Official Team Space has been set.");
                }
            };
            document.getElementById('rename-team-space-btn').onclick = async () => {
                const newId = document.getElementById('new-team-space-id-input').value.trim();
                if (newId && newId !== currentTeamSpaceId) {
                    if (confirm(`This is a major action. Are you sure you want to rename '${currentTeamSpaceId}' to '${newId}'?`)) {
                        await renameTeamSpace(currentTeamSpaceId, newId);
                    }
                } else {
                    alert("Please enter a new, valid ID.");
                }
            };
        }

        // --- NEW: Superadmin Functions ---
        async function renameTeamSpace(oldId, newId) {
            showLoading(true);
            try {
                const newDocRef = doc(db, "team_spaces", newId);
                const newDocSnap = await getDoc(newDocRef);
                if (newDocSnap.exists()) {
                    throw new Error(`Team Space with ID "${newId}" already exists.`);
                }

                await runTransaction(db, async (transaction) => {
                    const oldDocRef = doc(db, "team_spaces", oldId);
                    const oldDocSnap = await transaction.get(oldDocRef);
                    if (!oldDocSnap.exists()) {
                        throw new Error("Original document not found.");
                    }
                    transaction.set(newDocRef, oldDocSnap.data());
                    transaction.delete(oldDocRef);
                });

                const subcollections = ['pokemon_teams', 'tasks', 'breeding', 'hunts', 'resources'];
                for (const sub of subcollections) {
                    const oldSubCollectionRef = collection(db, `team_spaces/${oldId}/${sub}`);
                    const snapshot = await getDocs(oldSubCollectionRef);
                    for (const d of snapshot.docs) {
                        const oldDocRef = doc(db, `team_spaces/${oldId}/${sub}`, d.id);
                        const newDocRef = doc(db, `team_spaces/${newId}/${sub}`, d.id);
                        await setDoc(newDocRef, d.data());
                        
                        const nestedSubs = ['contributions'];
                        for (const nested of nestedSubs) {
                            const oldNestedRef = collection(oldDocRef, nested);
                            const nestedSnapshot = await getDocs(oldNestedRef);
                            for (const nestedDoc of nestedSnapshot.docs) {
                                await setDoc(doc(newDocRef, nested, nestedDoc.id), nestedDoc.data());
                                await deleteDoc(doc(oldDocRef, nested, nestedDoc.id));
                            }
                        }
                        await deleteDoc(oldDocRef);
                    }
                }
                
                const officialTeamRef = doc(db, "system_settings", "official_team_space");
                const officialTeamSnap = await getDoc(officialTeamRef);
                if (officialTeamSnap.exists() && officialTeamSnap.data().id === oldId) {
                    await updateDoc(officialTeamRef, { id: newId });
                }

                alert(`Team Space successfully renamed to ${newId}. The page will now reload.`);
                localStorage.setItem('currentTeamSpaceId', newId);
                location.reload();

            } catch (error) {
                console.error("Error renaming Team Space:", error);
                alert("Failed to rename Team Space: " + error.message);
            } finally {
                showLoading(false);
            }
        }


        // --- Event Listeners ---
        onAuthStateChanged(auth, async (user) => {
            try {
                showLoading(true);
                if (user) {
                    currentUserId = user.uid;
                    const userRef = doc(db, "users", currentUserId);
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        const userData = userSnap.data();
                        currentUsername = userData.username;
                        currentUserRole = user.uid === SUPERADMIN_UID ? 'Superadmin' : userData.role;
                        if (user.uid === SUPERADMIN_UID && userData.role !== 'Superadmin') {
                            await updateDoc(userRef, { role: 'Superadmin' });
                        }
                        userProfileDisplay.textContent = `${currentUsername} (${currentUserRole})`;
                        document.getElementById('admin-panel-btn').style.display = currentUserRole === 'Superadmin' ? 'block' : 'none';
                        authContainer.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        await setupTeamSpace(currentUserId);
                        await renderOfficialTeamSpaceButton(); 
                    } else { await signOut(auth); }
                } else {
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            } catch (error) { console.error("Authentication Error:", error); } 
            finally { showLoading(false); }
        });

        document.getElementById('login-form').onsubmit = async (e) => { e.preventDefault(); showLoading(true); const email = e.target.email.value; const password = e.target.password.value; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { alert(error.message); } finally { showLoading(false); } };
        
        document.getElementById('signup-form').onsubmit = async (e) => {
            e.preventDefault(); showLoading(true); const email = e.target.signup_email.value; const password = e.target.signup_password.value; const username = e.target.signup_username.value;
            if (password.length < 6) { alert("Password must be at least 6 characters."); showLoading(false); return; }
            if (username.length < 3) { alert("Username must be at least 3 characters."); showLoading(false); return; }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password); const user = userCredential.user;
                let role = user.uid === SUPERADMIN_UID ? 'Superadmin' : 'Member';
                await setDoc(doc(db, "users", user.uid), { username, email, role });
            } catch (error) { alert(error.message); } finally { showLoading(false); }
        };
        
        logoutBtn.onclick = () => signOut(auth);
        navButtons.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
        changeTeamSpaceBtn.addEventListener('click', () => { const newTeamSpaceId = teamSpaceIdInput.value.trim(); if (newTeamSpaceId && newTeamSpaceId !== currentTeamSpaceId) { localStorage.setItem('currentTeamSpaceId', newTeamSpaceId); location.reload(); } });
        createTeamSpaceBtn.addEventListener('click', () => { 
            const randomId = `team-${Math.random().toString(36).substring(2, 9)}`;
            localStorage.setItem('currentTeamSpaceId', randomId);
            location.reload();
        });

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tasks-tab-btn.active, .teams-filter-btn.active { color: #0d9488; border-color: #0d9488; }
        .modal-dialog { transition: all 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-teal-500"></div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container">
        <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-4xl w-full grid md:grid-cols-2 gap-8 p-8">
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">Login</h2>
                    <form id="login-form" class="space-y-4">
                        <input type="email" name="email" placeholder="Email" class="w-full p-3 border rounded-lg" required>
                        <input type="password" name="password" placeholder="Password" class="w-full p-3 border rounded-lg" required>
                        <button type="submit" class="w-full bg-teal-500 text-white p-3 rounded-lg font-bold hover:bg-teal-600">Login</button>
                    </form>
                </div>
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">Sign Up</h2>
                    <form id="signup-form" class="space-y-4">
                        <input type="text" name="signup_username" placeholder="Username" class="w-full p-3 border rounded-lg" required>
                        <input type="email" name="signup_email" placeholder="Email" class="w-full p-3 border rounded-lg" required>
                        <input type="password" name="signup_password" placeholder="Password" class="w-full p-3 border rounded-lg" required>
                        <p class="text-xs text-red-600 text-center">Warning: For your security, do NOT use the same password as your PokeMMO game account.</p>
                        <button type="submit" class="w-full bg-gray-700 text-white p-3 rounded-lg font-bold hover:bg-gray-800">Create Account</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden">
        <!-- Generic Modal -->
        <div id="generic-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full z-50 flex items-center justify-center">
            <div class="modal-dialog bg-white p-8 rounded-lg shadow-xl w-full mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="generic-modal-title" class="text-2xl font-bold">Modal Title</h3>
                    <button id="generic-modal-close-btn" class="text-gray-500 hover:text-gray-800 font-bold text-2xl">&times;</button>
                </div>
                <div id="generic-modal-content" class="max-h-[60vh] overflow-y-auto"></div>
            </div>
        </div>
        
        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full z-50 flex items-center justify-center">
           <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <p id="confirmation-modal-message" class="text-xl mb-6 text-center"></p>
            <div class="flex justify-center gap-4">
             <button id="confirmation-modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
             <button id="confirmation-modal-confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Confirm</button>
            </div>
           </div>
        </div>

        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside class="w-64 bg-white shadow-md flex flex-col">
                <div class="p-6 text-center border-b">
                    <h1 class="text-2xl font-bold text-teal-700">Player Team Hub</h1>
                </div>
                <nav class="flex-grow p-4 space-y-2">
                    <button data-view="dashboard" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Dashboard</button>
                    <button data-view="pokemon-teams" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Pokémon Team Locker</button>
                    <button data-view="tasks" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Task Board</button>
                    <button data-view="breeding" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Breeding Projects</button>
                    <button data-view="hunts" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Shiny Hunts</button>
                    <button data-view="pokedex" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Pokédex & Builds</button>
                    <button data-view="ev-hotspots" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">EV Hotspots</button>
                    <button data-view="money-guide" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition">Money Guide</button>
                    <button data-view="admin-panel" id="admin-panel-btn" class="nav-button w-full text-left font-semibold px-4 py-2 rounded-lg hover:bg-gray-100 transition" style="display: none;">Admin Panel</button>
                </nav>
                <div class="p-4 border-t space-y-3">
                    <div id="user-profile-display" class="text-sm text-center text-gray-600 font-semibold"></div>
                    <button id="logout-btn" class="w-full text-sm text-red-500 hover:underline">Logout</button>
                    
                    <!-- NEW: Official Team Space Section -->
                    <div id="official-team-space-container" class="border-t pt-3"></div>

                    <div class="border-t pt-3">
                        <h4 class="font-bold mb-2">My Team Spaces</h4>
                        <p class="text-sm text-gray-600 mb-2">Your current Team ID is:</p>
                        <p id="team-space-id-display" class="bg-gray-100 p-2 rounded text-center font-mono break-words"></p>
                        <input id="team-space-id-input" type="text" placeholder="Enter Team ID to join" class="w-full p-2 border rounded mt-3">
                        <button id="change-team-space-btn" class="w-full bg-teal-500 text-white p-2 rounded mt-2 hover:bg-teal-600">Join Team Space</button>
                        <button id="create-team-space-btn" class="w-full text-sm text-gray-500 mt-2 hover:underline">Create a New Private Space</button>
                    </div>
                </div>
            </aside>
            <!-- Main Content -->
            <main class="flex-1 p-8 overflow-y-auto bg-gray-100">
                <div id="main-content">
                    <!-- Dynamic Content Rendered Here -->
                </div>
            </main>
        </div>
    </div>
</body>
</html>
