import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, onSnapshot, doc, setDoc, getDoc, where, updateDoc, serverTimestamp } from 'firebase/firestore';
import { Dna, Calendar, FileText, AlertTriangle, Users, Book, Leaf, HardHat, ListChecks, Settings, Plus, X, Search, ChevronDown, CheckCircle, Clock, AlertCircle as AlertCircleIcon, MoreVertical, ArrowLeft, Edit, Trash2 } from 'lucide-react';

// --- Firebase Configuration ---
// Per platform instructions, using the environment-provided config.
// The user-provided config is used as a fallback.
const userProvidedConfig = {
    apiKey: "AIzaSyA_iRaOVHrnqOS3K4haYdGEHWs1pQqsiF4",
    authDomain: "safetysidekick-9252d.firebaseapp.com",
    projectId: "safetysidekick-9252d",
    storageBucket: "safetysidekick-9252d.firebasestorage.app",
    messagingSenderId: "976365120737",
    appId: "1:976365120737:web:8d6d675acd6c4d5c389ba0",
    measurementId: "G-XNZ8V8VVQK"
};

const firebaseConfig = typeof __firebase_config !== 'undefined' 
    ? JSON.parse(__firebase_config) 
    : userProvidedConfig;


// --- Firebase Initialization ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Main Navigation Items ---
const navItems = [
    { name: 'Dashboard', icon: Calendar, page: 'dashboard' },
    { name: 'Incidents & Events', icon: FileText, page: 'incidents' },
    { name: 'Hazards & Risks', icon: AlertTriangle, page: 'hazards' },
    { name: 'Training & People', icon: Users, page: 'training' },
    { name: 'Documents & Records', icon: Book, page: 'documents' },
    { name: 'Environmental', icon: Leaf, page: 'environmental' },
    { name: 'Contractors', icon: HardHat, page: 'contractors' },
    { name: 'Tasks & Scheduling', icon: ListChecks, page: 'tasks' },
    { name: 'Admin Settings', icon: Settings, page: 'admin' },
];

// --- Helper Components ---

const Modal = ({ children, isOpen, onClose, title, size = '4xl' }) => {
    if (!isOpen) return null;
    const sizeClasses = {
        'md': 'max-w-md',
        'lg': 'max-w-lg',
        'xl': 'max-w-xl',
        '2xl': 'max-w-2xl',
        '4xl': 'max-w-4xl',
    }
    return (
        <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-start pt-10">
            <div className={`bg-gray-800 rounded-lg shadow-2xl w-full ${sizeClasses[size]} max-h-[90vh] flex flex-col text-white`}>
                <div className="flex justify-between items-center p-4 border-b border-gray-700">
                    <h2 className="text-xl font-bold">{title}</h2>
                    <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-700">
                        <X size={24} />
                    </button>
                </div>
                <div className="p-6 overflow-y-auto">
                    {children}
                </div>
            </div>
        </div>
    );
};

const FormInput = ({ label, type = 'text', value, onChange, name, required = false, children }) => (
    <div className="mb-4">
        <label htmlFor={name} className="block text-sm font-medium text-gray-300 mb-1">{label}{required && <span className="text-red-500 ml-1">*</span>}</label>
        {type === 'textarea' ? (
            <textarea id={name} name={name} value={value || ''} onChange={onChange} rows="4" className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
        ) : (
            <input type={type} id={name} name={name} value={value || ''} onChange={onChange} required={required} className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500" />
        )}
        {children}
    </div>
);

const FormSelect = ({ label, value, onChange, name, required = false, options }) => (
    <div className="mb-4">
        <label htmlFor={name} className="block text-sm font-medium text-gray-300 mb-1">{label}{required && <span className="text-red-500 ml-1">*</span>}</label>
        <select id={name} name={name} value={value || ''} onChange={onChange} required={required} className="w-full bg-gray-700 border border-gray-600 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="">Select...</option>
            {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
        </select>
    </div>
);

const DropdownButton = ({ onSelect }) => {
    const [isOpen, setIsOpen] = useState(false);
    const options = [
        { key: 'Injury/Illness', label: 'Injury / Illness' },
        { key: 'Near Miss', label: 'Near Miss' },
        { key: 'Event', label: 'Event (Spill, Damage, etc.)' },
        { key: 'Violation', label: 'Violation' },
    ];

    return (
        <div className="relative">
            <button onClick={() => setIsOpen(!isOpen)} className="flex items-center bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded">
                <Plus size={20} className="mr-2" />
                New Incident
                <ChevronDown size={20} className="ml-2" />
            </button>
            {isOpen && (
                <div className="absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-gray-700 ring-1 ring-black ring-opacity-5 z-10">
                    <div className="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                        {options.map(option => (
                            <a href="#" key={option.key} onClick={(e) => {
                                e.preventDefault();
                                onSelect(option.key);
                                setIsOpen(false);
                            }} className="block px-4 py-2 text-sm text-gray-100 hover:bg-gray-600" role="menuitem">
                                {option.label}
                            </a>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
};


// --- Main Application Components ---

const Sidebar = ({ currentPage, setCurrentPage }) => (
    <aside className="w-64 bg-gray-900 text-white flex flex-col p-4 shrink-0">
        <div className="flex items-center mb-8">
            <Dna size={32} className="text-blue-400" />
            <h1 className="text-2xl font-bold ml-2">Safety Sidekick</h1>
        </div>
        <nav className="flex-grow">
            <ul>
                {navItems.map(item => (
                    <li key={item.name} className="mb-2">
                        <a
                            href="#"
                            onClick={(e) => { e.preventDefault(); setCurrentPage(item.page); }}
                            className={`flex items-center p-2 rounded-md transition-colors ${currentPage === item.page ? 'bg-blue-500 text-white' : 'hover:bg-gray-700'}`}
                        >
                            <item.icon size={20} className="mr-3" />
                            <span>{item.name}</span>
                        </a>
                    </li>
                ))}
            </ul>
        </nav>
        <div className="mt-auto">
            <div className="flex items-center p-2 bg-gray-800 rounded-md">
                <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center font-bold">
                    U
                </div>
                <div className="ml-3">
                    <p className="font-semibold">User</p>
                    <p className="text-xs text-gray-400">Platform Admin</p>
                </div>
            </div>
        </div>
    </aside>
);

const Dashboard = () => {
    const calendarTasks = {
        '2025-07-22': [{ title: 'Weekly Fire Extinguisher Check', time: '09:00', status: 'Due' }],
        '2025-07-24': [{ title: 'Forklift Operator Training', time: '13:00', status: 'Upcoming' }],
        '2025-07-21': [{ title: 'Monthly Safety Committee Meeting', time: '10:00', status: 'Overdue' }],
    };
    const kpis = [
        { label: 'Total Incidents (YTD)', value: 12, trend: 'up' },
        { label: 'Open Corrective Actions', value: 8, trend: 'down' },
        { label: 'Inspections Completed', value: '92%', trend: 'up' },
        { label: 'Training Compliance', value: '88%', trend: 'down' },
    ];
    return (
        <div>
            <h1 className="text-3xl font-bold mb-6">Dashboard</h1>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-gray-800 p-6 rounded-lg">
                    <h2 className="text-xl font-bold mb-4">Compliance Calendar - July 2025</h2>
                    <div className="grid grid-cols-7 gap-2 text-center text-xs text-gray-400 mb-2">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div className="grid grid-cols-7 gap-1">
                        {Array.from({ length: 35 }, (_, i) => {
                             const day = i - 3; // Start calendar on Sunday
                             const dateStr = `2025-07-${String(day).padStart(2, '0')}`;
                             const tasks = calendarTasks[dateStr] || [];
                             const isCurrentMonth = day > 0 && day <= 31;

                            return (
                                <div key={i} className={`p-2 rounded h-24 flex flex-col ${isCurrentMonth ? 'bg-gray-900/50' : 'bg-gray-800/20 text-gray-600'}`}>
                                    {isCurrentMonth && <span className="font-bold">{day}</span>}
                                    {isCurrentMonth && tasks.map(task => (
                                        <div key={task.title} className={`text-xs p-1 mt-1 rounded ${task.status === 'Overdue' ? 'bg-red-500/50' : 'bg-blue-500/50'}`}>
                                            {task.title}
                                        </div>
                                    ))}
                                </div>
                            )
                        })}
                    </div>
                </div>
                <div className="bg-gray-800 p-6 rounded-lg">
                    <h2 className="text-xl font-bold mb-4">Performance Dashboard</h2>
                    <div className="grid grid-cols-2 gap-4">
                        {kpis.map(kpi => (
                            <div key={kpi.label} className="bg-gray-700 p-4 rounded-md">
                                <p className="text-sm text-gray-400">{kpi.label}</p>
                                <p className="text-2xl font-bold">{kpi.value}</p>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};

// --- INCIDENTS & EVENTS MODULE ---

// Form for new incidents
const NewIncidentForm = ({ isOpen, onClose, onSave, userId, incidentType }) => {
    const [formData, setFormData] = useState({});

    useEffect(() => {
        // Reset form when type changes or modal opens
        setFormData({
            type: incidentType,
            reporterId: userId,
            status: 'New',
            caseStatus: 'Open (First Aid)',
            createdAt: serverTimestamp(),
            isOshaRecordable: false,
            // Section statuses for detail view tracking
            sections: {
                initialReport: true, // This form is the initial report
                employeeInfo: false,
                incidentInfo: false,
                rootCauseAnalysis: false,
                correctiveActionPlan: false,
                recordkeeping: false,
                // etc.
            }
        });
    }, [isOpen, incidentType, userId]);

    const handleChange = (e) => {
        const { name, value, type, checked } = e.target;
        setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            await onSave(formData);
            onClose();
        } catch (error) {
            console.error("Error saving incident:", error);
        }
    };

    const renderFormFields = () => {
        switch (incidentType) {
            case 'Injury/Illness':
                return (
                    <>
                        <FormInput label="Employee Name" name="employeeName" value={formData.employeeName} onChange={handleChange} required />
                        <FormInput label="Job Title" name="jobTitle" value={formData.jobTitle} onChange={handleChange} />
                        <FormInput label="Date of Incident" name="dateOfIncident" type="date" value={formData.dateOfIncident} onChange={handleChange} required />
                        <FormInput label="Time of Incident" name="timeOfIncident" type="time" value={formData.timeOfIncident} onChange={handleChange} required />
                        <FormInput label="Location" name="location" value={formData.location} onChange={handleChange} required />
                        <FormInput label="Incident Description" name="incidentDescription" type="textarea" value={formData.incidentDescription} onChange={handleChange} required />
                        <FormSelect label="How serious was it?" name="severity" value={formData.severity} onChange={handleChange} required options={[{value: '1', label: 'Minor'}, {value: '2', label: 'Moderate'}, {value: '3', label: 'Serious'}, {value: '4', label: 'Critical'}]}/>
                        <FormSelect label="How likely is this to happen again?" name="likelihood" value={formData.likelihood} onChange={handleChange} required options={[{value: '1', label: 'Rare'}, {value: '2', label: 'Occasional'}, {value: '3', label: 'Likely'}, {value: '4', label: 'Frequent'}]}/>
                        <div className="flex items-center gap-2 mb-4">
                            <input type="checkbox" id="isOshaRecordable" name="isOshaRecordable" checked={formData.isOshaRecordable} onChange={handleChange} className="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                            <label htmlFor="isOshaRecordable" className="text-sm text-gray-300">Flag as OSHA Recordable</label>
                        </div>
                    </>
                );
            case 'Near Miss':
                 return (
                    <>
                        <FormInput label="Date of Near Miss" name="dateOfIncident" type="date" value={formData.dateOfIncident} onChange={handleChange} required />
                        <FormInput label="Location" name="location" value={formData.location} onChange={handleChange} required />
                        <FormInput label="Describe the Near Miss" name="incidentDescription" type="textarea" value={formData.incidentDescription} onChange={handleChange} required />
                        <FormInput label="Potential Outcome if it had not been a near miss" name="potentialOutcome" type="textarea" value={formData.potentialOutcome} onChange={handleChange} />
                    </>
                );
            default:
                return (
                    <>
                        <FormInput label="Date of Event" name="dateOfIncident" type="date" value={formData.dateOfIncident} onChange={handleChange} required />
                        <FormInput label="Location" name="location" value={formData.location} onChange={handleChange} required />
                        <FormInput label="Describe the Event/Violation" name="incidentDescription" type="textarea" value={formData.incidentDescription} onChange={handleChange} required />
                    </>
                );
        }
    }

    return (
        <Modal isOpen={isOpen} onClose={onClose} title={`New ${incidentType} Report`} size="2xl">
            <form onSubmit={handleSubmit}>
                {renderFormFields()}
                <div className="mt-6 flex justify-end">
                    <button type="button" onClick={onClose} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded mr-2">
                        Cancel
                    </button>
                    <button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded">
                        Submit Report
                    </button>
                </div>
            </form>
        </Modal>
    );
};

// Detail view for a single incident
const IncidentDetailView = ({ incident, onBack }) => {
    const getCategory = (severity, likelihood) => {
        const sev = parseInt(severity, 10);
        const like = parseInt(likelihood, 10);
        if (isNaN(sev) || isNaN(like)) return { label: 'N/A', color: 'bg-gray-500' };
        const risk = sev * like;
        if (risk >= 13) return { label: 'A', color: 'bg-red-700' };
        if (risk >= 8) return { label: 'B', color: 'bg-orange-600' };
        if (risk >= 4) return { label: 'C', color: 'bg-yellow-500' };
        return { label: 'D', color: 'bg-green-600' };
    };
    
    const category = getCategory(incident.severity, incident.likelihood);
    const reportedDate = incident.createdAt?.toDate ? incident.createdAt.toDate().toLocaleDateString() : 'N/A';
    
    const navSections = {
        'Injury/Illness': [
            { name: 'Initial Incident Report Form', status: 'complete' },
            { name: 'Employee Information', status: 'incomplete' },
            { name: 'Incident Information', status: 'incomplete' },
            { name: 'Root Cause Analysis', status: 'incomplete' },
            { name: 'Corrective Action Plan', status: 'incomplete' },
            { name: 'Recordkeeping', status: 'in-progress' },
            { name: 'Employee Care Tracker', status: 'incomplete' },
            { name: 'Case Documentation', status: 'in-progress' },
            { name: 'Review', status: 'incomplete' },
        ],
        'Near Miss': [
            { name: 'Initial Incident Report Form', status: 'complete' },
            { name: 'Incident Information', status: 'incomplete' },
            { name: 'Root Cause Analysis', status: 'incomplete' },
            { name: 'Corrective Action Plan', status: 'incomplete' },
            { name: 'Review', status: 'incomplete' },
        ],
        'Event': [
            { name: 'Initial Incident Report Form', status: 'complete' },
            { name: 'Involved Parties Information', status: 'incomplete' },
            { name: 'Incident Information', status: 'incomplete' },
            { name: 'Root Cause Analysis', status: 'incomplete' },
            { name: 'Corrective Action Plan', status: 'incomplete' },
            { name: 'Review', status: 'incomplete' },
        ],
        'Violation': [
            { name: 'Initial Incident Report Form', status: 'complete' },
            { name: 'Employee Information', status: 'incomplete' },
            { name: 'Incident Information', status: 'incomplete' },
            { name: 'Root Cause Analysis', status: 'incomplete' },
            { name: 'Corrective Action Plan', status: 'incomplete' },
            { name: 'Review', status: 'incomplete' },
        ],
    };
    
    const getStatusIcon = (status) => {
        switch(status) {
            case 'complete': return <CheckCircle size={16} className="text-green-500" />;
            case 'in-progress': return <Clock size={16} className="text-yellow-500" />;
            case 'incomplete': return <AlertCircleIcon size={16} className="text-red-500" />;
            default: return null;
        }
    }

    return (
        <div>
            <button onClick={onBack} className="flex items-center text-blue-400 hover:text-blue-300 mb-4">
                <ArrowLeft size={20} className="mr-2" />
                Back to All Incidents
            </button>
            <div className="flex gap-6">
                {/* Left Nav */}
                <div className="w-1/4 bg-gray-800 p-4 rounded-lg">
                    <div className="border-b border-gray-700 pb-4 mb-4">
                        <h2 className="text-lg font-bold">{incident.type} Report</h2>
                        <p className="text-sm text-gray-400">ID: {incident.id.substring(0, 8)}...</p>
                        <span className={`mt-2 inline-block px-3 py-1 text-sm font-bold rounded-full text-white ${category.color}`}>
                            Category: {category.label}
                        </span>
                    </div>
                    <nav>
                        <ul>
                            {(navSections[incident.type] || []).map(section => (
                                <li key={section.name} className="mb-2">
                                    <a href="#" className="flex justify-between items-center p-2 rounded-md hover:bg-gray-700">
                                        <span>{section.name}</span>
                                        {getStatusIcon(section.status)}
                                    </a>
                                </li>
                            ))}
                        </ul>
                    </nav>
                </div>
                {/* Right Content */}
                <div className="w-3/4 bg-gray-800 p-6 rounded-lg">
                    <h3 className="text-xl font-bold mb-4">Initial Incident Report Form</h3>
                    <div className="space-y-4">
                        <div><strong className="text-gray-400 w-40 inline-block">Date of Incident:</strong> {incident.dateOfIncident}</div>
                        {incident.timeOfIncident && <div><strong className="text-gray-400 w-40 inline-block">Time of Incident:</strong> {incident.timeOfIncident}</div>}
                        {incident.employeeName && <div><strong className="text-gray-400 w-40 inline-block">Employee Name:</strong> {incident.employeeName}</div>}
                        <div><strong className="text-gray-400 w-40 inline-block">Location:</strong> {incident.location}</div>
                        <div>
                            <strong className="text-gray-400 block mb-1">Description:</strong>
                            <p className="bg-gray-900/50 p-3 rounded-md">{incident.incidentDescription}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

// Main Incidents Tab Content
const IncidentsTab = ({ userId, onSelectIncident }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [modalIncidentType, setModalIncidentType] = useState('');
    const [incidents, setIncidents] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!userId) return;
        setLoading(true);
        const q = query(collection(db, 'incidents'));
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const incidentsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            incidentsData.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
            setIncidents(incidentsData);
            setLoading(false);
        }, (error) => {
            console.error("Error fetching incidents: ", error);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [userId]);

    const handleNewIncidentSelect = (type) => {
        setModalIncidentType(type);
        setIsModalOpen(true);
    };

    const saveIncident = async (incidentData) => {
        try {
            await addDoc(collection(db, 'incidents'), incidentData);
        } catch (e) {
            console.error("Error adding document: ", e);
            throw e;
        }
    };
    
    const getCategory = (severity, likelihood) => {
        const sev = parseInt(severity, 10);
        const like = parseInt(likelihood, 10);
        if (isNaN(sev) || isNaN(like)) return { label: 'N/A', color: 'bg-gray-500' };
        const risk = sev * like;
        if (risk >= 13) return { label: 'A', color: 'bg-red-700' };
        if (risk >= 8) return { label: 'B', color: 'bg-orange-600' };
        if (risk >= 4) return { label: 'C', color: 'bg-yellow-500' };
        return { label: 'D', color: 'bg-green-600' };
    };

    const IncidentCard = ({ incident }) => {
        const category = getCategory(incident.severity, incident.likelihood);
        const reportedDate = incident.createdAt?.toDate ? incident.createdAt.toDate().toLocaleDateString() : 'N/A';
        return (
            <div onClick={() => onSelectIncident(incident)} className="bg-gray-800 p-4 rounded-lg border border-gray-700 flex flex-col justify-between hover:border-blue-500 cursor-pointer transition-all">
                <div>
                    <div className="flex justify-between items-start mb-2">
                        <span className="font-bold text-lg">{incident.type}</span>
                        <div className="flex items-center gap-2">
                            <span className={`px-3 py-1 text-sm font-bold rounded-full text-white ${category.color}`}>
                                Category: {category.label}
                            </span>
                            <span className="text-sm text-gray-400">Reported: {reportedDate}</span>
                        </div>
                    </div>
                    <div className="flex items-center gap-4 mb-3 text-sm">
                        <span>Report Status: <span className="font-semibold text-blue-400">{incident.status}</span></span>
                        <span>Case Status: <span className="font-semibold text-yellow-400">{incident.caseStatus || 'N/A'}</span></span>
                    </div>
                    <p className="text-gray-300 text-sm mb-4">
                        {incident.incidentDescription.substring(0, 150)}{incident.incidentDescription.length > 150 && '...'}
                    </p>
                </div>
                <div className="flex justify-between items-center mt-auto pt-2 border-t border-gray-700/50">
                    <div className="flex gap-2">
                        {incident.isOshaRecordable && <span className="bg-red-500/80 text-white text-xs font-bold px-2 py-1 rounded">OSHA Recordable</span>}
                    </div>
                    <button className="p-1 hover:bg-gray-700 rounded-full"><MoreVertical size={20}/></button>
                </div>
            </div>
        );
    };

    return (
        <div>
            <NewIncidentForm isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={saveIncident} userId={userId} incidentType={modalIncidentType} />
            <div className="flex justify-between items-center mb-4">
                <div className="flex items-center bg-gray-800 border border-gray-700 rounded-md px-2">
                    <Search size={20} className="text-gray-400" />
                    <input type="text" placeholder="Search incidents..." className="bg-transparent p-2 focus:outline-none w-64" />
                </div>
                <DropdownButton onSelect={handleNewIncidentSelect} />
            </div>
            {loading ? <p>Loading incidents...</p> : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {incidents.map(incident => <IncidentCard key={incident.id} incident={incident} />)}
                </div>
            )}
        </div>
    );
};

// OSHA Log Tab Content
const OshaLogTab = ({ userId, onSelectIncident }) => {
    const [subTab, setSubTab] = useState('Recorded Incidents');
    const [incidents, setIncidents] = useState([]);
    const [hours, setHours] = useState([]);
    const [loading, setLoading] = useState(true);
    const [year, setYear] = useState(new Date().getFullYear());
    const [hoursEntry, setHoursEntry] = useState({ month: '', hours: '' });
    
    useEffect(() => {
        if (!userId) return;
        setLoading(true);
        // Fetch OSHA Recordable Incidents
        const incidentsQuery = query(collection(db, 'incidents'), where('isOshaRecordable', '==', true));
        const unsubIncidents = onSnapshot(incidentsQuery, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setIncidents(data);
            setLoading(false);
        });

        // Fetch Hours Worked
        const hoursQuery = query(collection(db, 'hoursWorked'));
        const unsubHours = onSnapshot(hoursQuery, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a,b) => a.month.localeCompare(b.month));
            setHours(data);
        });

        return () => {
            unsubIncidents();
            unsubHours();
        };
    }, [userId]);

    const handleSaveHours = async (e) => {
        e.preventDefault();
        if (!hoursEntry.month || !hoursEntry.hours) return;
        try {
            await addDoc(collection(db, 'hoursWorked'), {
                month: hoursEntry.month,
                hours: parseFloat(hoursEntry.hours),
                year: parseInt(hoursEntry.month.split('-')[0], 10),
                submittedBy: userId,
                submittedAt: serverTimestamp(),
            });
            setHoursEntry({ month: '', hours: '' });
        } catch (error) {
            console.error("Error saving hours:", error);
        }
    };
    
    return (
        <div className="flex gap-4">
            <div className="w-1/5">
                <nav className="flex flex-col gap-2">
                    {['Recorded Incidents', 'Hours Worked', 'OSHA Forms'].map(tabName => (
                        <button key={tabName} onClick={() => setSubTab(tabName)} className={`p-3 rounded-md text-left font-semibold ${subTab === tabName ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}`}>
                            {tabName}
                        </button>
                    ))}
                </nav>
            </div>
            <div className="w-4/5 bg-gray-800 p-4 rounded-lg">
                {subTab === 'Recorded Incidents' && (
                    <div>
                        <h3 className="text-xl font-bold mb-4">OSHA Recordable Incidents ({year})</h3>
                        {loading ? <p>Loading...</p> : (
                            <div className="space-y-3">
                                {incidents.filter(inc => inc.dateOfIncident?.startsWith(year)).map((inc, index) => (
                                    <div key={inc.id} className="bg-gray-700 p-3 rounded-md">
                                        <p className="font-bold">{String(index + 1).padStart(2, '0')} | {inc.id.substring(0,8)}... | {inc.dateOfIncident}</p>
                                        <p className="text-sm">Type: {inc.type}</p>
                                        <div className="mt-2">
                                            <button onClick={() => onSelectIncident(inc)} className="text-blue-400 text-sm hover:underline">Open Incident Report</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                )}
                {subTab === 'Hours Worked' && (
                    <div>
                        <h3 className="text-xl font-bold mb-4">Hours Worked ({year})</h3>
                        <form onSubmit={handleSaveHours} className="flex gap-2 mb-4 p-2 bg-gray-900/50 rounded-md">
                            <input type="month" value={hoursEntry.month} onChange={e => setHoursEntry({...hoursEntry, month: e.target.value})} className="bg-gray-700 p-2 rounded-md" required />
                            <input type="number" placeholder="Total hours" value={hoursEntry.hours} onChange={e => setHoursEntry({...hoursEntry, hours: e.target.value})} className="bg-gray-700 p-2 rounded-md" required />
                            <button type="submit" className="bg-blue-600 p-2 rounded-md font-semibold">Submit</button>
                        </form>
                        <div className="space-y-2">
                            {hours.filter(h => h.year === year).map(h => (
                                <div key={h.id} className="bg-gray-700 p-3 rounded-md flex justify-between items-center">
                                    <p><span className="font-bold">{h.month}</span>: {h.hours.toLocaleString()} hours</p>
                                    <span className="text-xs text-gray-400">Submitted: {h.submittedAt?.toDate().toLocaleDateString()}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
                {subTab === 'OSHA Forms' && (
                    <div>
                        <h3 className="text-xl font-bold mb-4">Generate OSHA Forms ({year})</h3>
                        <p className="text-gray-400 mb-4">This section will allow generation of PDF and CSV exports for official OSHA submissions.</p>
                        <div className="space-y-3">
                            <button className="w-full bg-gray-700 hover:bg-gray-600 p-3 rounded-md text-left">Generate OSHA 300 Log - PDF</button>
                            <button className="w-full bg-gray-700 hover:bg-gray-600 p-3 rounded-md text-left">Generate OSHA 300A Summary - PDF</button>
                             <button className="w-full bg-gray-700 hover:bg-gray-600 p-3 rounded-md text-left">Generate OSHA 300/301 Case Data - .csv</button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// Regulatory Interactions Tab Content
const RegulatoryInteractionsTab = ({ userId }) => {
    const [interactions, setInteractions] = useState([]);
    const [loading, setLoading] = useState(true);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [formData, setFormData] = useState({});

    useEffect(() => {
        if (!userId) return;
        setLoading(true);
        const q = query(collection(db, 'regulatoryInteractions'));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setInteractions(data);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [userId]);
    
    const handleSave = async (e) => {
        e.preventDefault();
        try {
            await addDoc(collection(db, 'regulatoryInteractions'), { ...formData, createdAt: serverTimestamp(), createdBy: userId });
            setIsModalOpen(false);
            setFormData({});
        } catch (error) {
            console.error("Error saving interaction:", error);
        }
    };

    const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});

    return (
        <div>
             <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="New Regulatory Interaction" size="2xl">
                <form onSubmit={handleSave}>
                    <FormSelect label="Interaction Type" name="type" value={formData.type} onChange={handleChange} required options={[
                        {value: 'Agency Inspection', label: 'Agency Inspection'},
                        {value: 'Environmental Release Notification', label: 'Environmental Release Notification'},
                        {value: 'Agency Request/Inquiry', label: 'Agency Request/Inquiry'},
                        {value: 'Other', label: 'Other'},
                    ]} />
                    <FormInput label="Agency Name" name="agency" value={formData.agency} onChange={handleChange} required />
                    <FormInput label="Date of Interaction" name="date" type="date" value={formData.date} onChange={handleChange} required />
                    <FormInput label="Summary" name="summary" type="textarea" value={formData.summary} onChange={handleChange} required />
                    <div className="mt-6 flex justify-end">
                        <button type="submit" className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded">Save Interaction</button>
                    </div>
                </form>
            </Modal>
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-xl font-bold">All Interactions</h3>
                <button onClick={() => setIsModalOpen(true)} className="flex items-center bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded">
                    <Plus size={20} className="mr-2" />
                    New Interaction
                </button>
            </div>
            {loading ? <p>Loading...</p> : (
                <div className="space-y-3">
                    {interactions.map(item => (
                        <div key={item.id} className="bg-gray-800 p-4 rounded-lg">
                            <div className="flex justify-between">
                                <p className="font-bold">{item.type} with {item.agency}</p>
                                <p className="text-sm text-gray-400">{item.date}</p>
                            </div>
                            <p className="text-sm mt-2">{item.summary}</p>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

// Main container for the Incidents & Events module
const IncidentsAndEvents = ({ userId }) => {
    const [activeTab, setActiveTab] = useState('Incidents');
    const [selectedIncident, setSelectedIncident] = useState(null);

    const renderContent = () => {
        if (selectedIncident) {
            return <IncidentDetailView incident={selectedIncident} onBack={() => setSelectedIncident(null)} />;
        }

        switch (activeTab) {
            case 'Incidents':
                return <IncidentsTab userId={userId} onSelectIncident={setSelectedIncident} />;
            case 'OSHA Log':
                return <OshaLogTab userId={userId} onSelectIncident={setSelectedIncident} />;
            case 'Regulatory Interactions':
                return <RegulatoryInteractionsTab userId={userId} />;
            default:
                return null;
        }
    };

    return (
        <div>
            <h1 className="text-3xl font-bold mb-4">Incidents & Events</h1>
            {!selectedIncident && (
                <div className="flex border-b border-gray-700 mb-6">
                    {['Incidents', 'OSHA Log', 'Regulatory Interactions'].map(tab => (
                        <button
                            key={tab}
                            onClick={() => setActiveTab(tab)}
                            className={`py-2 px-4 text-lg font-semibold ${activeTab === tab ? 'border-b-2 border-blue-500 text-white' : 'text-gray-400 hover:text-white'}`}
                        >
                            {tab}
                        </button>
                    ))}
                </div>
            )}
            {renderContent()}
        </div>
    );
};

const PlaceholderPage = ({ title }) => (
    <div>
        <h1 className="text-3xl font-bold mb-6">{title}</h1>
        <div className="bg-gray-800 p-10 rounded-lg text-center">
            <p className="text-xl text-gray-400">This module is under construction.</p>
            <p className="mt-2">Functionality for {title} will be implemented here based on the provided documentation.</p>
        </div>
    </div>
);


// --- Main App Component ---
export default function App() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState('dashboard');

    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
            setUser(currentUser);
            setLoading(false);
        });

        const performSignIn = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                setLoading(false);
            }
        };

        performSignIn();

        return () => unsubscribe();
    }, []);

    const renderPage = () => {
        switch (currentPage) {
            case 'dashboard':
                return <Dashboard />;
            case 'incidents':
                return <IncidentsAndEvents userId={user?.uid} />;
            case 'hazards':
                return <PlaceholderPage title="Hazards & Risks" />;
            case 'training':
                return <PlaceholderPage title="Training & People" />;
            case 'documents':
                return <PlaceholderPage title="Documents & Records" />;
            case 'environmental':
                return <PlaceholderPage title="Environmental" />;
            case 'contractors':
                return <PlaceholderPage title="Contractors" />;
            case 'tasks':
                return <PlaceholderPage title="Tasks & Scheduling" />;
            case 'admin':
                return <PlaceholderPage title="Admin Settings" />;
            default:
                return <Dashboard />;
        }
    };

    if (loading) {
        return <div className="bg-gray-900 text-white h-screen flex items-center justify-center text-xl">Loading Safety Sidekick...</div>;
    }

    return (
        <div className="flex h-screen bg-gray-900 text-white font-sans">
            <Sidebar currentPage={currentPage} setCurrentPage={setCurrentPage} />
            <main className="flex-1 p-8 overflow-y-auto bg-gray-800/50">
                <div className="max-w-7xl mx-auto">
                    {renderPage()}
                </div>
            </main>
        </div>
    );
}
