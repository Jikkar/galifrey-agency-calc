<meta>
 
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 
 <title>
  Safety Sidekick
 </title>
 <script src="https://cdn.tailwindcss.com">
 </script>
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
 <!-- FullCalendar JS and CSS -->
 <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js">
 </script>
 <style>
  body { font-family: 'Inter', sans-serif; }
        .view { display: none; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 50;
            justify-content: center; align-items: center; animation: fadeInBackdrop 0.3s;
        }
        @keyframes fadeInBackdrop { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { max-height: 90vh; animation: slideInUp 0.4s; }
        @keyframes slideInUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .app-content { display: none; }
        .app-content.active { display: block; }
        nav a.active { background-color: #374151; /* bg-gray-700 */ }
        /* FullCalendar Customizations */
        :root {
            --fc-border-color: #e5e7eb;
            --fc-daygrid-event-dot-width: 8px;
            --fc-list-event-dot-width: 10px;
            --fc-list-event-hover-bg-color: #f3f4f6;
        }
        .fc .fc-toolbar-title { font-size: 1.5em; font-weight: 600; }
        .fc .fc-button-primary { background-color: #4f46e5; border-color: #4f46e5; }
        .fc .fc-button-primary:hover { background-color: #4338ca; }
        .fc .fc-daygrid-day.fc-day-today { background-color: #eef2ff; }
        .fc-event { cursor: pointer; }
 </style>
 <!-- Main Application Container -->
 <div id="app" class="h-screen w-screen flex flex-col">
  <!-- Loading Spinner -->
  <div id="loading-view" class="view flex items-center justify-center h-full">
   <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
    </circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
    </path>
   </svg>
  </div>
  <!-- Error View -->
  <div id="error-view" class="view">
  </div>
  <!-- Auth Views -->
  <div id="admin-setup-view" class="view">
  </div>
  <div id="login-view" class="view">
  </div>
  <!-- Main App View -->
  <div id="main-app-view" class="view h-full w-full flex">
   <!-- Sidebar Navigation -->
   <nav class="bg-gray-800 text-white w-64 p-4 space-y-6 flex-shrink-0 flex flex-col">
    <div>
     <h2 class="text-2xl font-bold text-white">
      Safety Sidekick
     </h2>
    </div>
    <ul class="space-y-2 flex-1">
     <li>
      <a href="#" class="flex items-center p-2 rounded-md hover:bg-gray-700 transition-colors" data-view="dashboard-view">
       üìÖ Dashboard
      </a>
     </li>
     <li>
      <a href="#" class="flex items-center p-2 rounded-md hover:bg-gray-700 transition-colors" data-view="incidents-view">
       üìÑ Incidents &amp; Events
      </a>
     </li>
     <li>
      <a href="#" class="flex items-center p-2 rounded-md hover:bg-gray-700 transition-colors" data-view="tasks-view">
       üóÇÔ∏è Tasks &amp; Scheduling
      </a>
     </li>
     <li id="admin-nav-link" class="hidden">
      <a href="#" class="flex items-center p-2 rounded-md hover:bg-gray-700 transition-colors" data-view="admin-settings-view">
       ‚öôÔ∏è Admin Settings
      </a>
     </li>
    </ul>
    <div class="flex-shrink-0 border-t border-gray-700 pt-4">
     <p id="user-display-name" class="text-sm font-medium text-white">
     </p>
     <p id="user-display-email" class="text-xs text-gray-400">
     </p>
     <button id="logout-button" class="mt-2 text-sm text-indigo-400 hover:text-indigo-300 w-full text-left">
      Logout
     </button>
    </div>
   </nav>
   <!-- Main Content Area -->
   <main class="flex-1 p-6 overflow-y-auto bg-gray-50">
    <!-- Dashboard Content -->
    <div id="dashboard-view" class="app-content">
     <h1 class="text-3xl font-bold text-gray-900 mb-4">
      Compliance Calendar
     </h1>
     <div id="calendar" class="bg-white p-4 rounded-lg shadow">
     </div>
    </div>
    <!-- Incidents Content -->
    <div id="incidents-view" class="app-content">
    </div>
    <!-- Tasks Content -->
    <div id="tasks-view" class="app-content">
    </div>
    <!-- Admin Settings Content -->
    <div id="admin-settings-view" class="app-content">
    </div>
   </main>
  </div>
 </div>
 <!-- Modals Container -->
 <div id="modal-container">
 </div>
 <!-- Firebase SDK -->
 <script type="module">
  // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, serverTimestamp, onSnapshot, query, orderBy, where, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA_iRaOVHrnqOS3K4haYdGEHWs1pQqsiF4",
            authDomain: "safetysidekick-9252d.firebaseapp.com",
            projectId: "safetysidekick-9252d",
            storageBucket: "safetysidekick-9252d.firebasestorage.app",
            messagingSenderId: "976365120737",
            appId: "1:976365120737:web:8d6d675acd6c4d5c389ba0"
        };
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // --- Global State & Listeners ---
        let currentUser = null;
        let currentUserData = {};
        let allUsers = [];
        let calendar;
        let unsubscribe = {};
        // --- Core App Logic ---
        const App = {
            // Initialization
            init() {
                this.showView('loading-view');
                this.handleAuthChanges();
                this.attachNavListeners();
                document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
            },
            // Authentication Handler
            handleAuthChanges() {
                onAuthStateChanged(auth, async (user) => {
                    try {
                        this.cleanupListeners();
                        if (user) {
                            const userDoc = await getDoc(doc(db, "users", user.uid));
                            if (userDoc.exists()) {
                                currentUser = user;
                                currentUserData = { id: user.uid, ...userDoc.data() };
                                await this.loadMainApp();
                            } else {
                                // This handles the race condition where auth exists but doc doesn't.
                                // It could be a new user signing up. We log them out to ensure a clean state.
                                // The user can then log in normally.
                                console.warn("User exists in Auth but not in Firestore. Logging out for safety.");
                                await signOut(auth);
                            }
                        } else {
                            currentUser = null;
                            currentUserData = {};
                            const usersCollection = collection(db, "users");
                            const userSnapshot = await getDocs(usersCollection);
                            const usersExist = userSnapshot.size > 0;
                            this.showView(usersExist ? 'login-view' : 'admin-setup-view');
                        }
                    } catch (error) {
                        console.error("Critical Auth/Firestore error:", error);
                        // Show a dedicated error screen instead of hanging.
                        this.showView('error-view', { message: `Could not connect to the database. Please check your Firebase setup and security rules. <br><br><b>Common Fix:</b> In the Firebase Console -> Firestore Database -> Rules, ensure unauthenticated users can check if the 'users' collection is empty. <br><br><b>Error:</b> ${error.message}` });
                    }
                });
            },
            // Load Main Application after Login
            async loadMainApp() {
                this.renderAppShell();
                this.showView('main-app-view');
                this.showAppContent('dashboard-view');
                this.attachRealtimeListeners();
            },
            // Attach Real-time Data Listeners
            attachRealtimeListeners() {
                // Listen for tasks for the calendar
                const tasksQuery = query(collection(db, "tasks"));
                unsubscribe.tasks = onSnapshot(tasksQuery, (snapshot) => {
                    const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.renderCalendar(tasks);
                    this.renderTasksView(tasks); // Also update the tasks list view
                });
                // Listen for incidents
                const incidentsQuery = query(collection(db, "incidents"), orderBy("dateReported", "desc"));
                unsubscribe.incidents = onSnapshot(incidentsQuery, (snapshot) => {
                    const incidents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.renderIncidentsView(incidents);
                });
                // Listen for all users if admin
                if (currentUserData.role === 'Platform Admin') {
                    const usersQuery = query(collection(db, "users"), orderBy("email"));
                    unsubscribe.users = onSnapshot(usersQuery, (snapshot) => {
                        allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.renderAdminView(allUsers);
                    });
                }
            },
            // Cleanup Listeners on Logout
            cleanupListeners() {
                Object.values(unsubscribe).forEach(unsub => unsub && unsub());
                unsubscribe = {};
            },
            // --- View & Component Rendering ---
            showView(viewId, data = {}) {
                document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
                const view = document.getElementById(viewId);
                if (view) {
                    if (this.templates[viewId]) {
                        view.innerHTML = this.templates[viewId](data);
                        this.attachFormListeners(viewId);
                    }
                    view.style.display = 'flex';
                }
            },
            showAppContent(viewId) {
                document.querySelectorAll('.app-content').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
                const content = document.getElementById(viewId);
                const link = document.querySelector(`nav a[data-view="${viewId}"]`);
                if (content) content.classList.add('active');
                if (link) link.classList.add('active');
            },
            renderAppShell() {
                document.getElementById('user-display-name').textContent = currentUserData.displayName || 'No Name';
                document.getElementById('user-display-email').textContent = currentUser.email;
                document.getElementById('admin-nav-link').style.display = currentUserData.role === 'Platform Admin' ? 'block' : 'none';
            },
            renderCalendar(tasks = []) {
                const calendarEl = document.getElementById('calendar');
                if (!calendarEl) return;
                const events = tasks.map(task => ({
                    id: task.id,
                    title: task.title,
                    start: task.dueDate?.toDate(),
                    allDay: true,
                    backgroundColor: this.utils.getPriorityColor(task.priority),
                    borderColor: this.utils.getPriorityColor(task.priority),
                    extendedProps: task
                }));
                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                } else {
                    calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                        events: events,
                        eventClick: (info) => {
                            this.renderModal('taskDetail', info.event.extendedProps);
                        }
                    });
                    calendar.render();
                }
            },
            renderIncidentsView(incidents = []) {
                const view = document.getElementById('incidents-view');
                if (!view) return;
                view.innerHTML = this.templates.incidentsView(incidents);
                view.querySelector('#new-incident-btn')?.addEventListener('click', () => this.renderModal('incidentForm'));
            },
            renderTasksView(tasks = []) {
                const view = document.getElementById('tasks-view');
                if (!view) return;
                view.innerHTML = this.templates.tasksView(tasks, allUsers);
                view.querySelector('#new-task-btn')?.addEventListener('click', () => this.renderModal('taskForm', {}, allUsers));
            },
            renderAdminView(users = []) {
                const view = document.getElementById('admin-settings-view');
                if (!view) return;
                view.innerHTML = this.templates.adminView(users);
                this.attachFormListeners('admin-settings-view');
            },
            renderModal(type, data = {}, users = []) {
                const container = document.getElementById('modal-container');
                container.innerHTML = this.templates.modals[type](data, users);
                container.querySelector('.modal-backdrop').style.display = 'flex';
                this.attachModalListeners(type, data);
            },
            closeModal() {
                document.getElementById('modal-container').innerHTML = '';
            },
            // --- Event & Form Listeners ---
            attachNavListeners() {
                document.querySelectorAll('nav a[data-view]').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showAppContent(e.currentTarget.getAttribute('data-view'));
                    });
                });
            },
            attachFormListeners(viewId) {
                const view = document.getElementById(viewId);
                if (!view) return;
                const formHandlers = {
                    'admin-setup-view': this.handleAdminSetup,
                    'login-view': this.handleLogin,
                    'admin-settings-view': this.handleInviteUser
                };
                const handler = formHandlers[viewId];
                if (handler) {
                    const form = view.querySelector('form');
                    form?.addEventListener('submit', (e) => handler.call(this, e));
                }
            },
            attachModalListeners(type, data) {
                const modal = document.querySelector('.modal-backdrop');
                modal?.querySelector('.close-modal-btn')?.addEventListener('click', () => this.closeModal());
                modal?.addEventListener('click', (e) => {
                    if (e.target === modal) this.closeModal();
                });
                const form = modal?.querySelector('form');
                if (form) {
                    form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const payload = Object.fromEntries(formData.entries());
                        try {
                            if (type === 'incidentForm') await this.handleCreateIncident(payload);
                            if (type === 'taskForm') await this.handleCreateTask(payload);
                            if (type === 'taskDetail') await this.handleUpdateTask(data.id, payload);
                            this.closeModal();
                        } catch (error) {
                            console.error("Modal form error:", error);
                            form.querySelector('.form-error').textContent = error.message;
                            form.querySelector('.form-error').style.display = 'block';
                        }
                    });
                }
            },
            // --- Action Handlers (Firebase logic) ---
            async handleAdminSetup(e) {
                e.preventDefault();
                const form = e.target;
                const name = form.elements['name'].value;
                const email = form.elements['email'].value;
                const password = form.elements['password'].value;
                const errorDiv = form.querySelector('.form-error');
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        displayName: name, email, role: "Platform Admin", createdAt: serverTimestamp()
                    });
                    await this.seedDemoData(userCredential.user.uid);
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            },
            async handleLogin(e) {
                e.preventDefault();
                const form = e.target;
                const email = form.elements['email'].value;
                const password = form.elements['password'].value;
                const errorDiv = form.querySelector('.form-error');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    errorDiv.textContent = "Invalid credentials. Please try again.";
                    errorDiv.style.display = 'block';
                }
            },
            async handleInviteUser(e) {
                e.preventDefault();
                const form = e.target;
                const email = form.elements['invite-email'].value;
                const role = form.elements['invite-role'].value;
                const errorDiv = form.querySelector('.form-error');
                const successDiv = form.querySelector('.form-success');
                try {
                    // This creates a user doc, they will need to be told to sign up
                    await addDoc(collection(db, "users"), {
                        email, role, displayName: "Invited User", status: "invited", createdAt: serverTimestamp()
                    });
                    successDiv.textContent = `User profile for ${email} created. They can now sign up.`;
                    successDiv.style.display = 'block';
                    form.reset();
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                }
            },
            async handleCreateIncident(payload) {
                await addDoc(collection(db, "incidents"), {
                    ...payload,
                    riskCategory: payload.riskCategory.charAt(0),
                    reportedBy: currentUser.uid,
                    reportedByEmail: currentUser.email,
                    dateReported: serverTimestamp(),
                    status: "New"
                });
            },
            async handleCreateTask(payload) {
                await addDoc(collection(db, "tasks"), {
                    ...payload,
                    dueDate: new Date(payload.dueDate),
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    status: "Not Started"
                });
            },
            async handleUpdateTask(taskId, payload) {
                const taskRef = doc(db, "tasks", taskId);
                await updateDoc(taskRef, {
                    status: payload.status
                });
            },
            // --- Demo Data Seeding ---
            async seedDemoData(adminId) {
                const batch = writeBatch(db);
                // Demo Users
                const demoUsers = [
                    { uid: 'demo-supervisor-1', displayName: 'Jane Supervisor', email: 'supervisor@example.com', role: 'Supervisor' },
                    { uid: 'demo-employee-1', displayName: 'John Employee', email: 'employee@example.com', role: 'Employee' }
                ];
                demoUsers.forEach(user => {
                    const ref = doc(db, "users", user.uid);
                    batch.set(ref, { ...user, createdAt: serverTimestamp() });
                });
                // Demo Incidents
                const demoIncidents = [
                    { type: 'Near Miss', description: 'Forklift almost hit a pallet rack due to a blind corner.', riskCategory: 'C', status: 'New', reportedBy: 'demo-employee-1', reportedByEmail: 'employee@example.com' },
                    { type: 'Injury/Illness', description: 'Employee reported back pain after lifting heavy boxes.', riskCategory: 'D', status: 'In Progress', reportedBy: 'demo-supervisor-1', reportedByEmail: 'supervisor@example.com' }
                ];
                demoIncidents.forEach(incident => {
                    const ref = doc(collection(db, "incidents"));
                    batch.set(ref, { ...incident, dateReported: serverTimestamp() });
                });
                // Demo Tasks
                const today = new Date();
                const demoTasks = [
                    { title: 'Install convex mirror at warehouse corner', priority: 'High', status: 'Not Started', assignedTo: 'demo-supervisor-1', dueDate: new Date(new Date().setDate(today.getDate() + 3)) },
                    { title: 'Review manual lifting procedures with warehouse team', priority: 'Medium', status: 'In Progress', assignedTo: adminId, dueDate: new Date(new Date().setDate(today.getDate() + 7)) },
                    { title: 'Complete monthly fire extinguisher checks', priority: 'Low', status: 'Completed', assignedTo: 'demo-supervisor-1', dueDate: new Date(new Date().setDate(today.getDate() - 10)) }
                ];
                demoTasks.forEach(task => {
                    const ref = doc(collection(db, "tasks"));
                    batch.set(ref, { ...task, createdAt: serverTimestamp() });
                });
                await batch.commit();
            },
            // --- HTML Templates ---
            templates: {
                'error-view': (data) => `
                    <div class="w-full max-w-2xl p-8 space-y-6 bg-white rounded-xl shadow-xl text-center">
                        <h1 class="text-3xl font-bold text-red-600">Application Error</h1>
                        <p class="text-gray-600">There was a problem loading Safety Sidekick.</p>
                        <div class="mt-4 p-4 bg-red-50 border-l-4 border-red-400 text-red-700 text-left">
                           <p>${data.message}</p>
                        </div>
                    </div>`,
                'admin-setup-view': () => `
                    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-xl">
                        <div class="text-center"><h1 class="text-3xl font-bold text-gray-800">Welcome</h1><p class="text-gray-500">Create the first admin account to begin.</p></div>
                        <div class="form-error hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                        <form class="space-y-4">
                            <div><label for="name" class="text-sm font-medium text-gray-700">Full Name</label><input id="name" name="name" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label for="email" class="text-sm font-medium text-gray-700">Email</label><input id="email" name="email" type="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label for="password" class="text-sm font-medium text-gray-700">Password</label><input id="password" name="password" type="password" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Create Admin Account</button>
                        </form>
                    </div>`,
                'login-view': () => `
                    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-xl">
                        <div class="text-center"><h1 class="text-3xl font-bold text-gray-800">Sign In</h1><p class="text-gray-500">Welcome back to Safety Sidekick</p></div>
                        <div class="form-error hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                        <form class="space-y-4">
                            <div><label for="email" class="text-sm font-medium text-gray-700">Email</label><input id="email" name="email" type="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label for="password" class="text-sm font-medium text-gray-700">Password</label><input id="password" name="password" type="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Sign In</button>
                        </form>
                    </div>`,
                incidentsView: (incidents) => `
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-3xl font-bold text-gray-900">Incidents & Events</h1>
                        <button id="new-incident-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 shadow-sm">Report New Incident</button>
                    </div>
                    <div class="space-y-4">
                        ${incidents.length > 0 ? incidents.map(incident => `
                            <div class="bg-white p-4 rounded-lg shadow border-l-4 ${App.utils.getRiskBorderColor(incident.riskCategory)}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-lg text-gray-800">${incident.type}</p>
                                        <p class="text-sm text-gray-500">Reported by ${incident.reportedByEmail} on ${incident.dateReported?.toDate().toLocaleString() || 'N/A'}</p>
                                    </div>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full ${App.utils.getStatusPillColor(incident.status)}">${incident.status}</span>
                                </div>
                                <p class="mt-2 text-gray-700">${incident.description}</p>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-center py-8">No incidents found.</p>'}
                    </div>`,
                tasksView: (tasks, users) => `
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-3xl font-bold text-gray-900">Tasks & Scheduling</h1>
                        <button id="new-task-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 shadow-sm">Create New Task</button>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                           <thead class="bg-gray-50"><tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned To</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                           </tr></thead>
                           <tbody class="bg-white divide-y divide-gray-200">
                                ${tasks.length > 0 ? tasks.map(task => {
                                    const assignedUser = users.find(u => u.id === task.assignedTo);
                                    return `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task.title}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignedUser?.displayName || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.dueDate?.toDate().toLocaleDateString() || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" style="background-color:${App.utils.getPriorityColor(task.priority)}; color: white;">${task.priority}</span></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${App.utils.getStatusPillColor(task.status)}">${task.status}</span></td>
                                    </tr>
                                `}).join('') : '<tr><td colspan="5" class="text-center py-4">No tasks found.</td></tr>'}
                           </tbody>
                        </table>
                    </div>`,
                adminView: (users) => `
                    <h1 class="text-3xl font-bold text-gray-900">Admin Settings</h1>
                    <div class="mt-6 bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-semibold mb-4">Invite New User</h2>
                        <div class="form-success hidden p-3 mb-4 text-sm text-green-700 bg-green-100 rounded-lg"></div>
                        <div class="form-error hidden p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                        <form class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="invite-email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" name="invite-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                            <div>
                                <label for="invite-role" class="block text-sm font-medium text-gray-700">Role</label>
                                <select name="invite-role" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option>Employee</option><option>Supervisor</option><option>Safety Team</option><option>Platform Admin</option>
                                </select>
                            </div>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 shadow-sm w-full">Create User Profile</button>
                        </form>
                    </div>
                    <div class="mt-8">
                        <h2 class="text-xl font-semibold mb-4">Manage Users</h2>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                               <thead class="bg-gray-50"><tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                               </tr></thead>
                               <tbody class="bg-white divide-y divide-gray-200">
                                   ${users.map(user => `
                                       <tr>
                                           <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.displayName || 'N/A'}</td>
                                           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                                           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                                       </tr>
                                   `).join('')}
                               </tbody>
                            </table>
                        </div>
                    </div>`,
                modals: {
                    incidentForm: () => `
                        <div class="modal-backdrop">
                            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 space-y-4 modal-content overflow-y-auto">
                                <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">Report Incident</h2><button class="close-modal-btn text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button></div>
                                <div class="form-error hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                                <form class="space-y-4">
                                    <div><label for="type" class="block text-sm font-medium text-gray-700">Type</label><select name="type" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option>Injury/Illness</option><option>Near Miss</option><option>Property Damage</option><option>Environmental Event</option></select></div>
                                    <div><label for="description" class="block text-sm font-medium text-gray-700">Description</label><textarea name="description" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea></div>
                                    <div><label for="riskCategory" class="block text-sm font-medium text-gray-700">Risk</label><select name="riskCategory" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option>D (Low)</option><option>C (Medium)</option><option>B (High)</option><option>A (Critical)</option></select></div>
                                    <div class="flex justify-end space-x-3 pt-4"><button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Submit</button></div>
                                </form>
                            </div>
                        </div>`,
                    taskForm: (data, users) => `
                        <div class="modal-backdrop">
                            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 space-y-4 modal-content overflow-y-auto">
                                <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">Create Task</h2><button class="close-modal-btn text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button></div>
                                <div class="form-error hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                                <form class="space-y-4">
                                    <div><label for="title" class="block text-sm font-medium text-gray-700">Title</label><input type="text" name="title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                                    <div><label for="assignedTo" class="block text-sm font-medium text-gray-700">Assign To</label><select name="assignedTo" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">${users.map(u => `<option value="${u.id}">${u.displayName}</option>`).join('')}</select></div>
                                    <div><label for="dueDate" class="block text-sm font-medium text-gray-700">Due Date</label><input type="date" name="dueDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                                    <div><label for="priority" class="block text-sm font-medium text-gray-700">Priority</label><select name="priority" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option>Low</option><option>Medium</option><option>High</option><option>Critical</option></select></div>
                                    <div class="flex justify-end space-x-3 pt-4"><button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Create</button></div>
                                </form>
                            </div>
                        </div>`,
                    taskDetail: (task) => `
                        <div class="modal-backdrop">
                            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 space-y-4 modal-content overflow-y-auto">
                                <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">${task.title}</h2><button class="close-modal-btn text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button></div>
                                <div class="form-error hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                                <form class="space-y-4">
                                    <p><span class="font-semibold">Priority:</span> <span class="px-2 py-1 text-xs rounded-full" style="background-color:${App.utils.getPriorityColor(task.priority)}; color: white;">${task.priority}</span></p>
                                    <p><span class="font-semibold">Due:</span> ${task.dueDate?.toDate().toLocaleDateString()}</p>
                                    <div><label for="status" class="block text-sm font-medium text-gray-700">Update Status</label><select name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option ${task.status === 'Not Started' ? 'selected' : ''}>Not Started</option><option ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option><option ${task.status === 'Completed' ? 'selected' : ''}>Completed</option></select></div>
                                    <div class="flex justify-end space-x-3 pt-4"><button type="button" class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Update Status</button></div>
                                </form>
                            </div>
                        </div>`
                }
            },
            // --- Utility Functions ---
            utils: {
                getRiskBorderColor: (risk) => ({ 'A': 'border-red-500', 'B': 'border-orange-500', 'C': 'border-yellow-500', 'D': 'border-green-500' }[risk] || 'border-gray-400'),
                getStatusPillColor: (status) => ({ 'New': 'bg-blue-100 text-blue-800', 'In Progress': 'bg-yellow-100 text-yellow-800', 'Completed': 'bg-green-100 text-green-800' }[status] || 'bg-gray-100 text-gray-800'),
                getPriorityColor: (priority) => ({ 'Critical': '#ef4444', 'High': '#f97316', 'Medium': '#f59e0b', 'Low': '#22c55e' }[priority] || '#6b7280')
            }
        };
        // Start the application
        App.init();
 </script>