<meta>
 
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 
 <title>
  Galifrey Agency | Interactive Pricing Calculator
 </title>
 <script src="https://cdn.tailwindcss.com">
 </script>
 <script src="https://cdn.jsdelivr.net/npm/chart.js">
 </script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
 </script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js">
 </script>
<!-- START: Add these for Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<!-- Add this for URL compression -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
 <style>
  /* --- EPIC UI/UX STYLE UPLIFT (V2 - OPTIMIZED) --- */
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&display=swap');
        :root {
            --bg-primary: #f8f9fc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f2f5;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-tertiary: #9ca3af;
            --brand-primary: #4f46e5;
            --brand-secondary: #7c3aed;
            --brand-gradient: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-secondary) 100%);
            --accent-success: #16a34a;
            --accent-error: #dc2626;
            --accent-warning: #f59e0b;
            --border-primary: #e5e7eb;
            --border-focus: #a5b4fc;
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 20px 25px -5px rgba(79, 70, 229, 0.1), 0 8px 10px -6px rgba(79, 70, 229, 0.1);
            --radius-sm: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6; /* Improved default line height for readability */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .admin-view {
            background-color: #fff1f2;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }
        /* Main App Container */
        #app {
            max-width: 1600px;
            padding: 1rem md:2rem lg:3rem; /* Generous padding */
        }
        /* Header */
        header h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            background: var(--brand-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2; /* Prevent clipping on large text */
            letter-spacing: -0.02em;
            padding-bottom: 0.1em; /* Give space for letter descenders (e.g., 'g', 'y') */
        }
        header p {
            color: var(--text-secondary);
            max-width: 600px; /* Constrain line length for readability */
            margin-left: auto;
            margin-right: auto;
        }
        /* Tabs */
        #main-tabs {
            border-bottom: 2px solid var(--border-primary);
        }
        .tab {
            padding: 1rem; /* Increased padding */
            font-weight: 700;
            border-bottom: 4px solid transparent;
            margin-bottom: -2px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .tab.active {
            color: var(--brand-primary);
            border-image: var(--brand-gradient) 1;
        }
        .tab:not(.active):hover {
            color: var(--text-primary);
        }
        /* Base Card Style */
        .card-base {
            background-color: var(--bg-secondary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            border: 1px solid var(--border-primary);
            position: relative;
            overflow: hidden;
        }
        .card-base:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-md);
        }
        /* Package & Service Cards */
        .package-card, .service-card {
            background-color: var(--bg-secondary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            border: 2px solid transparent;
            overflow: visible;
            padding: 1.75rem; /* Increased padding */
        }
        .package-card:hover, .service-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }
        .service-card.selected {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 4px var(--border-focus);
            transform: translateY(-8px);
        }
        /* Accordions */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.7s cubic-bezier(0.16, 1, 0.3, 1), padding 0.5s ease;
            padding: 0 1.5rem;
        }
        .accordion-content.open {
            max-height: 5000px;
            padding: 1.5rem;
        }
        /* Summary Sidebar */
        #summary-sidebar {
            background: linear-gradient(180deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,1) 30%), var(--bg-secondary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-primary);
            backdrop-filter: blur(10px);
            padding: 2rem; /* Increased padding */
        }
        #summary-sidebar h2 {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            line-height: 1.3;
        }
        #detailed-summary .font-semibold {
            color: var(--text-primary);
        }
        #totals-section #total-investment {
            color: var(--brand-primary);
            font-weight: 800;
        }
        #totals-section > div {
            padding: 0.75rem 0; /* Spacing for total rows */
        }
        /* Buttons */
        .btn {
            padding: 0.8rem 1.75rem;
            border-radius: var(--radius-md);
            font-weight: 700;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: var(--shadow-sm);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            line-height: 1.2; /* Prevent text clipping in buttons */
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        .btn-primary {
            background: var(--brand-gradient);
            color: white;
        }
        .btn-success {
            background-color: var(--accent-success);
            color: white;
        }
        .btn-success:hover {
            background-color: #15803d;
        }
        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--brand-primary);
        }
        .btn-secondary:hover {
            background-color: #e0e7ff;
        }
        /* Assign btn classes */
        #request-quote-btn { background-color: var(--accent-success); color: white; padding: 1rem 1.75rem; } /* Make primary CTA larger */
        #request-quote-btn:hover { background-color: #15803D; box-shadow: var(--shadow-lg); transform: translateY(-2px); }
        #export-pdf-btn, button[data-action="select-package"] {
            background: var(--brand-gradient);
            color: white;
            padding: 0.8rem 1.75rem;
            border-radius: var(--radius-md);
            font-weight: 700;
        }
        #export-pdf-btn:hover, button[data-action="select-package"]:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        #apply-coupon-btn {
            background-color: var(--text-secondary);
            color: white;
            padding: 0.6rem 1rem;
            border-radius: var(--radius-sm);
        }
        #apply-coupon-btn:hover {
            background-color: var(--text-primary);
        }
        /* Forms */
        input[type='text'], input[type='number'], input[type='email'], input[type='tel'], input[type='url'], input[type='date'], textarea, select {
            background-color: var(--bg-tertiary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-sm);
            padding: 0.75rem 1rem; /* More spacious inputs */
            transition: border-color 0.3s, box-shadow 0.3s;
            width: 100%;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px var(--border-focus);
            background-color: var(--bg-secondary);
        }
        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: none; align-items: center; justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 1rem;
        }
        .modal-overlay[style*="display: flex"] {
            opacity: 1;
        }
        .modal-content {
            background-color: var(--bg-secondary);
            padding: 2rem;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-content h3, .modal-content h4 {
            line-height: 1.3; /* Ensure modal headers don't clip */
        }
        .modal-overlay[style*="display: flex"] .modal-content {
            transform: scale(1);
        }
        /* Badges */
        .recommendation-badge {
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--brand-gradient);
            color: white;
            font-size: 0.8rem;
            font-weight: 700;
            padding: 0.35rem 1rem;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            z-index: 5;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        .recommendation-badge svg {
            width: 1rem;
            height: 1rem;
        }
        /* Star Rating */
        .star-rating { display: inline-flex; flex-direction: row-reverse; justify-content: flex-end; }
        .star-rating input[type="radio"] { display: none; }
        .star-rating label { font-size: 2rem; color: #ddd; cursor: pointer; transition: color 0.2s, transform 0.2s; }
        .star-rating label:hover { transform: scale(1.2); }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label { color: var(--accent-warning); }
        /* Quote Panel in Admin */
        .quote-card-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .quote-card-content.open { max-height: 2000px; padding-top: 1.5rem; padding-bottom: 1.5rem; }
        /* Toast Notifications */
        #toast-container .bg-blue-500 { background: var(--brand-gradient); }
        #toast-container .bg-green-500 { background-color: var(--accent-success); }
        #toast-container .bg-red-500 { background-color: var(--accent-error); }
        /* Specificity overrides for Tailwind */
        .text-indigo-600 { color: var(--brand-primary) !important; }
        .bg-indigo-600 { background-color: var(--brand-primary) !important; }
        .hover\:bg-indigo-700:hover { background-color: var(--brand-secondary) !important; }
        .bg-green-600 { background-color: var(--accent-success) !important; }
        .hover\:bg-green-700:hover { background-color: #15803D !important; }
 </style>
 <div id="app" class="container mx-auto p-4 md:p-8">
    <div id="load-session-banner" class="hidden bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-4 rounded-lg mb-6 flex justify-between items-center">
        <p>
            <span class="font-bold">Welcome back!</span> We found a previously saved session.
        </p>
        <div>
            <button data-action="load-session" class="font-bold py-1 px-3 rounded-md bg-indigo-500 text-white hover:bg-indigo-600">Load Session</button>
            <button data-action="dismiss-load-banner" class="font-bold py-1 px-3 rounded-md hover:bg-indigo-200">Dismiss</button>
        </div>
    </div>
  <div id="campaign-modifier-banner" class="hidden bg-yellow-200 text-yellow-800 text-center p-2 rounded-lg mb-4">
  </div>
  <header class="text-center mb-8">
   <h1 class="text-3xl md:text-4xl font-bold text-gray-900">
    Galifrey Agency
   </h1>
   <p class="text-lg text-gray-600 mt-2">
    Interactive Pricing &amp; Campaign Calculator
   </p>
  </header>
  <div class="mb-6 border-b border-gray-200">
   <nav id="main-tabs" class="flex space-x-8" aria-label="Tabs">
    <button id="tab-packages" data-tab="packages" class="tab active py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
     Service Packages
    </button>
    <button id="tab-builder" data-tab="builder" class="tab py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
     Custom Campaign Builder
    </button>
    <button id="tab-augmentation" data-tab="augmentation" class="tab py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
     Team Augmentation
    </button>
    <button id="tab-admin" data-tab="admin" class="tab hidden py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
     Admin Panel
    </button>
    <button id="tab-quotes" data-tab="quotes" class="tab hidden py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
     Submitted Quotes
     <span id="quote-count-badge" class="hidden ml-2 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">
     </span>
    </button>
   </nav>
  </div>
  <div class="flex flex-col lg:flex-row gap-8">
   <!-- Main Content Area -->
   <div id="main-content" class="flex-grow lg:w-2/3">
    <div id="content-packages" data-content="packages">
    </div>
    <div id="content-builder" data-content="builder" class="hidden">
    </div>
    <div id="content-augmentation" data-content="augmentation" class="hidden">
        <!-- The calculator UI will be rendered here by JavaScript -->
    </div>
    <div id="content-admin" data-content="admin" class="hidden">
    </div>
    <div id="content-quotes" data-content="quotes" class="hidden">
    </div>
   </div>
   <!-- Sticky Summary Sidebar -->
   <aside id="summary-sidebar" class="lg:w-1/3 lg:sticky top-8 self-start bg-white p-6 rounded-2xl shadow-lg">
    <div class="border-b border-gray-200 mb-4">
     <nav id="summary-tabs" class="flex -mb-px" aria-label="Tabs">
      <button data-action="set-summary-tab" data-tab="summary" class="summary-tab active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm">
       Campaign Summary
      </button>
      <button data-action="set-summary-tab" data-tab="timeline" class="summary-tab whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm">
       Visual Timeline
      </button>
     </nav>
    </div>
    <div id="summary-tab-content-summary">
     <div class="text-center py-4" id="empty-summary-message">
      <p class="text-gray-500">
       Your selections will appear here.
      </p>
     </div>
     <div id="summary-content" class="hidden">
      <div id="detailed-summary" class="space-y-4 mb-4 max-h-[400px] overflow-y-auto pr-2">
       <!-- Detailed summary will be injected here -->
      </div>
      <div id="coupon-code-section" class="pt-4 border-t">
       <div class="flex items-center gap-2">
        <input type="text" id="coupon-code-input" placeholder="Enter Coupon Code" class="flex-grow p-2 border rounded-md text-sm">
        <button id="apply-coupon-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors text-sm">
         Apply
        </button>
       </div>
       <p id="coupon-status" class="text-xs mt-1 h-4">
       </p>
      </div>
      <div id="discounts-list" class="space-y-2 mb-4 pt-2">
      </div>
      <div id="totals-section" class="border-t pt-4 space-y-2">
       <div class="flex justify-between items-center">
        <span class="text-gray-600 font-medium">
         One-Time Fees
        </span>
        <div class="text-right flex items-center">
         <span id="total-one-time" class="text-lg font-bold text-gray-900">
          $0.00
         </span>
         <input type="number" id="override-one-time" data-input-action="update-override" data-id="oneTime" class="hidden admin-override-input ml-2 w-24 p-1 border rounded">
        </div>
       </div>
       <div class="flex justify-between items-center">
        <span class="text-gray-600 font-medium">
            Monthly Retainer<br><span class="text-xs text-gray-500">(to us)</span>
        </span>
        <div class="text-right flex items-center">
         <span id="total-monthly" class="text-lg font-bold text-gray-900">
          $0.00
         </span>
         <input type="number" id="override-monthly" data-input-action="update-override" data-id="monthly" class="hidden admin-override-input ml-2 w-24 p-1 border rounded">
        </div>
       </div>
       <div id="ad-spend-total-container" class="flex justify-between items-center hidden">
        <span class="text-gray-600 font-medium">
         Est. Ad Spend (to platforms)
        </span>
        <span id="total-ad-spend" class="text-lg font-bold text-gray-900">
         $0.00
        </span>
       </div>
       <div id="grand-total-container" class="border-t pt-4 mt-4 hidden">
        <div class="space-y-2">
         <div class="flex justify-between items-center">
          <span class="text-gray-800 font-bold text-lg">
           Total Upfront Cost
          </span>
          <span id="total-upfront" class="text-xl font-bold text-gray-900">
           $0.00
          </span>
         </div>
         <div class="flex justify-between items-center">
          <span class="text-indigo-700 font-bold text-lg">
           Total Est. Monthly Investment
          </span>
          <span id="total-investment" class="text-xl font-bold text-indigo-600">
           $0.00
          </span>
         </div>
        </div>
       </div>
      </div>
      <!-- ROI Sections -->
      <!-- This is the corrected version -->
<div id="value-articulation-section" class="mt-6 p-4 bg-indigo-50 rounded-lg hidden">
    <h4 class="font-bold text-indigo-800 mb-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"></path></svg>
        Your Strategic Value
    </h4>
    <ul id="value-propositions-list" class="list-disc list-inside text-sm text-indigo-700 space-y-1">
        <!-- Value propositions will be injected here -->
    </ul>
</div>
      <div id="roi-projection-section" class="mt-4 p-4 bg-green-50 rounded-lg hidden">
      </div>
      <div id="roi-forecast-section" class="mt-4 p-4 bg-blue-50 rounded-lg hidden">
    <!-- ROI Forecast will be injected here -->
</div>
      <!-- Action Buttons -->
      <div class="mt-6 space-y-3">
        <div class="grid grid-cols-2 gap-3">
        <button id="share-build-btn" data-action="share-build" class="w-full btn btn-secondary">Share Build</button>
        <button id="save-session-btn" data-action="save-session" class="w-full btn btn-secondary">Save Progress</button>
    </div>
       <button id="request-quote-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors">
        Request Formal Quote
       </button>
       <button id="generate-alternatives-btn" data-action="generate-alternatives" class="w-full bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors">
        Generate Alternative Proposals
       </button>
       <button id="export-pdf-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
        Export Full Summary to PDF
       </button>
      </div>
     </div>
    </div>
    <div id="summary-tab-content-timeline" class="hidden">
     <h3 class="text-xl font-bold mb-4">
      Project Timeline
     </h3>
     <div id="timeline-chart-container" style="height: 400px;">
      <canvas id="timeline-chart-canvas">
      </canvas>
     </div>
     <p class="text-xs text-gray-500 mt-2">
      This is an estimated timeline based on typical project pacing.
     </p>
    </div>
   </aside>
  </div>
 </div>
 <!-- Main Edit Modal -->
 <div id="edit-modal-overlay" class="modal-overlay">
  <div id="edit-modal-content" class="modal-content">
   <h3 class="text-2xl font-bold mb-6">
    Edit
   </h3>
   <form id="edit-form" class="space-y-4">
   </form>
  </div>
 </div>
 <!-- Modifier Options Sub-Modal -->
 <div id="modifier-options-modal" class="modal-overlay">
  <div id="modifier-options-modal-content" class="modal-content">
   <h3 id="modifier-options-modal-title" class="text-xl font-bold mb-4">
    Edit Options
   </h3>
   <form id="modifier-options-form" class="space-y-3">
   </form>
   <div class="mt-4 flex justify-between items-center">
    <button id="add-modifier-option-btn" class="bg-blue-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-600 text-sm">
     + Add Option
    </button>
    <div class="space-x-2">
     <button id="cancel-modifier-options-btn" class="bg-gray-200 py-2 px-3 rounded-lg text-sm hover:bg-gray-300">
      Cancel
     </button>
     <button id="save-modifier-options-btn" class="bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-indigo-700">
      Save Options
     </button>
    </div>
   </div>
  </div>
 </div>
 <!-- Campaign Modifier Modal -->
 <div id="campaign-modifier-modal" class="modal-overlay">
  <div id="campaign-modifier-modal-content" class="modal-content">
   <h3 id="campaign-modifier-modal-title" class="text-xl font-bold mb-4">
    Edit Campaign Modifier
   </h3>
   <div id="campaign-global-settings-form" class="p-4 bg-gray-100 rounded-lg mb-4">
   </div>
   <p class="text-sm text-gray-500 mb-4">
    Set specific prices for services in this campaign. Leave blank to use the default price.
   </p>
   <div id="campaign-modifier-form" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
   </div>
   <div class="mt-6 flex justify-end gap-4 border-t pt-4">
    <button data-action="close-campaign-modal" class="bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">
     Done
    </button>
   </div>
  </div>
 </div>
 <!-- Quote Request Modal -->
 <div id="quote-modal-overlay" class="modal-overlay">
  <div id="quote-modal-content" class="modal-content">
   <h3 class="text-2xl font-bold mb-4">
    Submit Your Quote Request
   </h3>
   <p class="text-sm text-gray-600 mb-6">
    Please provide your contact information. Your generated quote will be saved for our team to review.
   </p>
   <form id="quote-form" class="space-y-4">
    <div>
     <label class="block text-sm font-medium">
      Full Name
     </label>
     <input type="text" name="name" class="mt-1 block w-full p-2 border rounded-md" required="">
    </div>
    <div>
     <label class="block text-sm font-medium">
      Email Address
     </label>
     <input type="email" name="email" class="mt-1 block w-full p-2 border rounded-md" required="">
    </div>
    <div>
     <label class="block text-sm font-medium">
      Phone Number
     </label>
     <input type="tel" name="phone" class="mt-1 block w-full p-2 border rounded-md">
    </div>
    <div>
     <label class="block text-sm font-medium">
      Business Name
     </label>
     <input type="text" name="businessName" class="mt-1 block w-full p-2 border rounded-md">
    </div>
    <div class="flex justify-end gap-4 pt-4 border-t mt-6">
     <button type="button" data-action="close-quote-modal" class="bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">
      Cancel
     </button>
     <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">
      Submit Request
     </button>
    </div>
   </form>
  </div>
 </div>
 <!-- Alternative Proposals Modal -->
 <div id="alternatives-modal-overlay" class="modal-overlay">
  <div id="alternatives-modal-content" class="modal-content" style="max-width: 1200px;">
   <div class="flex justify-between items-center mb-6">
    <h3 class="text-2xl font-bold">
     Alternative Proposal Options
    </h3>
    <button data-action="close-alternatives-modal" class="text-gray-500 hover:text-gray-800">
     ×
    </button>
   </div>
   <div id="alternatives-content" class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Content will be injected here by generateAlternativeProposals() -->
   </div>
  </div>
 </div>
 <!-- START: Add this new modal -->
<div id="compare-modal-overlay" class="modal-overlay">
    <div id="compare-modal-content" class="modal-content" style="max-width: 1200px;">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold">Compare Packages</h3>
            <button data-action="close-compare-modal" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
        </div>
        <div id="compare-content" class="overflow-x-auto">
            <!-- Comparison table will be injected here by JavaScript -->
        </div>
    </div>
</div>
<!-- END: Add this new modal -->
     <!-- START: Add this new modal -->
    <div id="ab-test-modal-overlay" class="modal-overlay">
        <div id="ab-test-modal-content" class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">A/B Test Sample Size Planner</h3>
                <button data-action="close-ab-planner" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label for="ab-baseline-cvr" class="block text-sm font-medium">Baseline Conversion Rate (%)</label>
                        <input type="number" id="ab-baseline-cvr" value="" placeholder="e.g., 2.5" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="ab-mde" class="block text-sm font-medium">Minimum Detectable Effect (%)</label>
                        <p class="text-xs text-gray-500 mb-1">The smallest improvement you want to be able to detect (e.g., 10% lift).</p>
                        <input type="number" id="ab-mde" value="10" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="ab-significance" class="block text-sm font-medium">Statistical Significance</label>
                        <select id="ab-significance" class="mt-1 w-full p-2 border rounded-md">
                            <option value="0.80">80% (Directional)</option>
                            <option value="0.90">90% (Confident)</option>
                            <option value="0.95" selected>95% (Standard)</option>
                            <option value="0.99">99% (High Confidence)</option>
                        </select>
                    </div>
                    <button data-action="calculate-ab-sample-size" class="w-full btn btn-primary">Calculate</button>
                </div>
                <div id="ab-test-results-panel" class="p-6 bg-indigo-50 rounded-lg flex flex-col justify-center items-center text-center">
                    <p class="text-gray-500">Enter your test parameters and click "Calculate" to see the required sample size.</p>
                </div>
            </div>
        </div>
    </div>
    <!-- END: Add this new modal -->
    
 <!-- Toast Notification Container -->
 <div id="toast-container" class="fixed bottom-5 right-5 z-[200] space-y-2">
 </div>
 <script>
  document.addEventListener('DOMContentLoaded', function() {
    // ########## FIREBASE INITIALIZATION ##########
        const firebaseConfig = {
            apiKey: "AIzaSyCw4QA3yeLQHvOuCq6IO0qn4lIO2UzhlsU",
            authDomain: "agency-calc.firebaseapp.com",
            projectId: "agency-calc",
            storageBucket: "agency-calc.firebasestorage.app",
            messagingSenderId: "602758494985",
            appId: "1:602758494985:web:61f0cdaf04088ad471f1d8",
            measurementId: "G-DVV8FWWXXB"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let quotesListener = null; // To hold our real-time listener

        // This function will listen for real-time updates from Firebase
        function listenForQuotes() {
            // Unsubscribe from any previous listener to avoid duplicates
            if (quotesListener) {
                quotesListener();
            }

            const quotesCollection = db.collection("submittedQuotes").orderBy("timestamp", "desc");
            quotesListener = quotesCollection.onSnapshot((snapshot) => {
                const quotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSubmittedQuotes(quotes); // Re-render the list with fresh data
                updateQuoteCountBadge(quotes.length);
            }, (error) => {
                console.error("Error fetching quotes: ", error);
                showToast("Could not connect to the quotes database.", "error");
            });
        }
        // ##############################################
        // #region ########## DEFAULT CONFIGURATION ##########
        // START: REPLACE THIS ENTIRE OBJECT
const defaultConfig = {
    settings: {
        currencySymbol: "$",
        password: "galifreyadmin",
        pdfSettings: {
            logoUrl: 'https://placehold.co/150x50/4f46e5/ffffff?text=Galifrey',
            headerText: 'Galifrey Agency - Campaign Proposal',
            footerText: 'This estimate is valid for 30 days. Prices are subject to change.',
            introParagraph: 'Thank you for your interest in Galifrey Agency. This document outlines a preliminary estimate for the services discussed. We are committed to delivering tailored solutions and integrated digital excellence to help you achieve your goals.',
            nextSteps: 'To discuss this estimate further, please contact our sales team at sales@galifrey.agency or book a consultation call on our website.',
        },
        bundleDiscounts: [
            { threshold: 3, percentage: 0.05 },
            { threshold: 5, percentage: 0.10 },
        ],
        retainerTerms: [
            { name: "Month-to-Month", months: 1, discount: 0 },
            { name: "3 Months", months: 3, discount: 0.05 },
            { name: "6 Months", months: 6, discount: 0.10 },
            { name: "12 Months", months: 12, discount: 0.15 },
        ],
        adFeeTiers: [
            { threshold: 0, percentage: 0.20, minFee: 300 },
            { threshold: 5000, percentage: 0.18, minFee: 1000 },
            { threshold: 25000, percentage: 0.15, minFee: 4500 },
            { threshold: 50000, percentage: 0.12, minFee: 7500 },
        ],
        clientContext: {
            businessStages: ["Startup/Pre-launch", "Early Growth", "Established SMB", "Enterprise"],
            businessGoals: ["Increase brand awareness", "Generate more leads", "Drive direct sales", "Launch a new product/service"],
            geographicTargets: ["Local", "Regional", "National", "International"],
            pastMarketingOptions: ["SEO", "Social Media", "Paid Ads", "Email Marketing", "Traditional Ads", "None / Just Starting"],
            reasonsForSwitching: ["Price", "Service Quality", "Features", "Support", "Other"],
            referralSources: ["Web Search", "Social Media", "Referral", "Ad Campaign", "Other"],
            avgLeadValue: '',
            avgClv: '',
        },
        campaignModifiers: {},
        marketingDiscounts: [],
        valueArticulationEnabled: true,
    },
    // NEW: Team Augmentation Roles
    teamAugmentationRoles: [
        { id: 'role-seo', name: 'SEO Specialist', description: 'Dedicated expert for on-page, off-page, and technical SEO execution.', costPerHr: 95, minHrsPerMonth: 20, fullTimeSalaryComparison: 75000 },
        { id: 'role-ppc', name: 'PPC Manager', description: 'Manages and optimizes paid search and social campaigns.', costPerHr: 110, minHrsPerMonth: 15, fullTimeSalaryComparison: 85000 },
        { id: 'role-dev', name: 'Web Developer', description: 'For ongoing website feature development, integrations, and maintenance.', costPerHr: 125, minHrsPerMonth: 10, fullTimeSalaryComparison: 110000 }
    ],
    departments: [
        { id: 'dep-digital', name: 'DIGITAL', color: '#4f46e5' },
        { id: 'dep-social', name: 'SOCIAL', color: '#db2777' },
        { id: 'dep-studio', name: 'STUDIO', color: '#16a34a' },
    ],
    categories: [
        { id: 'cat-strategy', name: 'Strategy & Consulting', departmentId: 'dep-digital' },
        { id: 'cat-web', name: 'Web Solutions', departmentId: 'dep-digital' },
        { id: 'cat-seo', name: 'SEO & Content', departmentId: 'dep-digital' },
        { id: 'cat-dm', name: 'Digital Marketing', departmentId: 'dep-digital' },
        { id: 'cat-social-mgmt', name: 'Social Media Management', departmentId: 'dep-social' },
        { id: 'cat-social-creative', name: 'Social Creative & Ads', departmentId: 'dep-social' },
        { id: 'cat-photo', name: 'Photography', departmentId: 'dep-studio' },
        { id: 'cat-video', name: 'Video Production', departmentId: 'dep-studio' },
        { id: 'cat-audio', name: 'Audio Production', departmentId: 'dep-studio' },
    ],
    services: [
        {
            id: 's-blueprint', name: 'Galifrey Blueprint™', desc: 'A comprehensive discovery and strategy phase for complex projects.',
            model: 'Project', price: 3500, setupFee: 0, unit: '', categoryId: 'cat-strategy', modifiers: [],
            valuePropositions: ["Ensures project alignment with business goals.", "Reduces risks and costly revisions later.", "Provides a clear roadmap for execution."],
            priority: 'Core',
            roiMetrics: { metricName: 'Project Risk Reduction', metricUnit: '%', minImpact: 15, maxImpact: 30 },
            timeline: { phaseName: 'Phase 1: Discovery & Strategy', durationWeeks: 4, hidden: false },
            // --- NEW PROPERTIES ---
            dependencies: [],
            corequisite: '',
            tags: ['strategy', 'planning', 'core-service'],
            timelineDependsOn: ''
        },
        {
            id: 's-campaign-strategy', name: 'Campaign Strategy Development', desc: 'Meticulous design of integrated marketing campaigns...',
            model: 'Project', price: 2000, setupFee: 0, unit: '', categoryId: 'cat-strategy', modifiers: [],
            valuePropositions: ["Creates a cohesive plan for maximum impact.", "Optimizes budget allocation across channels.", "Sets clear, measurable KPIs for success."],
            priority: 'Core', roiMetrics: {},
            timeline: { phaseName: 'Phase 1: Discovery & Strategy', durationWeeks: 2, hidden: false },
            dependencies: ['s-blueprint'], // Example: Requires Blueprint first
            corequisite: '',
            tags: ['strategy', 'planning'],
            timelineDependsOn: 's-blueprint' // Example: Timeline dependency
        },
        {
            id: 's-web-custom', name: 'Custom Website (Galifrey Web/Duda)', desc: 'A bespoke, high-performance website built on the Duda platform...',
            model: 'Project', price: 4500, setupFee: 0, unit: '', categoryId: 'cat-web',
            valuePropositions: ["Optimized for Core Web Vitals and speed.", "Professionally designed to convert visitors.", "Easy for your team to manage content."],
            modifiers: [
                { id: 'mod-web-complex', name: 'Complexity', type: 'Dropdown', options: [ { name: 'Standard (5-10 pages)', adjustment: 0 }, { name: 'Advanced (11-25 pages)', adjustment: 2500 }, { name: 'Enterprise (25+ pages)', adjustment: 6000 } ]},
                { id: 'mod-web-duda-ecom', name: 'Duda E-commerce', type: 'Dropdown', options: [ { name: 'Not Included', adjustment: 0 }, { name: 'Basic Store (up to 100 products)', adjustment: 1500 }, { name: 'Advanced Store (up to 2500 products)', adjustment: 3000 } ]},
            ],
            priority: 'Core', roiMetrics: { metricName: 'Conversion Rate Lift', metricUnit: '%', minImpact: 1, maxImpact: 3 },
            timeline: { phaseName: 'Phase 3: Development & Launch', durationWeeks: 8, hidden: false },
            dependencies: ['s-blueprint'],
            corequisite: 's-web-maintenance', // Example: Automatically adds maintenance
            tags: ['website', 'core-service', 'development'],
            timelineDependsOn: 's-brand-design'
        },
        {
            id: 's-web-maintenance', name: 'Website Maintenance Retainer', desc: 'Keep your website secure, updated, and running smoothly.',
            model: 'Monthly', price: 250, setupFee: 0, unit: '', categoryId: 'cat-web', 
            valuePropositions: ["Protects against security vulnerabilities.", "Ensures optimal site performance.", "Provides peace of mind with regular backups."],
            modifiers: [ { id: 'mod-maint-ecom', name: 'Includes E-commerce Support', type: 'Checkbox', adjustment: 150 } ],
            priority: 'Recommended', roiMetrics: {},
            timeline: { phaseName: 'Ongoing', durationWeeks: 0, hidden: true },
            dependencies: [],
            corequisite: '',
            tags: ['website', 'support', 'retainer'],
            timelineDependsOn: ''
        },
        // ... (all other services would be similarly updated with the new empty properties)
    ],
    adChannels: [
        // ... (no changes needed here)
    ],
    packages: [
    {
        id: 'pkg-launchpad',
        name: 'Digital Launchpad',
        displayPrice: 5000,
        desc: 'Essential for new businesses or those needing a professional digital foundation. This package establishes your brand and launches your online presence.',
        features: 'Brand Strategy, Logo Design, Custom Website, Website Maintenance Retainer',
        services: [
            { id: 's-brand-strategy', quantity: 1, mods: {}, locked: true },
            { id: 's-logo-design', quantity: 1, mods: {}, locked: true },
            { id: 's-web-custom', quantity: 1, mods: {}, locked: false },
            { id: 's-web-maintenance', quantity: 1, mods: {}, locked: false }
        ]
    },
    {
        id: 'pkg-growth-engine',
        name: 'Growth Engine',
        displayPrice: 4500,
        desc: 'Designed for businesses ready to actively attract and engage customers. This package focuses on driving traffic and generating leads.',
        features: 'Comprehensive SEO Retainer, PPC Management, Paid Social Ads, Monthly Performance Reporting',
        services: [
            { id: 's-seo-retainer', quantity: 1, mods: {}, locked: true },
            { id: 's-ppc-management', quantity: 1, mods: {}, locked: true },
            { id: 's-paid-social-management', quantity: 1, mods: {}, locked: false },
            { id: 's-reporting-retainer', quantity: 1, mods: {}, locked: true }
        ]
    },
    {
        id: 'pkg-market-leader',
        name: 'Market Leader',
        displayPrice: 7500,
        desc: 'An integrated, all-in-one solution for established businesses aiming to dominate their market through a multi-channel strategy.',
        features: 'Fractional CMO, Comprehensive SEO, Social Media Management, Email Marketing, Promotional Video',
        services: [
            { id: 's-frac-cmo', quantity: 1, mods: {}, locked: true },
            { id: 's-seo-retainer', quantity: 1, mods: { "mod-seo-tier": "Aggressive (More Content/Links)" }, locked: true },
            { id: 's-social-management', quantity: 1, mods: { "mod-social-platforms": "3-4 Platforms" }, locked: false },
            { id: 's-email-management', quantity: 1, mods: {}, locked: false },
            { id: 's-video-promo', quantity: 1, mods: {}, locked: false }
        ]
    }
]
};
// END: REPLACE THIS ENTIRE OBJECT
        // #endregion
        // #region ########## APPLICATION STATE AND CORE LOGIC ##########
        let config = {};
        // START: REPLACE THIS OBJECT
        // START: REPLACE THIS OBJECT
        // START: REPLACE THIS OBJECT
let selections = {
    phases: [
        { id: `phase-${Date.now()}`, name: 'Phase 1: Campaign Selections', services: {}, adChannels: {} }
    ],
    activePhaseId: null,
    teamAugmentation: {},
    packagesToCompare: new Set(),
    clientContext: {
        businessStage: '', businessGoal: '', industry: '', targetAudience: '',
        geographicTarget: '', website: '',
        marketingHistory: [],
        previousProvider: '', previousServices: '', previousBudget: '', reasonForSwitching: '',
        durationWithProvider: '', satisfaction: 0, futureGoals: '', referralSource: '',
        avgLeadValue: '',
        avgClv: '',
        monthlyTraffic: '',
        conversionRate: '',
        avgSaleValue: '',
        // --- UPDATED: 'competitors' is now an array of objects, and 'socialUrls' is new ---
        competitors: [
            { url: '', notes: '' },
            { url: '', notes: '' },
            { url: '', notes: '' }
        ],
        socialUrls: [
            { url: '' },
            { url: '' },
            { url: '' }
        ]
    },
    overrides: { oneTime: null, monthly: null },
    appliedCoupon: null
};
        let isAdmin = false;
        let activeCampaign = null; 
        let openAccordions = new Set();
        let tempModifiers = [];
        let timelineChart = null; // For the new timeline chart instance
        const { jsPDF } = window.jspdf;

function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const sharedDataParam = urlParams.get('s');
    let sessionLoadedFromUrl = false;

    // Priority 1: Load from a shared URL parameter.
    if (sharedDataParam) {
        try {
            // DECODING PROCESS - Decodes the URL-safe Base64 string back to a Uint8Array
            const binaryString = atob(sharedDataParam.replace(/-/g, '+').replace(/_/g, '/'));
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            // Decompress the data
            const decompressed = pako.inflate(bytes, { to: 'string' });
            const sharedSelections = JSON.parse(decompressed);
            
            // Use the pure loadSession function to update the state.
            if (loadSession(sharedSelections)) {
                sessionLoadedFromUrl = true;
                showToast("Shared session loaded successfully!", "success");
                trackAnalytics('session_loaded', { source: 'URL' });

                // Clean the URL to prevent reloading the same shared data on refresh.
                try {
                    const cleanUrl = new URL(window.location);
                    cleanUrl.searchParams.delete('s');
                    window.history.replaceState({}, document.title, cleanUrl.href);
                } catch (urlError) {
                    console.warn("URL cleaning might be blocked by the environment.");
                }
            } else {
                 throw new Error("Invalid session data format from URL.");
            }
        } catch (e) {
            console.error("Failed to load from shared URL:", e);
            showToast("Could not load the shared link. It may be invalid or corrupted.", "error");
        }
    }

    // Priority 2: If no URL session, check for a local session to show the "Load" banner.
    if (!sessionLoadedFromUrl) {
        const savedSessionJSON = localStorage.getItem('galifreyCalcSession');
        if (savedSessionJSON) {
            document.getElementById('load-session-banner').classList.remove('hidden');
        }
    }

    // Standard application setup.
    activeCampaign = urlParams.get('campaign');
    loadConfig();
    setupEventListeners();
    listenForQuotes(); // Firebase listener

    // A single, final render call to draw the UI with either the shared data or the default state.
    renderAll();
}

        function loadConfig() {
            const savedConfig = localStorage.getItem('galifreyCalcConfig');
            try {
                config = savedConfig ? JSON.parse(savedConfig) : JSON.parse(JSON.stringify(defaultConfig));
                if (!config.settings) config.settings = defaultConfig.settings;
                if (!config.settings.clientContext) config.settings.clientContext = defaultConfig.settings.clientContext;
                if (!config.settings.campaignModifiers) config.settings.campaignModifiers = {}; 
                if (!config.settings.marketingDiscounts) config.settings.marketingDiscounts = [];
                if (!config.settings.retainerTerms) config.settings.retainerTerms = defaultConfig.settings.retainerTerms;
                if (!config.settings.bundleDiscounts) config.settings.bundleDiscounts = defaultConfig.settings.bundleDiscounts;
                if (!config.settings.pdfSettings) config.settings.pdfSettings = defaultConfig.settings.pdfSettings;
                if (!config.packages) config.packages = [];
                config.services.forEach(s => {
                    if (!s.modifiers) s.modifiers = [];
                    if (!s.valuePropositions) s.valuePropositions = [];
                });
            } catch (e) {
                console.error("Failed to parse config from localStorage, reverting to default.", e);
                config = JSON.parse(JSON.stringify(defaultConfig));
                showToast('Error loading configuration. Reverted to defaults.', 'error');
            }
        }
        function saveConfig() {
            try {
                localStorage.setItem('galifreyCalcConfig', JSON.stringify(config));
                trackAnalytics('config_saved');
                showToast('Configuration saved successfully!', 'success');
            } catch (e) {
                console.error("Failed to save config to localStorage", e);
                showToast('Error saving configuration.', 'error');
                return; // Stop if saving fails
            }
            // Render AFTER the save is complete and successful.
            // This prevents a rendering error from being caught by the save logic.
            renderAll();
        }
        function resetConfig() {
            if (confirm("Are you sure you want to reset all settings to their defaults? This will not affect submitted quotes or analytics.")) {
                config = JSON.parse(JSON.stringify(defaultConfig));
                // Also reset the entire selections object to a clean state
                const newPhaseId = `phase-${Date.now()}`;
                selections = {
                    phases: [{ id: newPhaseId, name: 'Phase 1: Campaign Selections', services: {}, adChannels: {} }],
                    activePhaseId: newPhaseId,
                    clientContext: {
                        businessStage: '', businessGoal: '', industry: '', targetAudience: '',
                        geographicTarget: '', website: '', competitors: ['', '', ''], marketingHistory: [],
                        previousProvider: '', previousServices: '', previousBudget: '', reasonForSwitching: '',
                        durationWithProvider: '', satisfaction: 0, futureGoals: '', referralSource: '',
                        avgLeadValue: '', avgClv: ''
                    },
                    overrides: { oneTime: null, monthly: null },
                    appliedCoupon: null
                };
                openAccordions = new Set();
                saveConfig(); // This will save the clean config and render the clean state
            }
        }
        function resetAnalytics() {
            if (confirm("Are you sure you want to permanently delete all usage analytics data? This action cannot be undone.")) {
                localStorage.removeItem('galifreyCalcAnalytics');
                trackAnalytics('analytics_reset');
                showToast('Usage analytics have been reset.', 'info');
                renderAdminPanel();
            }
        }
        function setupEventListeners() {
            document.getElementById('main-tabs').addEventListener('click', (e) => {
                if (e.target.matches('.tab')) {
                    switchTab(e.target.dataset.tab);
                }
            });
            document.addEventListener('keydown', e => {
                if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                    toggleAdminMode();
                }
            });
            document.getElementById('request-quote-btn').addEventListener('click', () => {
                document.getElementById('quote-modal-overlay').style.display = 'flex';
            });
            document.getElementById('export-pdf-btn').addEventListener('click', () => exportSummaryPDF(selections, 'Galifrey-Agency-Estimate.pdf'));
            document.getElementById('apply-coupon-btn').addEventListener('click', applyCoupon);
            document.body.addEventListener('click', handleDynamicClicks);
            document.body.addEventListener('change', handleDynamicChanges);
            document.body.addEventListener('input', handleDynamicInputs);
            document.getElementById('quote-form').addEventListener('submit', handleQuoteRequest);
            document.getElementById('edit-form').addEventListener('submit', handleAdminSaveEdit);
            document.getElementById('add-modifier-option-btn').addEventListener('click', () => addModifierOptionRow());
            document.getElementById('cancel-modifier-options-btn').addEventListener('click', closeModifierOptionsModal);
            document.getElementById('save-modifier-options-btn').addEventListener('click', saveModifierOptions);
        }
        // START: ADD THIS MISSING FUNCTION
function handleDynamicClicks(e) {
    const target = e.target.closest('[data-action]');
    if (!target) return;

    // This check is for the dedicated listener on the proposals modal.
    // It prevents this general listener from acting on those specific buttons.
    if (target.closest('#alternatives-content')) {
        return;
    }

    const action = target.dataset.action;
    const id = target.dataset.id;
    
    // A comprehensive switch statement that handles every possible action.
    switch (action) {
        // --- Session & Sharing ---
        case 'admin-clear-session': clearSessionData(); break;
        case 'save-session': saveSession(); break;
        case 'load-session':
            const savedJSON = localStorage.getItem('galifreyCalcSession');
            if (savedJSON) {
                const savedData = JSON.parse(savedJSON);
                if (loadSession(savedData)) {
                    showToast("Session loaded successfully!", "success");
                    renderAll();
                } else {
                    showToast("Could not load session. Data may be corrupt.", "error");
                }
            }
            target.closest('#load-session-banner').classList.add('hidden');
            break;
        case 'dismiss-load-banner': target.closest('#load-session-banner').classList.add('hidden'); break;
        case 'share-build': shareBuild(); break;

        // --- UI & Modals ---
        case 'compare-packages': renderCompareModal(); break;
        case 'close-compare-modal': document.getElementById('compare-modal-overlay').style.display = 'none'; break;
        case 'open-ab-planner': openABTestPlannerModal(); break;
        case 'close-ab-planner': document.getElementById('ab-test-modal-overlay').style.display = 'none'; break;
        case 'calculate-ab-sample-size': calculateABSampleSize(); break;
        case 'toggle-accordion': toggleAccordion(target); break;
        case 'close-modal': closeEditModal(); break;
        case 'close-quote-modal': document.getElementById('quote-modal-overlay').style.display = 'none'; break;
        case 'generate-alternatives': generateAlternativeProposals(); break;
        case 'close-alternatives-modal': document.getElementById('alternatives-modal-overlay').style.display = 'none'; break;

        // --- Core Calculator Actions ---
        case 'select-proposal': selectProposal(target.dataset.proposalType); break;
        case 'select-package': selectPackage(id); break;
        case 'toggle-service': if (e.target.closest('.service-config')) return; toggleService(id); break;
        case 'add-ad-channel-confirm': addAdChannel(); break;
        case 'remove-ad-channel': removeAdChannel(id); break;
        case 'clear-builder': clearBuilder(); break;
        case 'add-phase': const newPhaseName = prompt("Enter name for new phase:", `Phase ${selections.phases.length + 1}`); if (newPhaseName) { const newId = `phase-${Date.now()}`; selections.phases.push({ id: newId, name: newPhaseName, services: {}, adChannels: {} }); selections.activePhaseId = newId; renderBuilder(); } break;
        case 'delete-phase': if (confirm(`Are you sure you want to delete this phase?`)) { selections.phases = selections.phases.filter(p => p.id !== id); if (selections.activePhaseId === id) { selections.activePhaseId = selections.phases[0]?.id || null; } renderBuilder(); renderSummary(); } break;
        case 'set-active-phase': selections.activePhaseId = id; renderBuilder(); break;
        case 'set-summary-tab': setSummaryTab(target.dataset.tab); break;
        
        // --- Admin & Quote Actions (All restored) ---
        case 'admin-delete': handleAdminDelete(target); break;
        case 'admin-add': handleAdminAdd(target); break;
        case 'admin-edit': handleAdminEdit(target); break;
        case 'delete-quote': deleteQuote(id); break;
        case 'export-quote-pdf': exportQuotePDF(id); break;
        case 'toggle-quote-details': document.getElementById(`quote-content-${id}`).classList.toggle('open'); break;
        case 'move-category': moveCategory(id, target.dataset.direction); break;
        case 'add-campaign-modifier': addCampaignModifier(); break;
        case 'edit-campaign-modifier': openCampaignModifierModal(id); break;
        case 'delete-campaign-modifier': deleteCampaignModifier(id); break;
        case 'close-campaign-modal': document.getElementById('campaign-modifier-modal').style.display = 'none'; break;
        case 'edit-modifier-options': openModifierOptionsModal(target.dataset.modifierIndex); break;
        case 'add-service-modifier': addModifierRow(); break;
        case 'remove-service-modifier': removeModifierRow(target); break;
        case 'remove-modifier-option': target.closest('.modifier-option-row').remove(); break;
        case 'add-modifier-discount-tier': addDiscountTierRow(target); break;
        case 'remove-modifier-discount-tier': target.closest('.discount-tier-row').remove(); break;
        case 'add-package-service': addPackageServiceRow(); break;
        case 'remove-package-service': target.closest('.package-service-row').remove(); break;
        case 'save-version': saveVersion(); break;
        case 'load-version': loadVersion(target.dataset.key); break;
        case 'delete-version': deleteVersion(target.dataset.key); break;
        case 'reset-analytics': resetAnalytics(); break; // This was missing
        case 'update-satisfaction-rating': selections.clientContext.satisfaction = parseInt(target.value, 10); break;
    }
}
    
        // END: ADD THIS MISSING FUNCTION
        // #endregion
        // #region ########## DYNAMIC EVENT HANDLERS ##########
        // START: REPLACE THIS FUNCTION
        function handleDynamicChanges(e) {
            const target = e.target.closest('[data-change-action]');
            if (!target) return;
            const { changeAction, id, modifierId, path } = target.dataset;
            let value;
            if (target.type === 'checkbox') {
                value = target.checked;
            } else {
                value = target.value;
            }
            switch (changeAction) {
                case 'select-modifier': updateModifier(id, modifierId, value); break;
                case 'select-retainer-term': updateRetainerTerm(id, value); break;
                case 'update-client-context':
                    updateClientContext(id, value, target);
                    break;
                case 'update-modifier-type': handleModifierTypeChange(target); break;
                case 'update-admin-setting': 
                        setNestedValue(config, path, value);
                        renderAdminPanel();
                        break;
                    case 'update-campaign-global':
                    updateCampaignGlobal(id, path, value);
                    break;
                case 'update-timeline-setting':
                    updateTimelineSetting(id, target.dataset.setting, value);
                    break;
                // --- NEW: Handles the compare checkbox ---
                case 'toggle-compare-package':
                    if (value) { // if checked
                        selections.packagesToCompare.add(id);
                    } else { // if unchecked
                        selections.packagesToCompare.delete(id);
                    }
                    renderPackages(); // Re-render to show/hide the "Compare Selected" button
                    break;
            }
        }
        // END: REPLACE THIS FUNCTION
        function handleDynamicInputs(e) {
            const target = e.target.closest('[data-input-action]');
            if (!target) return;
            const { inputAction, id, modifierId, path, campaign } = target.dataset;
            const value = e.target.value;
            const numValue = parseFloat(value);
            switch (inputAction) {
                case 'update-quantity': updateQuantity(id, numValue); break;
                case 'update-modifier': updateModifier(id, modifierId, target.type === 'number' ? numValue : value); break;
                case 'update-ad-spend': updateAdSpend(id, numValue); break;
                case 'update-ad-setup': updateAdSetupFee(id, numValue); break;
                case 'update-client-context':
                    updateClientContext(id, value, target);
                    renderSummary(); 
                    break;
                case 'update-campaign-price':
                    updateCampaignPrice(campaign, id, value);
                    break;
                case 'update-campaign-package-price':
                    updateCampaignPackagePrice(campaign, id, value);
                    break;
                case 'update-admin-setting':
                        const finalValue = path.includes('percentage') || path.includes('discount') || path.includes('value') ? numValue / 100 : numValue;
                        setNestedValue(config, path, isNaN(finalValue) ? value : finalValue);
                        break;
                case 'update-override':
                    selections.overrides[id] = isNaN(numValue) || value === '' ? null : numValue;
                    renderSummary();
                    break;
                case 'update-campaign-global':
                    updateCampaignGlobal(id, path, value);
                    break;
                case 'update-timeline-setting':
                    updateTimelineSetting(id, target.dataset.setting, numValue);
                    break;
                case 'update-team-augmentation': // This case is new
                    updateTeamAugmentationHours(id, numValue);
                    break;
            }
        }
        // #endregion
        // #region ########## RENDER FUNCTIONS ##########
        // START: ADD THIS MISSING FUNCTION
        function renderAll() {
            renderPackages();
            renderBuilder();
            renderAugmentationCalculator();
            renderSummary();
            if (isAdmin) {
                renderAdminPanel();
                // renderSubmittedQuotes() is called by the real-time Firebase listener
            }
        }
        // END: ADD THIS MISSING FUNCTION
        // START: REPLACE THIS FUNCTION
        // START: REPLACE THIS FUNCTION
function renderPackages() {
    const container = document.getElementById('content-packages');
    if (!container) return;
    
    const campaignModifier = activeCampaign ? config.settings.campaignModifiers[activeCampaign] : null;
    const globalAdjust = campaignModifier?.globalAdjust;

    const processedPackages = config.packages.map(pkg => {
        let finalDisplayPrice = getCampaignPackagePrice(pkg.id) ?? pkg.displayPrice;

        if (getCampaignPackagePrice(pkg.id) === null && globalAdjust?.value) {
            if (globalAdjust.type === 'percent') {
                finalDisplayPrice *= (1 + globalAdjust.value);
            } else {
                finalDisplayPrice += globalAdjust.value;
            }
        }
        
        return { ...pkg, finalDisplayPrice };
    });

    processedPackages.sort((a, b) => a.finalDisplayPrice - b.finalDisplayPrice);

    const compareButtonHtml = selections.packagesToCompare.size >= 2 ? `
        <div class="flex justify-end mb-6">
            <button data-action="compare-packages" class="btn btn-secondary">
                Compare Selected (${selections.packagesToCompare.size})
            </button>
        </div>
    ` : '';

    container.innerHTML = `
        ${compareButtonHtml}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${processedPackages.map(pkg => {
                const displayPrice = pkg.finalDisplayPrice;
                const tempSelections = {
                    phases: [{ id: 'temp-phase', services: {} }],
                };
                pkg.services.forEach(s => {
                    const service = findService(s.id);
                    if (service) {
                        tempSelections.phases[0].services[s.id] = {
                            quantity: s.quantity || 1,
                            mods: s.mods || createDefaultModsForService(service),
                            termMonths: 1
                        };
                    }
                });
                
                const calculationResult = calculateTotals(tempSelections);
                const totalValue = calculationResult.breakdown.items.reduce((sum, item) => sum + item.cost, 0);
                
                const savings = totalValue > 0 && displayPrice > 0 ? totalValue - displayPrice : 0;
                const isRecommended = checkPackageRecommendation(pkg.id);
                const isCheckedForCompare = selections.packagesToCompare.has(pkg.id);

                return `
                <div class="package-card bg-white rounded-2xl shadow-md p-6 flex flex-col hover:shadow-xl transition-shadow duration-300 relative">
                    ${isRecommended ? `<div class="recommendation-badge"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" ></path></svg>Recommended</div>` : ''}
                    ${savings > 0 ? `<div class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-bl-lg rounded-tr-xl">SAVE ${formatCurrency(savings)}</div>` : ''}
                    <h3 class="text-2xl font-bold text-indigo-600">${pkg.name}</h3>
                    <p class="text-gray-500 mt-2 flex-grow">${pkg.desc}</p>
                    <div class="my-6">
                        <span class="text-4xl font-extrabold text-gray-900">${formatCurrency(displayPrice)}</span>
                        ${totalValue > 0 && savings > 0 ? `<span class="text-gray-500 line-through ml-2">${formatCurrency(totalValue)}</span>` : ''}
                    </div>
                    <ul class="space-y-2 text-sm text-gray-600 mb-6 flex-grow">
                        ${(pkg.features || '').split(',').map(f => `<li class="flex items-center"><svg class="w-4 h-4 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>${f.trim()}</li>`).join('')}
                    </ul>
                    <button data-action="select-package" data-id="${pkg.id}" class="mt-auto w-full btn btn-primary">Select Package</button>
                    <div class="mt-4 pt-4 border-t border-gray-200 text-center">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" data-change-action="toggle-compare-package" data-id="${pkg.id}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isCheckedForCompare ? 'checked' : ''}>
                            <span class="ml-2 text-sm text-gray-600">Compare</span>
                        </label>
                    </div>
                </div>`;
            }).join('')}
        </div>
    `;
}
// END: REPLACE THIS FUNCTION
        // END: REPLACE THIS FUNCTION
        // START: REPLACE THIS FUNCTION
function renderBuilder() {
    const container = document.getElementById('content-builder');
    if (selections.activePhaseId === null && selections.phases.length > 0) {
        selections.activePhaseId = selections.phases[0].id;
    }
    let phaseTabsHtml = selections.phases.map(phase => `...`).join(''); // This logic is unchanged
    container.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Build Your Campaign</h2>
            <button data-action="clear-builder" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors text-sm">Clear All Selections</button>
        </div>
        <div class="mb-6 border-b border-gray-200">
            <div class="flex items-center space-x-4">
                <nav class="flex -mb-px" aria-label="Phases">
                    ${selections.phases.map(phase => `
                        <div class="flex items-center group">
                            <button data-action="set-active-phase" data-id="${phase.id}" class="phase-tab text-sm font-medium border-b-2 py-2 px-4 ${selections.activePhaseId === phase.id ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">
                                ${phase.name}
                            </button>
                            ${selections.phases.length > 1 ? `<button data-action="delete-phase" data-id="${phase.id}" class="hidden group-hover:block text-red-400 hover:text-red-600 p-1 ml-1">&times;</button>` : ''}
                        </div>
                    `).join('')}
                </nav>
                <button data-action="add-phase" class="bg-gray-200 text-gray-600 hover:bg-gray-300 text-sm font-bold py-1 px-3 rounded-md">+ Add Phase</button>
            </div>
        </div>
        
        ${renderClientContextSection()}
        
        <!-- NEW PANELS ARE RENDERED HERE -->
        <div class="mt-6 space-y-4">
            ${renderRoiForecasterPanel()}
            ${renderCompetitorSnapshotPanel()}
        </div>

        <div class="space-y-4 mt-6">
            ${config.departments.map(dep => {
                const isOpen = openAccordions.has(dep.id);
                return `
                <div class="bg-white rounded-lg shadow-sm">
                    <button data-action="toggle-accordion" data-id="${dep.id}" class="w-full flex justify-between items-center p-4 text-left font-bold text-lg">
                        <span>${dep.name}</span>
                        <svg class="w-6 h-6 transform transition-transform ${isOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content ${isOpen ? 'open' : ''}">
                        <div class="p-4 border-t space-y-4">
                            ${config.categories.filter(cat => cat.departmentId === dep.id).map(cat => `
                                <div class="pl-4">
                                    <h4 class="font-semibold text-md mb-2 text-gray-700">${cat.name}</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        ${config.services.filter(s => s.categoryId === cat.id).map(s => renderServiceCard(s)).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `}).join('')}
             ${renderAdSpendSection()}
        </div>
    `;
    attachStarRatingListeners();
}
// END: REPLACE THIS FUNCTION
        // MODIFIED: Greatly expanded client context section
        function renderClientContextSection() {
    const { businessStages, businessGoals, reasonsForSwitching, referralSources } = config.settings.clientContext;
    const ctx = selections.clientContext;
    const isOpen = openAccordions.has('client-context');
    return `
        <div class="bg-white rounded-lg shadow-sm">
            <button data-action="toggle-accordion" data-id="client-context" class="w-full flex justify-between items-center p-4 text-left font-bold text-xl">
                <span>Tell Us About Yourself (Optional, but Recommended)</span>
                <svg class="w-6 h-6 transform transition-transform ${isOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div class="accordion-content ${isOpen ? 'open' : ''}">
                <div class="p-6 border-t space-y-8">
                    <!-- ROI & Value Inputs -->
                    <div id="roi-inputs-section">
                        <h4 class="font-semibold text-lg mb-3">ROI & Value Inputs</h4>
                        <p class="text-sm text-gray-500 mb-4">Providing these helps us project the potential value of your investment.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium">Average Value Per Lead ($)</label><input type="number" data-input-action="update-client-context" data-id="avgLeadValue" value="${ctx.avgLeadValue || ''}" class="mt-1 w-full p-2 border rounded-md"></div>
                            <div><label class="block text-sm font-medium">Customer Lifetime Value (CLV) ($)</label><input type="number" data-input-action="update-client-context" data-id="avgClv" value="${ctx.avgClv || ''}" class="mt-1 w-full p-2 border rounded-md"></div>
                        </div>
                    </div>
                    <!-- Previous Provider -->
                    <div id="previous-provider-section">
                        <h4 class="font-semibold text-lg mb-3">Previous Experience</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium">Previous Provider Name</label><input type="text" data-input-action="update-client-context" data-id="previousProvider" value="${ctx.previousProvider || ''}" class="mt-1 w-full p-2 border rounded-md"></div>
                            <div><label class="block text-sm font-medium">Services They Provided</label><input type="text" data-input-action="update-client-context" data-id="previousServices" value="${ctx.previousServices || ''}" class="mt-1 w-full p-2 border rounded-md"></div>
                            <div><label class="block text-sm font-medium">Previous Marketing Budget ($/mo)</label><input type="number" data-input-action="update-client-context" data-id="previousBudget" value="${ctx.previousBudget || ''}" class="mt-1 w-full p-2 border rounded-md"></div>
                            <div><label class="block text-sm font-medium">Duration with them</label><input type="text" data-input-action="update-client-context" data-id="durationWithProvider" placeholder="e.g., 2 years" value="${ctx.durationWithProvider || ''}" class="mt-1 w-full p-2 border rounded-md"></div>
                            <div>
                                <label class="block text-sm font-medium">Reason for Switching</label>
                                <select data-change-action="update-client-context" data-id="reasonForSwitching" class="mt-1 w-full p-2 border rounded-md">
                                    <option value="">Select...</option>
                                    ${reasonsForSwitching.map(s => `<option value="${s}" ${ctx.reasonForSwitching === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Satisfaction with Them</label>
                                <div class="star-rating">
                                    ${[5,4,3,2,1].map(star => `<input type="radio" id="star${star}" name="rating" value="${star}" data-action="update-satisfaction-rating" ${ctx.satisfaction === star ? 'checked' : ''}><label for="star${star}" title="${star} stars">&#9733;</label>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Goals & Background -->
                        <div>
                        <h4 class="font-semibold text-lg mb-3">Your Goals & Background</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Business Stage</label>
                                <select data-change-action="update-client-context" data-id="businessStage" class="w-full p-2 border rounded-md">
                                    <option value="">Select...</option>
                                    ${businessStages.map(s => `<option value="${s}" ${ctx.businessStage === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Primary Goal</label>
                                <select data-change-action="update-client-context" data-id="businessGoal" class="w-full p-2 border rounded-md">
                                    <option value="">Select...</option>
                                    ${businessGoals.map(g => `<option value="${g}" ${ctx.businessGoal === g ? 'selected' : ''}>${g}</option>`).join('')}
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">Tell us about your expectations and future goals</label>
                                <textarea data-input-action="update-client-context" data-id="futureGoals" class="mt-1 w-full p-2 border rounded-md h-20">${ctx.futureGoals || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">How did you hear about us?</label>
                                <select data-change-action="update-client-context" data-id="referralSource" class="mt-1 w-full p-2 border rounded-md">
                                    <option value="">Select...</option>
                                    ${referralSources.map(s => `<option value="${s}" ${ctx.referralSource === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                        <!-- UPDATED: Online Presence -->
                    <div>
                        <h4 class="font-semibold text-lg mb-3">Current Online Presence</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Current Website URL (if any)</label>
                                <input type="url" data-input-action="update-client-context" data-id="website" value="${ctx.website || ''}" placeholder="https://example.com" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Social Media URLs</label>
                                <input type="url" data-input-action="update-client-context" data-id="socialUrls" data-index="0" value="${(ctx.socialUrls[0] || {}).url || ''}" placeholder="https://linkedin.com/company/..." class="mt-1 w-full p-2 border rounded-md">
                                <input type="url" data-input-action="update-client-context" data-id="socialUrls" data-index="1" value="${(ctx.socialUrls[1] || {}).url || ''}" placeholder="https://facebook.com/..." class="mt-1 w-full p-2 border rounded-md">
                                <input type="url" data-input-action="update-client-context" data-id="socialUrls" data-index="2" value="${(ctx.socialUrls[2] || {}).url || ''}" placeholder="https://instagram.com/..." class="mt-1 w-full p-2 border rounded-md">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}
        function attachStarRatingListeners() {
            document.querySelectorAll('.star-rating input[type="radio"]').forEach(radio => {
                radio.addEventListener('click', (e) => {
                    selections.clientContext.satisfaction = parseInt(e.target.value, 10);
                });
            });
        }
        // START: REPLACE THIS FUNCTION
function renderServiceCard(service) {
    const activePhase = selections.phases.find(p => p.id === selections.activePhaseId);
    const isSelected = !!(activePhase && activePhase.services[service.id]);
    const selectionData = isSelected ? activePhase.services[service.id] : {};
    const isLocked = selectionData.locked || false;

    let dependenciesMet = true;
    let requiredServices = [];
    if (service.dependencies && service.dependencies.length > 0) {
        const selectedServiceIds = Object.keys(activePhase?.services || {});
        for (const depId of service.dependencies) {
            if (!selectedServiceIds.includes(depId)) {
                dependenciesMet = false;
                const depService = findService(depId);
                if (depService) requiredServices.push(depService.name);
            }
        }
    }

    const campaignPrice = getCampaignPrice(service.id);
    const globalAdjust = activeCampaign ? config.settings.campaignModifiers[activeCampaign]?.globalAdjust : null;
    let displayPrice = campaignPrice ?? service.price;
    let isCampaignPrice = campaignPrice !== null;

    if (!isCampaignPrice && globalAdjust?.value) {
        if (globalAdjust.type === 'percent') {
            displayPrice *= (1 + globalAdjust.value);
        } else if (displayPrice > 0) {
            displayPrice += globalAdjust.value;
        }
        isCampaignPrice = true;
    }

    let cardClasses = 'service-card p-4 border-2 rounded-lg transition-all relative';
    let cardAttributes = '';
    let clickAction = `data-action="toggle-service" data-id="${service.id}"`;

    if (isLocked) {
        cardClasses += ' selected bg-indigo-100 cursor-default';
        clickAction = '';
    } else if (!dependenciesMet) {
        cardClasses += ' bg-gray-100 opacity-60 cursor-not-allowed';
        cardAttributes = `title="Requires: ${requiredServices.join(', ')}"`;
        clickAction = '';
    } else {
        cardClasses += isSelected ? ' selected bg-indigo-50' : ' bg-white hover:bg-gray-50';
        cardClasses += ' cursor-pointer';
    }

    return `
        <div class="${cardClasses}" ${clickAction} ${cardAttributes}>
            ${isLocked ? `<div class="absolute top-2 right-2 text-gray-400" title="Locked by package selection"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg></div>` : ''}
            ${isCampaignPrice ? `<div class="absolute top-2 left-2 text-xs font-bold text-yellow-600 bg-yellow-100 px-2 py-0.5 rounded-full" title="Campaign pricing active">Campaign</div>` : ''}
            <div class="flex justify-between items-start">
                <h5 class="font-bold pr-2">${service.name}</h5>
                <div class="flex items-center flex-shrink-0">
                    <span class="text-sm font-semibold mr-2">${formatPrice(displayPrice, service.model)}</span>
                    <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'bg-indigo-600 border-indigo-600' : 'border-gray-300'}">
                        ${isSelected ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                    </div>
                </div>
            </div>
            <p class="text-sm text-gray-600 mt-1">${service.desc}</p>
            ${isSelected && !isLocked ? `<div class="mt-4 pt-4 border-t space-y-4 service-config">${renderServiceConfig(service, selectionData)}</div>` : ''}
        </div>
    `;
}
        // END: REPLACE THIS FUNCTION
        function renderServiceConfig(service, selectionData) {
            let html = '';
            if (service.model === 'Unit' || service.model === 'Hourly') {
                html += `<div><label class="block text-sm font-medium text-gray-700">Quantity (${service.unit || 'units'})</label><input type="number" min="1" value="${selectionData.quantity || 1}" class="mt-1 w-24 p-2 border rounded-md" data-input-action="update-quantity" data-id="${service.id}"></div>`;
            }
            if (service.model === 'Monthly') {
                html += `<div><label class="block text-sm font-medium text-gray-700">Commitment Term</label><select data-change-action="select-retainer-term" data-id="${service.id}" class="mt-1 w-full p-2 border rounded-md">${config.settings.retainerTerms.map(term => `<option value="${term.months}" ${selectionData.termMonths == term.months ? 'selected' : ''}>${term.name}${term.discount > 0 ? ` (${term.discount * 100}% off)` : ''}</option>`).join('')}</select></div>`;
            }
            if (service.modifiers) {
                html += service.modifiers.map(mod => {
                    const modValue = selectionData.mods[mod.id];
                    switch (mod.type) {
                        case 'Dropdown':
                        case 'TieredDropdown':
                            return `<div><label class="block text-sm font-medium text-gray-700">${mod.name}</label><select data-change-action="select-modifier" data-id="${service.id}" data-modifier-id="${mod.id}" class="mt-1 w-full p-2 border rounded-md">${mod.options.map(opt => `<option value="${opt.name}" ${modValue === opt.name ? 'selected' : ''}>${opt.name}</option>`).join('')}</select></div>`;
                        case 'Numeric':
                            const unitLabel = `${formatCurrency(mod.pricePerUnit || 0)} / ${mod.unitName || 'unit'}`;
                            return `<div><label class="block text-sm font-medium text-gray-700">${mod.name} (${unitLabel})</label><input type="number" min="0" value="${modValue || 0}" class="mt-1 w-24 p-2 border rounded-md" data-input-action="update-modifier" data-id="${service.id}" data-modifier-id="${mod.id}"></div>`;
                        case 'Checkbox':
                            return `<div class="flex items-center"><input type="checkbox" id="mod-${service.id}-${mod.id}" ${modValue ? 'checked' : ''} data-change-action="select-modifier" data-id="${service.id}" data-modifier-id="${mod.id}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="mod-${service.id}-${mod.id}" class="ml-2 block text-sm text-gray-900">${mod.name}</label></div>`;
                        case 'Text':
                            return `<div><label class="block text-sm font-medium text-gray-700">${mod.name}</label><input type="text" value="${modValue || ''}" class="mt-1 w-full p-2 border rounded-md" data-input-action="update-modifier" data-id="${service.id}" data-modifier-id="${mod.id}"></div>`;
                        default:
                            return '';
                    }
                }).join('');
            }
            // Timeline settings UI is removed from here.
            return html;
        }

        // <immersive id="calc_fix_renderAdSpendSection">
        function renderAdSpendSection() {
            const isOpen = openAccordions.has('paid-media');
            const activePhase = selections.phases.find(p => p.id === selections.activePhaseId);
            // Ensure adChannels exists on the active phase, default to empty object if not
            const adChannels = activePhase ? activePhase.adChannels : {}; 
            return `
                <div class="bg-white rounded-lg shadow-sm mt-4">
                     <button data-action="toggle-accordion" data-id="paid-media" class="w-full flex justify-between items-center p-4 text-left font-bold text-lg">
                        <span>Paid Media Management</span>
                        <svg class="w-6 h-6 transform transition-transform ${isOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content ${isOpen ? 'open' : ''}">
                        <div class="p-4 border-t space-y-4">
                            ${Object.keys(adChannels).map(id => renderAdChannelCard(id, adChannels[id])).join('') || '<p class="text-gray-500">No ad channels added to this phase.</p>'}
                        </div>
                        <div class="p-4 border-t">
                            <div class="flex items-center gap-2">
                                <select id="add-ad-channel-select" class="flex-grow p-2 border rounded-md">
                                    <option value="">-- Select Channel to Add --</option>
                                    ${config.adChannels.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                </select>
                                <button data-action="add-ad-channel-confirm" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        // <immersive id="calc_fix_renderAdChannelCard">
        function renderAdChannelCard(selectionId, selection) {
            const channel = findAdChannel(selection.id);
            if (!channel) return '';
            return `<div class="p-4 border rounded-lg bg-gray-50">
                <div class="flex justify-between items-center mb-4">
                    <h5 class="font-bold text-md">${channel.name}</h5>
                    <button data-action="remove-ad-channel" data-id="${selectionId}" class="text-red-500 hover:text-red-700 font-bold">&times; Remove</button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">One-Time Setup Fee</label>
                        <input type="number" value="${selection.setupFee}" class="mt-1 w-full p-2 border rounded-md" data-input-action="update-ad-setup" data-id="${selectionId}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Estimated Monthly Ad Spend</label>
                        <input type="number" value="${selection.spend}" class="mt-1 w-full p-2 border rounded-md" data-input-action="update-ad-spend" data-id="${selectionId}">
                    </div>
                </div>
            </div>`;
        }
        // START: REPLACE THIS FUNCTION
        // START: REPLACE THIS FUNCTION
function renderSummary() {
    const { totals, breakdown, discounts, valueProps, roiProjections, forecast, timelineData } = calculateTotals(selections);
    const summaryContent = document.getElementById('summary-content');
    const emptyMessage = document.getElementById('empty-summary-message');
    const overrideOneTimeInput = document.getElementById('override-one-time');
    const overrideMonthlyInput = document.getElementById('override-monthly');

    // Check if there are any selections to display.
    const totalSelectedItems = breakdown.items.length + Object.values(selections.teamAugmentation).filter(role => role.hours > 0).length;

    if (totalSelectedItems > 0) {
        summaryContent.classList.remove('hidden');
        emptyMessage.classList.add('hidden');
    } else {
        summaryContent.classList.add('hidden');
        emptyMessage.classList.remove('hidden');
        // If there's nothing to show, stop further rendering.
        return;
    }

    // Update totals display
    document.getElementById('total-one-time').textContent = formatCurrency(selections.overrides.oneTime ?? totals.oneTime);
    document.getElementById('total-monthly').textContent = formatCurrency(selections.overrides.monthly ?? totals.monthly);
    document.getElementById('total-ad-spend').textContent = formatCurrency(totals.adSpend);

    overrideOneTimeInput.value = selections.overrides.oneTime ?? '';
    overrideMonthlyInput.value = selections.overrides.monthly ?? '';

    const adSpendContainer = document.getElementById('ad-spend-total-container');
    const grandTotalContainer = document.getElementById('grand-total-container');

    if (totals.adSpend > 0) {
        adSpendContainer.classList.remove('hidden');
        grandTotalContainer.classList.remove('hidden');
    } else {
        adSpendContainer.classList.add('hidden');
        grandTotalContainer.classList.add('hidden');
    }

    document.getElementById('total-upfront').textContent = formatCurrency((selections.overrides.oneTime ?? totals.oneTime));
    const finalMonthlyInvestment = (selections.overrides.monthly ?? totals.monthly) + totals.adSpend;
    document.getElementById('total-investment').textContent = formatCurrency(finalMonthlyInvestment);

    // Render detailed breakdown
    const detailedSummary = document.getElementById('detailed-summary');
    let summaryHtml = '';
    
    selections.phases.forEach(phase => {
        const itemsInPhase = breakdown.items.filter(item => item.phaseId === phase.id);
        if (itemsInPhase.length > 0) {
            summaryHtml += `<div class="mb-3"><div class="font-bold text-indigo-700 text-sm border-b pb-1 mb-1">${phase.name}</div>`;
            itemsInPhase.forEach(item => {
                summaryHtml += `
                    <div class="flex justify-between items-center text-sm py-1">
                        <span class="text-gray-800">${item.name} <em class="text-gray-500 text-xs">(${item.desc})</em></span>
                        <span class="font-semibold">${formatCurrency(item.cost)}</span>
                    </div>`;
            });
            summaryHtml += `</div>`;
        }
    });

    const augmentationItems = breakdown.items.filter(item => item.phaseId === 'augmentation');
    if (augmentationItems.length > 0) {
         summaryHtml += `<div class="mb-3"><div class="font-bold text-indigo-700 text-sm border-b pb-1 mb-1">Team Augmentation</div>`;
         augmentationItems.forEach(item => {
             summaryHtml += `
                <div class="flex justify-between items-center text-sm py-1">
                    <span class="text-gray-800">${item.name} <em class="text-gray-500 text-xs">(${item.desc})</em></span>
                    <span class="font-semibold">${formatCurrency(item.cost)}</span>
                </div>`;
         });
         summaryHtml += `</div>`;
    }

    detailedSummary.innerHTML = summaryHtml;
    
    // Render discounts
    const discountsList = document.getElementById('discounts-list');
    if (discounts && discounts.length > 0) {
        discountsList.innerHTML = discounts.map(d => `
            <div class="flex justify-between items-center text-sm text-green-600">
                <span>${d.name}</span>
                <span>-${formatCurrency(d.amount)}</span>
            </div>
        `).join('');
        discountsList.classList.remove('hidden');
    } else {
        discountsList.innerHTML = '';
        discountsList.classList.add('hidden');
    }
    
    renderValuePropositions(valueProps);
    renderRoiProjections(roiProjections);
    renderRoiForecast(forecast);
}
// END: REPLACE THIS FUNCTION
        // END: REPLACE THIS FUNCTION
        function setSummaryTab(tabId) {
            document.querySelectorAll('#summary-tabs .summary-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab='${tabId}']`).classList.add('active');
            if (tabId === 'summary') {
                document.getElementById('summary-tab-content-summary').classList.remove('hidden');
                document.getElementById('summary-tab-content-timeline').classList.add('hidden');
            } else {
                document.getElementById('summary-tab-content-summary').classList.add('hidden');
                document.getElementById('summary-tab-content-timeline').classList.remove('hidden');
                // FIX: Calculate fresh data and render the chart only when the tab is made visible.
                const { timelineData } = calculateTotals(selections);
                renderTimelineChart(timelineData);
            }
        }
        function renderRoiProjections(projections) {
            const container = document.getElementById('roi-projection-section');
            if (!projections || projections.length === 0) {
                container.classList.add('hidden');
                return;
            }
            let html = `
                <h4 class="font-bold text-green-800 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428a1 1 0 00 .475 0l5 1.428a1 1 0 001.17-1.408l-7-14z" ></path></svg>
                    Projected Value & ROI
                </h4>
                <ul class="list-disc list-inside text-sm text-green-700 space-y-1">
            `;
            projections.forEach(proj => {
                html += `<li>${proj}</li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
            container.classList.remove('hidden');
        }
        // START: ADD THIS NEW FUNCTION
function renderRoiForecast(forecast) {
    const container = document.getElementById('roi-forecast-section');
    if (!container) return;

    // If the user hasn't entered all required data, hide the panel.
    if (!forecast || !forecast.hasInputs) {
        container.classList.add('hidden');
        return;
    }

    const formatRange = (min, max, isCurrency = false) => {
        const minFormatted = isCurrency ? formatCurrency(min) : min.toFixed(1);
        const maxFormatted = isCurrency ? formatCurrency(max) : max.toFixed(1);
        if (min.toFixed(1) === max.toFixed(1)) {
            return `<strong>${maxFormatted}</strong>`;
        }
        return `<strong>${minFormatted} - ${maxFormatted}</strong>`;
    };

    container.innerHTML = `
        <h4 class="font-bold text-blue-800 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" /><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" /></svg>
            ROI Forecast
        </h4>
        <div class="text-sm space-y-2 text-gray-700">
            <div class="flex justify-between"><span>Est. Additional Leads/Month:</span> <span>${formatRange(forecast.newLeads.min, forecast.newLeads.max)}</span></div>
            <div class="flex justify-between"><span>Est. Additional Revenue/Month:</span> <span>${formatRange(forecast.newRevenue.min, forecast.newRevenue.max, true)}</span></div>
            <div class="flex justify-between border-t pt-2 mt-2 font-semibold text-blue-700">
                <span>Projected Total Revenue/Month:</span>
                <span>${formatRange(forecast.totalRevenue.min, forecast.totalRevenue.max, true)}</span>
            </div>
        </div>
    `;
    container.classList.remove('hidden');
}
// END: ADD THIS NEW FUNCTION
        function renderValuePropositions(valueProps) {
            const container = document.getElementById('value-articulation-section');
            const list = document.getElementById('value-propositions-list'); // This is the line that was failing

            // --- FIX ---
            // First, ensure both the container and the list element exist
            if (!container || !list) {
                return; 
            }
            // -------------

            const uniqueProps = [...new Set(valueProps.filter(p => p))];
            
            if (config.settings.valueArticulationEnabled && uniqueProps.length > 0) {
                list.innerHTML = uniqueProps.map(vp => `<li>${vp}</li>`).join('');
                container.classList.remove('hidden');
            } else {
                list.innerHTML = '';
                container.classList.add('hidden');
            }
        }
        // START: ADD THIS NEW FUNCTION
        function renderAdminTeamAugmentation() {
            // Ensure the array exists in the config, defaulting to an empty array if not
            const roles = config.teamAugmentationRoles || [];
            return `
                <div>
                    <h3 class="font-bold text-xl mb-4">Team Augmentation Roles</h3>
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <p class="text-sm text-gray-500 mb-3">Manage the team roles available for client augmentation. These will appear in the main "Team Augmentation Calculator" tab.</p>
                        <div id="admin-team-roles-list" class="space-y-2">
                            ${roles.map(role => `
                                <div class="p-3 border rounded-md flex justify-between items-center bg-white">
                                    <span>${role.name} <span class="text-xs text-gray-500">(${formatCurrency(role.costPerHr)}/hr)</span></span>
                                    <div class="space-x-2">
                                        <button data-action="admin-edit" data-type="team-augmentation-role" data-id="${role.id}" class="text-sm text-blue-600 hover:underline">Edit</button>
                                        <button data-action="admin-delete" data-type="team-augmentation-role" data-id="${role.id}" class="text-sm text-red-600 hover:underline">Delete</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button data-action="admin-add" data-type="team-augmentation-role" class="mt-4 bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">+ Add New Role</button>
                    </div>
                </div>
            `;
        }
        // END: ADD THIS NEW FUNCTION
        // START: ADD THIS NEW FUNCTION
        function renderAdminTeamAugmentation() {
            // Ensure the array exists in the config, defaulting to an empty array if not
            if (!config.teamAugmentationRoles) {
                config.teamAugmentationRoles = [];
            }
            const roles = config.teamAugmentationRoles;
            return `
                <div>
                    <h3 class="font-bold text-xl mb-4">Team Augmentation Roles</h3>
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <p class="text-sm text-gray-500 mb-3">Manage the team roles available for client augmentation. These will appear in the main "Team Augmentation Calculator" tab.</p>
                        <div id="admin-team-roles-list" class="space-y-2">
                            ${roles.map(role => `
                                <div class="p-3 border rounded-md flex justify-between items-center bg-white">
                                    <span>${role.name} <span class="text-xs text-gray-500">(${formatCurrency(role.costPerHr)}/hr)</span></span>
                                    <div class="space-x-2">
                                        <button data-action="admin-edit" data-type="team-augmentation-role" data-id="${role.id}" class="text-sm text-blue-600 hover:underline">Edit</button>
                                        <button data-action="admin-delete" data-type="team-augmentation-role" data-id="${role.id}" class="text-sm text-red-600 hover:underline">Delete</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button data-action="admin-add" data-type="team-augmentation-role" class="mt-4 bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">+ Add New Role</button>
                    </div>
                </div>
            `;
        }
        // START: ADD THIS NEW FUNCTION
        function renderAugmentationCalculator() {
            const container = document.getElementById('content-augmentation');
            if (!container) return;

            const roles = config.teamAugmentationRoles || [];

            container.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h2 class="text-2xl font-bold">Team Augmentation Calculator</h2>
                        <p class="text-gray-600 mt-1">Select roles and specify hours to augment your team with our dedicated specialists.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${roles.map(role => {
                            const selection = selections.teamAugmentation[role.id] || { hours: 0 };
                            const monthlyCost = selection.hours * role.costPerHr;
                            const fullTimeMonthly = role.fullTimeSalaryComparison / 12;
                            const savings = fullTimeMonthly - monthlyCost;

                            return `
                            <div class="service-card p-6 border-2 rounded-xl transition-all ${selection.hours > 0 ? 'selected bg-indigo-50' : 'bg-white hover:bg-gray-50'}">
                                <h4 class="text-xl font-bold text-gray-800">${role.name}</h4>
                                <p class="text-sm text-gray-500 mt-1 h-10">${role.description}</p>

                                <div class="mt-4">
                                    <label for="hours-${role.id}" class="block text-sm font-medium text-gray-700">Hours per Month</label>
                                    <input 
                                        type="number" 
                                        id="hours-${role.id}"
                                        name="hours-${role.id}"
                                        value="${selection.hours > 0 ? selection.hours : ''}"
                                        min="0"
                                        placeholder="0"
                                        data-input-action="update-team-augmentation"
                                        data-id="${role.id}"
                                        class="mt-1 w-full p-2 border rounded-md"
                                    >
                                </div>

                                <div class="mt-4 pt-4 border-t">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 font-medium">Monthly Cost:</span>
                                        <span class="text-lg font-bold text-indigo-600">${formatCurrency(monthlyCost)}</span>
                                    </div>
                                    ${selection.hours > 0 && savings > 0 ? `
                                    <div class="flex justify-between items-center mt-2 text-sm">
                                        <span class="text-gray-500">vs. Full-Time Hire:</span>
                                        <span class="text-green-600 font-semibold">Save ~${formatCurrency(savings)}/mo</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        // END: ADD THIS NEW FUNCTION
        // START: ADD THESE NEW FUNCTIONS
        function renderRoiForecasterPanel() {
            const ctx = selections.clientContext;
            const isOpen = openAccordions.has('roi-forecaster');
            return `
                <div class="bg-white rounded-lg shadow-sm">
                    <button data-action="toggle-accordion" data-id="roi-forecaster" class="w-full flex justify-between items-center p-4 text-left font-bold text-lg">
                        <span>ROI & Goal Forecaster</span>
                        <svg class="w-6 h-6 transform transition-transform ${isOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content ${isOpen ? 'open' : ''}">
                        <div class="p-6 border-t space-y-4">
                            <p class="text-sm text-gray-600">Enter your current metrics to project the potential impact of our services.</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium">Current Monthly Website Traffic</label>
                                    <input type="number" data-input-action="update-client-context" data-id="monthlyTraffic" value="${ctx.monthlyTraffic || ''}" class="mt-1 w-full p-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">Current Conversion Rate (%)</label>
                                    <input type="number" data-input-action="update-client-context" data-id="conversionRate" value="${ctx.conversionRate || ''}" class="mt-1 w-full p-2 border rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">Average Sale Value ($)</label>
                                    <input type="number" data-input-action="update-client-context" data-id="avgSaleValue" value="${ctx.avgSaleValue || ''}" class="mt-1 w-full p-2 border rounded-md">
                                </div>
                            </div>
                            <!-- START: Add this new button -->
                            <div class="pt-4 border-t">
                                <button data-action="open-ab-planner" class="w-full btn btn-secondary flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>
                                    A/B Test Sample Size Planner
                                </button>
                            </div>
                            <!-- END: Add this new button -->
                        </div>
                    </div>
                </div>
            `;
        }

function renderCompetitorSnapshotPanel() {
    const ctx = selections.clientContext;
    const isOpen = openAccordions.has('competitor-snapshot');
    return `
        <div class="bg-white rounded-lg shadow-sm">
            <button data-action="toggle-accordion" data-id="competitor-snapshot" class="w-full flex justify-between items-center p-4 text-left font-bold text-lg">
                <span>Competitor Snapshot</span>
                <svg class="w-6 h-6 transform transition-transform ${isOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div class="accordion-content ${isOpen ? 'open' : ''}">
                <div class="p-6 border-t space-y-6">
                    <p class="text-sm text-gray-600">Provide up to three competitors for analysis. This intelligence is crucial for tailoring your strategy.</p>
                    
                    <!-- Competitor 1 -->
                    <div class="space-y-3 p-4 border rounded-lg bg-gray-50">
                        <label class="block text-sm font-medium text-gray-800">Competitor 1 URL</label>
                        <input type="url" data-input-action="update-client-context" data-id="competitors" data-index="0" data-field="url" value="${(ctx.competitors[0] || {}).url || ''}" placeholder="https://competitor1.com" class="w-full p-2 border rounded-md">
                        <label class="block text-sm font-medium text-gray-800">Notes & Analysis</label>
                        <textarea data-input-action="update-client-context" data-id="competitors" data-index="0" data-field="notes" class="w-full p-2 border rounded-md h-24" placeholder="e.g., Why are they a competitor? What do they do well? What do you want to explore or counter?">${(ctx.competitors[0] || {}).notes || ''}</textarea>
                    </div>

                    <!-- Competitor 2 -->
                    <div class="space-y-3 p-4 border rounded-lg bg-gray-50">
                        <label class="block text-sm font-medium text-gray-800">Competitor 2 URL</label>
                        <input type="url" data-input-action="update-client-context" data-id="competitors" data-index="1" data-field="url" value="${(ctx.competitors[1] || {}).url || ''}" placeholder="https://competitor2.com" class="w-full p-2 border rounded-md">
                        <label class="block text-sm font-medium text-gray-800">Notes & Analysis</label>
                        <textarea data-input-action="update-client-context" data-id="competitors" data-index="1" data-field="notes" class="w-full p-2 border rounded-md h-24" placeholder="e.g., Strengths, weaknesses, opportunities...">${(ctx.competitors[1] || {}).notes || ''}</textarea>
                    </div>

                    <!-- Competitor 3 -->
                    <div class="space-y-3 p-4 border rounded-lg bg-gray-50">
                        <label class="block text-sm font-medium text-gray-800">Competitor 3 URL</label>
                        <input type="url" data-input-action="update-client-context" data-id="competitors" data-index="2" data-field="url" value="${(ctx.competitors[2] || {}).url || ''}" placeholder="https://competitor3.com" class="w-full p-2 border rounded-md">
                        <label class="block text-sm font-medium text-gray-800">Notes & Analysis</label>
                        <textarea data-input-action="update-client-context" data-id="competitors" data-index="2" data-field="notes" class="w-full p-2 border rounded-md h-24" placeholder="e.g., Market positioning, pricing strategy...">${(ctx.competitors[2] || {}).notes || ''}</textarea>
                    </div>
                </div>
            </div>
        </div>
    `;
}
// END: ADD THESE NEW FUNCTIONS
        function renderAdminPanel() {
            const container = document.getElementById('content-admin');
            if (!isAdmin) {
                container.innerHTML = `<p class="text-center text-gray-500 p-8">Admin panel is locked. Press Ctrl+Shift+A and enter password to unlock.</p>`;
                return;
            }
            container.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md space-y-8">
                    <div>
                        <h3 class="font-bold text-xl mb-4">Configuration Management</h3>
                        <div class="flex flex-wrap gap-4 items-center">
                            <button id="admin-save" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Save All Changes to Live Config</button>
                            <button id="admin-reset" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Reset to Defaults</button>
                        </div>
                    </div>
                    ${renderAdminDataManagement()}
                    ${renderAdminVersioning()}
                    ${renderAdminAnalytics()}
                    ${renderAdminCampaignModifiers()}
                    ${renderAdminMarketingDiscounts()}
                    ${renderAdminPdfSettings()}
                    ${renderAdminPackageManagement()}
                    ${renderAdminTeamAugmentation()}
                    ${renderAdminDiscountsAndTiers()}
                    ${renderAdminCategoryManagement()}
                    ${renderAdminServiceManagement()}
                </div>
            `;
            document.getElementById('admin-save')?.addEventListener('click', saveConfig);
            document.getElementById('admin-reset')?.addEventListener('click', resetConfig);
            document.getElementById('admin-export-json')?.addEventListener('click', exportConfig);
            document.getElementById('admin-import-json')?.addEventListener('change', importConfig);
            document.getElementById('admin-export-csv')?.addEventListener('click', exportServicesCSV);
            document.getElementById('admin-import-csv')?.addEventListener('change', importServicesCSV);
        }
        // END: REPLACE THIS FUNCTION
        // END: REPLACE THIS FUNCTION
        // #endregion
        // #region ########## SUBMITTED QUOTES PANEL ##########
        // MODIFIED: Greatly expanded to show all new client data
function renderSubmittedQuotes(quotes = []) {
    const container = document.getElementById('content-quotes');
    if (!container) return;
    
    let contentHtml = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-2xl">Submitted Quote Requests</h3>
                <p class="text-sm text-green-600 flex items-center gap-2">
                    <span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span>
                    Listening for new quotes in real-time
                </p>
            </div>
    `;
    if (quotes.length === 0) {
        contentHtml += `<p class="text-center text-gray-500 py-8">No quotes have been submitted yet.</p>`;
    } else {
        contentHtml += `<div class="space-y-4">`;
        quotes.forEach(quote => {
            const { contact, summary, timestamp, id, selections: quoteSelections } = quote;
            // THIS IS THE KEY FIX: Access clientContext from the nested selections object
            const clientContext = quoteSelections?.clientContext || {};
            const summaryTotals = summary?.totals || {};
            const { oneTime = 0, monthly = 0, adSpend = 0 } = summaryTotals;
            const totalInvestment = monthly + adSpend;
            const submittedDate = timestamp ? new Date(timestamp.seconds * 1000).toLocaleString() : 'Just now';
            
            let itemizedHtml = '';
            if (quoteSelections?.phases && summary?.breakdown?.items) {
                 quoteSelections.phases.forEach(phase => {
                    const itemsInPhase = summary.breakdown.items.filter(item => item.phaseId === phase.id);
                    if (itemsInPhase.length > 0) {
                        itemizedHtml += `<p class="font-semibold mt-2 text-indigo-700">${phase.name}</p>
                        <ul class="list-disc list-inside pl-2">
                            ${itemsInPhase.map(item => `<li>${item.name} (${item.desc}) - <strong>${formatCurrency(item.cost)}</strong></li>`).join('')}
                        </ul>`;
                    }
                });
            } else if (summary?.breakdown?.items) {
                    itemizedHtml = `<ul class="list-disc list-inside pl-2">${summary.breakdown.items.map(item => `<li>${item.name} (${item.desc}) - <strong>${formatCurrency(item.cost)}</strong></li>`).join('')}</ul>`;
            } else {
                itemizedHtml = '<p>No itemized data available.</p>';
            }

            let competitorHtml = (clientContext.competitors || [])
                .filter(c => c.url)
                .map(c => `<div class="flex flex-col mt-2"><dt class="font-semibold">${c.url}:</dt><dd class="pl-2 text-gray-600">${c.notes || 'No notes.'}</dd></div>`)
                .join('');
            if(!competitorHtml) competitorHtml = renderQuoteDetail('Competitors', 'Not provided');


            contentHtml += `
                <div class="border border-gray-200 rounded-lg">
                    <div class="bg-gray-50 p-4 flex justify-between items-center cursor-pointer" data-action="toggle-quote-details" data-id="${id}">
                        <div>
                            <p class="font-bold text-lg">${contact.name} <span class="text-base font-normal text-gray-600">- ${contact.businessName || 'N/A'}</span></p>
                            <p class="text-sm text-gray-500">${contact.email}${contact.phone ? ` | ${contact.phone}` : ''} | Submitted: ${submittedDate}</p>
                            ${quote.campaign ? `<p class="text-xs text-yellow-700 font-semibold mt-1">Campaign: ${quote.campaign}</p>` : ''}
                        </div>
                        <div class="flex items-center gap-4">
                                <button data-action="export-quote-pdf" data-id="${id}" class="bg-indigo-600 text-white font-semibold py-1 px-3 rounded hover:bg-indigo-700 text-sm">Export PDF</button>
                                <button data-action="delete-quote" data-id="${id}" class="text-red-500 hover:text-red-700 font-semibold py-1 px-2 rounded hover:bg-red-100 text-sm">Delete</button>
                            <span class="text-sm font-semibold text-gray-700">Details
                                <svg class="w-5 h-5 inline-block transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </span>
                        </div>
                    </div>
                    <div id="quote-content-${id}" class="quote-card-content">
                        <div class="p-6 border-t grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                            <div class="md:col-span-1 space-y-4">
                                <h4 class="font-bold border-b pb-1">Client Profile</h4>
                                <dl class="text-sm space-y-3">
                                    ${renderQuoteDetail('Stage', clientContext.businessStage)}
                                    ${renderQuoteDetail('Primary Goal', clientContext.businessGoal)}
                                    ${renderQuoteDetail('Website', clientContext.website ? `<a href="${clientContext.website}" target="_blank" class="text-blue-600 hover:underline">${clientContext.website}</a>` : null)}
                                    ${(clientContext.socialUrls || []).filter(s => s.url).map((s, i) => renderQuoteDetail(`Social URL ${i+1}`, `<a href="${s.url}" target="_blank" class="text-blue-600 hover:underline">${s.url}</a>`)).join('')}
                                    ${renderQuoteDetail('Referral', clientContext.referralSource)}
                                </dl>
                                <h4 class="font-bold border-b pb-1 mt-4">Previous Provider Info</h4>
                                <dl class="text-sm space-y-3">
                                    ${renderQuoteDetail('Provider Name', clientContext.previousProvider)}
                                    ${renderQuoteDetail('Provided Services', clientContext.previousServices)}
                                    ${renderQuoteDetail('Budget', clientContext.previousBudget ? formatCurrency(clientContext.previousBudget) : null)}
                                    ${renderQuoteDetail('Duration', clientContext.durationWithProvider)}
                                    ${renderQuoteDetail('Reason for Switch', clientContext.reasonForSwitching)}
                                    ${renderQuoteDetail('Satisfaction', clientContext.satisfaction ? `${'&#9733;'.repeat(clientContext.satisfaction)}${'&#9734;'.repeat(5-clientContext.satisfaction)}` : null)}
                                </dl>
                                <h4 class="font-bold border-b pb-1 mt-4">Competitor Analysis</h4>
                                <dl class="text-sm space-y-3">${competitorHtml}</dl>
                            </div>
                            <div class="md:col-span-1">
                                <h4 class="font-bold mb-2 border-b pb-1">Itemized Summary</h4>
                                <div class="text-sm space-y-2">${itemizedHtml}</div>
                            </div>
                            <div class="md:col-span-1">
                                <h4 class="font-bold mb-2 border-b pb-1">Totals</h4>
                                <div class="space-y-2 text-sm">
                                        <div class="flex justify-between"><span>One-Time Fees:</span> <strong class="text-gray-900">${formatCurrency(oneTime)}</strong></div>
                                        <div class="flex justify-between"><span>Monthly Retainer:</span> <strong class="text-gray-900">${formatCurrency(monthly)}</strong></div>
                                        ${adSpend > 0 ? `<div class="flex justify-between"><span>Est. Monthly Ad Spend:</span> <strong class="text-gray-900">${formatCurrency(adSpend)}</strong></div>` : ''}
                                        ${totalInvestment > 0 && adSpend > 0 ? `<div class="flex justify-between border-t pt-2 mt-2"><strong>Total Monthly Investment:</strong> <strong class="text-indigo-600 text-base">${formatCurrency(totalInvestment)}</strong></div>` : ''}
                                </div>
                                ${summary?.discounts && summary.discounts.length > 0 ? `
                                    <h4 class="font-bold mt-4 mb-2 border-b pb-1">Discounts Applied</h4>
                                    <div class="space-y-1 text-sm text-green-600">
                                            ${summary.discounts.map(d => `<div class="flex justify-between"><span>${d.name}:</span> <strong>-${formatCurrency(d.amount)}</strong></div>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        contentHtml += `</div>`;
    }
    contentHtml += `</div>`;
    container.innerHTML = contentHtml;
}
        function updateTimelineSetting(serviceId, setting, value) {
            const activePhase = selections.phases.find(p => p.id === selections.activePhaseId);
            if (activePhase && activePhase.services[serviceId]) {
                if (!activePhase.services[serviceId].timeline) {
                     activePhase.services[serviceId].timeline = { enabled: false, order: 0, duration: 0 };
                }
                activePhase.services[serviceId].timeline[setting] = value;
                renderSummary(); // Re-render summary to be safe, might affect timeline tab
            }
        }
        function renderQuoteDetail(label, value) {
            if (!value) return '';
            return `<div class="flex flex-col"><dt class="font-semibold">${label}:</dt><dd class="pl-2">${value}</dd></div>`;
        }
        function updateQuoteCountBadge(count) {
            const badge = document.getElementById('quote-count-badge');
            if (!badge) return;
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        function deleteQuote(quoteId) {
            if (!confirm(`Are you sure you want to permanently delete this quote? This cannot be undone.`)) {
                return;
            }
            db.collection("submittedQuotes").doc(quoteId).delete()
            .then(() => {
                showToast('Quote deleted successfully.', 'info');
                // The real-time listener will automatically update the UI.
            })
            .catch((error) => {
                console.error("Error removing document: ", error);
                showToast("Could not delete quote. Please try again.", "error");
            });
        }
        // #endregion
        function renderAdminDataManagement() {
    return `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="p-4 border rounded-lg bg-gray-50">
                    <h4 class="font-semibold">Service Data (CSV)</h4>
                    <p class="text-sm text-gray-500 mb-3">Export/Import services for mass editing in a spreadsheet.</p>
                    <div class="flex flex-wrap gap-4">
                    <button id="admin-export-csv" class="btn btn-secondary text-sm">Export Services CSV</button>
                    <label class="btn btn-secondary text-sm">
                        Import Services CSV
                        <input type="file" id="admin-import-csv" class="hidden" accept=".csv">
                    </label>
                    </div>
            </div>
            <div class="p-4 border rounded-lg bg-gray-50">
                    <h4 class="font-semibold">Full Configuration</h4>
                    <p class="text-sm text-gray-500 mb-3">Save or load the entire application config, including all settings.</p>
                    <div class="flex flex-wrap gap-4">
                    <button id="admin-export-json" class="btn btn-secondary text-sm">Export Full Backup (JSON)</button>
                    <label class="btn btn-secondary text-sm">
                        Import Full Backup (JSON)
                        <input type="file" id="admin-import-json" class="hidden" accept=".json">
                    </label>
                    </div>
            </div>
            <div class="p-4 border rounded-lg bg-red-50">
                    <h4 class="font-semibold text-red-800">Debug Actions</h4>
                    <p class="text-sm text-red-700 mb-3">Use these tools to clear stored data for testing purposes.</p>
                    <div class="flex flex-wrap gap-4">
                        <button data-action="admin-clear-session" class="btn bg-red-600 text-white hover:bg-red-700 text-sm">Clear Saved Session</button>
                    </div>
            </div>
        </div>
    `;
}
        function renderAdminVersioning() {
            const versions = Object.keys(localStorage)
                .filter(key => key.startsWith('galifreyCalcConfig_'))
                .map(key => ({ key, name: key.replace('galifreyCalcConfig_', '') }));
            return `
                <div>
                    <h3 class="font-bold text-xl mb-4">Configuration Versions</h3>
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <p class="text-sm text-gray-500 mb-3">Save snapshots of your configuration. This is useful for testing new pricing or rolling back changes.</p>
                        <div class="flex items-center gap-2 mb-4">
                             <input type="text" id="version-name-input" placeholder="Enter new version name" class="flex-grow p-2 border rounded-md">
                             <button data-action="save-version" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700">Save as New Version</button>
                        </div>
                        <h4 class="font-semibold text-md mb-2">Saved Versions:</h4>
                        <div id="versions-list" class="space-y-2">
                            ${versions.length > 0 ? versions.map(v => `
                                <div class="p-2 bg-white border rounded-md flex justify-between items-center version-item">
                                    <span class="font-medium">${v.name}</span>
                                    <div class="space-x-2 opacity-0 version-actions transition-opacity">
                                        <button data-action="load-version" data-key="${v.key}" class="text-sm text-blue-600 hover:underline">Load</button>
                                        <button data-action="delete-version" data-key="${v.key}" class="text-sm text-red-600 hover:underline">Delete</button>
                                    </div>
                                </div>`).join('') : '<p class="text-gray-500">No versions saved.</p>'}
                        </div>
                    </div>
                </div>
            `;
        }
        // MODIFIED: Added discount and modifier analytics
        function renderAdminAnalytics() {
            const analytics = JSON.parse(localStorage.getItem('galifreyCalcAnalytics')) || {};
            const popularServices = Object.entries(analytics.service_selected?.details || [])
                .reduce((acc, [, detail]) => {
                    acc[detail.serviceId] = (acc[detail.serviceId] || 0) + 1;
                    return acc;
                }, {});
            const sortedServices = Object.entries(popularServices).sort((a,b) => b[1] - a[1]).slice(0, 5);
             const popularPackages = Object.entries(analytics.package_selected?.details || [])
                .reduce((acc, [, detail]) => {
                    acc[detail.packageId] = (acc[detail.packageId] || 0) + 1;
                    return acc;
                }, {});
            const sortedPackages = Object.entries(popularPackages).sort((a,b) => b[1] - a[1]).slice(0, 3);
            const popularDiscounts = Object.entries(analytics.discount_applied?.details || [])
                .reduce((acc, [, detail]) => {
                    acc[detail.code] = (acc[detail.code] || 0) + 1;
                    return acc;
                }, {});
            const sortedDiscounts = Object.entries(popularDiscounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
            return `
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-xl">Usage Analytics</h3>
                        <button data-action="reset-analytics" class="bg-red-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-red-700 transition-colors text-xs">Reset Analytics</button>
                    </div>
                    <div class="p-4 border rounded-lg bg-gray-50">
                         <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div><div class="text-3xl font-bold">${analytics.quote_submitted?.count || 0}</div><div class="text-sm text-gray-500">Quotes Submitted</div></div>
                            <div><div class="text-3xl font-bold">${analytics.pdf_exported?.count || 0}</div><div class="text-sm text-gray-500">PDFs Exported</div></div>
                            <div><div class="text-3xl font-bold">${analytics.service_selected?.count || 0}</div><div class="text-sm text-gray-500">Total Service Selections</div></div>
                             <div><div class="text-3xl font-bold">${analytics.package_selected?.count || 0}</div><div class="text-sm text-gray-500">Packages Selected</div></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 pt-4 border-t">
                             <div>
                                <h4 class="font-semibold mb-2">Most Popular Services</h4>
                                <ul class="list-decimal list-inside text-sm">
                                    ${sortedServices.map(([id, count]) => `<li>${findService(id)?.name || id} (${count} clicks)</li>`).join('') || 'No data.'}
                                </ul>
                             </div>
                             <div>
                                <h4 class="font-semibold mb-2">Most Popular Packages</h4>
                                 <ul class="list-decimal list-inside text-sm">
                                    ${sortedPackages.map(([id, count]) => `<li>${findPackage(id)?.name || id} (${count} clicks)</li>`).join('') || 'No data.'}
                                </ul>
                             </div>
                             <div>
                                <h4 class="font-semibold mb-2">Most Used Discount Codes</h4>
                                 <ul class="list-decimal list-inside text-sm">
                                    ${sortedDiscounts.map(([code, count]) => `<li>${code} (${count} uses)</li>`).join('') || 'No data.'}
                                </ul>
                             </div>
                        </div>
                    </div>
                </div>
            `;
        }
        // MODIFIED: Renamed and updated for new global adjustment feature
        function renderAdminCampaignModifiers() {
            const modifiers = config.settings.campaignModifiers || {};
            return `
                <div>
                    <h3 class="font-bold text-xl mb-4">Regional/Campaign Modifiers</h3>
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <p class="text-sm text-gray-500 mb-3">Create pricing campaigns that can be activated with a URL parameter (e.g., <code>?campaign=campaign-name</code>). You can set a global price adjustment and/or override individual service prices.</p>
                         <div class="flex items-center gap-2 mb-4">
                             <input type="text" id="new-modifier-name" placeholder="Enter new campaign name (e.g., end-of-year-sale)" class="flex-grow p-2 border rounded-md">
                             <button data-action="add-campaign-modifier" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Add Campaign</button>
                        </div>
                        <div id="campaign-modifiers-list" class="space-y-2">
                            ${Object.keys(modifiers).length > 0 ? Object.keys(modifiers).map(modName => `
                                <div class="p-3 border rounded-md flex justify-between items-center bg-white">
                                    <span class="font-medium">${modName}</span>
                                    <div class="space-x-2">
                                        <button data-action="edit-campaign-modifier" data-id="${modName}" class="text-sm text-blue-600 hover:underline">Edit Prices</button>
                                        <button data-action="delete-campaign-modifier" data-id="${modName}" class="text-sm text-red-600 hover:underline">Delete</button>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500">No campaigns configured.</p>'}
                        </div>
                    </div>
                </div>
            `;
        }
        // NEW: Admin section for creating/managing marketing discounts
        function renderAdminMarketingDiscounts() {
            const discounts = config.settings.marketingDiscounts || [];
            return `
                <div>
                    <h3 class="font-bold text-xl mb-4">Marketing & Discounts</h3>
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <p class="text-sm text-gray-500 mb-3">Create and manage coupon codes that customers can apply to their quotes.</p>
                        <div id="marketing-discounts-list" class="space-y-2">
                            ${discounts.length > 0 ? discounts.map(d => `
                                <div class="p-3 border rounded-md flex justify-between items-center bg-white">
                                    <div>
                                        <p class="font-medium">${d.code}</p>
                                        <p class="text-xs text-gray-500">${getDiscountDescription(d)}</p>
                                    </div>
                                    <div class="space-x-2">
                                        <button data-action="admin-edit" data-type="marketing-discount" data-id="${d.id}" class="text-sm text-blue-600 hover:underline">Edit</button>
                                        <button data-action="admin-delete" data-type="marketing-discount" data-id="${d.id}" class="text-sm text-red-600 hover:underline">Delete</button>
                                    </div>
                                </div>
                            `).join('') : '<p class="text-gray-500">No discount codes created.</p>'}
                        </div>
                        <button data-action="admin-add" data-type="marketing-discount" class="mt-4 bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">+ Add New Discount Code</button>
                    </div>
                </div>
            `;
        }
        function getDiscountDescription(d) {
            let desc = d.type === 'percent' ? `${d.value}% off` : `${formatCurrency(d.value)} off`;
            const targetMap = {
                oneTime: 'One-Time Fees',
                monthly: 'Monthly Retainer',
                service: `Service: ${findService(d.targetId)?.name || 'N/A'}`,
                category: `Category: ${findCategory(d.targetId)?.name || 'N/A'}`
            };
            desc += ` ${targetMap[d.applyTo] || ''}`;
            if (d.startDate || d.endDate) {
                desc += ` (Valid: ${d.startDate || 'any'} to ${d.endDate || 'any'})`;
            }
            return desc;
        }
        function renderAdminPdfSettings() {
            const s = config.settings;
            return `
                 <div>
                    <h3 class="font-bold text-xl mb-4">General Settings</h3>
                    <div class="p-4 border rounded-lg bg-gray-50 space-y-4">
                        <div class="pt-4 border-t"><h4 class="font-semibold text-lg">PDF Export Customization</h4></div>
                        <div><label class="block text-sm font-medium">Logo URL</label><input type="text" value="${s.pdfSettings.logoUrl}" data-change-action="update-admin-setting" data-path="settings.pdfSettings.logoUrl" class="w-full p-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">Header Text</label><input type="text" value="${s.pdfSettings.headerText}" data-change-action="update-admin-setting" data-path="settings.pdfSettings.headerText" class="w-full p-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">Introductory Paragraph</label><textarea data-change-action="update-admin-setting" data-path="settings.pdfSettings.introParagraph" class="w-full p-2 border rounded-md h-24">${s.pdfSettings.introParagraph}</textarea></div>
                        <div><label class="block text-sm font-medium">Footer Text</label><input type="text" value="${s.pdfSettings.footerText}" data-change-action="update-admin-setting" data-path="settings.pdfSettings.footerText" class="w-full p-2 border rounded-md"></div>
                    </div>
                </div>
            `;
        }
        function renderAdminPackageManagement() {
            return `
                <div>
                    <h3 class="font-bold text-xl mb-4">Package Management</h3>
                    <div id="admin-packages-list" class="space-y-2">
                        ${config.packages.map(p => `
                            <div class="p-3 border rounded-md flex justify-between items-center bg-gray-50">
                                <span>${p.name} <span class="text-xs text-gray-500">(${p.id})</span></span>
                                <div class="space-x-2">
                                    <button data-action="admin-edit" data-type="package" data-id="${p.id}" class="text-sm text-blue-600 hover:underline">Edit</button>
                                    <button data-action="admin-delete" data-type="package" data-id="${p.id}" class="text-sm text-red-600 hover:underline">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button data-action="admin-add" data-type="package" class="mt-4 bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">+ Add New Package</button>
                </div>
            `;
        }
        function renderAdminDiscountsAndTiers() {
            const { bundleDiscounts, retainerTerms, adFeeTiers } = config.settings;
            return `
                <div>
                     <h3 class="font-bold text-xl mb-4">Global Discounts & Tiers</h3>
                     <div class="space-y-6">
                        <div class="p-4 border rounded-lg">
                            <h4 class="font-semibold mb-2">Bundle Discounts</h4>
                            <p class="text-xs text-gray-500 mb-2">Apply a tiered discount based on the number of unique services selected.</p>
                            <div id="admin-bundle-discounts-list" class="space-y-2">
                                <div class="grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 px-2"><div class="col-span-5">Min. Services</div><div class="col-span-6">Discount %</div></div>
                                ${(bundleDiscounts || []).map((tier, index) => `
                                    <div class="grid grid-cols-12 gap-2 items-center">
                                        <div class="col-span-5"><input type="number" class="w-full p-1 border rounded" value="${tier.threshold}" data-input-action="update-admin-setting" data-path="settings.bundleDiscounts.${index}.threshold"></div>
                                        <div class="col-span-6"><input type="number" class="w-full p-1 border rounded" value="${(tier.percentage || 0) * 100}" data-input-action="update-admin-setting" data-path="settings.bundleDiscounts.${index}.percentage"></div>
                                        <button data-action="admin-delete" data-type="bundle-discount" data-id="${index}" class="col-span-1 text-red-500 hover:text-red-700 font-bold">&times;</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button data-action="admin-add" data-type="bundle-discount" class="mt-3 bg-gray-200 py-1 px-3 rounded text-sm">+ Add Bundle Tier</button>
                        </div>
                        <div class="p-4 border rounded-lg">
                            <h4 class="font-semibold mb-2">Retainer Term Discounts</h4>
                            <p class="text-xs text-gray-500 mb-2">Applies to all services with a "Monthly" pricing model.</p>
                            <div id="admin-retainer-terms-list" class="space-y-2">
                                <div class="grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 px-2"><div class="col-span-5">Display Name</div><div class="col-span-3">Months</div><div class="col-span-3">Discount %</div></div>
                                ${(retainerTerms || []).map((term, index) => `
                                    <div class="grid grid-cols-12 gap-2 items-center">
                                        <div class="col-span-5"><input type="text" class="w-full p-1 border rounded" value="${term.name}" data-change-action="update-admin-setting" data-path="settings.retainerTerms.${index}.name"></div>
                                        <div class="col-span-3"><input type="number" class="w-full p-1 border rounded" value="${term.months}" data-input-action="update-admin-setting" data-path="settings.retainerTerms.${index}.months"></div>
                                        <div class="col-span-3"><input type="number" class="w-full p-1 border rounded" value="${(term.discount || 0) * 100}" data-input-action="update-admin-setting" data-path="settings.retainerTerms.${index}.discount"></div>
                                        <button data-action="admin-delete" data-type="retainer-term" data-id="${index}" class="col-span-1 text-red-500 hover:text-red-700 font-bold">&times;</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button data-action="admin-add" data-type="retainer-term" class="mt-3 bg-gray-200 py-1 px-3 rounded text-sm">+ Add Term</button>
                        </div>
                        <div class="p-4 border rounded-lg">
                            <h4 class="font-semibold mb-2">Ad Spend Management Fee Tiers</h4>
                             <div class="grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 px-2"><div class="col-span-4">Min Spend</div><div class="col-span-3">Fee %</div><div class="col-span-4">Min Fee ($)</div></div>
                            <div class="space-y-2">
                                 ${adFeeTiers.map((tier, index) => `
                                    <div class="grid grid-cols-12 gap-2 items-center">
                                        <div class="col-span-4"><input type="number" class="w-full p-1 border rounded" value="${tier.threshold || 0}" data-input-action="update-admin-setting" data-path="settings.adFeeTiers.${index}.threshold"></div>
                                        <div class="col-span-3"><input type="number" class="w-full p-1 border rounded" value="${(tier.percentage || 0) * 100}" data-input-action="update-admin-setting" data-path="settings.adFeeTiers.${index}.percentage"></div>
                                        <div class="col-span-4"><input type="number" class="w-full p-1 border rounded" value="${tier.minFee || 0}" data-input-action="update-admin-setting" data-path="settings.adFeeTiers.${index}.minFee"></div>
                                        <button data-action="admin-delete" data-type="ad-tier" data-id="${index}" class="col-span-1 text-red-500 hover:text-red-700 font-bold">&times;</button>
                                    </div>
                                `).join('')}
                            </div>
                             <button data-action="admin-add" data-type="ad-tier" class="mt-3 bg-gray-200 py-1 px-3 rounded text-sm">+ Add Tier</button>
                        </div>
                     </div>
                </div>
            `;
        }
        function renderAdminCategoryManagement() {
            return `
                <div>
                    <h3 class="font-bold text-xl mb-4">Category Management</h3>
                    <p class="text-xs text-gray-500 mb-3">Click the arrows to re-order categories within their department.</p>
                    <div class="space-y-4">
                        ${config.departments.map(dep => `
                            <div class="p-4 border rounded-lg">
                                 <h4 class="font-semibold mb-2">${dep.name}</h4>
                                 <div class="space-y-2">
                                    ${config.categories.filter(c => c.departmentId === dep.id).map((cat, index, arr) => `
                                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                            <span>${cat.name} <span class="text-xs text-gray-400">(${cat.id})</span></span>
                                            <div class="flex items-center gap-3">
                                                 <button data-action="move-category" data-id="${cat.id}" data-direction="up" class="text-gray-500 hover:text-gray-800 ${index === 0 ? 'opacity-25 cursor-not-allowed' : ''}" ${index === 0 ? 'disabled' : ''}>&#9650;</button>
                                                 <button data-action="move-category" data-id="${cat.id}" data-direction="down" class="text-gray-500 hover:text-gray-800 ${index === arr.length - 1 ? 'opacity-25 cursor-not-allowed' : ''}" ${index === arr.length - 1 ? 'disabled' : ''}>&#9660;</button>
                                                 <button data-action="admin-edit" data-type="category" data-id="${cat.id}" class="text-sm text-blue-600 hover:underline">Edit</button>
                                                 <button data-action="admin-delete" data-type="category" data-id="${cat.id}" class="text-sm text-red-600 hover:underline">Delete</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                 </div>
                                 <button data-action="admin-add" data-type="category" data-id="${dep.id}" class="mt-3 bg-gray-200 py-1 px-3 rounded text-sm">+ Add Category to ${dep.name}</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        function renderAdminServiceManagement() {
             return `
                <div>
                    <h3 class="font-bold text-xl mb-4">Services</h3>
                    <div id="admin-services-list" class="space-y-2">
                        ${config.services.map(s => `
                            <div class="p-3 border rounded-md flex justify-between items-center bg-gray-50">
                                <span>${s.name} <span class="text-xs text-gray-500">(${findCategory(s.categoryId)?.name || 'N/A'})</span></span>
                                <div class="space-x-2">
                                    <button data-action="admin-edit" data-type="service" data-id="${s.id}" class="text-sm text-blue-600 hover:underline">Edit</button>
                                    <button data-action="admin-delete" data-type="service" data-id="${s.id}" class="text-sm text-red-600 hover:underline">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button data-action="admin-add" data-type="service" class="mt-4 bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">+ Add New Service</button>
                </div>
            `;
        }
        // #endregion
        // #region ########## CORE LOGIC / ACTIONS ##########
        // START: ADD THESE NEW FUNCTIONS
        // START: REPLACE THIS FUNCTION
    function clearSessionData() {
    if (confirm("Are you sure you want to clear all locally saved session data? This will not affect submitted quotes.")) {
        localStorage.removeItem('galifreyCalcSession');
        showToast("Local session data has been cleared.", "info");
        // Hide the load banner if it was visible
        const banner = document.getElementById('load-session-banner');
        if (banner) {
            banner.classList.add('hidden');
        }
    }
}
    function openABTestPlannerModal() {
        const baselineInput = document.getElementById('ab-baseline-cvr');
        const resultsPanel = document.getElementById('ab-test-results-panel');
        // Pre-fill with data from the forecaster if it exists
        const forecasterRate = selections.clientContext.conversionRate;
        if (forecasterRate) {
            baselineInput.value = forecasterRate;
        }
        resultsPanel.innerHTML = '<p class="text-gray-500">Enter your test parameters and click "Calculate" to see the required sample size.</p>';
        document.getElementById('ab-test-modal-overlay').style.display = 'flex';
    }

    function calculateABSampleSize() {
        // Z-scores for a two-tailed test
        const zScores = { '0.80': 1.28, '0.90': 1.645, '0.95': 1.96, '0.99': 2.576 };
        
        const baselineRate = (parseFloat(document.getElementById('ab-baseline-cvr').value) || 0) / 100;
        const minEffect = (parseFloat(document.getElementById('ab-mde').value) || 0) / 100;
        const significance = document.getElementById('ab-significance').value;

        if (baselineRate <= 0 || minEffect <= 0) {
            showToast("Please enter a valid baseline rate and minimum effect greater than 0.", "error");
            return;
        }

        const zAlpha = zScores[significance]; // For statistical significance (Alpha)
        const zBeta = 0.84; // Z-score for statistical power of 80% (Beta), a standard value.

        const p1 = baselineRate;
        const p2 = baselineRate * (1 + minEffect);
        const p_avg = (p1 + p2) / 2;

        const numerator = Math.pow((zAlpha * Math.sqrt(2 * p_avg * (1 - p_avg))) + (zBeta * Math.sqrt(p1 * (1 - p1) + p2 * (1 - p2))), 2);
        const denominator = Math.pow(p2 - p1, 2);
        
        const sampleSizePerVariation = Math.ceil(numerator / denominator);
        const totalSampleSize = sampleSizePerVariation * 2;

        const resultsPanel = document.getElementById('ab-test-results-panel');
        resultsPanel.innerHTML = `
            <p class="text-gray-600 mb-2">You will need:</p>
            <p class="text-3xl font-bold text-indigo-600">${sampleSizePerVariation.toLocaleString()}</p>
            <p class="text-gray-800 font-medium mb-4">visitors per variation</p>
            <p class="text-gray-600 text-sm border-t pt-4 mt-4">For a total of <strong class="text-gray-900">${totalSampleSize.toLocaleString()}</strong> visitors to reach statistical significance.</p>
        `;
    }
    
        function saveSession() {
            try {
                // Create a serializable copy of the selections object
                const sessionToSave = {
                    ...selections,
                    packagesToCompare: Array.from(selections.packagesToCompare || []) // Convert Set to Array
                };
                const sessionData = JSON.stringify(sessionToSave);
                localStorage.setItem('galifreyCalcSession', sessionData);
                showToast("Your progress has been saved to this browser.", "success");
                trackAnalytics('session_saved');
            } catch (e) {
                console.error("Failed to save session:", e);
                showToast("Could not save session. Browser storage may be full.", "error");
            }
        }
        // END: REPLACE THIS FUNCTION

function loadSession(dataToLoad) {
    try {
        // Validate that the essential properties exist on the loaded data
        if (dataToLoad && dataToLoad.phases && dataToLoad.clientContext) {
            
            // Reconstruct the 'packagesToCompare' Set from the array that was stringified.
            dataToLoad.packagesToCompare = new Set(dataToLoad.packagesToCompare || []);
            
            // Ensure other complex or potentially missing properties have defaults
            dataToLoad.teamAugmentation = dataToLoad.teamAugmentation || {};
            dataToLoad.overrides = dataToLoad.overrides || { oneTime: null, monthly: null };
            
            // Overwrite the global `selections` variable with the fully-formed, loaded data.
            selections = dataToLoad;
            return true; // Return true to indicate success.
        }
        // Return false if the data format is invalid.
        console.warn("loadSession returned false, data is missing core properties.");
        return false;
    } catch (e) {
        console.error("Error processing session data during loadSession:", e);
        return false;
    }
}


        // START: REPLACE THIS FUNCTION
function shareBuild() {
    try {
        // Create a serializable copy of the selections object to handle the Set
        const sessionToShare = {
            ...selections,
            packagesToCompare: Array.from(selections.packagesToCompare || []) // Convert Set to Array
        };
        const jsonString = JSON.stringify(sessionToShare);
        
        // ENCODING PROCESS - Compresses the data and converts it to a URL-safe Base64 string
        const compressed = pako.deflate(jsonString);
        const encoded = btoa(String.fromCharCode.apply(null, compressed)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

        const url = new URL(window.location);
        url.searchParams.set('s', encoded);

        // Use document.execCommand for robust copying in different environments (like iFrames).
        const textArea = document.createElement("textarea");
        textArea.value = url.href;
        textArea.style.position = "fixed"; // Avoid scrolling to bottom
        textArea.style.opacity = "0"; // Make it invisible
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showToast("Sharable link copied to clipboard!", "success");
        } catch (err) {
            showToast("Failed to copy link automatically.", "error");
            console.error('Clipboard copy failed:', err);
        }
        document.body.removeChild(textArea);
        
        trackAnalytics('build_shared');

    } catch (e) {
        console.error("Failed to create share link:", e);
        showToast("Could not create shareable link.", "error");
    }
}
        // END: REPLACE THIS FUNCTION
        // END: ADD THESE NEW FUNCTIONS
        function switchTab(tabId) {
            document.querySelectorAll('#main-tabs .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#main-content > div').forEach(c => c.classList.add('hidden'));
            const tab = document.getElementById(`tab-${tabId}`);
            const content = document.getElementById(`content-${tabId}`);
            if (tab && content) {
                tab.classList.add('active');
                content.classList.remove('hidden');
            }
        }
        function toggleAdminMode() {
            if (isAdmin) {
                isAdmin = false;
                document.body.classList.remove('admin-view');
                document.getElementById('tab-admin').classList.add('hidden');
                document.getElementById('tab-quotes').classList.add('hidden');
                document.querySelectorAll('.admin-override-input').forEach(i => i.classList.add('hidden'));

                // --- NEW: Stop listening when logging out ---
                if (quotesListener) {
                    quotesListener(); // This detaches the real-time listener
                    quotesListener = null;
                }
                // ------------------------------------------

                if(document.getElementById('tab-admin').classList.contains('active') || document.getElementById('tab-quotes').classList.contains('active')) {
                    switchTab('packages');
                }
            } else {
                const password = prompt('Enter admin password:');
                if (password === config.settings.password) {
                    isAdmin = true;
                    document.body.classList.add('admin-view');
                    document.getElementById('tab-admin').classList.remove('hidden');
                    document.getElementById('tab-quotes').classList.remove('hidden');
                    document.querySelectorAll('.admin-override-input').forEach(i => i.classList.remove('hidden'));
                    
                    // --- NEW: Start listening for quotes AFTER login ---
                    listenForQuotes(); 
                    // ---------------------------------------------------

                    renderAdminPanel();
                    // renderSubmittedQuotes() will be called automatically by the listener now
                    switchTab('admin');
                    showToast('Admin mode unlocked.', 'success');
                } else if (password) {
                    showToast('Incorrect password.', 'error');
                }
            }
        }
        // START: REPLACE THIS FUNCTION
        function selectPackage(packageId) {
            const pkg = findPackage(packageId);
            if (!pkg) return;
            const phase = selections.phases.find(p => p.id === selections.activePhaseId);
            if (!phase) {
                showToast("Cannot select package: No active phase.", "error");
                return;
            }

            phase.services = {}; // Clear existing services in the active phase
            
            pkg.services.forEach(s => {
                const service = findService(s.id);
                if (!service) return;

                const defaultMods = createDefaultModsForService(service);
                const packageMods = s.mods || {};
                const finalMods = { ...defaultMods, ...packageMods };

                // Carry over the locked status from the package config
                phase.services[s.id] = {
                    quantity: s.quantity || 1,
                    mods: finalMods,
                    termMonths: config.settings.retainerTerms[0]?.months || 1,
                    locked: s.locked || false 
                };
            });

            trackAnalytics('package_selected', { packageId });
            renderAll();
            switchTab('builder');
            showToast(`${pkg.name} package added to builder.`, 'info');
        }
        // END: REPLACE THIS FUNCTION
        // START: REPLACE THIS FUNCTION
function toggleService(serviceId) {
    const phase = selections.phases.find(p => p.id === selections.activePhaseId);
    if (!phase) {
        showToast("No active phase selected.", "error");
        return;
    }

    const service = findService(serviceId);
    if (!service) return;

    if (phase.services[serviceId]) { // This is a DESELECTION
        if (phase.services[serviceId].locked) {
            showToast(`${service.name} is locked by the selected package and cannot be removed.`, "error");
            return;
        }
        
        delete phase.services[serviceId];
        trackAnalytics('service_deselected', { serviceId });

        // --- FIX: CHECK FOR AND REMOVE DEPENDENTS ---
        const newlyRemovedServiceName = service.name;
        const removedDependents = [];

        // Check all other selected services to see if they depended on the one just removed.
        for (const selectedId in phase.services) {
            const selectedService = findService(selectedId);
            if (selectedService?.dependencies?.includes(serviceId)) {
                delete phase.services[selectedId];
                removedDependents.push(selectedService.name);
                trackAnalytics('service_deselected', { serviceId: selectedId, reason: 'dependency_removed' });
            }
        }
        
        if (removedDependents.length > 0) {
            const message = `${newlyRemovedServiceName} deselected, also removing dependent services: ${removedDependents.join(', ')}.`;
            showToast(message, 'info');
        }
        // --- END FIX ---

    } else { // This is a SELECTION
        phase.services[serviceId] = {
            quantity: 1,
            mods: createDefaultModsForService(service),
            termMonths: config.settings.retainerTerms[0]?.months || 1,
            locked: false
        };
        trackAnalytics('service_selected', { serviceId });

        if (service.corequisite && !phase.services[service.corequisite]) {
            const coreqService = findService(service.corequisite);
            if (coreqService) {
                phase.services[coreqService.id] = {
                    quantity: 1,
                    mods: createDefaultModsForService(coreqService),
                    termMonths: config.settings.retainerTerms[0]?.months || 1,
                    locked: false
                };
                trackAnalytics('service_selected', { serviceId: coreqService.id, reason: 'co-requisite' });
                showToast(`${coreqService.name} was automatically added as a required co-requisite.`, 'info');
            }
        }
    }
    renderBuilder();
    renderSummary();
}
        // END: REPLACE THIS FUNCTION
        function createDefaultModsForService(service) {
            if (!service.modifiers) return {};
            return service.modifiers.reduce((acc, mod) => {
                if ((mod.type === 'Dropdown' || mod.type === 'TieredDropdown') && mod.options && mod.options.length > 0) {
                    acc[mod.id] = mod.options[0].name;
                } else if (mod.type === 'Numeric') {
                    acc[mod.id] = 1;
                } else if (mod.type === 'Checkbox') {
                    acc[mod.id] = false;
                } else {
                    acc[mod.id] = '';
                }
                return acc;
            }, {});
        }
        function updateQuantity(serviceId, quantity) {
            const activePhase = selections.phases.find(p => p.id === selections.activePhaseId);
            if (activePhase && activePhase.services[serviceId]) {
                activePhase.services[serviceId].quantity = isNaN(quantity) ? 1 : Math.max(1, quantity);
                renderSummary();
            }
        }
        function updateModifier(serviceId, modifierId, value) {
            const activePhase = selections.phases.find(p => p.id === selections.activePhaseId);
             if (activePhase && activePhase.services[serviceId] && activePhase.services[serviceId].mods) {
                activePhase.services[serviceId].mods[modifierId] = value;
                trackAnalytics('modifier_used', { serviceId, modifierId });
                renderSummary();
            }
        }
        function updateRetainerTerm(serviceId, termMonths) {
            const activePhase = selections.phases.find(p => p.id === selections.activePhaseId);
            if (activePhase && activePhase.services[serviceId]) {
                activePhase.services[serviceId].termMonths = parseInt(termMonths, 10);
                renderSummary();
            }
        }
        // START: REPLACE THIS FUNCTION
function updateClientContext(field, value, target) {
    if (field === 'competitors') {
        const index = parseInt(target.dataset.index, 10);
        const subField = target.dataset.field; // 'url' or 'notes'
        selections.clientContext.competitors[index][subField] = value;
        
        if (subField === 'url' && value.trim() !== '') {
            trackAnalytics('competitor_url_entered', { url: value });
        }
    } else if (field === 'socialUrls') {
        const index = parseInt(target.dataset.index, 10);
        selections.clientContext.socialUrls[index] = { url: value };
    } else if (field === 'marketingHistory') {
        const historySet = new Set(selections.clientContext.marketingHistory);
        if (target.checked) {
            historySet.add(value);
        } else {
            historySet.delete(value);
        }
        selections.clientContext.marketingHistory = Array.from(historySet);
    } else {
        selections.clientContext[field] = value;
    }

    if (field === 'businessStage') {
        renderPackages();
    }
    if (field === 'businessGoal') {
        renderBuilder();
    }
    if (['monthlyTraffic', 'conversionRate', 'avgSaleValue'].includes(field)) {
        renderSummary();
        if (value.trim() !== '') {
            trackAnalytics('roi_data_entered', { field: field, value: value });
        }
    }
}

// END: REPLACE THIS FUNCTION
        // START: ADD THIS NEW FUNCTION
        function updateTeamAugmentationHours(roleId, hours) {
            if (isNaN(hours) || hours <= 0) {
                delete selections.teamAugmentation[roleId];
            } else {
                selections.teamAugmentation[roleId] = { hours: hours };
                // --- NEW: Analytics Tracking ---
                const role = (config.teamAugmentationRoles || []).find(r => r.id === roleId);
                if (role) {
                    trackAnalytics('team_role_added', { roleName: role.name, hours: hours });
                }
                // -----------------------------
            }
            renderAugmentationCalculator();
            renderSummary();
        }

        // END: ADD THIS NEW FUNCTION
        function clearBuilder() {
    if (confirm("Are you sure you want to clear all selections? This will reset the builder, any selected packages, and the summary to a blank state.")) {
        // By re-initializing the entire 'selections' object, we ensure a complete and clean reset.
        const newPhaseId = `phase-${Date.now()}`;
        selections = {
            phases: [{ id: newPhaseId, name: 'Phase 1: Campaign Selections', services: {}, adChannels: {} }],
            activePhaseId: newPhaseId,
            teamAugmentation: {},
            packagesToCompare: new Set(),
            clientContext: {
                businessStage: '',
                businessGoal: '',
                industry: '',
                targetAudience: '',
                geographicTarget: '',
                website: '',
                marketingHistory: [],
                previousProvider: '',
                previousServices: '',
                previousBudget: '',
                reasonForSwitching: '',
                durationWithProvider: '',
                satisfaction: 0,
                futureGoals: '',
                referralSource: '',
                avgLeadValue: '',
                avgClv: '',
                monthlyTraffic: '',
                conversionRate: '',
                avgSaleValue: '',
                competitors: [
                    { url: '', notes: '' },
                    { url: '', notes: '' },
                    { url: '', notes: '' }
                ],
                socialUrls: [
                    { url: '' },
                    { url: '' },
                    { url: '' }
                ]
            },
            overrides: { oneTime: null, monthly: null },
            appliedCoupon: null
        };

        // Also reset any UI elements that are managed outside the main render flow.
        document.getElementById('coupon-code-input').value = '';
        document.getElementById('coupon-status').textContent = '';
        
        showToast("All selections have been cleared.", "info");
        
        // A single, comprehensive render call to update the entire user interface.
        renderAll(); 
    }
}
                function addAdChannel() {
            const select = document.getElementById('add-ad-channel-select');
            const channelId = select.value;
            if (!channelId) return showToast("Please select a channel to add.", "error");
            const phase = selections.phases.find(p => p.id === selections.activePhaseId);
            if (!phase) return showToast("No active phase selected.", "error");
            const channel = findAdChannel(channelId);
            if (channel) {
                const isAlreadyAdded = Object.values(phase.adChannels).some(c => c.id === channelId);
                if (isAlreadyAdded) return showToast(`${channel.name} has already been added to this phase.`, "error");
                const selectionId = `selection-${Date.now()}`;
                phase.adChannels[selectionId] = {
                    id: channel.id,
                    spend: 1000,
                    setupFee: channel.setupFee || 0,
                };
                trackAnalytics('adchannel_added', { channelId: channel.id });
                select.value = ""; // Reset dropdown
                renderBuilder();
                renderSummary();
            } else {
                showToast("Invalid channel ID selected.", "error");
            }
        }
        function removeAdChannel(selectionId) {
            const phase = selections.phases.find(p => p.id === selections.activePhaseId);
            if (phase && phase.adChannels[selectionId]) {
                delete phase.adChannels[selectionId];
                renderBuilder();
                renderSummary();
            }
        }
        function updateAdSpend(selectionId, spend) {
            const phase = selections.phases.find(p => p.id === selections.activePhaseId);
            if (phase && phase.adChannels[selectionId]) {
                phase.adChannels[selectionId].spend = isNaN(spend) ? 0 : spend;
                renderSummary();
            }
        }
        function updateAdSetupFee(selectionId, fee) {
            const phase = selections.phases.find(p => p.id === selections.activePhaseId);
            if (phase && phase.adChannels[selectionId]) {
                phase.adChannels[selectionId].setupFee = isNaN(fee) ? 0 : fee;
                renderSummary();
            }
        }
        function removeAdChannel(selectionId) {
            const phase = selections.phases.find(p => p.id === selections.activePhaseId);
            if (phase && phase.adChannels[selectionId]) {
                delete phase.adChannels[selectionId];
                renderBuilder();
                renderSummary();
            }
        }
        function updateAdSpend(selectionId, spend) {
            const phase = selections.phases.find(p => p.id === selections.activePhaseId);
            if (phase && phase.adChannels[selectionId]) {
                phase.adChannels[selectionId].spend = isNaN(spend) ? 0 : spend;
                renderSummary();
            }
        }
        function updateAdSetupFee(selectionId, fee) {
            const phase = selections.phases.find(p => p.id === selections.activePhaseId);
            if (phase && phase.adChannels[selectionId]) {
                phase.adChannels[selectionId].setupFee = isNaN(fee) ? 0 : fee;
                renderSummary();
            }
        }
        function toggleAccordion(button) {
            const accordionId = button.dataset.id;
            const content = button.nextElementSibling;
            if (!content || !content.classList.contains('accordion-content')) return;
            const icon = button.querySelector('svg');
            if (openAccordions.has(accordionId)) {
                openAccordions.delete(accordionId);
                content.classList.remove('open');
                icon.classList.remove('rotate-180');
            } else {
                openAccordions.add(accordionId);
                content.classList.add('open');
                icon.classList.add('rotate-180');
            }
        }
        // #endregion
        // #region ########## ADMIN CRUD and MODAL LOGIC ##########
        // START: REPLACE THIS FUNCTION
        function handleAdminAdd(target) {
    const type = target.dataset.type;
    const id = target.dataset.id; // Used for category
    if (type === 'service') {
        openEditModal({}, 'service');
    } else if (type === 'package') {
        openPackageEditModal({});
    } else if (type === 'marketing-discount') {
        openDiscountEditModal({});
    } else if (type === 'team-augmentation-role') {
        openEditModal({}, 'team-augmentation-role');
    } else if (type === 'category') {
        const newCatName = prompt(`Enter new category name:`);
        if (newCatName) {
            const newCatId = `cat-${newCatName.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}`;
            config.categories.push({ id: newCatId, name: newCatName, departmentId: id });
            renderAdminPanel();
        }
    } else if (type === 'bundle-discount') {
        config.settings.bundleDiscounts.push({ threshold: 10, percentage: 0.15 });
        renderAdminPanel();
    } else if (type === 'ad-tier') {
        config.settings.adFeeTiers.push({ threshold: 100000, percentage: 0.1, minFee: 10000 });
        renderAdminPanel();
    } else if (type === 'retainer-term') {
        config.settings.retainerTerms.push({ name: "New Term", months: 24, discount: 0.20 });
        renderAdminPanel();
    }
}
        // END: REPLACE THIS FUNCTION
        // START: REPLACE THIS FUNCTION
        function handleAdminEdit(target) {
    const id = target.dataset.id;
    const type = target.dataset.type;
    if (type === 'service') {
        const service = findService(id);
        if (service) openEditModal(service, 'service');
    } else if (type === 'category') {
        const category = findCategory(id);
        if (category) openEditModal(category, 'category');
    } else if (type === 'package') {
        const pkg = findPackage(id);
        if(pkg) openPackageEditModal(pkg);
    } else if (type === 'marketing-discount') {
        const discount = findDiscount(id);
        if (discount) openDiscountEditModal(discount);
    } else if (type === 'team-augmentation-role') {
        const role = (config.teamAugmentationRoles || []).find(r => r.id === id);
        if (role) openEditModal(role, 'team-augmentation-role');
    }
}
        // END: REPLACE THIS FUNCTION
        // START: REPLACE THIS FUNCTION
function openEditModal(item = {}, type) {
    const form = document.getElementById('edit-form');
    const overlay = document.getElementById('edit-modal-overlay');
    const modalTitle = document.querySelector('#edit-modal-content h3');
    
    let formHtml = '';

    if (type === 'service') {
        modalTitle.textContent = item.id ? 'Edit Service' : 'Create New Service';
        tempModifiers = JSON.parse(JSON.stringify(item.modifiers || []));
        const allServiceOptions = config.services.map(s => `<option value="${s.id}" ${item.id === s.id ? 'disabled' : ''}>${s.name}</option>`).join('');
        const priorities = ['Core', 'Recommended', 'Upsell'];
        const pricingModels = ['Project', 'Monthly', 'Unit', 'Hourly', 'Quote'];
        const categoryOptions = config.categories.map(c => `<option value="${c.id}" ${item.categoryId === c.id ? 'selected' : ''}>${findDepartment(c.departmentId)?.name} > ${c.name}</option>`).join('');

        formHtml = `
            <input type="hidden" name="id" value="${item.id || `s-${Date.now()}`}">
            <input type="hidden" name="type" value="service">
            
            <div class="space-y-4">
                <div><label class="block text-sm font-medium">Service Name</label><input type="text" name="name" value="${item.name || ''}" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label class="block text-sm font-medium">Description</label><textarea name="desc" class="mt-1 block w-full p-2 border rounded-md h-24">${item.desc || ''}</textarea></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 border-t pt-4">
                 <div class="space-y-4">
                    <h4 class="font-semibold text-lg">Pricing</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium">Base Price</label><input type="number" name="price" value="${item.price || 0}" step="0.01" class="mt-1 block w-full p-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">Setup Fee</label><input type="number" name="setupFee" value="${item.setupFee || 0}" step="0.01" class="mt-1 block w-full p-2 border rounded-md"></div>
                     </div>
                 </div>
                 <div class="space-y-4">
                     <h4 class="font-semibold text-lg">Model</h4>
                     <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium">Pricing Model</label><select name="model" class="mt-1 block w-full p-2 border rounded-md">${pricingModels.map(m => `<option value="${m}" ${item.model === m ? 'selected' : ''}>${m}</option>`).join('')}</select></div>
                        <div><label class="block text-sm font-medium">Unit Name (if Unit/Hourly)</label><input type="text" name="unit" value="${item.unit || ''}" class="mt-1 block w-full p-2 border rounded-md"></div>
                    </div>
                 </div>
            </div>

            <div class="mt-6 border-t pt-4">
                <h4 class="font-semibold text-lg mb-2">Category & Modifiers</h4>
                 <div><label class="block text-sm font-medium">Category</label><select name="categoryId" class="mt-1 block w-full p-2 border rounded-md">${categoryOptions}</select></div>
                <div class="mt-4">
                    <label class="block text-sm font-medium mb-2">Service Modifiers</label>
                    <div id="service-modifiers-container" class="space-y-3">${renderModifierRows(tempModifiers)}</div>
                    <button type="button" data-action="add-service-modifier" class="mt-3 bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">+ Add Modifier</button>
                </div>
             </div>

            <div class="mt-6 border-t pt-4">
                <h4 class="font-semibold text-lg mb-2">Value & Metadata</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium">Value Propositions (one per line)</label>
                        <textarea name="valuePropositions" class="mt-1 block w-full p-2 border rounded-md h-24">${(item.valuePropositions || []).join('\n')}</textarea>
                    </div>
                     <div>
                        <label class="block text-sm font-medium">Priority / Recommendation Type</label>
                        <select name="priority" class="mt-1 block w-full p-2 border rounded-md">${priorities.map(p => `<option value="${p}" ${item.priority === p ? 'selected' : ''}>${p}</option>`).join('')}</select>
                        <label class="block text-sm font-medium mt-4">Tags (comma-separated)</label>
                        <input type="text" name="tags" value="${(item.tags || []).join(', ')}" class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                </div>
             </div>

             <div class="mt-6 border-t pt-4">
                <h4 class="font-semibold text-lg mb-2">Dependencies</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium">Requires (select all that apply)</label>
                        <select name="dependencies" multiple class="mt-1 block w-full p-2 border rounded-md h-32">${allServiceOptions.replace(new RegExp((item.dependencies || []).map(d => `value="${d}"`).join('|'), 'g'), match => `${match} selected`)}</select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Automatically Adds (Co-requisite)</label>
                        <select name="corequisite" class="mt-1 block w-full p-2 border rounded-md"><option value="">None</option>${allServiceOptions.replace(`value="${item.corequisite}"`, `value="${item.corequisite}" selected`)}</select>
                        <label class="block text-sm font-medium mt-4">Timeline Depends On</label>
                        <select name="timelineDependsOn" class="mt-1 block w-full p-2 border rounded-md"><option value="">None</option>${allServiceOptions.replace(`value="${item.timelineDependsOn}"`, `value="${item.timelineDependsOn}" selected`)}</select>
                    </div>
                </div>
            </div>

            <div class="mt-6 border-t pt-4">
                <h4 class="font-semibold text-lg mb-2">ROI & Timeline</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium">ROI Metric Name</label><input type="text" name="roiMetricName" value="${item.roiMetrics?.metricName || ''}" class="mt-1 block w-full p-2 border rounded-md">
                        <label class="block text-sm font-medium mt-2">ROI Metric Unit</label><input type="text" name="roiMetricUnit" value="${item.roiMetrics?.metricUnit || ''}" class="mt-1 block w-full p-2 border rounded-md">
                        <div class="grid grid-cols-2 gap-2 mt-2">
                             <div><label class="text-sm">Min Impact</label><input type="number" name="roiMinImpact" value="${item.roiMetrics?.minImpact || 0}" class="w-full p-2 border rounded-md"></div>
                             <div><label class="text-sm">Max Impact</label><input type="number" name="roiMaxImpact" value="${item.roiMetrics?.maxImpact || 0}" class="w-full p-2 border rounded-md"></div>
                        </div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium">Timeline Phase Name</label><input type="text" name="timelinePhaseName" value="${item.timeline?.phaseName || ''}" class="mt-1 block w-full p-2 border rounded-md">
                         <label class="block text-sm font-medium mt-2">Duration (Weeks)</label><input type="number" name="timelineDuration" value="${item.timeline?.durationWeeks || 0}" class="mt-1 block w-full p-2 border rounded-md">
                         <div class="mt-4"><input type="checkbox" name="timelineHidden" ${item.timeline?.hidden ? 'checked' : ''} class="h-4 w-4 rounded"><label class="ml-2">Hide from timeline chart by default</label></div>
                    </div>
                </div>
            </div>
        `;
    } else if (type === 'category') {
        modalTitle.textContent = 'Edit Category';
        formHtml = `
            <input type="hidden" name="originalId" value="${item.id}">
            <input type="hidden" name="type" value="category">
            <div><label class="block text-sm font-medium">Category Name</label><input type="text" name="name" value="${item.name}" class="mt-1 block w-full p-2 border rounded-md" required></div>
            <div><label class="block text-sm font-medium">Category ID</label><input type="text" name="id" value="${item.id}" class="mt-1 block w-full p-2 border rounded-md" required></div>
        `;
    } else if (type === 'team-augmentation-role') {
        modalTitle.textContent = item.id ? 'Edit Team Role' : 'Create New Team Role';
        formHtml = `
            <input type="hidden" name="id" value="${item.id || `role-${Date.now()}`}">
            <input type="hidden" name="type" value="team-augmentation-role">
            <div class="space-y-4">
                <div><label class="block text-sm font-medium">Role Name</label><input type="text" name="name" value="${item.name || ''}" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label class="block text-sm font-medium">Description</label><textarea name="description" class="mt-1 block w-full p-2 border rounded-md h-20">${item.description || ''}</textarea></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium">Cost per Hour ($)</label><input type="number" name="costPerHr" value="${item.costPerHr || 0}" step="1" class="mt-1 block w-full p-2 border rounded-md"></div>
                    <div><label class="block text-sm font-medium">Minimum Hours / Month</label><input type="number" name="minHrsPerMonth" value="${item.minHrsPerMonth || 0}" step="1" class="mt-1 block w-full p-2 border rounded-md"></div>
                </div>
                <div><label class="block text-sm font-medium">Full-Time Salary Comparison ($)</label><input type="number" name="fullTimeSalaryComparison" value="${item.fullTimeSalaryComparison || 0}" step="1000" class="mt-1 block w-full p-2 border rounded-md"></div>
            </div>
        `;
    }

    form.innerHTML = formHtml + `
        <div class="flex justify-end gap-4 pt-4 border-t mt-6">
            <button type="button" data-action="close-modal" class="bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">Cancel</button>
            <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Changes</button>
        </div>
    `;

    document.querySelectorAll('#service-modifiers-container .modifier-type').forEach(el => handleModifierTypeChange(el));
    overlay.style.display = 'flex';
}
        // END: REPLACE THIS FUNCTION
        function closeEditModal() {
            document.getElementById('edit-modal-overlay').style.display = 'none';
            tempModifiers = [];
        }
        // START: ADD THIS MISSING FUNCTION
function handleAdminSaveEdit(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const type = formData.get('type');
    
    if (type === 'service') {
        const id = formData.get('id');
        const serviceIndex = config.services.findIndex(s => s.id === id);
        updateTempModifiersFromDOM();
        
        const serviceData = {
            id: id,
            name: formData.get('name'),
            desc: formData.get('desc'),
            price: parseFloat(formData.get('price')) || 0,
            setupFee: parseFloat(formData.get('setupFee')) || 0,
            model: formData.get('model'),
            categoryId: formData.get('categoryId'),
            unit: formData.get('unit'),
            modifiers: tempModifiers,
            valuePropositions: formData.get('valuePropositions').split('\n').filter(vp => vp.trim() !== ''),
            priority: formData.get('priority'),
            timeline: {
                phaseName: formData.get('timelinePhaseName'),
                durationWeeks: parseInt(formData.get('timelineDuration'), 10) || 0,
                hidden: formData.get('timelineHidden') === 'on'
            },
            roiMetrics: {
                metricName: formData.get('roiMetricName'),
                metricUnit: formData.get('roiMetricUnit'),
                minImpact: parseFloat(formData.get('roiMinImpact')) || 0,
                maxImpact: parseFloat(formData.get('roiMaxImpact')) || 0,
            },
            dependencies: formData.getAll('dependencies'),
            corequisite: formData.get('corequisite'),
            tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(Boolean),
            timelineDependsOn: formData.get('timelineDependsOn')
        };
        if (serviceIndex > -1) {
            config.services[serviceIndex] = serviceData;
        } else {
            config.services.push(serviceData);
        }
    } else if (type === 'package') {
        const id = formData.get('id');
        const packageIndex = config.packages.findIndex(p => p.id === id);
        const packageData = {
            id: id, name: formData.get('name'), desc: formData.get('desc'),
            displayPrice: parseFloat(formData.get('displayPrice')) || 0,
            features: formData.get('features'), services: []
        };
        document.querySelectorAll('#package-services-container .package-service-row').forEach(row => {
            const serviceId = row.querySelector('.package-service-id').value;
            const quantity = parseInt(row.querySelector('.package-service-quantity').value, 10) || 1;
            const isLocked = row.querySelector('.package-service-locked').checked;
            if (serviceId) {
                packageData.services.push({ id: serviceId, quantity, mods: {}, locked: isLocked });
            }
        });
        if (packageIndex > -1) { config.packages[packageIndex] = packageData; } 
        else { config.packages.push(packageData); }
    } else if (type === 'team-augmentation-role') {
        // ... this section is correct in the original file
    } else if (type === 'category') {
        // ... this section is correct in the original file
    } else if (type === 'marketing-discount') {
       // ... this section is correct in the original file
    }

    showToast(`Item updated. Remember to click "Save All Changes" to persist your edits.`, 'info');
    renderAdminPanel();
    closeEditModal();
}
        // END: ADD THIS MISSING FUNCTION
        // START: REPLACE THIS FUNCTION        
        // #endregion
        // #region ########## MODIFIER & PACKAGE EDITING LOGIC ##########
        function moveCategory(categoryId, direction) {
            const index = config.categories.findIndex(c => c.id === categoryId);
            if (index === -1) return;
            const category = config.categories[index];
            const departmentCategories = config.categories.filter(c => c.departmentId === category.departmentId);
            const localIndex = departmentCategories.findIndex(c => c.id === categoryId);
            if (direction === 'up' && localIndex > 0) {
                const swapWithCategory = departmentCategories[localIndex - 1];
                const swapWithIndex = config.categories.findIndex(c => c.id === swapWithCategory.id);
                [config.categories[index], config.categories[swapWithIndex]] = [config.categories[swapWithIndex], config.categories[index]];
            } else if (direction === 'down' && localIndex < departmentCategories.length - 1) {
                const swapWithCategory = departmentCategories[localIndex + 1];
                const swapWithIndex = config.categories.findIndex(c => c.id === swapWithCategory.id);
                [config.categories[index], config.categories[swapWithIndex]] = [config.categories[swapWithIndex], config.categories[index]];
            }
            renderAdminPanel();
            renderBuilder();
        }
        // START: REPLACE THIS FUNCTION
        function openPackageEditModal(pkg = {}) {
            const form = document.getElementById('edit-form');
            const overlay = document.getElementById('edit-modal-overlay');
            const modalTitle = document.querySelector('#edit-modal-content h3');
            modalTitle.textContent = pkg.id ? 'Edit Package' : 'Create New Package';

            form.innerHTML = `
                <input type="hidden" name="id" value="${pkg.id || `pkg-${Date.now()}`}">
                <input type="hidden" name="type" value="package">
                
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium">Package Name</label><input type="text" name="name" value="${pkg.name || ''}" class="mt-1 block w-full p-2 border rounded-md" required></div>
                    <div><label class="block text-sm font-medium">Description</label><textarea name="desc" class="mt-1 block w-full p-2 border rounded-md h-20">${pkg.desc || ''}</textarea></div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium">Display Price</label><input type="number" name="displayPrice" value="${pkg.displayPrice || 0}" step="0.01" class="mt-1 block w-full p-2 border rounded-md"></div>
                        <div><label class="block text-sm font-medium">Features (comma-separated)</label><input type="text" name="features" value="${pkg.features || ''}" class="mt-1 block w-full p-2 border rounded-md"></div>
                    </div>
                </div>

                    <div class="border-t pt-4 mt-4">
                    <h4 class="text-lg font-semibold mb-2">Included Services</h4>
                    <div id="package-services-container" class="space-y-3">
                        ${renderPackageServiceRows(pkg.services || [])}
                    </div>
                    <button type="button" data-action="add-package-service" class="mt-3 bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">+ Add Service</button>
                </div>

                    <div class="flex justify-end gap-4 pt-4 border-t mt-6">
                    <button type="button" data-action="close-modal" class="bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Changes</button>
                </div>
            `;
            overlay.style.display = 'flex';
        }
        // END: REPLACE THIS FUNCTION
        // NEW: Modal for adding/editing marketing discounts
        function openDiscountEditModal(discount = {}) {
            const form = document.getElementById('edit-form');
            const overlay = document.getElementById('edit-modal-overlay');
            const modalTitle = document.querySelector('#edit-modal-content h3');
            modalTitle.textContent = discount.id ? 'Edit Discount Code' : 'Create New Discount Code';
            const serviceOptions = config.services.map(s => `<option value="${s.id}" ${discount.targetId === s.id ? 'selected' : ''}>${s.name}</option>`).join('');
            const categoryOptions = config.categories.map(c => `<option value="${c.id}" ${discount.targetId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            // Note the change here: the select is now named 'discountType' to avoid collision
            form.innerHTML = `
                <input type="hidden" name="id" value="${discount.id || `disc-${Date.now()}`}">
                <input type="hidden" name="type" value="marketing-discount">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium">Code</label><input type="text" name="code" value="${discount.code || ''}" class="mt-1 block w-full p-2 border rounded-md uppercase" required></div>
                    <div><label class="block text-sm font-medium">Value</label><input type="number" name="value" value="${discount.type === 'percent' ? (discount.value || 0) * 100 : (discount.value || 0)}" step="0.01" class="mt-1 block w-full p-2 border rounded-md"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium">Discount Type</label>
                        <select name="discountType" class="mt-1 block w-full p-2 border rounded-md">
                            <option value="percent" ${discount.type === 'percent' ? 'selected' : ''}>Percentage (%)</option>
                            <option value="fixed" ${discount.type === 'fixed' ? 'selected' : ''}>Fixed Amount ($)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Apply To</label>
                        <select name="applyTo" id="discount-apply-to" class="mt-1 block w-full p-2 border rounded-md">
                            <option value="oneTime" ${discount.applyTo === 'oneTime' ? 'selected' : ''}>Total One-Time Fees</option>
                            <option value="monthly" ${discount.applyTo === 'monthly' ? 'selected' : ''}>Total Monthly Retainer</option>
                            <option value="service" ${discount.applyTo === 'service' ? 'selected' : ''}>Specific Service</option>
                            <option value="category" ${discount.applyTo === 'category' ? 'selected' : ''}>Specific Category</option>
                        </select>
                    </div>
                </div>
                <div id="discount-target-container" class="hidden">
                    <label class="block text-sm font-medium">Target</label>
                    <select name="targetId" id="discount-target-id" class="mt-1 block w-full p-2 border rounded-md">${discount.applyTo === 'service' ? serviceOptions : categoryOptions}</select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium">Start Date (Optional)</label><input type="date" name="startDate" value="${discount.startDate || ''}" class="mt-1 block w-full p-2 border rounded-md"></div>
                    <div><label class="block text-sm font-medium">End Date (Optional)</label><input type="date" name="endDate" value="${discount.endDate || ''}" class="mt-1 block w-full p-2 border rounded-md"></div>
                </div>
                 <div class="flex justify-end gap-4 pt-4 border-t mt-6">
                    <button type="button" data-action="close-modal" class="bg-gray-200 py-2 px-4 rounded-lg text-sm hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Changes</button>
                </div>
            `;
            const applyToSelect = form.querySelector('#discount-apply-to');
            const targetContainer = form.querySelector('#discount-target-container');
            const targetSelect = form.querySelector('#discount-target-id');
            const toggleTargetSelect = () => {
                const selected = applyToSelect.value;
                if (selected === 'service' || selected === 'category') {
                    targetContainer.classList.remove('hidden');
                    targetSelect.innerHTML = selected === 'service' ? serviceOptions : categoryOptions;
                } else {
                    targetContainer.classList.add('hidden');
                }
            };
            applyToSelect.addEventListener('change', toggleTargetSelect);
            toggleTargetSelect(); // Initial call
            overlay.style.display = 'flex';
        }
        // START: REPLACE THIS FUNCTION
        function renderPackageServiceRows(services) {
            if (!services || services.length === 0) return '<p class="text-gray-500 text-sm">No services in this package.</p>';
            const serviceOptions = config.services.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            return services.map(s => `
                <div class="grid grid-cols-12 gap-2 items-center package-service-row">
                    <div class="col-span-6"><select class="w-full p-2 border rounded-md package-service-id">${serviceOptions.replace(`value="${s.id}"`, `value="${s.id}" selected`)}</select></div>
                    <div class="col-span-2"><input type="number" min="1" value="${s.quantity || 1}" class="w-full p-2 border rounded-md package-service-quantity"></div>
                    <div class="col-span-3 flex items-center justify-center">
                        <input type="checkbox" ${s.locked ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 package-service-locked">
                        <label class="ml-2 text-sm">Locked</label>
                    </div>
                    <div class="col-span-1 text-right"><button type="button" data-action="remove-package-service" class="text-red-500 hover:text-red-700 font-bold text-lg">&times;</button></div>
                </div>
            `).join('');
        }
        // END: REPLACE THIS FUNCTION
        function addPackageServiceRow() {
            const container = document.getElementById('package-services-container');
            if (container.querySelector('p')) container.innerHTML = '';
            const serviceOptions = config.services.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            const newRowHtml = `
                <div class="grid grid-cols-12 gap-2 items-center package-service-row">
                    <div class="col-span-8"><select class="w-full p-2 border rounded-md package-service-id"><option value="">Select a service...</option>${serviceOptions}</select></div>
                    <div class="col-span-3"><input type="number" min="1" value="1" class="w-full p-2 border rounded-md package-service-quantity"></div>
                    <div class="col-span-1 text-right"><button type="button" data-action="remove-package-service" class="text-red-500 hover:text-red-700 font-bold text-lg">&times;</button></div>
                </div>`;
            container.insertAdjacentHTML('beforeend', newRowHtml);
        }
        function renderModifierRows(modifiers) {
    if (!modifiers || modifiers.length === 0) return '<p class="text-gray-500 text-sm">No modifiers for this service.</p>';
    return modifiers.map((mod, index) => {
        const modifierTypes = ['Dropdown', 'TieredDropdown', 'Numeric', 'Checkbox', 'Text'];
        const isOptionsType = mod.type === 'Dropdown' || mod.type === 'TieredDropdown';
        const hasNumericConfig = mod.type === 'Numeric';
        const hasCheckboxConfig = mod.type === 'Checkbox';

        return `
        <div class="p-3 border rounded-md bg-gray-50 modifier-row" data-modifier-index="${index}">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
                <input type="text" placeholder="Modifier Name" value="${mod.name || ''}" class="p-2 border rounded-md modifier-name">
                <select class="p-2 border rounded-md modifier-type" data-change-action="update-modifier-type">
                    ${modifierTypes.map(type => `<option value="${type}" ${mod.type === type ? 'selected' : ''}>${type}</option>`).join('')}
                </select>
                <div class="flex items-center justify-end gap-2">
                     <button type="button" data-action="edit-modifier-options" data-modifier-index="${index}" class="text-sm text-blue-600 hover:underline ${isOptionsType ? '' : 'hidden'}">Edit Options (${mod.options ? mod.options.length : 0})</button>
                     <button type="button" data-action="remove-service-modifier" class="text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
                </div>
            </div>
            <div id="config-Numeric-${index}" class="modifier-config-panel mt-3 pt-3 border-t border-gray-200 ${hasNumericConfig ? '' : 'hidden'}">
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div><label class="text-sm font-medium">Price Per Unit</label><input type="number" step="0.01" class="mt-1 w-full p-2 border rounded-md modifier-price-per-unit" value="${mod.pricePerUnit || 0}"></div>
                    <div><label class="text-sm font-medium">Unit Name</label><input type="text" class="mt-1 w-full p-2 border rounded-md modifier-unit-name" value="${mod.unitName || 'unit'}"></div>
                </div>
            </div>
            <div id="config-Checkbox-${index}" class="modifier-config-panel mt-3 pt-3 border-t border-gray-200 ${hasCheckboxConfig ? '' : 'hidden'}">
                 <div><label class="text-sm font-medium">Price Adjustment (if checked)</label><input type="number" step="0.01" class="mt-1 w-full p-2 border rounded-md modifier-adjustment" value="${mod.adjustment || 0}"></div>
            </div>
        </div>`;
    }).join('');
}
        function handleModifierTypeChange(selectElement) {
    const row = selectElement.closest('.modifier-row');
    const selectedType = selectElement.value;
    row.querySelectorAll('.modifier-config-panel').forEach(p => p.style.display = 'none');
    
    const panelToShow = row.querySelector(`#config-${selectedType}-${row.dataset.modifierIndex}`);
    if (panelToShow) {
        panelToShow.style.display = 'block';
    }
    
    const optionsButton = row.querySelector('[data-action="edit-modifier-options"]');
    if(optionsButton) {
        optionsButton.classList.toggle('hidden', !(selectedType === 'Dropdown' || selectedType === 'TieredDropdown'));
    }
}
        function renderDiscountTiers(discounts) {
            if (!discounts || discounts.length === 0) return '';
            return discounts.map(tier => `
                <div class="grid grid-cols-12 gap-2 items-center discount-tier-row">
                    <span class="col-span-2 text-sm text-right">If Qty >=</span>
                    <div class="col-span-3"><input type="number" min="1" class="w-full p-1 border rounded discount-threshold" value="${tier.threshold || 1}"></div>
                    <span class="col-span-2 text-sm text-right">then</span>
                    <div class="col-span-3"><input type="number" min="0" max="100" class="w-full p-1 border rounded discount-percentage" value="${(tier.percentage || 0) * 100}"></div>
                    <span class="col-span-1 text-sm">% off</span>
                    <div class="col-span-1 text-right"><button type="button" data-action="remove-modifier-discount-tier" class="text-red-500 hover:text-red-700 font-bold">&times;</button></div>
                </div>
            `).join('');
        }
        function addModifierRow() {
            const newModifier = { id: `mod-${Date.now()}`, name: '', type: 'Dropdown', options: [] };
            tempModifiers.push(newModifier);
            const container = document.getElementById('service-modifiers-container');
            if (container.querySelector('p')) container.innerHTML = '';
            const newRowHTML = renderModifierRows([newModifier]);
            container.insertAdjacentHTML('beforeend', newRowHTML.replace(/data-modifier-index="0"/g, `data-modifier-index="${tempModifiers.length - 1}"`));
            const newRowElement = container.lastElementChild;
            handleModifierTypeChange(newRowElement.querySelector('.modifier-type'));
        }
        function removeModifierRow(button) {
            const row = button.closest('.modifier-row');
            const index = parseInt(row.dataset.modifierIndex, 10);
            updateTempModifiersFromDOM();
            if (!isNaN(index)) {
                tempModifiers.splice(index, 1);
                document.getElementById('service-modifiers-container').innerHTML = renderModifierRows(tempModifiers);
                document.querySelectorAll('.modifier-row .modifier-type').forEach(el => handleModifierTypeChange(el));
            }
        }
        function addDiscountTierRow(button) { /* Omitted for brevity */ }
        function updateTempModifiersFromDOM() {
            const modifierRows = document.querySelectorAll('#service-modifiers-container .modifier-row');
            const newTempModifiers = [];
            modifierRows.forEach((row, newIndex) => {
                const originalIndex = parseInt(row.dataset.modifierIndex, 10);
                const originalMod = tempModifiers[originalIndex] || { id: `mod-${Date.now()}` };
                const modType = row.querySelector('.modifier-type').value;
                const updatedMod = {
                    id: originalMod.id,
                    name: row.querySelector('.modifier-name').value,
                    type: modType,
                    options: originalMod.options || [], 
                    discounts: originalMod.discounts || []
                };
                if (modType === 'Numeric') {
                    updatedMod.pricePerUnit = parseFloat(row.querySelector('.modifier-price-per-unit').value) || 0;
                    updatedMod.unitName = row.querySelector('.modifier-unit-name').value || 'unit';
                    updatedMod.discounts = [];
                     row.querySelectorAll('.discount-tier-row').forEach(tierRow => {
                        updatedMod.discounts.push({
                            threshold: parseInt(tierRow.querySelector('.discount-threshold').value) || 0,
                            percentage: (parseFloat(tierRow.querySelector('.discount-percentage').value) || 0) / 100,
                        });
                    });
                } else if (modType === 'Checkbox') {
                    updatedMod.adjustment = parseFloat(row.querySelector('.modifier-adjustment').value) || 0;
                }
                newTempModifiers.push(updatedMod);
            });
            tempModifiers = newTempModifiers;
        }
        function openModifierOptionsModal(index) {
            updateTempModifiersFromDOM();
            const modifier = tempModifiers[index];
            if (!modifier || (modifier.type !== 'Dropdown' && modifier.type !== 'TieredDropdown')) return;
            const form = document.getElementById('modifier-options-form');
            const modal = document.getElementById('modifier-options-modal');
            const title = document.getElementById('modifier-options-modal-title');
            modal.dataset.editingModifierIndex = index;
            title.textContent = `Edit Options for "${modifier.name}"`;
            let optionsHtml = '';
            const isTiered = modifier.type === 'TieredDropdown';
            if (isTiered) {
                optionsHtml = (modifier.options || []).map(opt => `
                    <div class="grid grid-cols-12 gap-2 items-center modifier-option-row">
                        <div class="col-span-7"><input type="text" placeholder="Option Name" value="${opt.name}" class="p-2 border rounded-md w-full option-name"></div>
                        <span class="col-span-2 text-sm text-right">Multiplier:</span>
                        <div class="col-span-2"><input type="number" step="0.01" value="${opt.multiplier || 1.0}" class="p-2 border rounded-md w-full option-multiplier"></div>
                        <button type="button" data-action="remove-modifier-option" class="col-span-1 text-red-500 hover:text-red-700 font-bold">&times;</button>
                    </div>`).join('');
            } else { // Standard Dropdown
                optionsHtml = (modifier.options || []).map(opt => `
                    <div class="grid grid-cols-12 gap-2 items-center modifier-option-row">
                        <div class="col-span-7"><input type="text" placeholder="Option Name" value="${opt.name}" class="p-2 border rounded-md w-full option-name"></div>
                         <span class="col-span-2 text-sm text-right">Adjustment:</span>
                        <div class="col-span-2"><input type="number" step="0.01" value="${opt.adjustment || 0}" class="p-2 border rounded-md w-full option-adjustment"></div>
                        <button type="button" data-action="remove-modifier-option" class="col-span-1 text-red-500 hover:text-red-700 font-bold">&times;</button>
                    </div>`).join('');
            }
            form.innerHTML = optionsHtml || '<p class="text-gray-500">No options yet. Add one below.</p>';
            document.getElementById('modifier-options-modal').style.display = 'flex';
        }
        function addModifierOptionRow() {
            const form = document.getElementById('modifier-options-form');
            const index = document.getElementById('modifier-options-modal').dataset.editingModifierIndex;
            const modifier = tempModifiers[index];
            if (!modifier) return;
            if (form.querySelector('p')) form.innerHTML = '';
            const isTiered = modifier.type === 'TieredDropdown';
            let newRowHtml = '';
            if (isTiered) {
                 newRowHtml = `<div class="grid grid-cols-12 gap-2 items-center modifier-option-row"><div class="col-span-7"><input type="text" placeholder="Option Name" class="p-2 border rounded-md w-full option-name"></div><span class="col-span-2 text-sm text-right">Multiplier:</span><div class="col-span-2"><input type="number" step="0.01" value="1.0" class="p-2 border rounded-md w-full option-multiplier"></div><button type="button" data-action="remove-modifier-option" class="col-span-1 text-red-500 hover:text-red-700 font-bold">&times;</button></div>`;
            } else {
                 newRowHtml = `<div class="grid grid-cols-12 gap-2 items-center modifier-option-row"><div class="col-span-7"><input type="text" placeholder="Option Name" class="p-2 border rounded-md w-full option-name"></div><span class="col-span-2 text-sm text-right">Adjustment:</span><div class="col-span-2"><input type="number" step="0.01" value="0" class="p-2 border rounded-md w-full option-adjustment"></div><button type="button" data-action="remove-modifier-option" class="col-span-1 text-red-500 hover:text-red-700 font-bold">&times;</button></div>`;
            }
            form.insertAdjacentHTML('beforeend', newRowHtml);
        }
        function closeModifierOptionsModal() {
            document.getElementById('modifier-options-modal').style.display = 'none';
        }
        function saveModifierOptions() {
            const modal = document.getElementById('modifier-options-modal');
            const index = modal.dataset.editingModifierIndex;
            const modifier = tempModifiers[index];
            if (!modifier) return;
            const newOptions = [];
            const isTiered = modifier.type === 'TieredDropdown';
            document.querySelectorAll('#modifier-options-form .modifier-option-row').forEach(row => {
                const name = row.querySelector('.option-name').value;
                if(name) {
                    if (isTiered) {
                        newOptions.push({ name: name, multiplier: parseFloat(row.querySelector('.option-multiplier').value) || 1.0 });
                    } else {
                        newOptions.push({ name: name, adjustment: parseFloat(row.querySelector('.option-adjustment').value) || 0 });
                    }
                }
            });
            modifier.options = newOptions;
            closeModifierOptionsModal();
             document.getElementById('service-modifiers-container').innerHTML = renderModifierRows(tempModifiers);
             document.querySelectorAll('.modifier-row .modifier-type').forEach(el => handleModifierTypeChange(el));
        }
        // #endregion
        // #region ########## CALCULATION ENGINE ##########
        // <immersive id="calc_fix_calculateTotals_final_2">
        // START: REPLACE THIS FUNCTION
        // START: REPLACE THIS FUNCTION
// ========================================================================
// 1. Replace the 'calculateTotals' function
// ========================================================================

function calculateTotals(currentSelections) {
    const source = currentSelections || selections;
    let totals = { oneTime: 0, monthly: 0, adSpend: 0 };
    let preDiscountTotals = { oneTime: 0, monthly: 0 };
    let allDiscounts = [];
    let breakdown = { items: [], serviceMonthlyCosts: {} };
    let allValueProps = []; // Restored
    let roiProjections = []; // Restored
    let timelineData = []; // Restored
    let forecast = {}; // Restored

    // --- Step 1: Calculate Gross Costs from all selections ---
    source.phases.forEach(phase => {
        // Services
        for (const serviceId in phase.services) {
            const service = findService(serviceId);
            const selection = phase.services[serviceId];
            if (!service) continue;

            // Add value props, timeline data, etc. for other parts of the app
            if (service.valuePropositions) allValueProps.push(...service.valuePropositions);
            if (service.timeline && service.timeline.durationWeeks > 0 && !service.timeline.hidden) {
                timelineData.push({ name: service.name, order: service.timeline.order || 0, duration: service.timeline.durationWeeks || 0 });
            }

            let serviceOneTime = service.setupFee || 0;
            let serviceMonthly = 0;
            let multiplier = 1;
            let summaryDesc = [];
            
            const campaignPrice = getCampaignPrice(serviceId);
            const globalAdjust = activeCampaign ? config.settings.campaignModifiers[activeCampaign]?.globalAdjust : null;
            let basePrice = campaignPrice ?? service.price;

            if (campaignPrice === null && globalAdjust?.value) {
                if (globalAdjust.type === 'percent') {
                    basePrice *= (1 + globalAdjust.value);
                    if (serviceOneTime > 0) serviceOneTime *= (1 + globalAdjust.value);
                } else {
                    const totalServiceBaseCost = basePrice + serviceOneTime;
                     if(totalServiceBaseCost > 0) {
                        if(basePrice > 0) basePrice += globalAdjust.value;
                        else serviceOneTime += globalAdjust.value;
                    }
                }
            }

            if(service.modifiers && selection.mods) {
                for (const modId in selection.mods) {
                    const mod = service.modifiers.find(m => m.id === modId);
                    if (!mod) continue;
                    const modValue = selection.mods[modId];
                    summaryDesc.push(mod.type === 'Checkbox' ? mod.name : modValue);
                    switch(mod.type) {
                        case 'Dropdown': basePrice += mod.options?.find(o => o.name === modValue)?.adjustment || 0; break;
                        case 'TieredDropdown': multiplier *= mod.options?.find(o => o.name === modValue)?.multiplier || 1; break;
                        case 'Numeric': basePrice += (parseInt(modValue, 10) || 0) * (mod.pricePerUnit || 0); break;
                        case 'Checkbox': if (modValue === true) basePrice += mod.adjustment || 0; break;
                    }
                }
            }

            basePrice *= multiplier;

            if (service.model === 'Project' || service.model === 'Unit' || service.model === 'Hourly') {
                serviceOneTime += basePrice * (selection.quantity || 1);
            } else if (service.model === 'Monthly') {
                serviceMonthly += basePrice * (selection.quantity || 1);
            }
            
            const itemDesc = summaryDesc.length > 0 ? summaryDesc.join(', ') : 'Standard';
            breakdown.items.push({ name: service.name, desc: itemDesc, cost: serviceOneTime + serviceMonthly, type: service.model, phaseId: phase.id, categoryId: service.categoryId, serviceId: serviceId });
            if (serviceMonthly > 0) {
                breakdown.serviceMonthlyCosts[serviceId] = (breakdown.serviceMonthlyCosts[serviceId] || 0) + serviceMonthly;
            }
            totals.oneTime += serviceOneTime;
            totals.monthly += serviceMonthly;
        }

        // Ad Channels
        for (const selectionId in phase.adChannels) {
            const selection = phase.adChannels[selectionId];
            const channel = findAdChannel(selection.id);
            if (!channel) continue;
            totals.oneTime += selection.setupFee;
            totals.monthly += calculateAdFee(channel, selection.spend);
            totals.adSpend += selection.spend;
            breakdown.items.push({ name: `${channel.name} Management`, desc: `For ${formatCurrency(selection.spend)} ad spend`, cost: selection.setupFee + calculateAdFee(channel, selection.spend), type: 'Ad Spend', phaseId: phase.id });
        }
    });

    // Team Augmentation
    for (const roleId in source.teamAugmentation) {
        const role = (config.teamAugmentationRoles || []).find(r => r.id === roleId);
        const selection = source.teamAugmentation[roleId];
        if (role && selection?.hours > 0) {
            const cost = role.costPerHr * selection.hours;
            totals.monthly += cost;
            breakdown.items.push({ name: `Team Aug: ${role.name}`, desc: `${selection.hours} hrs/mo`, cost, type: 'Monthly', phaseId: 'augmentation' });
        }
    }

    preDiscountTotals = { ...totals };
    
    // --- Step 2: Apply Global Discounts ---
    source.phases.forEach(phase => {
        for(const serviceId in phase.services) {
            const service = findService(serviceId);
            const selection = phase.services[serviceId];
            if (!service || service.model !== 'Monthly') continue;
            const term = findRetainerTerm(selection.termMonths);
            if (term?.discount > 0) {
                const serviceCost = breakdown.serviceMonthlyCosts[serviceId] || 0;
                const discountAmount = serviceCost * term.discount;
                if (discountAmount > 0) {
                    allDiscounts.push({name: `Term Discount on ${service.name}`, amount: discountAmount});
                    totals.monthly -= discountAmount;
                }
            }
        }
    });

    const totalServiceCount = source.phases.reduce((acc, p) => acc + Object.keys(p.services).length, 0);
    const applicableBundle = [...(config.settings.bundleDiscounts || [])].sort((a, b) => b.threshold - a.threshold).find(d => totalServiceCount >= d.threshold);
    if (applicableBundle?.percentage > 0) {
        const discountAmount = totals.monthly * applicableBundle.percentage;
        if (discountAmount > 0) {
            allDiscounts.push({ name: `Bundle Discount (${totalServiceCount} services)`, amount: discountAmount });
            totals.monthly -= discountAmount;
        }
    }
    
    if (source.appliedCoupon) {
        const coupon = source.appliedCoupon;
        let discountAmount = 0;
        let discountableAmount = 0;
        
        switch (coupon.applyTo) {
            case 'oneTime': discountableAmount = preDiscountTotals.oneTime; break;
            case 'monthly': discountableAmount = preDiscountTotals.monthly; break;
            case 'service':
                const targetItems = breakdown.items.filter(item => item.serviceId === coupon.targetId);
                discountableAmount = targetItems.reduce((sum, item) => sum + item.cost, 0);
                break;
            case 'category':
                const itemsInCategory = breakdown.items.filter(item => item.categoryId === coupon.targetId);
                discountableAmount = itemsInCategory.reduce((sum, item) => sum + item.cost, 0);
                break;
        }

        if (coupon.type === 'percent') {
            discountAmount = discountableAmount * coupon.value;
        } else {
            discountAmount = Math.min(discountableAmount, coupon.value);
        }

        if (discountAmount > 0) {
            allDiscounts.push({ name: `Coupon: ${coupon.code}`, amount: discountAmount });
            if (coupon.applyTo === 'oneTime' || coupon.applyTo === 'service' || coupon.applyTo === 'category') {
                 totals.oneTime -= discountAmount;
            } else { // monthly
                totals.monthly -= discountAmount;
            }
        }
    }
    
    totals.oneTime = Math.max(0, totals.oneTime);
    totals.monthly = Math.max(0, totals.monthly);

    return { totals, breakdown, discounts: allDiscounts, valueProps: allValueProps, roiProjections, timelineData, forecast };
}
// END: REPLACE THIS FUNCTION
        // END: REPLACE THIS FUNCTION
        function renderTimelineChart(timelineData) {
            const ctx = document.getElementById('timeline-chart-canvas').getContext('2d');
            if (timelineChart) {
                timelineChart.destroy();
            }
            if (!timelineData || timelineData.length === 0) {
                document.getElementById('timeline-chart-container').innerHTML = '<canvas id="timeline-chart-canvas"></canvas><p class="text-center text-gray-500 p-8">No services enabled for the timeline. Check the box on a service to add it here.</p>';
                return;
            }
            document.getElementById('timeline-chart-container').innerHTML = '<canvas id="timeline-chart-canvas"></canvas>';
            const newCtx = document.getElementById('timeline-chart-canvas').getContext('2d');
            // Sort data by the user-defined order
            const sortedData = timelineData.sort((a, b) => a.order - b.order);
            const labels = sortedData.map(d => d.name);
            const data = [];
            let currentWeek = 0;
            sortedData.forEach(item => {
                data.push([currentWeek, currentWeek + item.duration]);
                currentWeek += item.duration;
            });
            const datasets = [{
                label: 'Project Duration (Weeks)',
                data: data,
                backgroundColor: config.departments.map((dep, i) => config.departments[i % config.departments.length].color),
                barPercentage: 0.5,
            }];
            timelineChart = new Chart(newCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const raw = context.raw;
                                    const duration = raw[1] - raw[0];
                                    return `Duration: ${duration} week(s) (Ends Week ${raw[1]})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: false, // Ensure bars are sequential, not on top of each other
                            title: {
                                display: true,
                                text: 'Project Weeks'
                            }
                        },
                        y: {
                            stacked: true,
                        }
                    }
                }
            });
        }
        function getServiceMonthlyCost(service, selection) {
    if (!service || service.model !== 'Monthly') {
        return 0;
    }

    let basePrice = getCampaignPrice(service.id) ?? service.price;
    let multiplier = 1;

    if (service.modifiers && selection.mods) {
        for (const modId in selection.mods) {
            const mod = service.modifiers.find(m => m.id === modId);
            if (!mod) continue;
            const modValue = selection.mods[modId];
            switch (mod.type) {
                case 'Dropdown':
                    const opt = mod.options?.find(o => o.name === modValue);
                    if (opt) basePrice += opt.adjustment || 0;
                    break;
                case 'TieredDropdown':
                    const tieredOpt = mod.options?.find(o => o.name === modValue);
                    if (tieredOpt?.multiplier) multiplier *= tieredOpt.multiplier;
                    break;
                case 'Numeric':
                    const numQty = parseInt(modValue, 10) || 0;
                    if (numQty > 0) basePrice += numQty * (mod.pricePerUnit || 0);
                    break;
                case 'Checkbox':
                    if (modValue === true) basePrice += mod.adjustment || 0;
                    break;
            }
        }
    }
    
    let finalMonthly = (basePrice * multiplier) * (selection.quantity || 1);

    // Apply retainer term discount
    const term = findRetainerTerm(selection.termMonths);
    if (term?.discount > 0) {
        finalMonthly *= (1 - term.discount);
    }

    return finalMonthly;
}
function createBudgetProposal(originalSelections) {
    const budgetSelections = JSON.parse(JSON.stringify(originalSelections));
    budgetSelections.packagesToCompare = new Set(originalSelections.packagesToCompare);

    const { totals: originalTotals } = calculateTotals(budgetSelections);
    const targetMonthlyCost = originalTotals.monthly * 0.75; // Target 75% of monthly

    let allRemovableServices = [];
    budgetSelections.phases.forEach(phase => {
        for (const serviceId in phase.services) {
            const service = findService(serviceId);
            const selection = phase.services[serviceId];
            if (service && !selection.locked && service.model === 'Monthly') {
                const monthlyCost = getServiceMonthlyCost(service, selection);
                allRemovableServices.push({ serviceId, phaseId: phase.id, monthlyCost });
            }
        }
    });

    // Sort services to remove by the most expensive monthly cost first
    allRemovableServices.sort((a, b) => b.monthlyCost - a.monthlyCost);

    let currentMonthlyCost = originalTotals.monthly;
    for (const item of allRemovableServices) {
        if (currentMonthlyCost <= targetMonthlyCost || item.monthlyCost <= 0) {
            break;
        }
        
        const phase = budgetSelections.phases.find(p => p.id === item.phaseId);
        if (phase && phase.services[item.serviceId]) {
            delete phase.services[item.serviceId];
            currentMonthlyCost -= item.monthlyCost;
        }
    }
    return budgetSelections;
}
function createGrowthProposal(originalSelections) {
    const growthSelections = JSON.parse(JSON.stringify(originalSelections));
    growthSelections.packagesToCompare = new Set(originalSelections.packagesToCompare);
    
    const { totals: originalTotals } = calculateTotals(growthSelections);
    const targetMonthlyCost = originalTotals.monthly * 1.30;

    const currentServiceIds = new Set(growthSelections.phases.flatMap(p => Object.keys(p.services)));

    const potentialAdditions = config.services
        .filter(s => !currentServiceIds.has(s.id) && s.model === 'Monthly' && s.price > 0)
        .map(service => {
            const selection = { quantity: 1, mods: createDefaultModsForService(service), termMonths: config.settings.retainerTerms[0]?.months || 1 };
            const monthlyCost = getServiceMonthlyCost(service, selection);
            return { service, selection, monthlyCost };
        })
        .filter(item => item.monthlyCost > 0)
        .sort((a, b) => a.monthlyCost - b.monthlyCost);

    let currentMonthlyCost = originalTotals.monthly;
    for (const item of potentialAdditions) {
        if (currentMonthlyCost >= targetMonthlyCost) {
            break;
        }
        
        const phaseToAdd = growthSelections.phases[0];
        if (phaseToAdd) {
             phaseToAdd.services[item.service.id] = item.selection;
             currentMonthlyCost += item.monthlyCost;
        }
    }
    return growthSelections;
}
function generateAlternativeProposals() {
    const overlay = document.getElementById('alternatives-modal-overlay');
    const container = document.getElementById('alternatives-content');
    container.innerHTML = '<p class="text-center col-span-3">Generating proposals...</p>';
    overlay.style.display = 'flex';

    const originalSelections = JSON.parse(JSON.stringify(selections));
    originalSelections.packagesToCompare = new Set(selections.packagesToCompare);
    
    const { totals: originalTotals } = calculateTotals(originalSelections);
    const originalInvestment = originalTotals.oneTime + originalTotals.monthly + originalTotals.adSpend;

    if (originalInvestment === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 col-span-3 py-8">Please select some services before generating alternatives.</p>';
        return;
    }

    // These functions now work reliably.
    const budgetSelections = createBudgetProposal(originalSelections);
    const growthSelections = createGrowthProposal(originalSelections);

    const proposals = [
        { name: "Budget Focus", desc: "A streamlined version of your selection focusing on core essentials.", selections: budgetSelections, type: 'budget' },
        { name: "Your Current Selection", desc: "The custom campaign you built.", selections: originalSelections, type: 'current', isCurrent: true },
        { name: "Growth Accelerator", desc: "An enhanced version with additional strategic services to maximize impact.", selections: growthSelections, type: 'growth' }
    ];

    let html = '';
    proposals.forEach(p => {
        const { totals, breakdown } = calculateTotals(p.selections);
        const totalInvestment = totals.oneTime + totals.monthly + totals.adSpend;
        const hasSelections = breakdown.items.length > 0;
        
        let diffHtml = '';
        if (!p.isCurrent && originalInvestment > 0) {
            const diffPercent = ((totalInvestment - originalInvestment) / originalInvestment) * 100;
            if (Math.abs(diffPercent) > 1) {
                diffHtml = `<span class="text-xs font-bold ${diffPercent > 0 ? 'text-green-600' : 'text-red-600'}">(${diffPercent > 0 ? '+' : ''}${diffPercent.toFixed(0)}%)</span>`;
            }
        }

        html += `
            <div class="p-6 border rounded-xl flex flex-col ${p.isCurrent ? 'border-indigo-500 ring-4 ring-indigo-200' : 'bg-gray-50'}">
                <h4 class="text-xl font-bold">${p.name}</h4>
                <p class="text-sm text-gray-500 flex-grow min-h-[40px]">${p.desc}</p>
                <div class="my-6">
                    <p class="text-sm text-gray-600">Total Investment ${diffHtml}</p>
                    <p class="text-3xl font-bold text-indigo-600">${formatCurrency(totalInvestment)}</p>
                    <p class="text-xs text-gray-500 mt-1">(${formatCurrency(totals.oneTime)} one-time + ${formatCurrency(totals.monthly + totals.adSpend)}/mo)</p>
                </div>
                <h5 class="font-semibold mb-2 text-sm">Included Services:</h5>
                <ul class="text-xs space-y-1 list-disc list-inside mb-6 flex-grow">
                    ${hasSelections ? breakdown.items.map(i => `<li>${i.name}</li>`).join('') : '<li class="list-none text-gray-400">No services in this proposal.</li>'}
                </ul>
                <button class="proposal-button mt-auto w-full font-bold py-2 px-4 rounded-lg transition-colors ${p.isCurrent ? 'bg-indigo-600 text-white' : 'bg-white hover:bg-indigo-100 border'}"
                        data-proposal-type="${p.type}" ${!hasSelections ? 'disabled' : ''}>
                    ${p.isCurrent ? "Keep This Selection" : "Switch to This Proposal"}
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    window.tempProposals = {
        budget: proposals[0].selections,
        current: proposals[1].selections,
        growth: proposals[2].selections
    };
    
    container.addEventListener('click', function(event) {
        const button = event.target.closest('.proposal-button');
        if (button && !button.disabled) {
            selectProposal(button.dataset.proposalType);
        }
    }, { once: true });
}
function selectProposal(proposalType) {
    if (window.tempProposals && window.tempProposals[proposalType]) {
        const newSelections = JSON.parse(JSON.stringify(window.tempProposals[proposalType]));
        newSelections.packagesToCompare = new Set(window.tempProposals[proposalType].packagesToCompare);
        selections = newSelections;
        
        document.getElementById('alternatives-modal-overlay').style.display = 'none';
        window.tempProposals = null;
        showToast("Proposal updated!", "success");
        
        renderAll(); 
    } else {
        showToast("Could not switch proposal. Please try again.", "error");
        console.error("Attempted to select a proposal that was not found in window.tempProposals", proposalType);
    }
}
        // START: ADD THIS NEW FUNCTION
        function renderCompareModal() {
            const overlay = document.getElementById('compare-modal-overlay');
            const container = document.getElementById('compare-content');
            if (!container || !overlay) return;

            const packageIds = Array.from(selections.packagesToCompare);
            const packages = packageIds.map(id => findPackage(id)).filter(Boolean);

            if (packages.length < 2) {
                showToast("Please select at least two packages to compare.", "error");
                return;
            }

            // --- GATHER ALL FEATURES AND SERVICES ACROSS SELECTED PACKAGES ---
            const allFeatures = new Set();
            const allServices = new Map(); // Use a map to store service objects by ID

            packages.forEach(pkg => {
                (pkg.features || '').split(',').forEach(f => {
                    const feature = f.trim();
                    if (feature) allFeatures.add(feature);
                });
                (pkg.services || []).forEach(s => {
                    const service = findService(s.id);
                    if (service && !allServices.has(s.id)) {
                        allServices.set(s.id, service);
                    }
                });
            });

            // --- BUILD THE HTML TABLE ---
            let tableHtml = `<table class="w-full text-left border-collapse">`;

            // Table Header
            tableHtml += `
                <thead>
                    <tr>
                        <th class="p-4 border-b-2 border-gray-200 font-bold text-lg w-1/4">Feature</th>
                        ${packages.map(pkg => `<th class="p-4 border-b-2 border-gray-200 font-bold text-lg text-center">${pkg.name}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
            `;

            // Price Row
            tableHtml += `
                <tr class="bg-gray-50">
                    <td class="p-4 border-b border-gray-200 font-semibold">Price</td>
                    ${packages.map(pkg => `<td class="p-4 border-b border-gray-200 text-center text-xl font-bold text-indigo-600">${formatCurrency(pkg.displayPrice)}</td>`).join('')}
                </tr>
            `;

            // Features Rows
            allFeatures.forEach(feature => {
                tableHtml += `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 border-b border-gray-200">${feature}</td>
                        ${packages.map(pkg => {
                            const hasFeature = (pkg.features || '').toLowerCase().includes(feature.toLowerCase());
                            return `<td class="p-4 border-b border-gray-200 text-center">${hasFeature ? '<span class="text-green-500 font-bold text-2xl">&#10003;</span>' : '<span class="text-red-400 font-bold text-xl">&times;</span>'}</td>`;
                        }).join('')}
                    </tr>
                `;
            });

            // Services Rows
            allServices.forEach((service, serviceId) => {
                tableHtml += `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 border-b border-gray-200">${service.name}</td>
                        ${packages.map(pkg => {
                            const hasService = (pkg.services || []).some(s => s.id === serviceId);
                            return `<td class="p-4 border-b border-gray-200 text-center">${hasService ? '<span class="text-green-500 font-bold text-2xl">&#10003;</span>' : '<span class="text-red-400 font-bold text-xl">&times;</span>'}</td>`;
                        }).join('')}
                    </tr>
                `;
            });


            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;
            overlay.style.display = 'flex';
        }
        // END: ADD THIS NEW FUNCTION
        function calculateAdFee(channel, spend) {
            if (spend <= 0) return 0;
            switch(channel.feeModel) {
                case 'flatFee': return channel.flatFee || 0;
                case 'hybridFee': return (channel.flatFee || 0) + (spend * (channel.percentage || 0));
                case 'tieredPercentageWithMinimums':
                    const sortedTiers = [...config.settings.adFeeTiers].sort((a,b) => b.threshold - a.threshold);
                    let applicableTier = sortedTiers.find(tier => spend >= tier.threshold);
                    if (!applicableTier) return 0;
                    return Math.max(spend * applicableTier.percentage, applicableTier.minFee);
                default: return 0;
            }
        }
        // #endregion
        // #region ########## UTILITIES AND HELPERS ##########
        function checkPackageRecommendation(packageId) {
            const stage = selections.clientContext.businessStage;
            if (!stage) return false;
            if (stage === "Startup/Pre-launch" && packageId === 'pkg-ignite') return true;
            if (stage === "Early Growth" && packageId === 'pkg-accelerate') return true;
            if ((stage === "Established SMB" || stage === "Enterprise") && packageId === 'pkg-apex') return true;
            return false;
        }
        function checkServiceRecommendation(serviceId) {
            const goal = selections.clientContext.businessGoal;
            if (!goal) return false;
            const recommendations = {
                "Increase brand awareness": ['s-brandbuild', 's-brand-design', 's-social-mgmt', 's-video-promo', 's-dm-native'],
                "Generate more leads": ['s-seo-retainer', 's-dm-email', 'ad-google', 'ad-meta', 's-content-blog'],
                "Drive direct sales": ['s-web-custom', 's-content-copy', 'ad-google', 'ad-meta'],
                "Launch a new product/service": ['s-blueprint', 's-campaign-strategy', 's-web-custom', 's-video-promo']
            };
            // Also recommend ad channels
            if (recommendations[goal]?.includes(serviceId)) return true;
            if (recommendations[goal]?.some(id => id.startsWith('ad-')) && serviceId.startsWith('ad-')) return true;
            return false;
        }
        // MODIFIED: Gets campaign-specific price if available
        function getCampaignPrice(serviceId) {
            if (activeCampaign && config.settings.campaignModifiers[activeCampaign] && config.settings.campaignModifiers[activeCampaign].services[serviceId]) {
                 return config.settings.campaignModifiers[activeCampaign].services[serviceId];
            }
            return null; // Use null to indicate no override
        }
        function getCampaignPackagePrice(packageId) {
            const modifier = config.settings.campaignModifiers[activeCampaign];
            if (modifier && modifier.packages && modifier.packages[packageId]) {
                return modifier.packages[packageId];
            }
            return null; // No campaign-specific price found
        }
        function findService(id) { return config.services.find(s => s.id === id); }
        function findPackage(id) { return config.packages.find(p => p.id === id); }
        function findAdChannel(id) { return config.adChannels.find(c => c.id === id); }
        function findCategory(id) { return config.categories.find(c => c.id === id); }
        function findDepartment(id) { return config.departments.find(d => d.id === id); }
        function findRetainerTerm(months) { return config.settings.retainerTerms.find(t => t.months == months); }
        function findDiscount(id) { return config.settings.marketingDiscounts.find(d => d.id === id); }
        function findDiscountByCode(code) { return config.settings.marketingDiscounts.find(d => d.code.toUpperCase() === code.toUpperCase()); }
        function formatCurrency(amount) {
            return `${config.settings.currencySymbol}${(amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        function formatPrice(price, model) {
            switch (model) {
                case 'Quote': return `<span class="text-blue-600">Contact for Quote</span>`;
                case 'Monthly': return `${formatCurrency(price)}/mo`;
                case 'Unit': return `${formatCurrency(price)}/unit`;
                case 'Hourly': return `${formatCurrency(price)}/hr`;
                case 'Project': default: return formatCurrency(price);
            }
        }
        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            let current = obj;
            for (let i = 0; i < keys.length - 1; i++) {
                current = current[keys[i]];
            }
            current[keys[keys.length - 1]] = value;
        }
        function saveVersion() {
            const nameInput = document.getElementById('version-name-input');
            const name = nameInput.value.trim();
            if (!name) {
                showToast("Please enter a name for the version.", "error");
                return;
            }
            const key = `galifreyCalcConfig_${name}`;
            if (localStorage.getItem(key)) {
                if (!confirm(`A version named "${name}" already exists. Overwrite it?`)) {
                    return;
                }
            }
            localStorage.setItem(key, JSON.stringify(config));
            showToast(`Version "${name}" saved.`, 'success');
            nameInput.value = '';
            renderAdminVersioning();
        }
        function loadVersion(key) {
             if (confirm("This will overwrite your current live configuration with the selected version. Are you sure?")) {
                const savedConfig = localStorage.getItem(key);
                if (savedConfig) {
                    config = JSON.parse(savedConfig);
                    saveConfig();
                    showToast(`Version loaded successfully.`, 'success');
                }
             }
        }
        function deleteVersion(key) {
             if (confirm("Are you sure you want to delete this saved version? This cannot be undone.")) {
                localStorage.removeItem(key);
                showToast(`Version deleted.`, 'info');
                renderAdminVersioning();
             }
        }
        function downloadFile(filename, content) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
        function exportConfig() {
            const content = JSON.stringify(config, null, 2);
            downloadFile('galifrey-full-backup.json', content);
            trackAnalytics('config_exported_json');
        }
        function importConfig(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedConfig = JSON.parse(e.target.result);
                        if (confirm("This will overwrite your entire configuration. Are you sure?")) {
                            config = importedConfig;
                            openAccordions = new Set();
                            saveConfig();
                        }
                    } catch (error) {
                        showToast("Invalid JSON file.", 'error');
                    }
                };
                reader.readAsText(file);
            }
            event.target.value = '';
        }
        function exportServicesCSV() {
            try {
                const dataToExport = config.services.map(service => ({
                    id: service.id,
                    name: service.name,
                    desc: service.desc,
                    model: service.model,
                    price: service.price,
                    setupFee: service.setupFee,
                    unit: service.unit,
                    categoryId: service.categoryId,
                    modifiers_json: JSON.stringify(service.modifiers || []),
                    valuePropositions_pipe_separated: (service.valuePropositions || []).join('|')
                }));
                const csv = Papa.unparse(dataToExport);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "galifrey-services-export.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast("Services exported to CSV.", "success");
            } catch(e) {
                showToast("Error exporting CSV.", "error");
                console.error("CSV Export Error:", e);
            }
        }
        function importServicesCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showToast(`Errors found in CSV file. See console for details.`, 'error');
                        console.error("CSV Parsing Errors:", results.errors);
                        return;
                    }
                    if (!confirm(`Found ${results.data.length} services in the CSV. This will overwrite existing services with the same ID and add new ones. Continue?`)) {
                        return;
                    }
                    let updatedCount = 0;
                    let addedCount = 0;
                    results.data.forEach(row => {
                        if (!row.id) return;
                        let modifiers = [];
                        try {
                            modifiers = JSON.parse(row.modifiers_json || '[]');
                        } catch(e) {
                            console.warn(`Could not parse modifiers for service ${row.id}:`, e);
                        }
                        const serviceData = {
                            id: row.id,
                            name: row.name || '',
                            desc: row.desc || '',
                            model: row.model || 'Project',
                            price: parseFloat(row.price) || 0,
                            setupFee: parseFloat(row.setupFee) || 0,
                            unit: row.unit || '',
                            categoryId: row.categoryId || '',
                            modifiers: Array.isArray(modifiers) ? modifiers : [],
                            valuePropositions: (row.valuePropositions_pipe_separated || '').split('|').filter(Boolean)
                        };
                        const existingIndex = config.services.findIndex(s => s.id === serviceData.id);
                        if (existingIndex > -1) {
                            config.services[existingIndex] = serviceData;
                            updatedCount++;
                        } else {
                            config.services.push(serviceData);
                            addedCount++;
                        }
                    });
                    showToast(`${updatedCount} services updated, ${addedCount} added. Click "Save All Changes" to finalize.`, "success");
                    renderAdminPanel();
                },
                error: function(error) {
                    showToast("Failed to read the CSV file.", "error");
                    console.error("CSV Reading Error:", error);
                }
            });
            event.target.value = '';
        }
        // NEW: Handles exporting the main summary PDF.
        function exportSummaryPDF(currentSelections, filename) {
             exportQuoteToPDF(
                currentSelections.clientContext,
                calculateTotals(currentSelections),
                currentSelections.overrides,
                activeCampaign,
                filename
            );
            trackAnalytics('pdf_exported');
        }
        // NEW: Handles exporting a specific submitted quote to PDF.
        function exportQuotePDF(quoteId) {
            const quotes = JSON.parse(localStorage.getItem('submittedQuotes') || '[]');
            const quote = quotes.find(q => q.id === quoteId);
            if (!quote) {
                showToast('Quote not found.', 'error');
                return;
            }
            // CORRECTED: Pass the clientContext from within the saved selections object
             exportQuoteToPDF(
                quote.selections.clientContext, 
                quote.summary,
                {}, // Overrides are baked into the final totals for submitted quotes
                quote.campaign,
                `Galifrey-Quote-${quote.contact.name.replace(/\s/g, '_')}-${quote.id}.pdf`
            );
        }
        // NEW: Centralized PDF generation logic
                function exportQuoteToPDF(clientContext, summaryData, overrides, campaign, filename) {
            const { totals, phaseTotals, breakdown, discounts, valueProps, roiProjections, timelineData } = summaryData;
            const finalOneTime = overrides.oneTime !== null ? overrides.oneTime : totals.oneTime;
            const finalMonthly = overrides.monthly !== null ? overrides.monthly : totals.monthly;
            const totalInvestment = finalMonthly + totals.adSpend;
            const pdf = new jsPDF({unit: 'pt', format: 'a4'});
            const settings = config.settings.pdfSettings;
            const today = new Date().toLocaleDateString('en-US');
            const pageMargin = 40;
            const pageWidth = pdf.internal.pageSize.getWidth();
            const contentWidth = pageWidth - (pageMargin * 2);
            let yPos = 60;
            const checkPageBreak = (neededHeight) => {
                if (yPos + neededHeight > 780) {
                    pdf.addPage();
                    yPos = 60;
                }
            };
            const addSectionTitle = (title) => {
                checkPageBreak(40);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(17, 24, 39);
                pdf.text(title, pageMargin, yPos);
                yPos += 25;
            };
            const addDetailRow = (label, value) => {
                if (!value || (Array.isArray(value) && value.length === 0)) return;
                checkPageBreak(20);
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text(`${label}:`, pageMargin, yPos);
                pdf.setFont(undefined, 'normal');
                const valueX = pageMargin + 140;
                const valueWidth = contentWidth - 140;
                let processedValue = value;
                if (label === 'Satisfaction' && !isNaN(value) && value > 0) {
                    processedValue = `${'★'.repeat(value)}${'☆'.repeat(5-value)}`;
                } else if (Array.isArray(value)) {
                    processedValue = value.filter(v => v).join(', ');
                }
                const valueLines = pdf.splitTextToSize(String(processedValue), valueWidth);
                checkPageBreak(valueLines.length * 12 + 8);
                pdf.text(valueLines, valueX, yPos);
                yPos += valueLines.length * 12 + 8;
            };
            // Header
            pdf.setFontSize(22);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(49, 46, 129);
            pdf.text(settings.headerText, pageMargin, yPos);
            if (campaign) {
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.setTextColor(217, 119, 6);
                pdf.text(`Pricing for campaign: ${campaign}`, pageMargin, yPos + 15);
            }
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.setTextColor(107, 114, 128);
            pdf.text(`Date: ${today}`, pageWidth - pageMargin, yPos, { align: 'right' });
            yPos += 30;
            pdf.setDrawColor(229, 231, 235);
            pdf.line(pageMargin, yPos, pageWidth - pageMargin, yPos);
            yPos += 25;
            // Intro
            pdf.setFontSize(11);
            pdf.setTextColor(55, 65, 81);
            const introLines = pdf.splitTextToSize(settings.introParagraph, contentWidth);
            checkPageBreak(introLines.length * 14 + 20);
            pdf.text(introLines, pageMargin, yPos);
            yPos += introLines.length * 14 + 20;
            // Client Profile Section
            if (clientContext && Object.values(clientContext).some(v => v)) {
                addSectionTitle('Client Profile & Project Details');
                addDetailRow('Business Stage', clientContext.businessStage);
                addDetailRow('Primary Goal', clientContext.businessGoal);
                addDetailRow('Future Goals', clientContext.futureGoals);
                addDetailRow('Website', clientContext.website);
                addDetailRow('Competitors', clientContext.competitors);
                addDetailRow('Referral Source', clientContext.referralSource);
                addDetailRow('Previous Provider', clientContext.previousProvider);
                addDetailRow('Previous Services', clientContext.previousServices);
                addDetailRow('Previous Budget ($/mo)', clientContext.previousBudget ? formatCurrency(clientContext.previousBudget) : null);
                addDetailRow('Duration With Provider', clientContext.durationWithProvider);
                addDetailRow('Reason for Switching', clientContext.reasonForSwitching);
                addDetailRow('Satisfaction', clientContext.satisfaction);
                addDetailRow('Avg. Lead Value', clientContext.avgLeadValue ? formatCurrency(clientContext.avgLeadValue) : null);
                addDetailRow('Customer Lifetime Value', clientContext.avgClv ? formatCurrency(clientContext.avgClv) : null);
                yPos += 15;
                pdf.setDrawColor(229, 231, 235);
                pdf.line(pageMargin, yPos, pageWidth - pageMargin, yPos);
                yPos += 25;
            }
            // Itemized Estimate
            addSectionTitle('Itemized Estimate');
            if (phaseTotals && breakdown?.items) {
                 for (const phaseId in phaseTotals) {
                    const phase = phaseTotals[phaseId];
                    const itemsInPhase = breakdown.items.filter(item => item.phaseId === phaseId);
                    if (itemsInPhase.length === 0) continue;
                    checkPageBreak(25);
                    pdf.setFillColor(239, 246, 255); // blue-50
                    pdf.rect(pageMargin, yPos, contentWidth, 25, 'F');
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    pdf.setTextColor(30, 64, 175); // blue-800
                    pdf.text(phase.name, pageMargin + 10, yPos + 16);
                    yPos += 25;
                    itemsInPhase.forEach(item => {
                        pdf.setFont(undefined, 'normal');
                        pdf.setFontSize(10);
                        pdf.setTextColor(55, 65, 81); // gray-700
                        const itemLines = pdf.splitTextToSize(`${item.name} (${item.desc})`, contentWidth - 100);
                        const rowHeight = Math.max(25, itemLines.length * 12 + 10);
                        checkPageBreak(rowHeight);
                        pdf.setDrawColor(229, 231, 235);
                        pdf.line(pageMargin, yPos + rowHeight, pageWidth - pageMargin, yPos + rowHeight);
                        pdf.text(itemLines, pageMargin + 15, yPos + 16);
                        pdf.text(formatCurrency(item.cost), pageWidth - pageMargin - 10, yPos + 16, { align: 'right' });
                        yPos += rowHeight;
                    });
                    checkPageBreak(30);
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`Phase One-Time: ${formatCurrency(phase.oneTime)}`, pageWidth - pageMargin - 150, yPos + 15, { align: 'right' });
                    pdf.text(`Phase Monthly: ${formatCurrency(phase.monthly)}`, pageWidth - pageMargin - 10, yPos + 15, { align: 'right' });
                    yPos += 30;
                }
            }
            // ROI Section
            if(roiProjections && roiProjections.length > 0) {
                addSectionTitle('Projected Value & ROI');
                pdf.setFontSize(10);
                pdf.setTextColor(21, 128, 61);
                roiProjections.forEach(proj => {
                    const projLines = pdf.splitTextToSize(`• ${proj.replace(/<b>/g, '').replace(/<\/b>/g, '')}`, contentWidth);
                     checkPageBreak(projLines.length * 12 + 5);
                     pdf.text(projLines, pageMargin, yPos);
                     yPos += projLines.length * 12 + 5;
                });
                yPos += 20;
            }
            // Timeline Section
            if (timelineChart && timelineData && timelineData.length > 0) {
                 addSectionTitle('Estimated Project Timeline');
                 const chartImage = timelineChart.toBase64Image();
                 const imgProps = pdf.getImageProperties(chartImage);
                 const imgHeight = (imgProps.height * contentWidth) / imgProps.width;
                 checkPageBreak(imgHeight);
                 pdf.addImage(chartImage, 'PNG', pageMargin, yPos, contentWidth, imgHeight);
                 yPos += imgHeight + 20;
            }
            // Totals Section
            checkPageBreak(150);
            let totalsX = pageWidth - pageMargin - 200;
            if (discounts && discounts.length > 0) {
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(22, 163, 74); // Green-600
                discounts.forEach(d => {
                    pdf.text(d.name, totalsX, yPos, {align: 'right'});
                    pdf.text(`-${formatCurrency(d.amount)}`, pageWidth - pageMargin - 10, yPos, { align: 'right' });
                    yPos += 14;
                });
                yPos += 5;
            }
            pdf.setDrawColor(209, 213, 219);
            pdf.line(totalsX - 10, yPos, pageWidth - pageMargin, yPos);
            yPos += 15;
            pdf.setFontSize(11);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(17, 24, 39);
            pdf.text('One-Time Fees:', totalsX, yPos, { align: 'right'});
            pdf.text(formatCurrency(finalOneTime), pageWidth - pageMargin - 10, yPos, { align: 'right'});
            yPos += 18;
            pdf.text('Monthly Retainer (to us):', totalsX, yPos, { align: 'right'});
            pdf.text(formatCurrency(finalMonthly), pageWidth - pageMargin - 10, yPos, { align: 'right'});
            yPos += 18;
            if (totals.adSpend > 0) {
                pdf.text('Est. Ad Spend (to platforms):', totalsX, yPos, { align: 'right'});
                pdf.text(formatCurrency(totals.adSpend), pageWidth - pageMargin - 10, yPos, { align: 'right'});
                yPos += 18;
                pdf.setDrawColor(209, 213, 219);
                pdf.line(totalsX - 10, yPos, pageWidth - pageMargin, yPos);
                yPos += 15;
                pdf.setFontSize(12);
                pdf.setTextColor(79, 70, 229);
                pdf.text('Total Est. Monthly Investment:', totalsX, yPos, { align: 'right'});
                pdf.text(formatCurrency(totalInvestment), pageWidth - pageMargin - 10, yPos, { align: 'right'});
                yPos += 18;
            }
            // Footer
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(9);
                pdf.setTextColor(156, 163, 175);
                pdf.line(pageMargin, 800, pageWidth - pageMargin, 800);
                pdf.text(settings.footerText, pageMargin, 815);
                pdf.text(`Page ${i} of ${pageCount}`, pageWidth - pageMargin, 815, { align: 'right' });
            }
            pdf.save(filename);
        }
        // MODIFIED: Saves all new client context fields
        function handleQuoteRequest(e) {
    e.preventDefault();
    const form = e.target;
    const name = form.elements.name.value.trim();
    const email = form.elements.email.value.trim();
    if (!name || !email) {
        showToast("Please enter at least your name and email.", "error");
        return;
    }

    // --- Create a serializable copy to fix the Set -> Array issue ---
    const selectionsToSave = {
        ...selections,
        packagesToCompare: Array.from(selections.packagesToCompare || [])
    };
    // -----------------------------------------------------------------

    const rawSummary = calculateTotals(selectionsToSave);
    const finalOneTime = selectionsToSave.overrides.oneTime !== null ? selectionsToSave.overrides.oneTime : rawSummary.totals.oneTime;
    const finalMonthly = selectionsToSave.overrides.monthly !== null ? selectionsToSave.overrides.monthly : rawSummary.totals.monthly;
    const formData = new FormData(form);
    
    const quoteData = {
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        contact: {
            name: formData.get('name'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            businessName: formData.get('businessName'),
        },
        selections: selectionsToSave, // Save the cleaned object
        summary: {
            ...rawSummary,
            totals: {
                oneTime: finalOneTime,
                monthly: finalMonthly,
                adSpend: rawSummary.totals.adSpend,
            }
        },
        campaign: activeCampaign
    };
    
    db.collection("submittedQuotes").add(quoteData)
    .then(() => {
        document.getElementById('quote-modal-overlay').style.display = 'none';
        form.reset();
        trackAnalytics('quote_submitted');
        showToast("Thank you! Your quote has been submitted for review.", "success");
    })
    .catch((error) => {
        console.error("Error writing document: ", error);
        showToast("Could not submit quote. Please try again.", "error");
    });
}
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' };
            toast.className = `p-4 rounded-lg text-white shadow-lg transform translate-x-full transition-transform duration-300 ${colors[type]}`;
            toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        function trackAnalytics(eventName, data = {}) {
            try {
                let analytics = JSON.parse(localStorage.getItem('galifreyCalcAnalytics')) || {};
                if(!analytics[eventName]) analytics[eventName] = { count: 0, details: [] };
                analytics[eventName].count++;
                analytics[eventName].details.push({ ...data, timestamp: new Date().toISOString() });
                if(analytics[eventName].details.length > 50) analytics[eventName].details.shift();
                localStorage.setItem('galifreyCalcAnalytics', JSON.stringify(analytics));
            } catch (e) {
                console.error("Analytics tracking failed:", e);
            }
        }
        // #endregion
        // #region ########## CAMPAIGN MODIFIER & DISCOUNT LOGIC ##########
        function addCampaignModifier() {
            const input = document.getElementById('new-modifier-name');
            const modName = input.value.trim().toLowerCase().replace(/\s+/g, '-');
            if (!modName) {
                showToast("Please enter a valid campaign name.", "error");
                return;
            }
            if (config.settings.campaignModifiers[modName]) {
                showToast(`Campaign "${modName}" already exists.`, "error");
                return;
            }
            // Add 'packages' object to the new modifier
            config.settings.campaignModifiers[modName] = { 
                globalAdjust: { type: 'percent', value: 0 }, 
                services: {},
                packages: {} // New property for package overrides
            };
            input.value = '';
            showToast(`Campaign "${modName}" created. Click 'Edit Prices' to configure.`, 'success');
            renderAdminCampaignModifiers();
        }
        function deleteCampaignModifier(modName) {
            if (confirm(`Are you sure you want to delete the "${modName}" campaign? This cannot be undone.`)) {
                delete config.settings.campaignModifiers[modName];
                showToast(`Campaign "${modName}" deleted.`, 'info');
                renderAdminCampaignModifiers();
            }
        }
        function openCampaignModifierModal(modName) {
            const modal = document.getElementById('campaign-modifier-modal');
            const title = document.getElementById('campaign-modifier-modal-title');
            const globalForm = document.getElementById('campaign-global-settings-form');
            const formContainer = document.getElementById('campaign-modifier-form');
            title.textContent = `Edit Prices for: ${modName}`;
            const modifierData = config.settings.campaignModifiers[modName];
            // Ensure the packages property exists
            if (!modifierData.packages) {
                modifierData.packages = {};
            }
            const globalAdjust = modifierData.globalAdjust || { type: 'percent', value: 0};
            // Render Global Adjustment Form
            globalForm.innerHTML = `
                <h4 class="font-semibold text-md mb-2">Global Price Adjustment</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
                    <select data-change-action="update-campaign-global" data-id="${modName}" data-path="type" class="p-2 border rounded-md">
                        <option value="percent" ${globalAdjust.type === 'percent' ? 'selected' : ''}>Percentage (%)</option>
                        <option value="fixed" ${globalAdjust.type === 'fixed' ? 'selected' : ''}>Fixed Amount ($)</option>
                    </select>
                    <input type="number" 
                           value="${globalAdjust.type === 'percent' ? (globalAdjust.value || 0) * 100 : (globalAdjust.value || 0)}" 
                           step="0.01"
                           data-input-action="update-campaign-global" 
                           data-id="${modName}" 
                           data-path="value"
                           class="md:col-span-2 w-full p-2 border rounded-md">
                </div>
                 <p class="text-xs text-gray-500 mt-1">Applies to all services. Use negative numbers for a discount.</p>
            `;
            // --- RENDER OVERRIDES ---
            let formHtml = '';
            // Section for Package Overrides
            formHtml += `<h4 class="font-semibold text-lg text-gray-800 mt-6 border-b pb-2">Package Price Overrides</h4>`;
            formHtml += config.packages.map(pkg => {
                const campaignPrice = modifierData.packages[pkg.id] ?? '';
                const defaultPrice = `Default: ${formatCurrency(pkg.displayPrice)}`;
                return `
                    <div class="grid grid-cols-12 gap-2 items-center mt-2">
                        <label class="col-span-6 text-sm">${pkg.name}</label>
                        <div class="col-span-4">
                            <input type="number" 
                                   placeholder="${defaultPrice}"
                                   value="${campaignPrice}"
                                   data-input-action="update-campaign-package-price" 
                                   data-campaign="${modName}" 
                                   data-id="${pkg.id}" 
                                   class="w-full p-1 border rounded-md text-sm">
                        </div>
                        <span class="col-span-2 text-xs text-gray-500">${defaultPrice}</span>
                    </div>
                `;
            }).join('');
            // Section for Service Overrides
            formHtml += `<h4 class="font-semibold text-lg text-gray-800 mt-6 border-b pb-2">Service Price Overrides</h4>`;
            config.categories.forEach(cat => {
                const servicesInCategory = config.services.filter(s => s.categoryId === cat.id);
                if(servicesInCategory.length === 0) return;
                formHtml += `<h5 class="font-semibold text-md text-gray-700 mt-4">${cat.name}</h5>`;
                formHtml += servicesInCategory.map(service => {
                    const campaignPrice = modifierData.services[service.id] ?? '';
                    const defaultPrice = `Default: ${formatCurrency(service.price)}`;
                    return `
                        <div class="grid grid-cols-12 gap-2 items-center">
                            <label class="col-span-6 text-sm">${service.name}</label>
                            <div class="col-span-4">
                                <input type="number" 
                                       placeholder="${defaultPrice}"
                                       value="${campaignPrice}"
                                       data-input-action="update-campaign-price" 
                                       data-campaign="${modName}" 
                                       data-id="${service.id}" 
                                       class="w-full p-1 border rounded-md text-sm">
                            </div>
                            <span class="col-span-2 text-xs text-gray-500">${defaultPrice}</span>
                        </div>
                    `;
                }).join('');
            });
            formContainer.innerHTML = formHtml;
            modal.style.display = 'flex';
        }
        function updateCampaignPrice(campaign, serviceId, value) {
            const price = parseFloat(value);
            if (value.trim() === '' || isNaN(price)) {
                delete config.settings.campaignModifiers[campaign].services[serviceId];
            } else {
                config.settings.campaignModifiers[campaign].services[serviceId] = price;
            }
        }
function updateCampaignGlobal(campaign, path, value) {
    let mod = config.settings.campaignModifiers[campaign];
    if (!mod.globalAdjust) {
        mod.globalAdjust = { type: 'percent', value: 0 };
    }
    if (path === 'value') {
        const numValue = parseFloat(value) || 0;
        // Correctly convert percentage to decimal, otherwise store the fixed value.
        mod.globalAdjust.value = mod.globalAdjust.type === 'percent' ? numValue / 100 : numValue;
    } else {
        mod.globalAdjust[path] = value;
    }
}
        function applyCoupon() {
            const input = document.getElementById('coupon-code-input');
            const code = input.value.trim();
            const statusEl = document.getElementById('coupon-status');
            if (!code) {
                selections.appliedCoupon = null;
                statusEl.textContent = '';
                renderSummary();
                return;
            }
            const coupon = findDiscountByCode(code);
            if (!coupon) {
                selections.appliedCoupon = null;
                statusEl.textContent = 'Invalid coupon code.';
                statusEl.className = 'text-xs mt-1 h-4 text-red-500';
                renderSummary();
                return;
            }
            const today = new Date();
            today.setHours(0,0,0,0);
            const startDate = coupon.startDate ? new Date(coupon.startDate) : null;
            const endDate = coupon.endDate ? new Date(coupon.endDate) : null;
            if (startDate && today < startDate) {
                 selections.appliedCoupon = null;
                 statusEl.textContent = 'Coupon is not yet active.';
                 statusEl.className = 'text-xs mt-1 h-4 text-red-500';
                 renderSummary();
                 return;
            }
            if (endDate && today > endDate) {
                 selections.appliedCoupon = null;
                 statusEl.textContent = 'Coupon has expired.';
                 statusEl.className = 'text-xs mt-1 h-4 text-red-500';
                 renderSummary();
                 return;
            }
            selections.appliedCoupon = coupon;
            statusEl.textContent = `Coupon "${coupon.code}" applied!`;
            statusEl.className = 'text-xs mt-1 h-4 text-green-600';
            trackAnalytics('discount_applied', { code: coupon.code });
            renderSummary();
        }
        // #endregion
        init();
    });
 </script>