<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TipTally - Cloud Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #111827; /* Gray 900 */
            --bg-secondary: #1f2937; /* Gray 800 */
            --bg-tertiary: #374151; /* Gray 700 */
            --border-color: #4b5563; /* Gray 600 */
            --text-primary: #f9fafb; /* Gray 50 */
            --text-secondary: #d1d5db; /* Gray 300 */
            --text-muted: #9ca3af; /* Gray 400 */
            --brand-pink: #ec4899; /* Pink 500 */
            --brand-pink-hover: #db2777; /* Pink 600 */
            --brand-green: #22c55e; /* Green 500 */
            --brand-yellow: #f59e0b; /* Amber 500 */
            --brand-blue: #3b82f6; /* Blue 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }
        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .btn-primary {
            background-color: var(--brand-pink);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--brand-pink-hover);
        }
        .btn-primary:disabled {
            background-color: var(--bg-tertiary);
            cursor: not-allowed;
            opacity: 0.6;
        }
        .input-field {
            width: 100%;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--brand-pink);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.3);
        }
        .card {
            background-color: var(--bg-secondary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app-container" class="min-h-screen">
        <!-- Login View -->
        <div id="login-view" class="flex items-center justify-center min-h-screen">
            <div class="w-full max-w-sm p-8 space-y-6 card">
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-white">TipTally</h1>
                    <p class="text-text-muted mt-2">Streamlined Earnings Management</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="user-select" class="block text-sm font-medium text-text-secondary mb-1">Select User</label>
                        <select id="user-select" class="input-field"></select>
                    </div>
                    <div>
                        <label for="pin-input" class="block text-sm font-medium text-text-secondary mb-1">PIN</label>
                        <input type="password" id="pin-input" class="input-field" placeholder="****"/>
                    </div>
                    <p id="login-error" class="text-sm text-red-400 hidden"></p>
                    <button data-action="login" class="w-full btn btn-primary">Login</button>
                </div>
            </div>
        </div>

        <!-- Main App View (Worker/Admin) -->
        <div id="main-view" class="hidden">
            <header class="bg-bg-secondary p-4 flex justify-between items-center shadow-md border-b border-border-color">
                <div>
                    <h1 class="text-xl font-bold text-white">TipTally</h1>
                    <p class="text-sm text-text-muted">Logged in as: <span id="current-user-name" class="font-semibold text-brand-pink"></span></p>
                </div>
                <button data-action="logout" class="btn bg-bg-tertiary hover:bg-gray-600 text-white">Logout</button>
            </header>
            <main id="dashboard-content" class="p-4 md:p-8"></main>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- App State ---
        let state = {
            users: [],
            transactions: [],
            currentUser: null,
            view: 'login', // 'login', 'workerDashboard', 'adminDashboard', 'adminWorkerDetail', 'adminAddWorker'
            selectedDate: new Date(),
            selectedWorkerId: null,
            loginError: '',
            selectedLoginUser: ''
        };

        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyCbX8RkQxxDMxkhSDMzeKmDi5m07GoCEGQ",
          authDomain: "tiptally-b3e22.firebaseapp.com",
          projectId: "tiptally-b3e22",
          storageBucket: "tiptally-b3e22.firebasestorage.app",
          messagingSenderId: "455968198845",
          appId: "1:455968198845:web:fb55125d3d82b24eafe7d4",
          measurementId: "G-SRDQRGLQ5Y"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const mainView = document.getElementById('main-view');
        const dashboardContent = document.getElementById('dashboard-content');
        const userSelect = document.getElementById('user-select');
        const pinInput = document.getElementById('pin-input');
        const loginErrorEl = document.getElementById('login-error');
        const currentUserNameEl = document.getElementById('current-user-name');

        // --- Main Render Function ---
        function render() {
            // Update login screen user dropdown
            if (state.view === 'login') {
                userSelect.innerHTML = state.users.map(user => `<option value="${user.id}">${user.name} (${user.role})</option>`).join('');
                if (state.selectedLoginUser) {
                    userSelect.value = state.selectedLoginUser;
                }
                loginErrorEl.textContent = state.loginError;
                loginErrorEl.classList.toggle('hidden', !state.loginError);
            }

            // Show/hide main views
            loginView.classList.toggle('hidden', state.view !== 'login');
            mainView.classList.toggle('hidden', state.view === 'login');

            if (state.currentUser) {
                currentUserNameEl.textContent = state.currentUser.name;
            }

            // Render the correct dashboard
            if (state.view === 'workerDashboard') {
                renderWorkerDashboard();
            } else if (state.view === 'adminDashboard') {
                renderAdminDashboard();
            }
        }
        
        // --- Render Partials ---
        function renderWorkerDashboard() {
            const dailyTransactions = state.transactions.filter(t => t.workerId === state.currentUser.id && isSameDay(new Date(t.submissionTimestamp), state.selectedDate)).sort((a, b) => new Date(b.submissionTimestamp) - new Date(a.submissionTimestamp));
            const allTimeTransactions = state.transactions.filter(t => t.workerId === state.currentUser.id);
            const getApprovedAmount = (tx) => tx.managerVerifiedAmount !== null ? tx.managerVerifiedAmount : tx.workerSubmittedAmount;
            const dailyApprovedTotal = dailyTransactions.filter(t => t.status === 'approved').reduce((sum, t) => sum + getApprovedAmount(t), 0);
            const allTimeApprovedTotal = allTimeTransactions.filter(t => t.status === 'approved').reduce((sum, t) => sum + getApprovedAmount(t), 0);
            const allTimeTake = allTimeApprovedTotal * state.currentUser.payoutSplit.worker;
            const isToday = isSameDay(state.selectedDate, new Date());

            let html = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-4">
                        <div class="card">${renderCalendar()}</div>
                        <div class="card">
                            <h3 class="text-text-muted text-sm">Your Total Take (All Time)</h3>
                            <p class="text-4xl font-bold text-brand-green">$${allTimeTake.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-1">My Daily Summary</h2>
                            <p class="text-lg text-brand-pink">${formatDate(state.selectedDate)}</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="card"><h3 class="text-text-muted text-sm">Approved Earnings (Day)</h3><p class="text-2xl font-bold text-brand-green">$${dailyApprovedTotal.toFixed(2)}</p></div>
                            <div class="card"><h3 class="text-text-muted text-sm">Your Take (Day)</h3><p class="text-2xl font-bold text-brand-pink">$${(dailyApprovedTotal * state.currentUser.payoutSplit.worker).toFixed(2)}</p></div>
                            <div class="card"><h3 class="text-text-muted text-sm">House Take (Day)</h3><p class="text-2xl font-bold text-brand-blue">$${(dailyApprovedTotal * state.currentUser.payoutSplit.house).toFixed(2)}</p></div>
                        </div>
                        ${isToday ? `
                        <div class="card">
                            <h3 class="text-xl font-bold text-white mb-4">Submit New Earnings</h3>
                            <div class="flex flex-col md:flex-row gap-4">
                                <input type="number" id="new-transaction-amount" placeholder="Enter amount" class="input-field flex-grow"/>
                                <button data-action="add-transaction" class="btn btn-primary">Submit</button>
                            </div>
                        </div>` : ''}
                        <div>
                            <h3 class="text-xl font-bold text-white mb-4">Submissions for this day</h3>
                            <div class="space-y-4">
                                ${dailyTransactions.length > 0 ? dailyTransactions.map(tx => `
                                <div class="card flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                    <div><p class="font-bold text-white">ID: <span class="font-mono text-brand-pink">${tx.transactionCode}</span></p><p class="text-sm text-text-muted">${new Date(tx.submissionTimestamp).toLocaleTimeString()}</p></div>
                                    <div class="text-left md:text-right"><p class="text-lg font-bold text-white">You Submitted: $${tx.workerSubmittedAmount.toFixed(2)}</p>${tx.status === 'disputed' ? `<p class="text-md font-semibold text-brand-yellow">Manager Counted: $${tx.managerVerifiedAmount.toFixed(2)}</p>` : ''}</div>
                                    <div class="flex items-center gap-4 w-full md:w-auto">${renderStatusBadge(tx.status)} ${tx.status === 'disputed' ? `<button data-action="worker-accept" data-id="${tx.id}" class="btn text-xs bg-brand-green text-white">Accept</button>` : ''}</div>
                                </div>`).join('') : `<p class="text-text-muted">No transactions submitted on this day.</p>`}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            dashboardContent.innerHTML = html;
        }

        function renderAdminDashboard() {
            const dailyTransactions = state.transactions.filter(t => isSameDay(new Date(t.submissionTimestamp), state.selectedDate));
            const pendingTransactions = dailyTransactions.filter(t => t.status === 'pending');
            const workers = state.users.filter(u => u.role === 'worker');
            
            const getApprovedAmount = (tx) => tx.managerVerifiedAmount !== null ? tx.managerVerifiedAmount : tx.workerSubmittedAmount;
            
            const getWorkerTotals = (txList) => {
                const totals = {};
                workers.forEach(w => {
                    totals[w.id] = { name: w.name, total: 0, split: w.payoutSplit, id: w.id };
                });
                txList.forEach(tx => {
                    if (tx.status === 'approved' && totals[tx.workerId]) {
                        totals[tx.workerId].total += getApprovedAmount(tx);
                    }
                });
                return Object.values(totals);
            };

            const workerDailyTotals = getWorkerTotals(dailyTransactions);
            const workerAllTimeTotals = getWorkerTotals(state.transactions);
            const totalClubEarningsDay = workerDailyTotals.reduce((sum, w) => sum + w.total, 0);
            const totalHouseTakeDay = workerDailyTotals.reduce((sum, w) => sum + (w.total * w.split.house), 0);

            let html = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-4">
                        <div class="card">${renderCalendar()}</div>
                        <div class="card">
                            <h3 class="text-xl font-bold text-white mb-4">Daily Worker Payouts</h3>
                            <div class="space-y-2">${workerDailyTotals.map(w => `<div class="flex justify-between items-center text-sm"><span class="font-semibold text-white">${w.name}</span><span class="font-bold text-brand-pink">$${(w.total * w.split.worker).toFixed(2)}</span></div>`).join('')}</div>
                        </div>
                         <div class="card">
                            <h3 class="text-xl font-bold text-white mb-4">All-Time Worker Payouts</h3>
                            <div class="space-y-2">${workerAllTimeTotals.map(w => `<div class="flex justify-between items-center text-sm"><span class="font-semibold text-white">${w.name}</span><span class="font-bold text-brand-green">$${(w.total * w.split.worker).toFixed(2)}</span></div>`).join('')}</div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-1">Daily Summary</h2>
                            <p class="text-lg text-brand-pink">${formatDate(state.selectedDate)}</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="card"><h3 class="text-text-muted text-sm">Club Earnings (Day)</h3><p class="text-3xl font-bold text-brand-green">$${totalClubEarningsDay.toFixed(2)}</p></div>
                            <div class="card"><h3 class="text-text-muted text-sm">House Take (Day)</h3><p class="text-3xl font-bold text-brand-pink">$${totalHouseTakeDay.toFixed(2)}</p></div>
                        </div>
                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                            <div class="card">
                                <h3 class="text-xl font-bold text-white mb-4">Worker Totals (Day)</h3>
                                <div class="space-y-3">${workerDailyTotals.map(w => `<div class="bg-bg-tertiary p-4 rounded-lg flex justify-between items-center cursor-pointer hover:bg-gray-600 transition-colors"><p class="font-bold text-white text-lg">${w.name}</p><p class="font-semibold text-brand-green text-lg">$${w.total.toFixed(2)}</p></div>`).join('')}</div>
                            </div>
                            <div class="card">
                                <h3 class="text-xl font-bold text-white mb-4">Pending Verifications (${pendingTransactions.length})</h3>
                                <div class="space-y-4 max-h-96 overflow-y-auto pr-2">${pendingTransactions.length > 0 ? pendingTransactions.map(tx => `
                                    <div class="bg-bg-tertiary p-4 rounded-lg">
                                        <div class="flex justify-between items-center mb-3">
                                            <div><p class="font-bold text-white">${tx.workerName} - <span class="font-mono text-brand-pink">${tx.transactionCode}</span></p><p class="text-sm text-text-muted">Submitted: $${tx.workerSubmittedAmount.toFixed(2)}</p></div>
                                            ${renderStatusBadge(tx.status)}
                                        </div>
                                        <div class="flex gap-2">
                                            <input type="number" data-id="${tx.id}" placeholder="Enter counted amount" class="input-field verification-amount flex-grow"/>
                                            <button data-action="verify" data-id="${tx.id}" class="btn bg-brand-green text-white">Verify</button>
                                        </div>
                                    </div>`).join('') : `<p class="text-text-muted">No pending transactions.</p>`}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            dashboardContent.innerHTML = html;
        }
        
        function renderCalendar() {
            const { selectedDate, transactions } = state;
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const transactionDays = new Set(transactions.map(tx => new Date(tx.submissionTimestamp).toDateString()));

            let daysHtml = '';
            for (let i = 0; i < firstDay; i++) {
                daysHtml += `<div class="w-10 h-10"></div>`;
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isSelected = isSameDay(date, selectedDate);
                const isToday = isSameDay(date, new Date());
                const hasTransactions = transactionDays.has(date.toDateString());
                const dayClasses = `w-10 h-10 flex items-center justify-center rounded-full cursor-pointer transition-colors relative ${isSelected ? 'bg-brand-pink text-white font-bold' : isToday ? 'bg-bg-tertiary' : 'hover:bg-bg-tertiary'}`;
                daysHtml += `<div data-action="select-date" data-date="${date.toISOString()}" class="${dayClasses}"><span>${day}</span>${hasTransactions && !isSelected ? '<div class="absolute bottom-1 w-1.5 h-1.5 bg-brand-blue rounded-full"></div>' : ''}</div>`;
            }

            return `
                <div class="flex justify-between items-center mb-4">
                    <button data-action="prev-month" class="p-2 rounded-full hover:bg-bg-tertiary">&lt;</button>
                    <h3 class="text-lg font-semibold text-white">${monthNames[month]} ${year}</h3>
                    <button data-action="next-month" class="p-2 rounded-full hover:bg-bg-tertiary">&gt;</button>
                </div>
                <div class="grid grid-cols-7 gap-y-2 place-items-center text-xs text-text-muted mb-2">
                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<div>${d}</div>`).join('')}
                </div>
                <div class="grid grid-cols-7 gap-y-2 place-items-center">${daysHtml}</div>
            `;
        }

        function renderStatusBadge(status) {
            const badgeMap = {
                approved: { text: 'Approved', color: 'brand-green' },
                disputed: { text: 'Disputed', color: 'brand-yellow' },
                pending: { text: 'Pending', color: 'gray-500' }
            };
            const { text, color } = badgeMap[status] || badgeMap.pending;
            return `<span class="px-2 py-1 text-xs font-bold rounded-full text-white bg-${color}">${text}</span>`;
        }
        
        // --- Event Handlers & Actions ---
        function handleAction(e) {
            const action = e.target.dataset.action;
            if (!action) return;

            switch(action) {
                case 'login':
                    handleLogin();
                    break;
                case 'logout':
                    handleLogout();
                    break;
                case 'select-date':
                    state.selectedDate = new Date(e.target.dataset.date);
                    render();
                    break;
                case 'prev-month':
                    state.selectedDate.setMonth(state.selectedDate.getMonth() - 1);
                    render();
                    break;
                case 'next-month':
                    state.selectedDate.setMonth(state.selectedDate.getMonth() + 1);
                    render();
                    break;
                case 'add-transaction':
                    handleAddTransaction();
                    break;
                case 'verify':
                    handleVerification(e.target.dataset.id);
                    break;
                case 'worker-accept':
                    handleWorkerAcceptance(e.target.dataset.id);
                    break;
            }
        }
        
        async function handleLogin() {
            const selectedId = userSelect.value;
            const pin = pinInput.value;
            const user = state.users.find(u => u.id === selectedId);

            if (user && user.pin === pin) {
                state.currentUser = user;
                state.view = user.role === 'admin' ? 'adminDashboard' : 'workerDashboard';
                state.loginError = '';
                pinInput.value = '';
                state.selectedDate = new Date();
            } else {
                state.loginError = 'Invalid PIN. Please try again.';
            }
            render();
        }

        function handleLogout() {
            state.currentUser = null;
            state.view = 'login';
            render();
        }
        
        async function handleAddTransaction() {
            const amountInput = document.getElementById('new-transaction-amount');
            const amount = parseFloat(amountInput.value);
            if (!amount || amount <= 0) return;

            const newTransaction = {
              workerId: state.currentUser.id,
              workerName: state.currentUser.name,
              transactionCode: `${state.currentUser.name.substring(0, 3).toUpperCase()}-${Math.floor(100 + Math.random() * 900)}`,
              workerSubmittedAmount: amount,
              managerVerifiedAmount: null,
              status: 'pending',
              submissionTimestamp: new Date().toISOString(),
              verificationTimestamp: null,
            };
            await db.collection('transactions').add(newTransaction);
            amountInput.value = '';
        }

        async function handleVerification(txId) {
            const amountInput = document.querySelector(`input.verification-amount[data-id="${txId}"]`);
            const managerAmount = parseFloat(amountInput.value);
            if (isNaN(managerAmount)) {
                alert('Please enter a valid number.');
                return;
            }
            const txRef = db.collection('transactions').doc(txId);
            const txDoc = await txRef.get();
            if (txDoc.exists) {
                const tx = txDoc.data();
                const status = managerAmount === tx.workerSubmittedAmount ? 'approved' : 'disputed';
                await txRef.update({
                    managerVerifiedAmount: managerAmount,
                    status,
                    verificationTimestamp: new Date().toISOString(),
                });
            }
        }
        
        async function handleWorkerAcceptance(txId) {
            const txRef = db.collection('transactions').doc(txId);
            const txDoc = await txRef.get();
            if (txDoc.exists && txDoc.data().status === 'disputed') {
                await txRef.update({ status: 'approved' });
            }
        }

        // --- Initial Setup ---
        getInitialData();
        
        db.collection('users').onSnapshot(snapshot => {
            state.users = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            if (!state.selectedLoginUser && state.users.length > 0) {
                state.selectedLoginUser = state.users[0].id;
            }
            render();
        }, error => console.error("Error fetching users:", error));

        db.collection('transactions').orderBy("submissionTimestamp", "desc").onSnapshot(snapshot => {
            state.transactions = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            render();
        }, error => console.error("Error fetching transactions:", error));
        
        document.body.addEventListener('click', handleAction);
        userSelect.addEventListener('change', (e) => { state.selectedLoginUser = e.target.value; });

    });
    </script>
</body>
</html>
