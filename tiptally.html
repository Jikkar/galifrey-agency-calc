<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TipTally - Cloud Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- START: Duda Override Fix --- */
        /* All styles are now scoped to the #tiptally-app-wrapper to increase specificity. */
        /* The `!important` rule is used to ensure these styles take priority over Duda's global CSS. */
        #tiptally-app-wrapper {
            --bg-primary: #111827; /* Gray 900 */
            --bg-secondary: #1f2937; /* Gray 800 */
            --bg-tertiary: #374151; /* Gray 700 */
            --border-color: #4b5563; /* Gray 600 */
            --text-primary: #f9fafb; /* Gray 50 */
            --text-secondary: #d1d5db; /* Gray 300 */
            --text-muted: #9ca3af; /* Gray 400 */
            --brand-pink: #ec4899; /* Pink 500 */
            --brand-pink-hover: #db2777; /* Pink 600 */
            --brand-green: #22c55e; /* Green 500 */
            --brand-yellow: #f59e0b; /* Amber 500 */
            --brand-blue: #3b82f6; /* Blue 500 */
            
            font-family: 'Inter', sans-serif !important;
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }
        #tiptally-app-wrapper.light-mode {
            --bg-primary: #f3f4f6; /* Gray 100 */
            --bg-secondary: #ffffff; /* White */
            --bg-tertiary: #e5e7eb; /* Gray 200 */
            --border-color: #d1d5db; /* Gray 300 */
            --text-primary: #111827; /* Gray 900 */
            --text-secondary: #4b5563; /* Gray 600 */
            --text-muted: #6b7280; /* Gray 500 */
        }
        /* --- END: Duda Override Fix --- */

        body {
            /* Body styles are minimal to avoid conflicts */
            font-family: 'Inter', sans-serif;
        }
        #tiptally-app-wrapper .font-mono {
            font-family: 'Roboto Mono', monospace !important;
        }
        #tiptally-app-wrapper .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }
        #tiptally-app-wrapper .btn-primary {
            background-color: var(--brand-pink) !important;
            color: white !important;
        }
        #tiptally-app-wrapper .btn-primary:hover {
            background-color: var(--brand-pink-hover) !important;
        }
        #tiptally-app-wrapper .btn-primary:disabled {
            background-color: var(--bg-tertiary) !important;
            cursor: not-allowed;
            opacity: 0.6;
        }
        #tiptally-app-wrapper .input-field {
            width: 100%;
            background-color: var(--bg-tertiary) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            color: var(--text-primary) !important;
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s;
        }
        #tiptally-app-wrapper .input-field:focus {
            outline: none !important;
            border-color: var(--brand-pink) !important;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.3) !important;
        }
        #tiptally-app-wrapper .card {
            background-color: var(--bg-secondary) !important;
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color) !important;
            transition: background-color 0.3s, border-color 0.3s;
        }
        #tiptally-app-wrapper .hidden {
            display: none !important;
        }
        /* Scoped text color overrides */
        #tiptally-app-wrapper h1, 
        #tiptally-app-wrapper h2, 
        #tiptally-app-wrapper h3, 
        #tiptally-app-wrapper h4, 
        #tiptally-app-wrapper p, 
        #tiptally-app-wrapper div,
        #tiptally-app-wrapper span,
        #tiptally-app-wrapper label,
        #tiptally-app-wrapper button,
        #tiptally-app-wrapper select,
        #tiptally-app-wrapper option {
            color: var(--text-primary);
        }
        #tiptally-app-wrapper .text-text-muted {
            color: var(--text-muted) !important;
        }
        #tiptally-app-wrapper .text-text-secondary {
             color: var(--text-secondary) !important;
        }
        #tiptally-app-wrapper .text-brand-pink {
            color: var(--brand-pink) !important;
        }
         #tiptally-app-wrapper .text-brand-green {
            color: var(--brand-green) !important;
        }
         #tiptally-app-wrapper .text-brand-blue {
            color: var(--brand-blue) !important;
        }
         #tiptally-app-wrapper .text-brand-yellow {
            color: var(--brand-yellow) !important;
        }
        #tiptally-app-wrapper .bg-bg-tertiary {
            background-color: var(--bg-tertiary) !important;
        }
    </style>
</head>
<body>
    <!-- START: Duda Override Fix - Added a wrapper div with a unique ID -->
    <div id="tiptally-app-wrapper">
        <div id="app-container" class="min-h-screen">
            <!-- App content is rendered here by JavaScript -->
            <div class="flex items-center justify-center min-h-screen">
                <p class="text-text-muted">Loading TipTally...</p>
            </div>
        </div>
    </div>
    <!-- END: Duda Override Fix -->

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- App State ---
        let state = {
            users: [],
            transactions: [],
            currentUser: null,
            view: 'login', // 'login', 'workerDashboard', 'adminDashboard', 'adminWorkerDetail', 'adminAddWorker', 'adminEditWorker'
            selectedDate: new Date(),
            selectedWorkerId: null,
            loginError: '',
            selectedLoginUser: ''
        };

        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyCbX8RkQxxDMxkhSDMzeKmDi5m07GoCEGQ",
          authDomain: "tiptally-b3e22.firebaseapp.com",
          projectId: "tiptally-b3e22",
          storageBucket: "tiptally-b3e22.firebasestorage.app",
          messagingSenderId: "455968198845",
          appId: "1:455968198845:web:fb55125d3d82b24eafe7d4",
          measurementId: "G-SRDQRGLQ5Y"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const appWrapper = document.getElementById('tiptally-app-wrapper');


        // --- Helper Functions ---
        const isSameDay = (date1, date2) => {
            if (!date1 || !date2) return false;
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        };

        const formatDate = (date) => {
            return new Intl.DateTimeFormat('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).format(new Date(date));
        };
        
        const getApprovedAmount = (tx) => {
            if (tx.status !== 'approved') return 0;
            return tx.managerVerifiedAmount !== null ? tx.managerVerifiedAmount : tx.workerSubmittedAmount;
        };

        // --- Main Render Function ---
        function render() {
            let currentViewHtml = '';
            switch (state.view) {
                case 'login':
                    currentViewHtml = renderLoginView();
                    break;
                case 'workerDashboard':
                    currentViewHtml = renderMainAppView(renderWorkerDashboard());
                    break;
                case 'adminDashboard':
                    currentViewHtml = renderMainAppView(renderAdminDashboard());
                    break;
                case 'adminWorkerDetail':
                    currentViewHtml = renderMainAppView(renderAdminWorkerDetail());
                    break;
                case 'adminAddWorker':
                    currentViewHtml = renderMainAppView(renderAddWorkerForm());
                    break;
                 case 'adminEditWorker':
                    currentViewHtml = renderMainAppView(renderAddWorkerForm({isEdit: true}));
                    break;
            }
            appContainer.innerHTML = currentViewHtml;
        }
        
        // --- View Templates ---
        function renderLoginView() {
            return `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="w-full max-w-sm p-8 space-y-6 card">
                        <div class="text-center">
                            <h1 class="text-4xl font-bold text-primary">TipTally</h1>
                            <p class="text-text-muted mt-2">Streamlined Earnings Management</p>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="user-select" class="block text-sm font-medium text-text-secondary mb-1">Select User</label>
                                <select id="user-select" class="input-field">
                                    ${state.users.length > 0 ? state.users.map(user => `<option value="${user.id}" ${state.selectedLoginUser === user.id ? 'selected' : ''}>${user.name} (${user.role})</option>`).join('') : '<option>Loading users...</option>'}
                                </select>
                            </div>
                            <div>
                                <label for="pin-input" class="block text-sm font-medium text-text-secondary mb-1">PIN</label>
                                <input type="password" id="pin-input" class="input-field" placeholder="****"/>
                            </div>
                            <p id="login-error" class="text-sm text-red-400 ${state.loginError ? '' : 'hidden'}">${state.loginError}</p>
                            <button data-action="login" class="w-full btn btn-primary">Login</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderMainAppView(content) {
            return `
                <header class="bg-bg-secondary p-4 flex justify-between items-center shadow-md border-b border-border-color">
                    <div>
                        <h1 class="text-xl font-bold text-primary">TipTally</h1>
                        <p class="text-sm text-text-muted">Logged in as: <span class="font-semibold text-brand-pink">${state.currentUser?.name}</span></p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button data-action="toggle-theme" class="btn bg-bg-tertiary hover:bg-gray-600 text-primary">Toggle Theme</button>
                        <button data-action="logout" class="btn bg-bg-tertiary hover:bg-gray-600 text-primary">Logout</button>
                    </div>
                </header>
                <main class="p-4 md:p-8">${content}</main>
            `;
        }

        function renderWorkerDashboard() {
            const dailyTransactions = state.transactions.filter(t => t.workerId === state.currentUser.id && isSameDay(t.submissionTimestamp, state.selectedDate)).sort((a, b) => new Date(b.submissionTimestamp) - new Date(a.submissionTimestamp));
            const allTimeTransactions = state.transactions.filter(t => t.workerId === state.currentUser.id);
            const dailyApprovedTotal = dailyTransactions.reduce((sum, t) => sum + getApprovedAmount(t), 0);
            const allTimeApprovedTotal = allTimeTransactions.reduce((sum, t) => sum + getApprovedAmount(t), 0);
            const allTimeTake = allTimeApprovedTotal * state.currentUser.payoutSplit.worker;
            const isToday = isSameDay(state.selectedDate, new Date());

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-4">
                        <div class="card">${renderCalendar()}</div>
                        <div class="card">
                            <h3 class="text-text-muted text-sm">Your Total Take (All Time)</h3>
                            <p class="text-4xl font-bold text-brand-green">$${allTimeTake.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div>
                            <h2 class="text-2xl font-bold text-primary mb-1">My Daily Summary</h2>
                            <p class="text-lg text-brand-pink">${formatDate(state.selectedDate)}</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="card"><h3 class="text-text-muted text-sm">Approved Earnings (Day)</h3><p class="text-2xl font-bold text-brand-green">$${dailyApprovedTotal.toFixed(2)}</p></div>
                            <div class="card"><h3 class="text-text-muted text-sm">Your Take (Day)</h3><p class="text-2xl font-bold text-brand-pink">$${(dailyApprovedTotal * state.currentUser.payoutSplit.worker).toFixed(2)}</p></div>
                            <div class="card"><h3 class="text-text-muted text-sm">House Take (Day)</h3><p class="text-2xl font-bold text-brand-blue">$${(dailyApprovedTotal * state.currentUser.payoutSplit.house).toFixed(2)}</p></div>
                        </div>
                        ${isToday ? `
                        <div class="card">
                            <h3 class="text-xl font-bold text-primary mb-4">Submit New Earnings</h3>
                            <div class="flex flex-col md:flex-row gap-4">
                                <input type="number" id="new-transaction-amount" placeholder="Enter amount" class="input-field flex-grow"/>
                                <button data-action="add-transaction" class="btn btn-primary">Submit</button>
                            </div>
                        </div>` : ''}
                        <div>
                            <h3 class="text-xl font-bold text-primary mb-4">Submissions for this day</h3>
                            <div class="space-y-4">
                                ${dailyTransactions.length > 0 ? dailyTransactions.map(tx => `
                                <div class="card flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                    <div><p class="font-bold text-primary">ID: <span class="font-mono text-brand-pink">${tx.transactionCode}</span></p><p class="text-sm text-text-muted">${new Date(tx.submissionTimestamp).toLocaleTimeString()}</p></div>
                                    <div class="text-left md:text-right"><p class="text-lg font-bold text-primary">You Submitted: $${tx.workerSubmittedAmount.toFixed(2)}</p>${tx.status === 'disputed' ? `<p class="text-md font-semibold text-brand-yellow">Manager Counted: $${tx.managerVerifiedAmount.toFixed(2)}</p>` : ''}</div>
                                    <div class="flex items-center gap-4 w-full md:w-auto">${renderStatusBadge(tx.status)} ${tx.status === 'disputed' ? `<button data-action="worker-accept" data-id="${tx.id}" class="btn text-xs bg-brand-green text-white">Accept</button>` : ''}</div>
                                </div>`).join('') : `<p class="text-text-muted">No transactions submitted on this day.</p>`}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminDashboard() {
            const dailyTransactions = state.transactions.filter(t => isSameDay(t.submissionTimestamp, state.selectedDate));
            const pendingTransactions = dailyTransactions.filter(t => t.status === 'pending');
            const workers = state.users.filter(u => u.role === 'worker');
            
            const getWorkerTotals = (txList) => {
                const totals = {};
                workers.forEach(w => { totals[w.id] = { name: w.name, total: 0, split: w.payoutSplit, id: w.id }; });
                txList.forEach(tx => { if (totals[tx.workerId]) { totals[tx.workerId].total += getApprovedAmount(tx); } });
                return Object.values(totals);
            };

            const workerDailyTotals = getWorkerTotals(dailyTransactions);
            const workerAllTimeTotals = getWorkerTotals(state.transactions);
            const totalClubEarningsDay = workerDailyTotals.reduce((sum, w) => sum + w.total, 0);
            const totalHouseTakeDay = workerDailyTotals.reduce((sum, w) => sum + (w.total * w.split.house), 0);

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-4">
                        <div class="card">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-primary">Admin Tools</h2>
                                <button data-action="admin-add-worker-view" class="btn text-sm bg-brand-blue text-white">Add Worker</button>
                            </div>
                            ${renderCalendar()}
                        </div>
                        <div class="card">
                            <h3 class="text-xl font-bold text-primary mb-4">Daily Worker Payouts</h3>
                            <div class="space-y-2">${workerDailyTotals.map(w => `<div class="flex justify-between items-center text-sm"><span class="font-semibold text-primary">${w.name}</span><span class="font-bold text-brand-pink">$${(w.total * w.split.worker).toFixed(2)}</span></div>`).join('')}</div>
                        </div>
                         <div class="card">
                            <h3 class="text-xl font-bold text-primary mb-4">All-Time Worker Payouts</h3>
                            <div class="space-y-2">${workerAllTimeTotals.map(w => `<div class="flex justify-between items-center text-sm"><span class="font-semibold text-primary">${w.name}</span><span class="font-bold text-brand-green">$${(w.total * w.split.worker).toFixed(2)}</span></div>`).join('')}</div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-6">
                        <div>
                            <h2 class="text-2xl font-bold text-primary mb-1">Daily Summary</h2>
                            <p class="text-lg text-brand-pink">${formatDate(state.selectedDate)}</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="card"><h3 class="text-text-muted text-sm">Club Earnings (Day)</h3><p class="text-3xl font-bold text-brand-green">$${totalClubEarningsDay.toFixed(2)}</p></div>
                            <div class="card"><h3 class="text-text-muted text-sm">House Take (Day)</h3><p class="text-3xl font-bold text-brand-pink">$${totalHouseTakeDay.toFixed(2)}</p></div>
                        </div>
                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                            <div class="card">
                                <h3 class="text-xl font-bold text-primary mb-4">Worker Totals (Day)</h3>
                                <div class="space-y-3">${workerDailyTotals.map(w => `<div data-action="admin-worker-detail-view" data-id="${w.id}" class="bg-bg-tertiary p-4 rounded-lg flex justify-between items-center cursor-pointer hover:bg-gray-600 transition-colors"><p class="font-bold text-primary text-lg">${w.name}</p><p class="font-semibold text-brand-green text-lg">$${w.total.toFixed(2)}</p></div>`).join('')}</div>
                            </div>
                            <div class="card">
                                <h3 class="text-xl font-bold text-primary mb-4">Pending Verifications (${pendingTransactions.length})</h3>
                                <div class="space-y-4 max-h-96 overflow-y-auto pr-2">${pendingTransactions.length > 0 ? pendingTransactions.map(tx => `
                                    <div class="bg-bg-tertiary p-4 rounded-lg">
                                        <div class="flex justify-between items-center mb-3">
                                            <div><p class="font-bold text-primary">${tx.workerName} - <span class="font-mono text-brand-pink">${tx.transactionCode}</span></p><p class="text-sm text-text-muted">Submitted: $${tx.workerSubmittedAmount.toFixed(2)}</p></div>
                                            ${renderStatusBadge(tx.status)}
                                        </div>
                                        <div class="flex gap-2">
                                            <input type="number" data-id="${tx.id}" placeholder="Enter counted amount" class="input-field verification-amount flex-grow"/>
                                            <button data-action="verify" data-id="${tx.id}" class="btn bg-brand-green text-white">Verify</button>
                                        </div>
                                    </div>`).join('') : `<p class="text-text-muted">No pending transactions.</p>`}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminWorkerDetail() {
            const worker = state.users.find(u => u.id === state.selectedWorkerId);
            if (!worker) return `<p>Worker not found.</p>`;

            const dailyTransactions = state.transactions.filter(t => t.workerId === worker.id && isSameDay(t.submissionTimestamp, state.selectedDate)).sort((a, b) => new Date(b.submissionTimestamp) - new Date(a.submissionTimestamp));
            const allTimeTransactions = state.transactions.filter(t => t.workerId === worker.id);
            const dailyApprovedTotal = dailyTransactions.reduce((sum, t) => sum + getApprovedAmount(t), 0);
            const allTimeApprovedTotal = allTimeTransactions.reduce((sum, t) => sum + getApprovedAmount(t), 0);
            const { payoutSplit } = worker;
            
            return `
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <button data-action="admin-dashboard-view" class="text-brand-pink hover:underline">&larr; Back to Dashboard</button>
                        <button data-action="admin-edit-worker-view" data-id="${worker.id}" class="btn text-sm bg-yellow-500 text-white">Edit Worker</button>
                    </div>
                    <h2 class="text-3xl font-bold text-primary mb-2">${worker.name}'s Summary</h2>
                    <div class="mb-8 p-4 card mt-4">
                        <h3 class="text-xl font-bold text-primary mb-4">All-Time Totals</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="card bg-bg-tertiary"><h3 class="text-text-muted text-sm">Total Approved</h3><p class="text-3xl font-bold text-brand-green">$${allTimeApprovedTotal.toFixed(2)}</p></div>
                            <div class="card bg-bg-tertiary"><h3 class="text-text-muted text-sm">Total Payout (${payoutSplit.worker * 100}%)</h3><p class="text-3xl font-bold text-brand-pink">$${(allTimeApprovedTotal * payoutSplit.worker).toFixed(2)}</p></div>
                            <div class="card bg-bg-tertiary"><h3 class="text-text-muted text-sm">Total House Take (${payoutSplit.house * 100}%)</h3><p class="text-3xl font-bold text-brand-blue">$${(allTimeApprovedTotal * payoutSplit.house).toFixed(2)}</p></div>
                        </div>
                    </div>
                    <p class="text-lg text-brand-pink mb-4 font-bold">${formatDate(state.selectedDate)}</p>
                    <h3 class="text-xl font-bold text-primary mb-4">Transaction History (Day)</h3>
                    <div class="space-y-4">
                        ${dailyTransactions.length > 0 ? dailyTransactions.map(tx => `
                        <div class="card flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div><p class="font-bold text-primary">ID: <span class="font-mono text-brand-pink">${tx.transactionCode}</span></p><p class="text-sm text-text-muted">${new Date(tx.submissionTimestamp).toLocaleTimeString()}</p></div>
                            <div class="text-left md:text-right"><p class="text-lg font-bold text-primary">Submitted: $${tx.workerSubmittedAmount.toFixed(2)}</p>${tx.managerVerifiedAmount !== null ? `<p class="text-md font-semibold text-brand-yellow">Verified: $${tx.managerVerifiedAmount.toFixed(2)}</p>` : ''}</div>
                            ${renderStatusBadge(tx.status)}
                        </div>`).join('') : `<p class="text-text-muted">No transactions on this day.</p>`}
                    </div>
                </div>
            `;
        }

        function renderAddWorkerForm({ isEdit = false } = {}) {
            const worker = isEdit ? state.users.find(u => u.id === state.selectedWorkerId) : null;
            return `
                <div>
                    <button data-action="admin-dashboard-view" class="mb-6 text-brand-pink hover:underline">&larr; Back to Dashboard</button>
                    <div class="max-w-md mx-auto card">
                        <h2 class="text-2xl font-bold text-primary mb-6">${isEdit ? 'Edit Worker Profile' : 'Add New Worker'}</h2>
                        <div class="space-y-4">
                            <div><label for="worker-name" class="block text-sm font-medium text-text-secondary mb-1">Worker Name</label><input type="text" id="worker-name" class="input-field" value="${worker?.name || ''}" required /></div>
                            <div><label for="worker-pin" class="block text-sm font-medium text-text-secondary mb-1">4-Digit PIN</label><input type="text" pattern="\\d{4}" title="PIN must be 4 digits" id="worker-pin" class="input-field" value="${worker?.pin || ''}" required /></div>
                            <div><label for="worker-split" class="block text-sm font-medium text-text-secondary mb-1">Worker Payout Split (%)</label><input type="number" min="0" max="100" id="worker-split" class="input-field" value="${worker ? worker.payoutSplit.worker * 100 : '70'}" required /></div>
                            <button data-action="${isEdit ? 'admin-update-worker' : 'admin-create-worker'}" data-id="${worker?.id || ''}" class="w-full btn btn-primary">${isEdit ? 'Save Changes' : 'Create Worker'}</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCalendar() {
            const { selectedDate, transactions } = state;
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const transactionDays = new Set(transactions.map(tx => new Date(tx.submissionTimestamp).toDateString()));

            let daysHtml = '';
            for (let i = 0; i < firstDay; i++) {
                daysHtml += `<div class="w-10 h-10"></div>`;
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isSelected = isSameDay(date, selectedDate);
                const isToday = isSameDay(date, new Date());
                const hasTransactions = transactionDays.has(date.toDateString());
                const dayClasses = `w-10 h-10 flex items-center justify-center rounded-full cursor-pointer transition-colors relative ${isSelected ? 'bg-brand-pink text-white font-bold' : isToday ? 'bg-bg-tertiary' : 'hover:bg-bg-tertiary'}`;
                daysHtml += `<div data-action="select-date" data-date="${date.toISOString()}" class="${dayClasses}"><span>${day}</span>${hasTransactions && !isSelected ? '<div class="absolute bottom-1 w-1.5 h-1.5 bg-brand-blue rounded-full"></div>' : ''}</div>`;
            }

            return `
                <div class="flex justify-between items-center mb-4">
                    <button data-action="prev-month" class="p-2 rounded-full hover:bg-bg-tertiary">&lt;</button>
                    <h3 class="text-lg font-semibold text-primary">${monthNames[month]} ${year}</h3>
                    <button data-action="next-month" class="p-2 rounded-full hover:bg-bg-tertiary">&gt;</button>
                </div>
                <div class="grid grid-cols-7 gap-y-2 place-items-center text-xs text-text-muted mb-2">
                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<div>${d}</div>`).join('')}
                </div>
                <div class="grid grid-cols-7 gap-y-2 place-items-center">${daysHtml}</div>
            `;
        }

        function renderStatusBadge(status) {
            const badgeMap = {
                approved: { text: 'Approved', color: 'bg-brand-green' },
                disputed: { text: 'Disputed', color: 'bg-brand-yellow' },
                pending: { text: 'Pending', color: 'bg-gray-500' }
            };
            const { text, color } = badgeMap[status] || badgeMap.pending;
            return `<span class="px-2 py-1 text-xs font-bold rounded-full text-white ${color}">${text}</span>`;
        }
        
        // --- Event Handlers & Actions ---
        function handleAction(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const { action, id } = target.dataset;

            switch(action) {
                case 'login': handleLogin(); break;
                case 'logout': handleLogout(); break;
                case 'select-date':
                    state.selectedDate = new Date(target.dataset.date);
                    render();
                    break;
                case 'prev-month':
                    state.selectedDate.setMonth(state.selectedDate.getMonth() - 1);
                    render();
                    break;
                case 'next-month':
                    state.selectedDate.setMonth(state.selectedDate.getMonth() + 1);
                    render();
                    break;
                case 'add-transaction': handleAddTransaction(); break;
                case 'verify': handleVerification(id); break;
                case 'worker-accept': handleWorkerAcceptance(id); break;
                case 'admin-dashboard-view':
                    state.view = 'adminDashboard';
                    render();
                    break;
                case 'admin-add-worker-view':
                    state.view = 'adminAddWorker';
                    render();
                    break;
                case 'admin-worker-detail-view':
                    state.selectedWorkerId = id;
                    state.view = 'adminWorkerDetail';
                    render();
                    break;
                case 'admin-edit-worker-view':
                    state.selectedWorkerId = id;
                    state.view = 'adminEditWorker';
                    render();
                    break;
                case 'admin-create-worker': handleAddWorker(); break;
                case 'admin-update-worker': handleUpdateWorker(id); break;
                case 'toggle-theme': handleToggleTheme(); break;
            }
        }
        
        async function handleLogin() {
            const selectedId = document.getElementById('user-select').value;
            const pin = document.getElementById('pin-input').value;
            const user = state.users.find(u => u.id === selectedId);

            if (user && user.pin === pin) {
                state.currentUser = user;
                state.view = user.role === 'admin' ? 'adminDashboard' : 'workerDashboard';
                state.loginError = '';
            } else {
                state.loginError = 'Invalid PIN. Please try again.';
            }
            render();
        }

        function handleLogout() {
            state.currentUser = null;
            state.view = 'login';
            render();
        }
        
        async function handleAddTransaction() {
            const amountInput = document.getElementById('new-transaction-amount');
            const amount = parseFloat(amountInput.value);
            if (!amount || amount <= 0) { alert("Please enter a valid amount."); return; }

            const newTransaction = {
              workerId: state.currentUser.id,
              workerName: state.currentUser.name,
              transactionCode: `${state.currentUser.name.substring(0, 3).toUpperCase()}-${Math.floor(100 + Math.random() * 900)}`,
              workerSubmittedAmount: amount,
              managerVerifiedAmount: null,
              status: 'pending',
              submissionTimestamp: new Date().toISOString(),
              verificationTimestamp: null,
            };
            await db.collection('transactions').add(newTransaction);
            amountInput.value = '';
        }

        async function handleVerification(txId) {
            const amountInput = document.querySelector(`input.verification-amount[data-id="${txId}"]`);
            const managerAmount = parseFloat(amountInput.value);
            if (isNaN(managerAmount)) { alert('Please enter a valid number.'); return; }

            const txRef = db.collection('transactions').doc(txId);
            const txDoc = await txRef.get();
            if (txDoc.exists) {
                const tx = txDoc.data();
                const status = managerAmount === tx.workerSubmittedAmount ? 'approved' : 'disputed';
                await txRef.update({ managerVerifiedAmount: managerAmount, status, verificationTimestamp: new Date().toISOString() });
            }
        }
        
        async function handleWorkerAcceptance(txId) {
            const txRef = db.collection('transactions').doc(txId);
            await txRef.update({ status: 'approved' });
        }

        async function handleAddWorker() {
            const name = document.getElementById('worker-name').value;
            const pin = document.getElementById('worker-pin').value;
            const split = document.getElementById('worker-split').value;
            if (!name || !pin || !split) { alert("All fields are required."); return; }

            const newWorker = {
                name, role: 'worker', pin,
                payoutSplit: { worker: parseFloat(split) / 100, house: 1 - (parseFloat(split) / 100) }
            };
            await db.collection('users').add(newWorker);
            state.view = 'adminDashboard';
            render();
        }

        async function handleUpdateWorker(id) {
            const name = document.getElementById('worker-name').value;
            const pin = document.getElementById('worker-pin').value;
            const split = document.getElementById('worker-split').value;
            if (!id || !name || !pin || !split) { alert("All fields are required."); return; }
            
            const workerRef = db.collection('users').doc(id);
            await workerRef.update({
                name, pin,
                payoutSplit: { worker: parseFloat(split) / 100, house: 1 - (parseFloat(split) / 100) }
            });
            state.view = 'adminDashboard';
            render();
        }
        
        function handleToggleTheme() {
            const appWrapper = document.getElementById('tiptally-app-wrapper');
            const isLight = appWrapper.classList.toggle('light-mode');
            localStorage.setItem('tipTallyTheme', isLight ? 'light' : 'dark');
        }

        // --- Initializer ---
        async function init() {
            function applyTheme() {
                const savedTheme = localStorage.getItem('tipTallyTheme') || 'dark';
                const appWrapper = document.getElementById('tiptally-app-wrapper');
                if (appWrapper) {
                   appWrapper.classList.toggle('light-mode', savedTheme === 'light');
                }
            }
            applyTheme();

            // Seed data if necessary
            const usersRef = db.collection('users');
            try {
                const usersSnapshot = await usersRef.get();
                if (usersSnapshot.empty) {
                    console.log('No users found, seeding initial data.');
                    const initialUsers = [
                      { id: 'admin-1', name: 'Manager', role: 'admin', pin: '1234', payoutSplit: { worker: 0, house: 1 } },
                      { id: 'worker-1', name: 'Destiny', role: 'worker', pin: '1111', payoutSplit: { worker: 0.7, house: 0.3 } },
                      { id: 'worker-2', name: 'Crystal', role: 'worker', pin: '2222', payoutSplit: { worker: 0.7, house: 0.3 } },
                    ];
                    const batch = db.batch();
                    initialUsers.forEach(user => {
                      const docRef = usersRef.doc(user.id);
                      batch.set(docRef, user);
                    });
                    await batch.commit();
                    console.log("Default users seeded.");
                }
            } catch (e) {
                console.error("Firestore operation failed. This is likely a permissions issue. Please check your Firestore security rules.", e);
                appContainer.innerHTML = `<div class="p-8 text-center text-red-400"><h2>Connection Error</h2><p>Could not connect to the database. Please ensure your Firestore security rules are set to allow reads and writes.</p></div>`;
                return;
            }

            // Set up real-time listeners
            db.collection('users').onSnapshot(snapshot => {
                state.users = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                if (!state.selectedLoginUser && state.users.length > 0) {
                    state.selectedLoginUser = state.users[0].id;
                }
                if (state.view === 'login') render();
            }, error => console.error("Error fetching users:", error));

            db.collection('transactions').orderBy("submissionTimestamp", "desc").onSnapshot(snapshot => {
                state.transactions = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                if (state.view !== 'login') render();
            }, error => console.error("Error fetching transactions:", error));
            
            // Add global event listeners
            appContainer.addEventListener('click', handleAction);
            appContainer.addEventListener('change', (e) => {
                if (e.target.id === 'user-select') {
                    state.selectedLoginUser = e.target.value;
                }
            });

            // Initial render is now driven by the snapshot listeners
        }

        init();

    });
    </script>
</body>
</html>
