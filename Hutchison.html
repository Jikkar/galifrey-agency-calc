<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Pricing Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
    /*
    ============================================
    --- 1. CSS Variables & Root Setup
    ============================================
    Defines the core design tokens (colors, spacing, fonts) for the application.
    */
    :root {
        --color-primary: #4f46e5; /* Indigo 600 */
        --color-primary-dark: #4338ca; /* Indigo 700 */
        --color-accent: #10b981; /* Emerald 500 */
        --color-bg: #f8f9fa; /* Lighter Gray */
        --color-surface: #ffffff;
        --color-text-header: #212529;
        --color-text-body: #495057;
        --color-text-muted: #6c757d;
        --color-border: #dee2e6;
        --color-input-bg: #f1f3f5;
        --color-error: #dc3545;
        --font-family-base: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --spacing-unit: 8px;
        --border-radius: 0.5rem; /* 8px */
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.04);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.05);
        --transition-speed: 0.2s;
    }

    /*
    ============================================
    --- 2. Base & Global Styles
    ============================================
    Applies foundational styles and resets.
    */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-family-base);
        background-color: var(--color-bg);
        color: var(--color-text-body);
        line-height: 1.6;
        font-size: 16px;
    }

    .hidden {
        display: none !important;
    }

    .app-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: calc(var(--spacing-unit) * 3);
    }
    
    /*
    ============================================
    --- 3. Password Prompt
    ============================================
    */
    #password-prompt {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: calc(var(--spacing-unit) * 2);
    }

    #password-prompt > div {
        max-width: 400px;
        width: 100%;
        background-color: var(--color-surface);
        padding: calc(var(--spacing-unit) * 5);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        text-align: center;
    }
    
    #password-prompt h2 {
        color: var(--color-text-header);
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: var(--spacing-unit);
    }

    #password-prompt p {
        color: var(--color-text-muted);
        margin-bottom: calc(var(--spacing-unit) * 3);
    }

    #password-input {
        width: 100%;
        padding: calc(var(--spacing-unit) * 1.5);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        font-size: 1rem;
        margin-bottom: calc(var(--spacing-unit) * 2);
        transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
    }

    #password-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgb(79 70 229 / 0.2);
    }

    #submit-password {
        width: 100%;
        padding: calc(var(--spacing-unit) * 1.5);
        background-color: var(--color-primary);
        color: var(--color-surface);
        border: none;
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color var(--transition-speed);
    }

    #submit-password:hover {
        background-color: var(--color-primary-dark);
    }

    #password-error {
        color: var(--color-error);
        margin-top: var(--spacing-unit);
        font-size: 0.875rem;
    }

    /*
    ============================================
    --- 4. Main Application Layout & Header
    ============================================
    */
    header {
        text-align: center;
        margin-bottom: calc(var(--spacing-unit) * 5);
    }

    #company-header {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-text-header);
        margin-bottom: var(--spacing-unit);
    }

    header > p {
        color: var(--color-text-muted);
        font-size: 1.125rem;
    }

    header .view-switcher {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: var(--spacing-unit);
        margin-top: calc(var(--spacing-unit) * 3);
    }
    
    header .view-switcher button {
        padding: calc(var(--spacing-unit) * 1.25) calc(var(--spacing-unit) * 3);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        font-weight: 600;
        cursor: pointer;
        transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    header .view-switcher button.active {
        background-color: var(--color-primary);
        color: var(--color-surface);
        border-color: var(--color-primary);
    }
    
    header .view-switcher button:not(.active) {
        background-color: var(--color-surface);
        color: var(--color-text-body);
    }
    
    header .view-switcher button:not(.active):hover {
        background-color: var(--color-bg);
    }


    /*
    ============================================
    --- 5. General Card & Form Styles
    ============================================
    Shared styles for calculator, admin, and quote summary cards.
    */
    .card {
        background-color: var(--color-surface);
        border-radius: var(--border-radius);
        padding: calc(var(--spacing-unit) * 4);
        box-shadow: var(--shadow-md);
        margin-bottom: calc(var(--spacing-unit) * 3);
    }
    
    .card__title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--color-text-header);
        margin-bottom: calc(var(--spacing-unit) * 3);
        padding-bottom: calc(var(--spacing-unit) * 2);
        border-bottom: 1px solid var(--color-border);
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: calc(var(--spacing-unit) * 4);
    }

    .form-fieldset {
        border: none;
        display: flex;
        flex-direction: column;
        gap: calc(var(--spacing-unit) * 2);
    }

    .form-fieldset__legend {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-text-header);
        margin-bottom: var(--spacing-unit);
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group__label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-text-body);
        margin-bottom: var(--spacing-unit);
    }

    .form-group__input,
    .form-group__select {
        width: 100%;
        padding: calc(var(--spacing-unit) * 1.25);
        border: 1px solid var(--color-border);
        border-radius: calc(var(--border-radius) / 1.5);
        font-size: 1rem;
        background-color: var(--color-surface);
        transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
    }

    .form-group__input:focus,
    .form-group__select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgb(79 70 229 / 0.2);
    }
    
    .form-group--checkbox {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: var(--spacing-unit);
    }

    .form-group__checkbox {
        height: 1.25em;
        width: 1.25em;
        accent-color: var(--color-primary);
    }

    /*
    ============================================
    --- 6. Calculator Interface Specifics
    ============================================
    */
    #calculator-interface .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: calc(var(--spacing-unit) * 4);
    }

    #quote-summary.card {
        position: sticky;
        top: calc(var(--spacing-unit) * 3);
    }
    
    .quote-summary__placeholder {
        text-align: center;
        color: var(--color-text-muted);
        padding: calc(var(--spacing-unit) * 8) 0;
    }

    .quote-summary__table, #full-quote-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .quote-summary__table td, #full-quote-table td, #full-quote-table th {
        padding: calc(var(--spacing-unit) * 1.5) var(--spacing-unit);
        border-bottom: 1px solid var(--color-border);
    }
    
    #full-quote-table th {
        text-align: left;
        font-size: 0.875rem;
        color: var(--color-text-muted);
        text-transform: uppercase;
        border-bottom-width: 2px;
    }

    .quote-summary__table tr:last-child td, #full-quote-table tr:last-child td {
        border-bottom: none;
    }

    .quote-summary__table .item-name, #full-quote-table .item-name {
        font-weight: 500;
    }
    #full-quote-table .item-details {
        font-size: 0.875rem;
        color: var(--color-text-muted);
    }
    
    .quote-summary__table .item-cost, #full-quote-table .item-cost {
        text-align: right;
    }
    
    #full-quote-table .item-actions {
        text-align: right;
    }

    .quote-summary__table .subtotal-row td, #full-quote-table .subtotal-row td {
        font-weight: 600;
        color: var(--color-text-header);
        border-top: 2px solid var(--color-border);
        padding-top: calc(var(--spacing-unit) * 2);
    }
    
    .quote-summary__table .total-row td, #full-quote-table .total-row td {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--color-primary);
        background-color: #f3f4f6;
    }
    
    #full-quote-table .discount-row td {
        color: var(--color-accent);
        font-weight: 500;
    }

    #quote-chart-container, #full-quote-chart-container {
        margin-top: calc(var(--spacing-unit) * 4);
        padding-top: calc(var(--spacing-unit) * 3);
        border-top: 1px solid var(--color-border);
    }
    
    #full-quote-chart-container {
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    .add-to-quote-btn {
        width: 100%;
        padding: calc(var(--spacing-unit) * 1.5);
        background-color: var(--color-accent);
        color: var(--color-surface);
        border: none;
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color var(--transition-speed);
        margin-top: calc(var(--spacing-unit) * 3);
    }
    .add-to-quote-btn:hover {
        background-color: #0d9488;
    }
    .add-to-quote-btn:disabled {
        background-color: var(--color-text-muted);
        cursor: not-allowed;
    }

    /*
    ============================================
    --- 7. Admin Panel Specifics
    ============================================
    */
    #admin-panel .admin-group {
        display: grid;
        grid-template-columns: 1fr 200px;
        gap: calc(var(--spacing-unit) * 2);
        align-items: center;
        margin-bottom: var(--spacing-unit);
    }

    #admin-panel .data-management-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: calc(var(--spacing-unit) * 2);
    }

    #admin-panel .data-management-card {
         background-color: var(--color-bg);
         padding: calc(var(--spacing-unit) * 2);
         border-radius: var(--border-radius);
         border: 1px solid var(--color-border);
    }

    #admin-panel .data-management-card h4 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: var(--spacing-unit);
    }

     #admin-panel .data-management-card p {
        font-size: 0.875rem;
        color: var(--color-text-muted);
        margin-bottom: calc(var(--spacing-unit) * 2);
    }
    
    #admin-panel .admin-group__label {
        font-weight: 500;
    }

    #admin-panel .admin-section-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-top: calc(var(--spacing-unit) * 4);
        margin-bottom: calc(var(--spacing-unit) * 2);
        padding-bottom: var(--spacing-unit);
        border-bottom: 1px solid var(--color-border);
    }
    
    .admin-actions {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: calc(var(--spacing-unit) * 2);
        margin-top: calc(var(--spacing-unit) * 4);
    }
    
    .save-button, .admin-button {
        padding: calc(var(--spacing-unit) * 1.25) calc(var(--spacing-unit) * 3);
        background-color: var(--color-primary);
        color: var(--color-surface);
        border: none;
        border-radius: var(--border-radius);
        font-weight: 600;
        cursor: pointer;
        transition: background-color var(--transition-speed);
        display: inline-block;
        text-align: center;
    }
    
    .save-button:hover, .admin-button:hover {
        background-color: var(--color-primary-dark);
    }
    
    .admin-button.secondary {
        background-color: var(--color-text-muted);
    }

    .admin-button.secondary:hover {
        background-color: var(--color-text-body);
    }
    
    .admin-button.danger {
        background-color: var(--color-error);
    }
    .admin-button.danger:hover {
        background-color: #c82333;
    }

    .delete-item-btn {
        background: none;
        border: none;
        color: var(--color-error);
        cursor: pointer;
        font-size: 1rem;
    }


    #save-confirmation {
        color: var(--color-accent);
        font-weight: 600;
        transition: opacity 0.3s ease-in-out;
    }

    #admin-help-content ul {
        list-style-position: inside;
        padding-left: var(--spacing-unit);
    }
    #admin-help-content li {
        margin-bottom: var(--spacing-unit);
    }

    /*
    ============================================
    --- 8. Responsive Design
    ============================================
    */
    @media (max-width: 992px) {
        #calculator-interface .main-grid,
        #admin-panel .main-grid,
        #full-quote-view .main-grid {
            grid-template-columns: 1fr;
        }
    }
    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        #admin-panel .admin-group {
            grid-template-columns: 1fr;
            gap: var(--spacing-unit);
        }

        .app-wrapper {
             padding: calc(var(--spacing-unit) * 2);
        }
    }
    @media (min-width: 768px) {
        #company-header {
            font-size: 2.5rem;
        }
    }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="password-prompt">
            <div>
                <h2>Admin Access</h2>
                <p>Enter password to access the calculator and admin panel.</p>
                <div>
                    <label for="password-input" class="hidden">Password</label>
                    <input id="password-input" name="password" type="password" required placeholder="Password">
                </div>
                <div>
                    <button id="submit-password">Unlock</button>
                </div>
                <p id="password-error" class="hidden">Incorrect password. Please try again.</p>
            </div>
        </div>
    </div>

    <div id="encrypted-payload" class="hidden"></div>


    <script>
    // --- START: MAIN APPLICATION LOGIC (IIFE Modules) ---
    // The modules are ordered to resolve dependencies: modules that are needed by others are defined first.

    /**
     * @module DataEngine
     * @description Handles all interactions with localStorage. No dependencies.
     */
    const DataEngine = (function() {
        const DB_KEY = 'businessCalculatorData';

        // Default data schema as per the blueprint
        function getDefaultData() {
            const commonCutouts = {
                undermount_sink: { name: "Undermount Sink", cost: 300 },
                dropin_sink: { name: "Drop-in Sink", cost: 150 },
                cooktop: { name: "Cooktop", cost: 200 },
                faucet_hole: { name: "Faucet Hole", cost: 20 }
            };

            const commonEdges = {
                eased: { name: "Eased (Standard)", cost_lnft: 0 },
                bevel: { name: "Bevel", cost_lnft: 10 },
                bullnose: { name: "Bullnose", cost_lnft: 15},
                ogee: { name: "Ogee", cost_lnft: 25 }
            };

            return {
                "version": "2.8.0", // Updated version
                "settings": {
                    "companyName": "Hutchison Custom Fabrication",
                    "taxRate": 0.0875
                },
                "countertops": {
                    "plastic_laminate": { name: "Plastic Laminate", cost_sqft: 35.67, options: { brand: { name: "Brand/Finish", type: "select", values: { standard: { name: "Standard (Formica, Wilsonart)", multiplier: 1.0 }, premium: { name: "Premium Finish", multiplier: 1.25 } } } }, edges: commonEdges, cutouts: commonCutouts },
                    "granite": { name: "Granite", cost_sqft: 80.63, options: { grade: { name: "Grade", type: "select", values: { level_1: { name: "Level 1 (Standard)", multiplier: 1.0 }, level_2: { name: "Level 2 (Mid-Grade)", multiplier: 1.2 }, exotic: { name: "Exotic", multiplier: 1.5 } } } }, edges: commonEdges, cutouts: commonCutouts },
                    "quartz": { name: "Quartz", cost_sqft: 73.16, options: { brand: { name: "Brand", type: "select", values: { standard: { name: "Standard (e.g., Silestone)", multiplier: 1.0 }, premium: { name: "Premium (e.g., Cambria)", multiplier: 1.3 } } } }, edges: commonEdges, cutouts: commonCutouts },
                    "solid_surface": { name: "Solid Surface", cost_sqft: 49.27, options: { color: { name: "Color/Pattern", type: "select", values: { standard: { name: "Standard Color", multiplier: 1.0 }, premium: { name: "Premium Pattern", multiplier: 1.2 } } } }, edges: commonEdges, cutouts: { ...commonCutouts, integral_sink: { name: "Integral Sink", cost: 450 } } },
                    "butcher_block": { name: "Butcher Block", cost_sqft: 39.63, options: { species: { name: "Wood Species", type: "select", values: { oak: { name: "Oak", multiplier: 1.0 }, maple: { name: "Maple", multiplier: 1.1 }, walnut: { name: "Walnut", multiplier: 1.5 } } } }, edges: commonEdges, cutouts: commonCutouts },
                    "stainless_steel": { name: "Stainless Steel", cost_sqft: 90.32, options: { gauge: { name: "Gauge", type: "select", values: { '16_gauge': { name: "16-Gauge (Standard)", multiplier: 1.0 }, '14_gauge': { name: "14-Gauge (Heavy Duty)", multiplier: 1.3 } } } }, edges: { square: { name: "Square Edge", cost_lnft: 0 } }, cutouts: commonCutouts },
                    "phenolic_resin": { name: "Phenolic Resin", cost_sqft: 60.00, options: { thickness: { name: "Thickness", type: "select", values: { 'three_quarter': { name: "3/4 inch", multiplier: 1.0 }, 'one_inch': { name: "1 inch", multiplier: 1.25 } } } }, edges: { square: { name: "Square Edge", cost_lnft: 0 } }, cutouts: commonCutouts },
                    "epoxy_resin": { name: "Epoxy Resin", cost_sqft: 100.00, options: { design: { name: "Design Complexity", type: "select", values: { simple: { name: "Simple (1-2 Colors)", multiplier: 1.0 }, complex: { name: "Complex (Metallics, Veining)", multiplier: 1.5 } } } }, edges: { square: { name: "Square Edge", cost_lnft: 0 } }, cutouts: commonCutouts }
                },
                "casework": {
                    "base_cabinets": { 
                        name: "Base Cabinets",
                        type: "standard",
                        cost_lnft: 250,
                        options: {
                            awi_grade: { name: "AWI Grade", type: "select", values: { economy: { name: "Economy", multiplier: 1.0 }, custom: { name: "Custom", multiplier: 1.4 }, premium: { name: "Premium", multiplier: 2.0 } } },
                            material: { name: "Material", type: "select", values: { p_laminate: { name: "Plastic Laminate", multiplier: 1.0 }, wood_veneer: { name: "Wood Veneer", multiplier: 1.8 } } },
                            construction: { name: "Construction", type: "select", values: { frameless: { name: "Frameless", multiplier: 1.0 }, face_frame: { name: "Face Frame", multiplier: 1.15 }, inset: { name: "Inset", multiplier: 1.35 } } }
                        }
                    },
                    "wall_cabinets": {
                        name: "Wall Cabinets",
                        type: "standard",
                        cost_lnft: 200, 
                        options: {
                             awi_grade: { name: "AWI Grade", type: "select", values: { economy: { name: "Economy", multiplier: 1.0 }, custom: { name: "Custom", multiplier: 1.4 }, premium: { name: "Premium", multiplier: 2.0 } } },
                             material: { name: "Material", type: "select", values: { p_laminate: { name: "Plastic Laminate", multiplier: 1.0 }, wood_veneer: { name: "Wood Veneer", multiplier: 1.8 } } },
                             construction: { name: "Construction", type: "select", values: { frameless: { name: "Frameless", multiplier: 1.0 }, face_frame: { name: "Face Frame", multiplier: 1.15 } } }
                        }
                    },
                    "reception_desk": {
                        name: "Reception Desk",
                        type: "custom_millwork",
                        base_cost: 3000,
                        options: {
                            shape: { name: "Shape", type: "select", values: { straight: {name: "Straight", multiplier: 1.0}, l_shape: {name: "L-Shape", multiplier: 1.5}, u_shape: {name: "U-Shape", multiplier: 2.0} } },
                            ada_section: { name: "ADA Compliant Section", type: "checkbox", cost: 500 },
                            transaction_top: { name: "Transaction Top", type: "checkbox", cost: 750 }
                        }
                    },
                     "trophy_case": {
                        name: "Trophy Case",
                        type: "custom_millwork",
                        base_cost: 2500,
                        options: {
                            size: { name: "Size", type: "select", values: { "48in": {name: "48-inch", multiplier: 1.0}, "60in": {name: "60-inch", multiplier: 1.25}, "72in": {name: "72-inch", multiplier: 1.5} } },
                            lighting: { name: "LED Lighting", type: "checkbox", cost: 400 },
                            locking_doors: { name: "Locking Doors", type: "checkbox", cost: 150 }
                        }
                    },
                    "architectural_wall_panels": {
                        name: "Architectural Wall Panels",
                        type: "custom_sqft",
                        cost_sqft: 25.00,
                        options: {
                            style: { 
                                name: "Style", 
                                type: "select", 
                                values: { 
                                    shiplap: { name: "Shiplap", multiplier: 1.0 }, 
                                    board_batten: { name: "Board & Batten", multiplier: 1.2 }, 
                                    raised_panel: { name: "Raised Panel", multiplier: 1.5 } 
                                } 
                            },
                            material: { 
                                name: "Material", 
                                type: "select", 
                                values: { 
                                    mdf: { name: "MDF", multiplier: 1.0 }, 
                                    paintable_wood: { name: "Paintable Wood", multiplier: 1.4 },
                                    veneer: { name: "Wood Veneer", multiplier: 2.0 }
                                } 
                            }
                        }
                    }
                },
                "misc_services": {
                    "design": {
                        "name": "Design Services",
                        "rate_hourly": 75
                    },
                    "cnc_machining": {
                        "name": "CNC Machining",
                        "rate_hourly": 90,
                        "setup_fee": 50
                    },
                    "welding_fab": {
                        "name": "Light Welding & Fabrication",
                        "rate_hourly": 65
                    },
                    "custom_cabinet_fabrication": {
                        name: "Custom Cabinet Fabrication",
                        type: "custom_cabinet",
                        cost_cubic_ft: 50, // Base cost per cubic foot
                        materials: {
                            mdf: { name: "MDF", cost_sqft: 2.50 },
                            plywood: { name: "Plywood", cost_sqft: 4.00 },
                            solid_wood: { name: "Solid Wood", cost_sqft: 8.00 }
                        },
                        finishes: {
                            paint: { name: "Paint", cost: 300 },
                            stain: { name: "Stain & Varnish", cost: 450 }
                        },
                        hardware: {
                            standard: { name: "Standard", cost: 50 },
                            premium: { name: "Premium Soft-Close", cost: 150 }
                        }
                    }
                }
            };
        }

        function init() {
            const currentData = getData();
            saveData(currentData);
            console.log('Data engine initialized and data validated.');
        }

        function getData() {
            const defaultData = getDefaultData();
            try {
                const storedDataString = localStorage.getItem(DB_KEY);
                if (storedDataString) {
                    const storedData = JSON.parse(storedDataString);
                    const mergedData = {
                        ...defaultData,
                        ...storedData,
                        settings: { ...defaultData.settings, ...(storedData.settings || {}) },
                        countertops: { ...defaultData.countertops, ...(storedData.countertops || {}) },
                        casework: { ...defaultData.casework, ...(storedData.casework || {}) },
                        misc_services: { ...defaultData.misc_services, ...(storedData.misc_services || {}) },
                    };
                    return mergedData;
                }
                return defaultData;
            } catch (e) {
                console.error("Error parsing data from localStorage, falling back to defaults:", e);
                return defaultData;
            }
        }

        function saveData(data) {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
            }
        }

        return { init, getData, saveData };
    })();

    /**
     * @module UIController
     * @description Manages DOM manipulation and view switching. Depends on Calculator and AdminPanel modules at runtime.
     */
    const UIController = (function() {
        let mainViews = {};
        let mainButtons = {};

        function init() {
            mainViews = {
                calculator: document.getElementById('calculator-interface'),
                fullQuote: document.getElementById('full-quote-view'),
                admin: document.getElementById('admin-panel')
            };
            mainButtons = {
                calculator: document.getElementById('show-calculator-btn'),
                fullQuote: document.getElementById('show-full-quote-btn'),
                admin: document.getElementById('show-admin-btn')
            };
        }

        function showMainView(viewName) {
            Object.keys(mainViews).forEach(key => {
                const isActive = key === viewName;
                if (mainViews[key]) mainViews[key].classList.toggle('hidden', !isActive);
                if (mainButtons[key]) mainButtons[key].classList.toggle('active', isActive);
            });
            
            if(viewName === 'calculator') Calculator.render();
            if(viewName === 'fullQuote') App.renderFullQuote();
            if(viewName === 'admin') AdminPanel.render();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        }

        return { init, showMainView, formatCurrency };
    })();
    
    /**
     * @module Calculator
     * @description Handles rendering and logic for the public-facing calculator.
     * @dependencies DataEngine, UIController
     */
    const Calculator = (function() {
        let container = null;
        let currentCategory = 'countertops';
        let itemQuoteChart = null; 

        function init() {
            container = document.getElementById('calculator-interface');
            if (container) {
                attachListeners();
            }
        }

        function render() {
             if(!container) container = document.getElementById('calculator-interface');
             if(!container) return; 
             let html = `
                <div id="calc-category-tabs" role="tablist" aria-label="Service Categories" class="view-switcher" style="justify-content: flex-start; margin-top: 0; margin-bottom: 24px; border-bottom: 1px solid var(--color-border); padding-bottom: 16px;">
                    <button id="tab-countertops" role="tab" aria-selected="${currentCategory === 'countertops'}" aria-controls="panel-countertops" data-category="countertops" class="${currentCategory === 'countertops' ? 'active' : ''}">Countertops</button>
                    <button id="tab-casework" role="tab" aria-selected="${currentCategory === 'casework'}" aria-controls="panel-casework" data-category="casework" class="${currentCategory === 'casework' ? 'active' : ''}">Casework & Millwork</button>
                    <button id="tab-misc" role="tab" aria-selected="${currentCategory === 'misc_services'}" aria-controls="panel-misc" data-category="misc_services" class="${currentCategory === 'misc_services' ? 'active' : ''}">Misc Services</button>
                </div>
                <div id="calc-category-content"></div>`;
            container.innerHTML = html;
            renderCategoryContent(currentCategory);
        }

        function renderCategoryContent(category) {
            currentCategory = category;
            const contentContainer = container.querySelector('#calc-category-content');
            if (!contentContainer) return;
            
            contentContainer.innerHTML = ''; 
            
            if (category === 'countertops') {
                contentContainer.id = 'panel-countertops';
                contentContainer.setAttribute('role', 'tabpanel');
                contentContainer.setAttribute('aria-labelledby', 'tab-countertops');
                renderCountertopCalculator(contentContainer);
            } else if (category === 'casework') {
                contentContainer.id = 'panel-casework';
                contentContainer.setAttribute('role', 'tabpanel');
                contentContainer.setAttribute('aria-labelledby', 'tab-casework');
                renderCaseworkCalculator(contentContainer);
            } else if (category === 'misc_services') {
                 contentContainer.id = 'panel-misc';
                 contentContainer.setAttribute('role', 'tabpanel');
                 contentContainer.setAttribute('aria-labelledby', 'tab-misc');
                renderMiscServicesCalculator(contentContainer);
            }
        }
        
        function renderCountertopCalculator(container) {
            const data = DataEngine.getData();
            const allMaterials = data.countertops;
            
            let materialOptionsHTML = Object.keys(allMaterials).map(key => `<option value="${key}">${allMaterials[key].name}</option>`).join('');

            let html = `
                <div class="main-grid">
                    <section aria-labelledby="calculator-title">
                        <div class="card" style="margin-bottom: 0;">
                            <h2 id="calculator-title" class="card__title">Countertop Calculator</h2>
                            <div class="form-group">
                                <label for="calc-material-select" class="form-group__label">1. Select Material</label>
                                <select id="calc-material-select" class="form-group__select">${materialOptionsHTML}</select>
                            </div>
                            <div id="calc-options-container"></div>
                        </div>
                    </section>
                    <aside aria-labelledby="summary-title">
                        <div id="quote-summary" class="card">
                            <h2 id="summary-title" class="card__title">Item Summary</h2>
                            <div id="quote-details" aria-live="polite">
                                <p class="quote-summary__placeholder">Select material and enter dimensions.</p>
                            </div>
                             <div id="quote-chart-container" class="hidden">
                                <canvas id="item-quote-chart" role="img" aria-label="Cost breakdown pie chart"></canvas>
                            </div>
                        </div>
                    </aside>
                </div>`;
             container.innerHTML = html;
             
             renderCountertopOptions(document.getElementById('calc-material-select').value);
        }
        
        function renderCountertopOptions(materialKey) {
            const optionsContainer = document.getElementById('calc-options-container');
            if(!optionsContainer) return;
            const data = DataEngine.getData();
            const materialData = data.countertops[materialKey];
            
            let optionsHTML = materialData.options ? Object.keys(materialData.options).map(optKey => {
                const option = materialData.options[optKey];
                return `<div class="form-group">
                            <label for="calc-option-${optKey}" class="form-group__label">${option.name}</label>
                            <select id="calc-option-${optKey}" data-option-key="${optKey}" class="form-group__select calc-input">
                                ${Object.keys(option.values).map(valKey => `<option value="${valKey}">${option.values[valKey].name}</option>`).join('')}
                            </select>
                        </div>`;
            }).join('') : '';

            let html = `
                <div class="form-grid" style="margin-top: 24px;">
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">2. Dimensions</legend>
                        <div class="form-group">
                            <label for="calc-length" class="form-group__label">Length (in)</label>
                            <input type="number" id="calc-length" class="form-group__input calc-input" placeholder="e.g., 120">
                        </div>
                        <div class="form-group">
                            <label for="calc-width" class="form-group__label">Width (in)</label>
                            <input type="number" id="calc-width" class="form-group__input calc-input" placeholder="e.g., 25.5">
                        </div>
                    </fieldset>

                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">3. Selections</legend>
                        ${optionsHTML}
                        <div class="form-group">
                            <label for="calc-edge" class="form-group__label">Edge Treatment</label>
                            <select id="calc-edge" class="form-group__select calc-input">
                                ${Object.keys(materialData.edges).map(key => `<option value="${key}">${materialData.edges[key].name}</option>`).join('')}
                            </select>
                        </div>
                    </fieldset>

                    <fieldset class="form-fieldset" style="grid-column: span 2;">
                         <legend class="form-fieldset__legend">4. Add-ons</legend>
                         <div class="form-group">
                            ${Object.keys(materialData.cutouts).map(key => `
                                <div class="form-group--checkbox">
                                    <input type="checkbox" id="calc-cutout-${key}" data-key="${key}" class="form-group__checkbox calc-input calc-cutout">
                                    <label for="calc-cutout-${key}" class="form-group__label">${materialData.cutouts[key].name}</label>
                                </div>`).join('')}
                         </div>
                    </fieldset>
                </div>
            `;
            optionsContainer.innerHTML = html;
            calculateQuote();
        }

        function renderCaseworkCalculator(container) {
            const data = DataEngine.getData();
            const allCasework = data.casework || {}; // Ensure it's an object
            let caseworkOptionsHTML = Object.keys(allCasework).map(key => `<option value="${key}">${allCasework[key].name}</option>`).join('');

             let html = `
                <div class="main-grid">
                    <section aria-labelledby="casework-calculator-title">
                        <div class="card" style="margin-bottom: 0;">
                            <h2 id="casework-calculator-title" class="card__title">Casework & Millwork Calculator</h2>
                             <div class="form-group">
                                <label for="calc-casework-select" class="form-group__label">1. Select Item Type</label>
                                <select id="calc-casework-select" class="form-group__select">${caseworkOptionsHTML}</select>
                            </div>
                            <div id="calc-casework-options-container"></div>
                        </div>
                    </section>
                    <aside aria-labelledby="casework-summary-title">
                        <div id="quote-summary" class="card">
                            <h2 id="casework-summary-title" class="card__title">Item Summary</h2>
                            <div id="quote-details" aria-live="polite">
                                <p class="quote-summary__placeholder">Select an item to begin.</p>
                            </div>
                        </div>
                    </aside>
                </div>
             `;
             container.innerHTML = html;
             if (Object.keys(allCasework).length > 0) {
                renderCaseworkOptions(document.getElementById('calc-casework-select').value);
             } else {
                document.getElementById('calc-casework-options-container').innerHTML = '<p class="text-error">No casework data found.</p>';
             }
        }

        function renderCaseworkOptions(caseworkKey) {
            const optionsContainer = document.getElementById('calc-casework-options-container');
            if(!optionsContainer) return;
            const data = DataEngine.getData();
            const caseworkData = data.casework[caseworkKey];
            
            let html = '';

            if (caseworkData.type === 'standard') {
                let optionsHTML = Object.keys(caseworkData.options).map(optKey => {
                    const option = caseworkData.options[optKey];
                    return `<div class="form-group">
                                <label for="calc-casework-option-${optKey}" class="form-group__label">${option.name}</label>
                                <select id="calc-casework-option-${optKey}" data-option-key="${optKey}" class="form-group__select calc-input">
                                    ${Object.keys(option.values).map(valKey => `<option value="${valKey}">${option.values[valKey].name}</option>`).join('')}
                                </select>
                            </div>`;
                }).join('');
                
                html = `
                    <div class="form-grid" style="margin-top: 24px;">
                         <fieldset class="form-fieldset">
                            <legend class="form-fieldset__legend">2. Dimensions</legend>
                            <div class="form-group">
                                <label for="calc-length" class="form-group__label">Length (ft)</label>
                                <input type="number" id="calc-length" class="form-group__input calc-input" placeholder="e.g., 10">
                            </div>
                        </fieldset>
                        <fieldset class="form-fieldset">
                            <legend class="form-fieldset__legend">3. Selections</legend>
                            ${optionsHTML}
                        </fieldset>
                    </div>
                `;
            } else if (caseworkData.type === 'custom_millwork') {
                 let optionsHTML = Object.keys(caseworkData.options).map(optKey => {
                    const option = caseworkData.options[optKey];
                    if (option.type === 'select') {
                        return `<div class="form-group">
                                <label for="calc-casework-option-${optKey}" class="form-group__label">${option.name}</label>
                                <select id="calc-casework-option-${optKey}" data-option-key="${optKey}" class="form-group__select calc-input">
                                    ${Object.keys(option.values).map(valKey => `<option value="${valKey}">${option.values[valKey].name}</option>`).join('')}
                                </select>
                            </div>`;
                    } else if (option.type === 'checkbox') {
                         return `<div class="form-group--checkbox">
                                    <input type="checkbox" id="calc-casework-option-${optKey}" data-option-key="${optKey}" class="form-group__checkbox calc-input">
                                    <label for="calc-casework-option-${optKey}" class="form-group__label">${option.name}</label>
                                 </div>`;
                    }
                    return '';
                }).join('');
                
                html = `
                    <fieldset class="form-fieldset" style="margin-top: 24px;">
                        <legend class="form-fieldset__legend">2. Configure Options</legend>
                        ${optionsHTML}
                    </fieldset>
                `;
            } else if (caseworkData.type === 'custom_sqft') {
                let optionsHTML = Object.keys(caseworkData.options).map(optKey => {
                    const option = caseworkData.options[optKey];
                    return `<div class="form-group">
                                <label for="calc-casework-option-${optKey}" class="form-group__label">${option.name}</label>
                                <select id="calc-casework-option-${optKey}" data-option-key="${optKey}" class="form-group__select calc-input">
                                    ${Object.keys(option.values).map(valKey => `<option value="${valKey}">${option.values[valKey].name}</option>`).join('')}
                                </select>
                            </div>`;
                }).join('');

                html = `
                    <div class="form-grid" style="margin-top: 24px;">
                        <fieldset class="form-fieldset">
                            <legend class="form-fieldset__legend">2. Dimensions</legend>
                            <div class="form-group">
                                <label for="calc-length-ft" class="form-group__label">Panel Width (ft)</label>
                                <input type="number" id="calc-length-ft" class="form-group__input calc-input" placeholder="e.g., 8">
                            </div>
                            <div class="form-group">
                                <label for="calc-height-ft" class="form-group__label">Panel Height (ft)</label>
                                <input type="number" id="calc-height-ft" class="form-group__input calc-input" placeholder="e.g., 4">
                            </div>
                        </fieldset>
                        <fieldset class="form-fieldset">
                            <legend class="form-fieldset__legend">3. Selections</legend>
                            ${optionsHTML}
                        </fieldset>
                    </div>
                `;
            }

            optionsContainer.innerHTML = html;
            calculateQuote();
        }

        function renderMiscServicesCalculator(container) {
            const data = DataEngine.getData();
            const allMiscServices = data.misc_services || {};
            let serviceOptionsHTML = Object.keys(allMiscServices).map(key => `<option value="${key}">${allMiscServices[key].name}</option>`).join('');

             let html = `
                <div class="main-grid">
                    <section aria-labelledby="misc-calculator-title">
                         <div class="card" style="margin-bottom: 0;">
                            <h2 id="misc-calculator-title" class="card__title">Miscellaneous Services Calculator</h2>
                            <div class="form-group">
                                <label for="calc-misc-select" class="form-group__label">1. Select Service</label>
                                <select id="calc-misc-select" class="form-group__select">${serviceOptionsHTML}</select>
                            </div>
                            <div id="calc-misc-options-container"></div>
                        </div>
                    </section>
                    <aside aria-labelledby="misc-summary-title">
                        <div id="quote-summary" class="card">
                            <h2 id="misc-summary-title" class="card__title">Item Summary</h2>
                            <div id="quote-details" aria-live="polite">
                                <p class="quote-summary__placeholder">Select a service to begin.</p>
                            </div>
                        </div>
                    </aside>
                </div>`;
             container.innerHTML = html;
             if (Object.keys(allMiscServices).length > 0) {
                renderMiscServiceOptions(document.getElementById('calc-misc-select').value);
             } else {
                document.getElementById('calc-misc-options-container').innerHTML = '<p class="text-error">No miscellaneous services data found.</p>';
             }
        }

        function renderMiscServiceOptions(serviceKey) {
            const optionsContainer = document.getElementById('calc-misc-options-container');
             if(!optionsContainer) return;
            const data = DataEngine.getData();
            const serviceData = data.misc_services[serviceKey];
            let html = '';

            if (serviceData.type === 'custom_cabinet') {
                html = `
                    <div class="form-grid" style="margin-top: 24px;">
                        <fieldset class="form-fieldset">
                             <legend class="form-fieldset__legend">2. Dimensions (in)</legend>
                             <div class="form-group">
                                <label for="calc-cabinet-width" class="form-group__label">Width</label>
                                <input type="number" id="calc-cabinet-width" class="form-group__input calc-input" placeholder="e.g., 36">
                            </div>
                             <div class="form-group">
                                <label for="calc-cabinet-height" class="form-group__label">Height</label>
                                <input type="number" id="calc-cabinet-height" class="form-group__input calc-input" placeholder="e.g., 34.5">
                            </div>
                             <div class="form-group">
                                <label for="calc-cabinet-depth" class="form-group__label">Depth</label>
                                <input type="number" id="calc-cabinet-depth" class="form-group__input calc-input" placeholder="e.g., 24">
                            </div>
                        </fieldset>
                        <fieldset class="form-fieldset">
                             <legend class="form-fieldset__legend">3. Selections</legend>
                             <div class="form-group">
                                <label for="calc-cabinet-material" class="form-group__label">Material</label>
                                <select id="calc-cabinet-material" class="form-group__select calc-input">
                                    ${Object.keys(serviceData.materials).map(key => `<option value="${key}">${serviceData.materials[key].name}</option>`).join('')}
                                </select>
                             </div>
                             <div class="form-group">
                                <label for="calc-cabinet-finish" class="form-group__label">Finish</label>
                                <select id="calc-cabinet-finish" class="form-group__select calc-input">
                                     ${Object.keys(serviceData.finishes).map(key => `<option value="${key}">${serviceData.finishes[key].name}</option>`).join('')}
                                </select>
                             </div>
                              <div class="form-group">
                                <label for="calc-cabinet-hardware" class="form-group__label">Hardware</label>
                                <select id="calc-cabinet-hardware" class="form-group__select calc-input">
                                     ${Object.keys(serviceData.hardware).map(key => `<option value="${key}">${serviceData.hardware[key].name}</option>`).join('')}
                                </select>
                             </div>
                        </fieldset>
                    </div>
                `;
            } else if (serviceKey === 'design' || serviceKey === 'welding_fab') {
                html = `
                    <div class="form-grid" style="margin-top: 24px;">
                         <fieldset class="form-fieldset"> <legend class="form-fieldset__legend">2. Enter Hours</legend>
                            <div class="form-group">
                                <label for="calc-hours" class="form-group__label">Estimated Hours</label>
                                <input type="number" id="calc-hours" class="form-group__input calc-input" placeholder="e.g., 5">
                            </div>
                        </fieldset>
                    </div>`;
            } else if (serviceKey === 'cnc_machining') {
                html = `
                     <div class="form-grid" style="margin-top: 24px;">
                         <fieldset class="form-fieldset"> <legend class="form-fieldset__legend">2. Enter Details</legend>
                            <div class="form-group">
                                <label for="calc-machine-time" class="form-group__label">Machine Time (Hours)</label>
                                <input type="number" id="calc-machine-time" class="form-group__input calc-input" placeholder="e.g., 2.5">
                            </div>
                             <div class="form-group">
                                <label for="calc-setup-fee" class="form-group__label">Setup Fee</label>
                                <input type="number" id="calc-setup-fee" class="form-group__input calc-input" value="${serviceData.setup_fee}" readonly aria-readonly="true">
                            </div>
                        </fieldset>
                    </div>`;
            }
            optionsContainer.innerHTML = html;
            calculateQuote();
        }

        function calculateQuote() {
            if(!container) return; 

            if (currentCategory === 'countertops') {
                calculateCountertopQuote();
            } else if (currentCategory === 'casework') {
                calculateCaseworkQuote();
            } else if (currentCategory === 'misc_services') {
                calculateMiscServicesQuote();
            }
        }

        function calculateCountertopQuote() {
            const data = DataEngine.getData();
            const materialKey = document.getElementById('calc-material-select')?.value;
            if(!materialKey) return;
            
            const materialData = data.countertops[materialKey];
            const settings = data.settings;

            const length = parseFloat(document.getElementById('calc-length')?.value) || 0;
            const width = parseFloat(document.getElementById('calc-width')?.value) || 0;
            const quoteDetailsContainer = document.getElementById('quote-details');
            const quoteChartContainer = document.getElementById('quote-chart-container');

            if (length === 0 || width === 0) {
                 quoteDetailsContainer.innerHTML = `<p class="quote-summary__placeholder">Enter dimensions to begin.</p><button class="add-to-quote-btn" disabled>Add to Quote</button>`;
                 if (quoteChartContainer) quoteChartContainer.classList.add('hidden');
                 return;
            }

            const squareFeet = (length * width) / 144;
            const linearFeet = (length * 2 + width * 2) / 12;

            let optionMultiplier = 1;
            let optionDetails = [];
            document.querySelectorAll('#calc-options-container select[data-option-key]').forEach(select => {
                const optKey = select.dataset.optionKey;
                const valKey = select.value;
                optionMultiplier *= materialData.options[optKey].values[valKey].multiplier;
                optionDetails.push(materialData.options[optKey].values[valKey].name);
            });
            
            const totalMaterialCost = squareFeet * materialData.cost_sqft * optionMultiplier;
            
            const selectedEdgeKey = document.getElementById('calc-edge').value;
            const edgeName = materialData.edges[selectedEdgeKey].name;
            const edgeCost = linearFeet * materialData.edges[selectedEdgeKey].cost_lnft;

            let cutoutCost = 0;
            let cutoutItems = [];
            document.querySelectorAll('.calc-cutout:checked').forEach(checkbox => {
                const key = checkbox.dataset.key;
                const cost = materialData.cutouts[key].cost;
                cutoutCost += cost;
                cutoutItems.push({ name: materialData.cutouts[key].name, cost: cost });
            });

            const subtotal = totalMaterialCost + edgeCost + cutoutCost;
            const tax = subtotal * settings.taxRate;
            const total = subtotal + tax;

            let summaryHTML = `
                <table class="quote-summary__table">
                    <tbody>
                        <tr><td class="item-name">${materialData.name}</td><td class="item-cost">${UIController.formatCurrency(totalMaterialCost)}</td></tr>
                        <tr><td class="item-name">Edge: ${edgeName}</td><td class="item-cost">${UIController.formatCurrency(edgeCost)}</td></tr>
                        ${cutoutItems.map(item => `<tr><td class="item-name">${item.name}</td><td class="item-cost">${UIController.formatCurrency(item.cost)}</td></tr>`).join('')}
                        <tr class="subtotal-row"><td>Subtotal</td><td class="item-cost">${UIController.formatCurrency(subtotal)}</td></tr>
                        <tr><td class="item-name">Tax (${(settings.taxRate * 100).toFixed(2)}%)</td><td class="item-cost">${UIController.formatCurrency(tax)}</td></tr>
                        <tr class="total-row"><td>Total</td><td class="item-cost">${UIController.formatCurrency(total)}</td></tr>
                    </tbody>
                </table>
                <button id="add-to-quote" class="add-to-quote-btn">Add to Quote</button>`;

            quoteDetailsContainer.innerHTML = summaryHTML;
            renderItemQuoteChart([totalMaterialCost, edgeCost, cutoutCost, tax]);
            if (quoteChartContainer) quoteChartContainer.classList.remove('hidden');
        }

        function calculateCaseworkQuote() {
            const data = DataEngine.getData();
            const caseworkKey = document.getElementById('calc-casework-select')?.value;
            if(!caseworkKey) return;
            
            const caseworkData = data.casework[caseworkKey];
            const settings = data.settings;
            const quoteDetailsContainer = document.getElementById('quote-details');
            let totalCost = 0;
            let lineItems = [];
            let itemDescription = [];
            
            if(caseworkData.type === 'standard') {
                const linearFeet = parseFloat(document.getElementById('calc-length')?.value) || 0;
                 if (linearFeet === 0) {
                    quoteDetailsContainer.innerHTML = `<p class="quote-summary__placeholder">Enter length to begin.</p><button class="add-to-quote-btn" disabled>Add to Quote</button>`;
                    return;
                }
                itemDescription.push(`${linearFeet} ln ft`);

                let optionMultiplier = 1;
                document.querySelectorAll('#calc-casework-options-container select[data-option-key]').forEach(select => {
                    const optKey = select.dataset.optionKey;
                    const valKey = select.value;
                    if (caseworkData.options && caseworkData.options[optKey] && caseworkData.options[optKey].values && caseworkData.options[optKey].values[valKey]) {
                        const multiplier = caseworkData.options[optKey].values[valKey].multiplier;
                        optionMultiplier *= multiplier;
                        itemDescription.push(caseworkData.options[optKey].values[valKey].name);
                    }
                });
                totalCost = (linearFeet * caseworkData.cost_lnft) * optionMultiplier;
                lineItems.push({ name: caseworkData.name, cost: totalCost });
            
            } else if (caseworkData.type === 'custom_millwork') {
                let baseCost = caseworkData.base_cost;
                let finalCost = baseCost;
                lineItems.push({ name: `${caseworkData.name} Base Unit`, cost: baseCost });

                document.querySelectorAll('#calc-casework-options-container .calc-input').forEach(input => {
                    const optKey = input.dataset.optionKey;
                    if (caseworkData.options && caseworkData.options[optKey]) {
                        const option = caseworkData.options[optKey];
                        if (input.type === 'select-one' && option.values) {
                            const valKey = input.value;
                            const selectedOptionValue = option.values[valKey];
                            if (selectedOptionValue) {
                                itemDescription.push(selectedOptionValue.name);
                                const multiplier = selectedOptionValue.multiplier;
                                if (multiplier && multiplier !== 1) {
                                    finalCost *= multiplier;
                                }
                            }
                        } else if (input.type === 'checkbox' && input.checked) {
                            finalCost += option.cost || 0;
                            lineItems.push({ name: option.name, cost: option.cost || 0 });
                            itemDescription.push(option.name);
                        }
                    }
                });
                
                lineItems[0].cost = finalCost - lineItems.slice(1).reduce((sum, item) => sum + item.cost, 0);
                totalCost = finalCost;
            
            } else if (caseworkData.type === 'custom_sqft') {
                const length = parseFloat(document.getElementById('calc-length-ft')?.value) || 0;
                const height = parseFloat(document.getElementById('calc-height-ft')?.value) || 0;
                if (length === 0 || height === 0) {
                    quoteDetailsContainer.innerHTML = `<p class="quote-summary__placeholder">Enter width and height.</p><button class="add-to-quote-btn" disabled>Add to Quote</button>`;
                    return;
                }
                const sqft = length * height;
                itemDescription.push(`${sqft.toFixed(2)} sq ft`);
                let optionMultiplier = 1;
                 document.querySelectorAll('#calc-casework-options-container select[data-option-key]').forEach(select => {
                    const optKey = select.dataset.optionKey;
                    const valKey = select.value;
                    if (caseworkData.options && caseworkData.options[optKey] && caseworkData.options[optKey].values && caseworkData.options[optKey].values[valKey]) {
                        const multiplier = caseworkData.options[optKey].values[valKey].multiplier;
                        optionMultiplier *= multiplier;
                        itemDescription.push(caseworkData.options[optKey].values[valKey].name);
                    }
                });
                totalCost = sqft * caseworkData.cost_sqft * optionMultiplier;
                lineItems.push({name: caseworkData.name, cost: totalCost});
            }

            const subtotal = totalCost;
            const tax = subtotal * settings.taxRate;
            const total = subtotal + tax;

             let summaryHTML = `
                <table class="quote-summary__table">
                    <tbody>
                        ${lineItems.map(item => `<tr><td class="item-name">${item.name}</td><td class="item-cost">${UIController.formatCurrency(item.cost)}</td></tr>`).join('')}
                        <tr class="subtotal-row"><td>Subtotal</td><td class="item-cost">${UIController.formatCurrency(subtotal)}</td></tr>
                        <tr><td class="item-name">Tax (${(settings.taxRate * 100).toFixed(2)}%)</td><td class="item-cost">${UIController.formatCurrency(tax)}</td></tr>
                        <tr class="total-row"><td>Total</td><td class="item-cost">${UIController.formatCurrency(total)}</td></tr>
                    </tbody>
                </table>
                <button id="add-to-quote" class="add-to-quote-btn">Add to Quote</button>`;
            quoteDetailsContainer.innerHTML = summaryHTML;
        }

        function calculateMiscServicesQuote() {
            const data = DataEngine.getData();
            const serviceKey = document.getElementById('calc-misc-select')?.value;
            if(!serviceKey) return;

            const serviceData = data.misc_services[serviceKey];
            const settings = data.settings;
            const quoteDetailsContainer = document.getElementById('quote-details');
            let subtotal = 0;
            let lineItems = [];
            let itemDescription = [];

            if (serviceData.type === 'custom_cabinet') {
                const width = parseFloat(document.getElementById('calc-cabinet-width')?.value) || 0;
                const height = parseFloat(document.getElementById('calc-cabinet-height')?.value) || 0;
                const depth = parseFloat(document.getElementById('calc-cabinet-depth')?.value) || 0;

                if (width === 0 || height === 0 || depth === 0) {
                    quoteDetailsContainer.innerHTML = `<p class="quote-summary__placeholder">Enter all dimensions.</p><button class="add-to-quote-btn" disabled>Add to Quote</button>`;
                    return;
                }
                const cubicFeet = (width * height * depth) / 1728;
                const surfaceArea = 2 * (width * height + width * depth + height * depth) / 144;

                const materialKey = document.getElementById('calc-cabinet-material').value;
                const finishKey = document.getElementById('calc-cabinet-finish').value;
                const hardwareKey = document.getElementById('calc-cabinet-hardware').value;
                
                const materialCost = surfaceArea * serviceData.materials[materialKey].cost_sqft;
                const laborCost = cubicFeet * serviceData.cost_cubic_ft;
                const finishCost = serviceData.finishes[finishKey].cost;
                const hardwareCost = serviceData.hardware[hardwareKey].cost;
                
                subtotal = laborCost + materialCost + finishCost + hardwareCost;
                lineItems.push({name: 'Labor Cost', cost: laborCost});
                lineItems.push({name: 'Material Cost', cost: materialCost});
                lineItems.push({name: 'Finish Cost', cost: finishCost});
                lineItems.push({name: 'Hardware Cost', cost: hardwareCost});

                itemDescription.push(`${width}"x${height}"x${depth}"`);
                itemDescription.push(serviceData.materials[materialKey].name);
                itemDescription.push(serviceData.finishes[finishKey].name);
                itemDescription.push(serviceData.hardware[hardwareKey].name);

            } else if (serviceKey === 'design' || serviceKey === 'welding_fab') {
                const hours = parseFloat(document.getElementById('calc-hours')?.value) || 0;
                if (hours > 0) {
                    subtotal = hours * serviceData.rate_hourly;
                    lineItems.push({name: serviceData.name, cost: subtotal});
                    itemDescription.push(`${hours} hrs`);
                }
            } else if (serviceKey === 'cnc_machining') {
                const machineTime = parseFloat(document.getElementById('calc-machine-time')?.value) || 0;
                const setupFee = serviceData.setup_fee;
                const machineCost = machineTime * serviceData.rate_hourly;
                subtotal = machineCost + setupFee;
                if (setupFee > 0) lineItems.push({name: `Setup Fee`, cost: setupFee});
                if (machineTime > 0) {
                    lineItems.push({name: `Machine Time`, cost: machineCost});
                    itemDescription.push(`${machineTime} hrs`);
                }
            }
            
            if (subtotal === 0) {
                quoteDetailsContainer.innerHTML = `<p class="quote-summary__placeholder">Enter details to generate a quote.</p><button class="add-to-quote-btn" disabled>Add to Quote</button>`;
                return;
            }

            const tax = subtotal * settings.taxRate;
            const total = subtotal + tax;
            
            let summaryHTML = `<table class="quote-summary__table"><tbody>
                        ${lineItems.map(item => `<tr><td class="item-name">${item.name}</td><td class="item-cost">${UIController.formatCurrency(item.cost)}</td></tr>`).join('')}
                        <tr class="subtotal-row"><td>Subtotal</td><td class="item-cost">${UIController.formatCurrency(subtotal)}</td></tr>
                        <tr><td class="item-name">Tax (${(settings.taxRate * 100).toFixed(2)}%)</td><td class="item-cost">${UIController.formatCurrency(tax)}</td></tr>
                        <tr class="total-row"><td>Total</td><td class="item-cost">${UIController.formatCurrency(total)}</td></tr>
                    </tbody></table>
                    <button id="add-to-quote" class="add-to-quote-btn">Add to Quote</button>`;
            quoteDetailsContainer.innerHTML = summaryHTML;
        }
        
        function renderItemQuoteChart(costData) {
            const ctx = document.getElementById('item-quote-chart')?.getContext('2d');
            if (!ctx) return;
            
            if (itemQuoteChart) {
                itemQuoteChart.destroy();
            }

            itemQuoteChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Base/Material', 'Options/Addons', 'Tax'],
                    datasets: [{
                        label: 'Cost Breakdown',
                        data: costData.reduce((acc, c, i) => {
                            if (i === 0) acc.push(c);
                            else if (i < costData.length -1) acc[1] = (acc[1] || 0) + c;
                            else acc.push(c);
                            return acc;
                        }, []),
                        backgroundColor: [
                            'rgba(79, 70, 229, 0.7)',
                            'rgba(30, 64, 175, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                        ],
                        borderColor: [
                            'rgba(79, 70, 229, 1)',
                            'rgba(30, 64, 175, 1)',
                            'rgba(255, 99, 132, 1)',
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Item Cost Breakdown'
                        }
                    }
                },
            });

        }

        function attachListeners() {
            if(!container) return;
            
            container.addEventListener('click', function(e) {
                const tabButton = e.target.closest('button[data-category]');
                if (tabButton && container.querySelector('#calc-category-tabs')?.contains(tabButton)) {
                    const category = tabButton.dataset.category;
                    if (category !== currentCategory) {
                        currentCategory = category;
                        render();
                    }
                }
                if (e.target.id === 'add-to-quote') {
                    App.addItemToFullQuote();
                }
            });

            container.addEventListener('input', calculateQuote);
            container.addEventListener('change', (e) => {
                if(e.target.matches('#calc-material-select')) {
                    renderCountertopOptions(e.target.value);
                } else if (e.target.matches('#calc-casework-select')) {
                    renderCaseworkOptions(e.target.value);
                } else if (e.target.matches('#calc-misc-select')) {
                    renderMiscServiceOptions(e.target.value);
                } else {
                    calculateQuote();
                }
            });
        }
        
        return { init, render };
    })();

    /**
     * @module AdminPanel
     * @description Handles rendering and logic for the admin panel.
     * @dependencies DataEngine, UIController, Calculator
     */
    const AdminPanel = (function() {
        let container = null;
        let currentCategory = 'settings';

        function init() {
            container = document.getElementById('admin-panel');
            if (container) {
                attachListeners();
            }
        }

        function render() {
            if(!container) container = document.getElementById('admin-panel');
            if(!container) return;
            
            let html = `
                <div id="admin-category-tabs" role="tablist" aria-label="Admin Sections" class="view-switcher" style="justify-content: flex-start; margin-top: 0; margin-bottom: 24px; border-bottom: 1px solid var(--color-border); padding-bottom: 16px;">
                    <button id="admin-tab-settings" role="tab" aria-selected="${currentCategory === 'settings'}" data-category="settings" class="${currentCategory === 'settings' ? 'active' : ''}">Settings & Data</button>
                    <button id="admin-tab-countertops" role="tab" aria-selected="${currentCategory === 'countertops'}" data-category="countertops" class="${currentCategory === 'countertops' ? 'active' : ''}">Countertops</button>
                    <button id="admin-tab-casework" role="tab" aria-selected="${currentCategory === 'casework'}" data-category="casework" class="${currentCategory === 'casework' ? 'active' : ''}">Casework</button>
                    <button id="admin-tab-misc" role="tab" aria-selected="${currentCategory === 'misc_services'}" data-category="misc_services" class="${currentCategory === 'misc_services' ? 'active' : ''}">Misc Services</button>
                    <button id="admin-tab-help" role="tab" aria-selected="${currentCategory === 'help'}" data-category="help" class="${currentCategory === 'help' ? 'active' : ''}">Help</button>
                </div>
                <div id="admin-category-content" role="region" aria-live="polite"></div>`;
            container.innerHTML = html;
            renderCategoryContent(currentCategory);
        }
        
        function renderCategoryContent(category) {
            currentCategory = category;
            const contentContainer = container.querySelector('#admin-category-content');
            if(!contentContainer) return;

            contentContainer.innerHTML = '';
            contentContainer.id = `admin-panel-${category}`;
            contentContainer.setAttribute('aria-labelledby', `admin-tab-${category}`);
            
            if(category === 'settings') {
                renderSettingsAdmin(contentContainer);
            } else if(category === 'countertops') {
                renderCountertopAdmin(contentContainer);
            } else if (category === 'casework') {
                 renderCaseworkAdmin(contentContainer);
            } else if (category === 'misc_services') {
                renderMiscServicesAdmin(contentContainer);
            } else if (category === 'help') {
                renderHelpAdmin(contentContainer);
            }
        }

        function renderSettingsAdmin(contentContainer) {
            const settings = DataEngine.getData().settings;

            let html = `
                <h2 class="card__title">Global Settings & Data Management</h2>
                <div class="form-grid">
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Business Info</legend>
                        <div class="admin-group">
                            <label for="admin-company-name" class="admin-group__label">Company Name</label>
                            <input type="text" id="admin-company-name" class="form-group__input" value="${settings.companyName}">
                        </div>
                         <div class="admin-group">
                            <label for="admin-tax-rate" class="admin-group__label">Tax Rate (%)</label>
                            <input type="number" id="admin-tax-rate" class="form-group__input" step="0.0001" value="${settings.taxRate * 100}">
                        </div>
                    </fieldset>
                </div>

                <h3 class="admin-section-title" style="margin-top: 40px;">Data Management</h3>
                <p style="color: var(--color-text-muted); font-size: 0.9rem; max-width: 80ch; margin-bottom: 16px;">
                    Use JSON to backup and restore the entire application's configuration. Use CSV to export a specific data category (like Countertops) for bulk editing in a spreadsheet program like Excel or Google Sheets.
                </p>
                <div class="data-management-grid">
                    <div class="data-management-card">
                        <h4>Full Backup (JSON)</h4>
                        <p>Save or load the entire application config.</p>
                        <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                            <button id="export-json-btn" class="admin-button">Export JSON</button>
                            <label for="import-json-file" class="admin-button secondary">Import JSON</label>
                            <input type="file" id="import-json-file" class="hidden" accept=".json">
                        </div>
                    </div>
                    <div class="data-management-card">
                        <h4>Countertops (CSV)</h4>
                        <p>Export/Import countertop pricing for spreadsheet editing.</p>
                        <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                            <button id="export-countertops-csv-btn" class="admin-button">Export CSV</button>
                            <label for="import-countertops-csv-file" class="admin-button secondary">Import CSV</label>
                            <input type="file" id="import-countertops-csv-file" class="hidden" accept=".csv">
                        </div>
                    </div>
                    <div class="data-management-card">
                        <h4>Casework (CSV)</h4>
                        <p>Export/Import casework pricing for spreadsheet editing.</p>
                        <div style="display:flex; gap: 8px; flex-wrap: wrap;">
                            <button id="export-casework-csv-btn" class="admin-button">Export CSV</button>
                            <label for="import-casework-csv-file" class="admin-button secondary">Import CSV</label>
                            <input type="file" id="import-casework-csv-file" class="hidden" accept=".csv">
                        </div>
                    </div>
                </div>

                <div class="admin-actions">
                    <span id="save-confirmation" class="hidden" aria-live="polite"></span>
                    <button class="save-button" data-save-type="settings">Save Settings</button>
                </div>
            `;
            contentContainer.innerHTML = html;
        }
        
        function renderCountertopAdmin(contentContainer) {
            const data = DataEngine.getData();
            const allMaterials = data.countertops;
            
            let materialOptionsHTML = Object.keys(allMaterials).map(key => `<option value="${key}">${allMaterials[key].name}</option>`).join('');

            let html = `
                <h2 class="card__title">Edit Countertop Pricing</h2>
                <div class="form-group">
                    <label for="admin-material-select" class="form-group__label">Select a Material to Edit</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="admin-material-select" class="form-group__select" style="flex-grow: 1;">${materialOptionsHTML}</select>
                        <button id="add-new-material-btn" class="admin-button secondary">Add New</button>
                        <button id="delete-material-btn" class="admin-button danger">Delete</button>
                    </div>
                </div>
                <div id="admin-material-form-container" class="mt-4"></div>
            `;
            contentContainer.innerHTML = html;
            
            renderCountertopAdminForm(contentContainer.querySelector('#admin-material-select').value);
        }

        function renderCountertopAdminForm(materialKey) {
            const formContainer = container.querySelector('#admin-material-form-container');
            if(!formContainer) return;

            const materialData = DataEngine.getData().countertops[materialKey];
            if(!materialData) {
                formContainer.innerHTML = '<p class="text-error">Could not load material data.</p>';
                return;
            }

            let optionsHTML = materialData.options ? Object.keys(materialData.options).map(optKey => {
                const option = materialData.options[optKey];
                return `
                    <h3 class="admin-section-title">${option.name} Multipliers</h3>
                    ${Object.keys(option.values).map(valKey => `
                        <div class="admin-group">
                             <label for="admin-ct-option-${optKey}-${valKey}" class="admin-group__label">${option.values[valKey].name}</label>
                             <input type="number" id="admin-ct-option-${optKey}-${valKey}" data-type="option" data-option-key="${optKey}" data-value-key="${valKey}" class="form-group__input" step="0.01" value="${option.values[valKey].multiplier}">
                        </div>`).join('')}
                `;
            }).join('') : '';

            let edgesHTML = materialData.edges ? Object.keys(materialData.edges).map(edgeKey => `
                <div class="admin-group">
                    <label for="admin-edge-${edgeKey}" class="admin-group__label">${materialData.edges[edgeKey].name}</label>
                    <input type="number" id="admin-edge-${edgeKey}" data-type="edge" data-key="${edgeKey}" class="form-group__input" step="0.01" value="${materialData.edges[edgeKey].cost_lnft}">
                </div>`).join('') : '';

            let cutoutsHTML = materialData.cutouts ? Object.keys(materialData.cutouts).map(cutoutKey => `
               <div class="admin-group">
                   <label for="admin-cutout-${cutoutKey}" class="admin-group__label">${materialData.cutouts[cutoutKey].name}</label>
                   <input type="number" id="admin-cutout-${cutoutKey}" data-type="cutout" data-key="${cutoutKey}" class="form-group__input" step="0.01" value="${materialData.cutouts[cutoutKey].cost}">
               </div>`).join('') : '';

            let html = `
                <div class="form-grid">
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Base Costs</legend>
                        <div class="admin-group">
                            <label for="admin-cost-sqft" class="admin-group__label">Cost per Sq. Ft.</label>
                            <input type="number" id="admin-cost-sqft" class="form-group__input" step="0.01" value="${materialData.cost_sqft}">
                        </div>
                    </fieldset>
                     <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Option Multipliers</legend>
                        <div id="admin-ct-options-wrapper">${optionsHTML}</div>
                    </fieldset>
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Edge Costs (per Ln. Ft.)</legend>
                        <div id="admin-edges-wrapper">${edgesHTML}</div>
                    </fieldset>
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Cutout Costs</legend>
                        <div id="admin-cutouts-wrapper">${cutoutsHTML}</div>
                    </fieldset>
                </div>
                <div class="admin-actions">
                    <span id="save-confirmation" class="hidden" aria-live="polite"></span>
                    <button class="save-button" data-save-type="countertop" data-material-key="${materialKey}">Save Changes</button>
                </div>`;
            formContainer.innerHTML = html;
        }

        function renderCaseworkAdmin(contentContainer) {
            const data = DataEngine.getData();
            const allCasework = data.casework;
            
            let caseworkOptionsHTML = Object.keys(allCasework).map(key => `<option value="${key}">${allCasework[key].name}</option>`).join('');

            let html = `
                <h2 class="card__title">Edit Casework Pricing</h2>
                <div class="form-group">
                    <label for="admin-casework-select" class="form-group__label">Select a Casework Type to Edit</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="admin-casework-select" class="form-group__select" style="flex-grow: 1;">${caseworkOptionsHTML}</select>
                        <button id="add-new-casework-btn" class="admin-button secondary">Add New</button>
                        <button id="delete-casework-btn" class="admin-button danger">Delete</button>
                    </div>
                </div>
                <div id="admin-casework-form-container" class="mt-4"></div>
            `;
            contentContainer.innerHTML = html;
            renderCaseworkAdminForm(contentContainer.querySelector('#admin-casework-select').value);
        }

        function renderCaseworkAdminForm(caseworkKey) {
            const formContainer = container.querySelector('#admin-casework-form-container');
            if(!formContainer) return;

            const caseworkData = DataEngine.getData().casework[caseworkKey];
            if (!caseworkData) {
                formContainer.innerHTML = '<p class="text-error">Could not load casework data.</p>';
                return;
            }

            let html = '';

            if (caseworkData.type === 'standard') {
                let optionsHTML = Object.keys(caseworkData.options).map(optKey => {
                    const option = caseworkData.options[optKey];
                    return `
                        <h3 class="admin-section-title">${option.name} Multipliers</h3>
                        ${Object.keys(option.values).map(valKey => `
                            <div class="admin-group">
                                 <label for="admin-cw-option-${optKey}-${valKey}" class="admin-group__label">${option.values[valKey].name}</label>
                                 <input type="number" id="admin-cw-option-${optKey}-${valKey}" data-type="option" data-option-key="${optKey}" data-value-key="${valKey}" class="form-group__input" step="0.01" value="${option.values[valKey].multiplier}">
                            </div>`).join('')}
                    `;
                }).join('');

                html = `
                    <div class="form-grid">
                        <fieldset class="form-fieldset">
                            <legend class="form-fieldset__legend">Base Costs</legend>
                            <div class="admin-group">
                                <label for="admin-cost-lnft" class="admin-group__label">Cost per Ln. Ft.</label>
                                <input type="number" id="admin-cost-lnft" class="form-group__input" step="0.01" value="${caseworkData.cost_lnft}">
                            </div>
                        </fieldset>
                         <fieldset class="form-fieldset">
                            <legend class="form-fieldset__legend">Option Multipliers</legend>
                            <div id="admin-cw-options-wrapper">${optionsHTML}</div>
                        </fieldset>
                    </div>`;

            } else if (caseworkData.type === 'custom_millwork') {
                 let optionsHTML = Object.keys(caseworkData.options).map(optKey => {
                    const option = caseworkData.options[optKey];
                    if (option.type === 'select') {
                        return `<h3 class="admin-section-title">${option.name} Multipliers</h3>
                                ${Object.keys(option.values).map(valKey => `
                                <div class="admin-group">
                                    <label for="admin-cw-option-${optKey}-${valKey}" class="admin-group__label">${option.values[valKey].name}</label>
                                    <input type="number" id="admin-cw-option-${optKey}-${valKey}" data-type="option-select" data-option-key="${optKey}" data-value-key="${valKey}" class="form-group__input" step="0.01" value="${option.values[valKey].multiplier}">
                                </div>`).join('')}`;
                    } else if (option.type === 'checkbox') {
                         return `<div class="admin-group">
                                    <label for="admin-cw-option-${optKey}" class="admin-group__label">${option.name}</label>
                                    <input type="number" id="admin-cw-option-${optKey}" data-type="option-checkbox" data-option-key="${optKey}" class="form-group__input" step="0.01" value="${option.cost}">
                                 </div>`;
                    }
                    return '';
                }).join('');
                
                html = `
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Base & Option Costs</legend>
                        <div class="admin-group">
                            <label for="admin-base-cost" class="admin-group__label">Base Unit Cost</label>
                            <input type="number" id="admin-base-cost" class="form-group__input" step="0.01" value="${caseworkData.base_cost}">
                        </div>
                        ${optionsHTML}
                    </fieldset>
                `;
            } else if (caseworkData.type === 'custom_sqft') {
                let optionsHTML = Object.keys(caseworkData.options).map(optKey => {
                    const option = caseworkData.options[optKey];
                    return `
                        <h3 class="admin-section-title">${option.name} Multipliers</h3>
                        ${Object.keys(option.values).map(valKey => `
                            <div class="admin-group">
                                 <label for="admin-cw-option-${optKey}-${valKey}" class="admin-group__label">${option.values[valKey].name}</label>
                                 <input type="number" id="admin-cw-option-${optKey}-${valKey}" data-type="option" data-option-key="${optKey}" data-value-key="${valKey}" class="form-group__input" step="0.01" value="${option.values[valKey].multiplier}">
                            </div>`).join('')}
                    `;
                }).join('');

                html = `
                     <div class="form-grid">
                        <fieldset class="form-fieldset">
                            <legend class="form-fieldset__legend">Base Costs</legend>
                            <div class="admin-group">
                                <label for="admin-cost-sqft" class="admin-group__label">Cost per Sq. Ft.</label>
                                <input type="number" id="admin-cost-sqft" class="form-group__input" step="0.01" value="${caseworkData.cost_sqft}">
                            </div>
                        </fieldset>
                         <fieldset class="form-fieldset">
                            <legend class="form-fieldset__legend">Option Multipliers</legend>
                            <div id="admin-cw-options-wrapper">${optionsHTML}</div>
                        </fieldset>
                    </div>`;
            }


            formContainer.innerHTML = html + `
                <div class="admin-actions">
                    <span id="save-confirmation" class="hidden" aria-live="polite"></span>
                    <button class="save-button" data-save-type="casework" data-casework-key="${caseworkKey}">Save Changes</button>
                </div>
            `;
        }

        function renderMiscServicesAdmin(contentContainer) {
            const miscServices = DataEngine.getData().misc_services;
            
            let servicesHTML = Object.keys(miscServices).map(key => {
                const service = miscServices[key];
                if (service.type === 'custom_cabinet') {
                    return `
                        <h3 class="admin-section-title">${service.name}</h3>
                        <div class="admin-group">
                            <label for="admin-misc-${key}-cost_cubic_ft" class="admin-group__label">Cost per Cubic Ft</label>
                            <input type="number" id="admin-misc-${key}-cost_cubic_ft" data-service-key="${key}" data-property="cost_cubic_ft" class="form-group__input" step="0.01" value="${service.cost_cubic_ft}">
                        </div>
                        <h4 class="admin-section-title" style="font-size: 1rem; margin-top: 1rem;">Materials (Cost/SqFt)</h4>
                        ${Object.keys(service.materials).map(mKey => `
                            <div class="admin-group">
                                <label for="admin-misc-${key}-mat-${mKey}" class="admin-group__label">${service.materials[mKey].name}</label>
                                <input type="number" id="admin-misc-${key}-mat-${mKey}" data-service-key="${key}" data-property="materials.${mKey}.cost_sqft" class="form-group__input" step="0.01" value="${service.materials[mKey].cost_sqft}">
                            </div>`).join('')}
                        <h4 class="admin-section-title" style="font-size: 1rem; margin-top: 1rem;">Finishes (Fixed Cost)</h4>
                         ${Object.keys(service.finishes).map(fKey => `
                            <div class="admin-group">
                                <label for="admin-misc-${key}-fin-${fKey}" class="admin-group__label">${service.finishes[fKey].name}</label>
                                <input type="number" id="admin-misc-${key}-fin-${fKey}" data-service-key="${key}" data-property="finishes.${fKey}.cost" class="form-group__input" step="0.01" value="${service.finishes[fKey].cost}">
                            </div>`).join('')}
                        <h4 class="admin-section-title" style="font-size: 1rem; margin-top: 1rem;">Hardware (Fixed Cost)</h4>
                         ${Object.keys(service.hardware).map(hKey => `
                            <div class="admin-group">
                                <label for="admin-misc-${key}-hdwr-${hKey}" class="admin-group__label">${service.hardware[hKey].name}</label>
                                <input type="number" id="admin-misc-${key}-hdwr-${hKey}" data-service-key="${key}" data-property="hardware.${hKey}.cost" class="form-group__input" step="0.01" value="${service.hardware[hKey].cost}">
                            </div>`).join('')}
                    `;
                }
                return `
                    <h3 class="admin-section-title">${service.name}</h3>
                    ${Object.keys(service).filter(prop => prop !== 'name').map(prop => `
                        <div class="admin-group">
                            <label for="admin-misc-${key}-${prop}" class="admin-group__label">${prop.replace(/_/g, ' ')}</label>
                            <input type="number" id="admin-misc-${key}-${prop}" data-service-key="${key}" data-property="${prop}" class="form-group__input" step="0.01" value="${service[prop]}">
                        </div>
                    `).join('')}
                `;
            }).join('');
            
            let html = `
                <h2 class="card__title">Edit Miscellaneous Services Pricing</h2>
                <div id="admin-misc-form-container">
                    ${servicesHTML}
                </div>
                <div class="admin-actions">
                    <span id="save-confirmation" class="hidden" aria-live="polite"></span>
                    <button class="save-button" data-save-type="misc">Save Changes</button>
                </div>
            `;
            contentContainer.innerHTML = html;
        }

        function renderHelpAdmin(contentContainer) {
             let html = `
                <h2 class="card__title">Help & Documentation</h2>
                <div id="admin-help-content">
                    <h3 class="admin-section-title">Using the Calculator</h3>
                    <p>The main calculator interface is divided into tabs for each major service category: Countertops, Casework, and Misc Services. Select the appropriate tab and fill in the fields to generate a real-time quote. The quote summary on the right will update automatically as you make changes.</p>
                    
                    <h3 class="admin-section-title">Managing Prices in the Admin Panel</h3>
                    <p>This admin panel gives you full control over the pricing logic.</p>
                    <ul>
                        <li><strong>Editing Prices:</strong> Navigate to the appropriate tab (e.g., "Countertops"). Select the item you wish to edit from the dropdown, change the values in the form fields, and click "Save Changes". The new prices will be active immediately.</li>
                        <li><strong>Adding New Items:</strong> Use the "Add New" button next to the dropdown in the "Countertops" or "Casework" sections to add a new material or type. You will be prompted for a name, and a new item will be created by copying the properties of an existing item.</li>
                        <li><strong>Deleting Items:</strong> Select an item from the dropdown and click the "Delete" button. You will be asked to confirm this action.</li>
                        <li><strong>Global Settings:</strong> In the "Settings & Data" tab, you can change the company name displayed on the header and the global tax rate applied to all quotes.</li>
                    </ul>

                    <h3 class="admin-section-title">Importing & Exporting Data</h3>
                    <p>You can back up and restore your entire pricing configuration using JSON files. This is useful for saving different pricing models or for recovery.</p>
                    <ul>
                        <li><strong>Export:</strong> Click the "Export All (JSON)" button in the "Settings & Data" tab. A file named <code>hutchison_calculator_backup.json</code> will be downloaded. Keep this file in a safe place.</li>
                        <li><strong>Import:</strong> Click the "Import from JSON" button and select a valid backup file. Your current data will be overwritten with the data from the file. The application will validate the file to prevent corruption.</li>
                    </ul>
                </div>
            `;
            contentContainer.innerHTML = html;
        }

        function saveChanges(button) {
            const saveType = button.dataset.saveType;
            const data = DataEngine.getData();
            let confirmationMessage = "Changes saved!";

            if (saveType === 'settings') {
                data.settings.companyName = container.querySelector('#admin-company-name').value;
                data.settings.taxRate = parseFloat(container.querySelector('#admin-tax-rate').value) / 100;
                confirmationMessage = "Settings saved!";
            } else if (saveType === 'countertop') {
                const materialKey = button.dataset.materialKey;
                const materialData = data.countertops[materialKey];
                materialData.cost_sqft = parseFloat(container.querySelector('#admin-cost-sqft').value);
                container.querySelectorAll('#admin-ct-options-wrapper input').forEach(input => {
                    materialData.options[input.dataset.optionKey].values[input.dataset.valueKey].multiplier = parseFloat(input.value);
                });
                container.querySelectorAll('#admin-edges-wrapper input').forEach(input => {
                    materialData.edges[input.dataset.key].cost_lnft = parseFloat(input.value);
                });
                container.querySelectorAll('#admin-cutouts-wrapper input').forEach(input => {
                    materialData.cutouts[input.dataset.key].cost = parseFloat(input.value);
                });
            } else if (saveType === 'casework') {
                const caseworkKey = button.dataset.caseworkKey;
                const caseworkData = data.casework[caseworkKey];
                if (caseworkData.type === 'standard') {
                    caseworkData.cost_lnft = parseFloat(container.querySelector('#admin-cost-lnft').value);
                     container.querySelectorAll('#admin-cw-options-wrapper input[data-type="option"]').forEach(input => {
                        caseworkData.options[input.dataset.optionKey].values[input.dataset.valueKey].multiplier = parseFloat(input.value);
                    });
                } else if (caseworkData.type === 'custom_millwork') {
                    caseworkData.base_cost = parseFloat(container.querySelector('#admin-base-cost').value);
                     container.querySelectorAll('input[data-type^="option-"]').forEach(input => {
                        const optKey = input.dataset.optionKey;
                        if(input.dataset.type === 'option-select') {
                            const valKey = input.dataset.valueKey;
                            caseworkData.options[optKey].values[valKey].multiplier = parseFloat(input.value);
                        } else if (input.dataset.type === 'option-checkbox') {
                            caseworkData.options[optKey].cost = parseFloat(input.value);
                        }
                    });
                } else if (caseworkData.type === 'custom_sqft') {
                    caseworkData.cost_sqft = parseFloat(container.querySelector('#admin-cost-sqft').value);
                     container.querySelectorAll('#admin-cw-options-wrapper input[data-type="option"]').forEach(input => {
                        caseworkData.options[input.dataset.optionKey].values[input.dataset.valueKey].multiplier = parseFloat(input.value);
                    });
                }
            } else if (saveType === 'misc') {
                container.querySelectorAll('#admin-misc-form-container input').forEach(input => {
                    const serviceKey = input.dataset.serviceKey;
                    const propPath = input.dataset.property.split('.');
                    
                    let target = data.misc_services[serviceKey];
                    for (let i = 0; i < propPath.length - 1; i++) {
                        target = target[propPath[i]];
                    }
                    target[propPath[propPath.length - 1]] = parseFloat(input.value);
                });
            }

            DataEngine.saveData(data);
            
            const confirmation = container.querySelector('#save-confirmation');
            if(confirmation) {
                confirmation.textContent = confirmationMessage;
                confirmation.classList.remove('hidden');
                setTimeout(() => { confirmation.classList.add('hidden'); }, 3000);
            }
            
            Calculator.render();
        }

        function exportDataToJSON() {
            const data = DataEngine.getData();
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hutchison_calculator_backup.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportServicesToCSV(category) {
            const data = DataEngine.getData();
            const collection = data[category];
            if (!collection) {
                showAdminMessage(`Category "${category}" not found for export.`, 'error');
                return;
            }

            const dataToExport = Object.keys(collection).map(key => {
                const item = collection[key];
                const flatItem = {
                    id: key,
                    name: item.name,
                    type: item.type || '',
                    cost_sqft: item.cost_sqft || 0,
                    cost_lnft: item.cost_lnft || 0,
                    base_cost: item.base_cost || 0,
                    rate_hourly: item.rate_hourly || 0,
                    setup_fee: item.setup_fee || 0,
                    options_json: JSON.stringify(item.options || {}),
                    edges_json: JSON.stringify(item.edges || {}),
                    cutouts_json: JSON.stringify(item.cutouts || {})
                };
                return flatItem;
            });
            
            if (dataToExport.length === 0) {
                showAdminMessage(`No data to export for ${category}.`, 'info');
                return;
            }

            try {
                const csv = Papa.unparse(dataToExport);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `hutchison_${category}_backup.csv`;
                a.click();
                URL.revokeObjectURL(url);
                showAdminMessage(`Successfully exported ${category} to CSV.`, 'info');
            } catch(e) {
                showAdminMessage('Failed to generate CSV file.', 'error');
                console.error("CSV Export Error:", e);
            }
        }


        function importDataFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.version && importedData.settings && importedData.countertops) {
                        if(confirm("Are you sure you want to overwrite all existing data with this file? This action cannot be undone.")) {
                            DataEngine.saveData(importedData);
                            showAdminMessage("Data imported successfully!", 'info');
                            AdminPanel.render();
                            Calculator.render();
                        }
                    } else {
                        showAdminMessage("Error: Invalid or corrupted JSON file.", 'error');
                    }
                } catch (error) {
                    showAdminMessage("Error parsing JSON file: " + error.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function importServicesFromCSV(event, category) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showAdminMessage(`Errors found in CSV file. See console for details.`, 'error');
                        console.error("CSV Parsing Errors:", results.errors);
                        return;
                    }
                    if (!results.data || results.data.length === 0) {
                        showAdminMessage('CSV file is empty or invalid.', 'error');
                        return;
                    }

                    if (!confirm(`Found ${results.data.length} items for "${category}". This will OVERWRITE existing items with the same ID and add new ones. Continue?`)) {
                        event.target.value = '';
                        return;
                    }
                    
                    const data = DataEngine.getData();
                    let updatedCount = 0;
                    let addedCount = 0;

                    results.data.forEach(row => {
                        const id = row.id;
                        if (!id) {
                            console.warn('Skipping row with no ID:', row);
                            return;
                        }

                        const newItem = {
                            name: row.name,
                            type: row.type || undefined,
                            cost_sqft: parseFloat(row.cost_sqft) || undefined,
                            cost_lnft: parseFloat(row.cost_lnft) || undefined,
                            base_cost: parseFloat(row.base_cost) || undefined,
                            rate_hourly: parseFloat(row.rate_hourly) || undefined,
                            setup_fee: parseFloat(row.setup_fee) || undefined,
                        };
                        
                        try { newItem.options = JSON.parse(row.options_json || '{}'); } catch(e) { newItem.options = {}; }
                        try { newItem.edges = JSON.parse(row.edges_json || '{}'); } catch(e) { newItem.edges = {}; }
                        try { newItem.cutouts = JSON.parse(row.cutouts_json || '{}'); } catch(e) { newItem.cutouts = {}; }

                        Object.keys(newItem).forEach(key => newItem[key] === undefined && delete newItem[key]);

                        if (data[category][id]) {
                            updatedCount++;
                        } else {
                            addedCount++;
                        }
                        data[category][id] = newItem;
                    });
                    
                    DataEngine.saveData(data);
                    showAdminMessage(`${updatedCount} items updated, ${addedCount} added in "${category}". Data saved.`, 'info');
                    AdminPanel.render();
                    Calculator.render();
                },
                error: function(err) {
                    showAdminMessage(`Failed to read CSV file: ${err.message}`, 'error');
                }
            });
            event.target.value = '';
        }
        
        function showAdminMessage(message, type = 'info') {
            const contentContainer = container.querySelector('#admin-category-content');
            if (!contentContainer) return;
            
            let messageEl = contentContainer.querySelector('.admin-message');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.className = 'admin-message';
                messageEl.style.padding = '12px';
                messageEl.style.borderRadius = 'var(--border-radius)';
                messageEl.style.marginBottom = '16px';
                messageEl.style.fontWeight = '600';
                messageEl.style.transition = 'opacity 0.5s';
                messageEl.setAttribute('role', 'alert');
                contentContainer.prepend(messageEl);
            }
            
            messageEl.textContent = message;
            messageEl.style.opacity = '1';
            
            if (type === 'error') {
                 messageEl.style.backgroundColor = '#f8d7da';
                 messageEl.style.color = '#721c24';
                 messageEl.style.borderColor = '#f5c6cb';
            } else { // info
                 messageEl.style.backgroundColor = '#d1ecf1';
                 messageEl.style.color = '#0c5460';
                 messageEl.style.borderColor = '#bee5eb';
            }
            
            setTimeout(() => {
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    messageEl.remove();
                }, 500);
            }, 4000);
        }

        function addNewItem(itemType) {
            const newName = prompt(`Enter the name for the new ${itemType}:`);
            if (!newName || newName.trim() === '') {
                showAdminMessage(`${itemType} name cannot be empty.`, 'error');
                return;
            }

            const data = DataEngine.getData();
            const dataCategory = itemType === 'material' ? 'countertops' : 'casework';
            const collection = data[dataCategory];

            const newKey = newName.trim().toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
            
            const nameExists = Object.values(collection).some(m => m.name.toLowerCase() === newName.trim().toLowerCase());
            if (nameExists) {
                showAdminMessage(`An item named "${newName}" already exists in this category.`, 'error');
                return;
            }

            const firstItemKey = Object.keys(collection)[0];
            const newItemData = JSON.parse(JSON.stringify(collection[firstItemKey]));
            newItemData.name = newName.trim();
            
            collection[newKey] = newItemData;
            DataEngine.saveData(data);

            showAdminMessage(`${itemType} "${newName}" added successfully. You can now edit its properties.`, 'info');
            currentCategory = dataCategory;
            render(); 
        }

        function deleteSelectedItem(itemType) {
            const dataCategory = itemType === 'material' ? 'countertops' : 'casework';
            const selectElement = document.getElementById(`admin-${itemType}-select`);
            const itemKeyToDelete = selectElement.value;

            if (!itemKeyToDelete) {
                showAdminMessage('No item selected to delete.', 'error');
                return;
            }

            const data = DataEngine.getData();
            const collection = data[dataCategory];
            const itemName = collection[itemKeyToDelete].name;
            
            if (Object.keys(collection).length <= 1) {
                showAdminMessage(`Cannot delete the last item. Add a new one before deleting "${itemName}".`, 'error');
                return;
            }

            if (confirm(`Are you sure you want to permanently delete "${itemName}"? This cannot be undone.`)) {
                delete collection[itemKeyToDelete];
                DataEngine.saveData(data);
                showAdminMessage(`"${itemName}" has been deleted.`, 'info');
                currentCategory = dataCategory;
                render();
            }
        }
        
        function attachListeners() {
            if (!container) return;
            
            container.addEventListener('click', (e) => {
                const target = e.target;
                
                const tabButton = target.closest('button[data-category]');
                 if (tabButton && container.querySelector('#admin-category-tabs').contains(tabButton)) {
                    const category = tabButton.dataset.category;
                    if (category !== currentCategory) {
                        currentCategory = category;
                        render();
                    }
                    return;
                }

                if (target.classList.contains('save-button')) {
                    saveChanges(target);
                } else if (target.id === 'add-new-material-btn') {
                    addNewItem('material');
                } else if (target.id === 'add-new-casework-btn') {
                    addNewItem('casework');
                } else if (target.id === 'delete-material-btn') {
                    deleteSelectedItem('material');
                } else if (target.id === 'delete-casework-btn') {
                    deleteSelectedItem('casework');
                } else if (target.id === 'export-json-btn') {
                     exportDataToJSON();
                } else if (target.id === 'export-countertops-csv-btn') {
                     exportServicesToCSV('countertops');
                } else if (target.id === 'export-casework-csv-btn') {
                     exportServicesToCSV('casework');
                }
            });
            
            container.addEventListener('change', (e) => {
                const target = e.target;
                 if (target.id === 'import-json-file') {
                    importDataFromJSON(e);
                 } else if (target.id === 'import-countertops-csv-file') {
                    importServicesFromCSV(e, 'countertops');
                 } else if (target.id === 'import-casework-csv-file') {
                    importServicesFromCSV(e, 'casework');
                 } else if(target.id === 'admin-material-select') {
                    renderCountertopAdminForm(target.value);
                } else if (target.id === 'admin-casework-select') {
                    renderCaseworkAdminForm(target.value);
                }
            });
        }
        
        return { init, render };
    })();
    
    /**
     * @module App
     * @description Main application controller. Initializes all other modules.
     * @dependencies DataEngine, UIController, Calculator, AdminPanel
     */
    const App = (function() {
        let fullQuote = [];
        let fullQuoteChart = null;
        let projectDetails = {
            clientName: '',
            projectName: '',
            discountType: 'percent',
            discountValue: 0,
        };

        function init() {
            DataEngine.init();
            UIController.init();
            Calculator.init();
            AdminPanel.init();

            const header = document.querySelector('header');
            if (header) {
                header.addEventListener('click', (e) => {
                    if (e.target.id === 'show-calculator-btn') {
                        UIController.showMainView('calculator');
                    } else if (e.target.id === 'show-full-quote-btn') {
                        UIController.showMainView('fullQuote');
                    } else if (e.target.id === 'show-admin-btn') {
                        UIController.showMainView('admin');
                    }
                });
            }

            document.addEventListener('click', e => {
                if (e.target.id === 'clear-full-quote') {
                    if (confirm('Are you sure you want to clear the entire quote?')) {
                        fullQuote = [];
                        renderFullQuote();
                    }
                }
                if (e.target.matches('.delete-item-btn')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    fullQuote.splice(index, 1);
                    renderFullQuote();
                }
                if (e.target.id === 'export-pdf-btn') {
                    exportQuoteToPDF();
                }
            });

             document.addEventListener('input', e => {
                if(e.target.matches('#client-name, #project-name, #project-discount-value, #project-discount-type')) {
                    projectDetails.clientName = document.getElementById('client-name').value;
                    projectDetails.projectName = document.getElementById('project-name').value;
                    projectDetails.discountType = document.getElementById('project-discount-type').value;
                    projectDetails.discountValue = parseFloat(document.getElementById('project-discount-value').value) || 0;
                    renderFullQuote();
                }
             });
            
            UIController.showMainView('calculator');
        }

        function addItemToFullQuote() {
            const quoteDetailsNode = document.querySelector('#quote-details');
            if (!quoteDetailsNode || quoteDetailsNode.querySelector('.quote-summary__placeholder')) {
                alert("Please calculate a valid item before adding to the quote.");
                return;
            }
            
            const item = {
                id: Date.now(),
                name: "New Item",
                details: [],
                subtotal: 0
            };
            
            const category = document.querySelector('#calc-category-tabs .active').dataset.category;
            
            if (category === 'countertops') {
                const materialSelect = document.getElementById('calc-material-select');
                item.name = materialSelect.options[materialSelect.selectedIndex].text;
                const length = document.getElementById('calc-length').value;
                const width = document.getElementById('calc-width').value;
                item.details.push(`${length}" x ${width}"`);
                document.querySelectorAll('#calc-options-container select').forEach(s => item.details.push(s.options[s.selectedIndex].text));
                document.querySelectorAll('.calc-cutout:checked').forEach(c => item.details.push(c.nextElementSibling.textContent));
            } else if (category === 'casework') {
                 const caseworkSelect = document.getElementById('calc-casework-select');
                 item.name = caseworkSelect.options[caseworkSelect.selectedIndex].text;
                 document.querySelectorAll('#calc-casework-options-container .calc-input').forEach(input => {
                     if (input.tagName === 'SELECT') item.details.push(input.options[input.selectedIndex].text);
                     else if (input.type === 'checkbox' && input.checked) item.details.push(input.nextElementSibling.textContent);
                     else if (input.type === 'number' && input.value > 0) {
                        const label = input.previousElementSibling;
                        if(label) item.details.push(`${label.textContent}: ${input.value}`);
                     }
                 });
            } else if (category === 'misc_services') {
                const serviceSelect = document.getElementById('calc-misc-select');
                item.name = serviceSelect.options[serviceSelect.selectedIndex].text;
                document.querySelectorAll('#calc-misc-options-container .calc-input').forEach(input => {
                    if (input.value > 0) {
                         const label = input.previousElementSibling;
                         if (label) item.details.push(`${label.textContent}: ${input.value}`);
                    }
                });
            }

            // Get subtotal from the summary table
            const subtotalRow = quoteDetailsNode.querySelector('.subtotal-row td:last-child');
            if (subtotalRow) {
                 item.subtotal = parseFloat(subtotalRow.textContent.replace(/[^0-9.-]+/g,""));
            }

            fullQuote.push(item);
            alert(`"${item.name}" has been added to the full quote.`);
            renderFullQuote();
        }

        function renderFullQuote() {
            const view = document.getElementById('full-quote-view');
            const settings = DataEngine.getData().settings;
            if (!view) return;

            let contentHTML = `
                <div class="card">
                     <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <h2 class="card__title" style="margin-bottom:0; border:0;">Full Project Quote</h2>
                        <div>
                            <button id="export-pdf-btn" class="admin-button">Export to PDF</button>
                            <button id="clear-full-quote" class="admin-button danger">Clear Quote</button>
                        </div>
                    </div>
                </div>
                 <div class="card">
                    <h3 class="card__title" style="font-size: 1.25rem; margin-bottom: 1rem;">Client & Project Details</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="client-name" class="form-group__label">Client Name</label>
                            <input type="text" id="client-name" class="form-group__input" value="${projectDetails.clientName}">
                        </div>
                        <div class="form-group">
                            <label for="project-name" class="form-group__label">Project Name / Reference</label>
                            <input type="text" id="project-name" class="form-group__input" value="${projectDetails.projectName}">
                        </div>
                    </div>
                </div>
            `;

            if (fullQuote.length === 0) {
                contentHTML += `<div class="card"><p class="quote-summary__placeholder">No items have been added to the quote yet. Go to the Calculator to add items.</p></div>`;
            } else {
                let subtotal = fullQuote.reduce((sum, item) => sum + item.subtotal, 0);
                
                let discountAmount = 0;
                if (projectDetails.discountValue > 0) {
                    if (projectDetails.discountType === 'percent') {
                        discountAmount = subtotal * (projectDetails.discountValue / 100);
                    } else {
                        discountAmount = projectDetails.discountValue;
                    }
                }
                
                const discountedSubtotal = subtotal - discountAmount;
                const tax = discountedSubtotal * settings.taxRate;
                const total = discountedSubtotal + tax;

                contentHTML += `
                    <div class="card">
                        <div class="main-grid">
                            <div>
                                <table id="full-quote-table">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th style="text-align: right;">Cost</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${fullQuote.map((item, index) => `
                                            <tr>
                                                <td>
                                                    <div class="item-name">${item.name}</div>
                                                    <div class="item-details">${item.details.join(', ')}</div>
                                                </td>
                                                <td class="item-cost">${UIController.formatCurrency(item.subtotal)}</td>
                                                <td class="item-actions">
                                                    <button class="delete-item-btn" data-index="${index}" title="Remove Item">&times;</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                        <tr class="subtotal-row">
                                            <td>Subtotal</td>
                                            <td class="item-cost">${UIController.formatCurrency(subtotal)}</td>
                                            <td></td>
                                        </tr>
                                        <tr class="discount-row">
                                            <td>
                                                <div style="display: flex; gap: 8px; align-items: center;">
                                                    <span>Project Discount</span>
                                                    <select id="project-discount-type" class="form-group__select" style="width: 120px; padding: 4px;">
                                                        <option value="percent" ${projectDetails.discountType === 'percent' ? 'selected' : ''}>Percent (%)</option>
                                                        <option value="fixed" ${projectDetails.discountType === 'fixed' ? 'selected' : ''}>Fixed ($)</option>
                                                    </select>
                                                    <input type="number" id="project-discount-value" class="form-group__input" style="width: 100px; padding: 4px;" value="${projectDetails.discountValue}">
                                                </div>
                                            </td>
                                            <td class="item-cost">-${UIController.formatCurrency(discountAmount)}</td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td>Tax (${(settings.taxRate * 100).toFixed(2)}%)</td>
                                            <td class="item-cost">${UIController.formatCurrency(tax)}</td>
                                            <td></td>
                                        </tr>
                                        <tr class="total-row">
                                            <td>Grand Total</td>
                                            <td class="item-cost">${UIController.formatCurrency(total)}</td>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="full-quote-chart-container">
                                <canvas id="full-quote-chart" role="img" aria-label="Full quote cost breakdown pie chart"></canvas>
                            </div>
                        </div>
                    </div>
                `;
            }
            view.innerHTML = contentHTML;

            if(fullQuote.length > 0) {
                renderFullQuoteChart();
            }
        }

        function renderFullQuoteChart() {
            const ctx = document.getElementById('full-quote-chart')?.getContext('2d');
            if(!ctx) return;

            if (fullQuoteChart) {
                fullQuoteChart.destroy();
            }
            
            const labels = fullQuote.map(item => item.name);
            const data = fullQuote.map(item => item.subtotal);
            
            let subtotal = fullQuote.reduce((sum, item) => sum + item.subtotal, 0);
            let discountAmount = 0;
            if (projectDetails.discountValue > 0) {
                 if (projectDetails.discountType === 'percent') {
                    discountAmount = subtotal * (projectDetails.discountValue / 100);
                } else {
                    discountAmount = projectDetails.discountValue;
                }
            }
            const discountedSubtotal = subtotal - discountAmount;
            const tax = discountedSubtotal * DataEngine.getData().settings.taxRate;
            
            labels.push('Tax');
            data.push(tax);
            if(discountAmount > 0) {
                labels.unshift('Discount');
                data.unshift(-discountAmount);
            }

            fullQuoteChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cost Breakdown',
                        data: data,
                        backgroundColor: [
                            'rgba(79, 70, 229, 0.7)', 'rgba(30, 64, 175, 0.7)', 'rgba(165, 180, 252, 0.7)', 'rgba(34, 197, 94, 0.7)', 'rgba(245, 158, 11, 0.7)',
                            'rgba(147, 51, 234, 0.7)', 'rgba(217, 70, 239, 0.7)', 'rgba(255, 99, 132, 0.7)'
                        ].slice(0, data.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Full Quote Visual Breakdown' }
                    }
                }
            });
        }
        
        function exportQuoteToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const settings = DataEngine.getData().settings;
            
            doc.setFontSize(22);
            doc.text(settings.companyName, 20, 30);
            doc.setFontSize(16);
            doc.text("Project Quote", 20, 40);
            
            doc.setFontSize(12);
            doc.text(`Client: ${projectDetails.clientName || 'N/A'}`, 20, 60);
            doc.text(`Project: ${projectDetails.projectName || 'N/A'}`, 20, 70);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, 70);

            let y = 90;
            fullQuote.forEach(item => {
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text(item.name, 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(UIController.formatCurrency(item.subtotal), 180, y, {align: 'right'});
                y+= 5;
                doc.setFontSize(8);
                doc.setTextColor(150);
                const details = doc.splitTextToSize(item.details.join(', '), 150);
                doc.text(details, 22, y);
                y += details.length * 3.5 + 5;
                 doc.setTextColor(0);
            });
            
            const subtotal = fullQuote.reduce((sum, item) => sum + item.subtotal, 0);
            let discountAmount = 0;
            if (projectDetails.discountValue > 0) {
                 if (projectDetails.discountType === 'percent') {
                    discountAmount = subtotal * (projectDetails.discountValue / 100);
                } else {
                    discountAmount = projectDetails.discountValue;
                }
            }
            const discountedSubtotal = subtotal - discountAmount;
            const tax = discountedSubtotal * settings.taxRate;
            const total = discountedSubtotal + tax;
            
            y+= 10;
            doc.line(20, y, 190, y);
            y+=10
            
            doc.setFontSize(10);
            doc.text('Subtotal:', 140, y);
            doc.text(UIController.formatCurrency(subtotal), 180, y, {align: 'right'});
            y+=7;

             if(discountAmount > 0) {
                doc.text(`Discount (${projectDetails.discountValue}${projectDetails.discountType === 'percent' ? '%' : '$'}):`, 140, y);
                doc.text(`-${UIController.formatCurrency(discountAmount)}`, 180, y, {align: 'right'});
                y+=7;
            }

            doc.text(`Tax (${(settings.taxRate * 100).toFixed(2)}%):`, 140, y);
            doc.text(UIController.formatCurrency(tax), 180, y, {align: 'right'});
            y+=10;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Total:', 140, y);
            doc.text(UIController.formatCurrency(total), 180, y, {align: 'right'});
            
            doc.save(`${projectDetails.projectName || 'quote'}_${new Date().toISOString().slice(0,10)}.pdf`);
        }

        return { init, renderFullQuote, addItemToFullQuote };
    })();

    /**
     * @module CryptoController
     * @description Handles password protection and decryption.
     * @dependencies App
     */
    const CryptoController = (function() {
        const payloadContainer = document.getElementById('encrypted-payload');
        const passwordPrompt = document.getElementById('password-prompt');
        const passwordInput = document.getElementById('password-input');
        const submitButton = document.getElementById('submit-password');
        const passwordError = document.getElementById('password-error');
        const appContainer = document.getElementById('app-container');

        const appHTML = `
            <div class="app-wrapper">
                <header>
                    <h1 id="company-header">Pricing Calculator</h1>
                    <p>A comprehensive business engine for quotes.</p>
                    <div class="view-switcher" role="navigation" aria-label="Main Views">
                        <button id="show-calculator-btn">Calculator</button>
                        <button id="show-full-quote-btn">Full Quote</button>
                        <button id="show-admin-btn">Admin Panel</button>
                    </div>
                </header>

                <main>
                    <div id="calculator-interface" class="card" role="region" aria-labelledby="calculator-view-title">
                         <h2 id="calculator-view-title" class="hidden">Calculator View</h2>
                    </div>
                    <div id="full-quote-view" class="hidden" role="region" aria-labelledby="full-quote-view-title">
                        <h2 id="full-quote-view-title" class="hidden">Full Quote View</h2>
                    </div>
                    <div id="admin-panel" class="card hidden" role="region" aria-labelledby="admin-view-title">
                         <h2 id="admin-view-title" class="hidden">Admin Panel View</h2>
                    </div>
                </main>
            </div>
        `;


        async function deriveKey(password, saltBuffer) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                { name: "PBKDF2" },
                false,
                ["deriveBits", "deriveKey"]
            );
            return window.crypto.subtle.deriveKey(
                {
                    "name": "PBKDF2",
                    salt: saltBuffer,
                    "iterations": 100000,
                    "hash": "SHA-256"
                },
                keyMaterial,
                { "name": "AES-GCM", "length": 256 },
                true,
                ["encrypt", "decrypt"]
            );
        }

        async function encrypt(data, password) {
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const key = await deriveKey(password, salt);
            const enc = new TextEncoder();
            const encodedData = enc.encode(data);

            const cipherText = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                key,
                encodedData
            );

            return {
                cipherText: btoa(String.fromCharCode.apply(null, new Uint8Array(cipherText))),
                iv: btoa(String.fromCharCode.apply(null, new Uint8Array(iv))),
                salt: btoa(String.fromCharCode.apply(null, new Uint8Array(salt)))
            };
        }


        async function decrypt(encryptedData, password) {
            try {
                const saltStr = atob(encryptedData.salt);
                const ivStr = atob(encryptedData.iv);
                const cipherTextStr = atob(encryptedData.cipherText);

                const saltBuffer = new Uint8Array(saltStr.split('').map(c => c.charCodeAt(0)));
                const ivBuffer = new Uint8Array(ivStr.split('').map(c => c.charCodeAt(0)));
                const cipherBuffer = new Uint8Array(cipherTextStr.split('').map(c => c.charCodeAt(0)));
                
                const key = await deriveKey(password, saltBuffer);
                const dec = new TextDecoder();
                
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: ivBuffer },
                    key,
                    cipherBuffer
                );

                return dec.decode(decrypted);
            } catch (e) {
                console.error("Decryption failed:", e);
                return null;
            }
        }
        
        async function handleUnlockAttempt() {
            const password = passwordInput.value;
            if (!password) return;

            const decryptedHTML = await decrypt(JSON.parse(payloadContainer.textContent), password);

            if (decryptedHTML) {
                passwordError.classList.add('hidden');
                appContainer.innerHTML = decryptedHTML;
                App.init(); 
            } else {
                passwordError.classList.remove('hidden');
            }
        }

        async function init() {
            const encryptedPayload = await encrypt(appHTML, "admin123");
            payloadContainer.textContent = JSON.stringify(encryptedPayload, null, 2);


            submitButton.addEventListener('click', handleUnlockAttempt);
            passwordInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    handleUnlockAttempt();
                }
            });
        }
        
        return { init };
    })();
    // --- END: ALL APPLICATION LOGIC ---


    // --- APPLICATION ENTRY POINT ---
    window.onload = function() {
        CryptoController.init();
    };

    </script>

</body>
</html>
