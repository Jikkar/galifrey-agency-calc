<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Pricing Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
    /*
    ============================================
    --- 1. CSS Variables & Root Setup
    ============================================
    Defines the core design tokens (colors, spacing, fonts) for the application.
    */
    :root {
        --color-primary: #4f46e5; /* Indigo 600 */
        --color-primary-dark: #4338ca; /* Indigo 700 */
        --color-accent: #10b981; /* Emerald 500 */
        --color-bg: #f8f9fa; /* Lighter Gray */
        --color-surface: #ffffff;
        --color-text-header: #212529;
        --color-text-body: #495057;
        --color-text-muted: #6c757d;
        --color-border: #dee2e6;
        --color-input-bg: #f1f3f5;
        --color-error: #dc3545;
        --font-family-base: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --spacing-unit: 8px;
        --border-radius: 0.5rem; /* 8px */
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.04);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.05);
        --transition-speed: 0.2s;
    }

    /*
    ============================================
    --- 2. Base & Global Styles
    ============================================
    Applies foundational styles and resets.
    */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-family-base);
        background-color: var(--color-bg);
        color: var(--color-text-body);
        line-height: 1.6;
        font-size: 16px;
    }

    .hidden {
        display: none !important;
    }

    .app-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: calc(var(--spacing-unit) * 3);
    }
    
    /*
    ============================================
    --- 3. Password Prompt
    ============================================
    */
    #password-prompt {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: calc(var(--spacing-unit) * 2);
    }

    #password-prompt > div {
        max-width: 400px;
        width: 100%;
        background-color: var(--color-surface);
        padding: calc(var(--spacing-unit) * 5);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        text-align: center;
    }
    
    #password-prompt h2 {
        color: var(--color-text-header);
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: var(--spacing-unit);
    }

    #password-prompt p {
        color: var(--color-text-muted);
        margin-bottom: calc(var(--spacing-unit) * 3);
    }

    #password-input {
        width: 100%;
        padding: calc(var(--spacing-unit) * 1.5);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        font-size: 1rem;
        margin-bottom: calc(var(--spacing-unit) * 2);
        transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
    }

    #password-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgb(79 70 229 / 0.2);
    }

    #submit-password {
        width: 100%;
        padding: calc(var(--spacing-unit) * 1.5);
        background-color: var(--color-primary);
        color: var(--color-surface);
        border: none;
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color var(--transition-speed);
    }

    #submit-password:hover {
        background-color: var(--color-primary-dark);
    }

    #password-error {
        color: var(--color-error);
        margin-top: var(--spacing-unit);
        font-size: 0.875rem;
    }

    /*
    ============================================
    --- 4. Main Application Layout & Header
    ============================================
    */
    header {
        text-align: center;
        margin-bottom: calc(var(--spacing-unit) * 5);
    }

    #company-header {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-text-header);
        margin-bottom: var(--spacing-unit);
    }

    header > p {
        color: var(--color-text-muted);
        font-size: 1.125rem;
    }

    header .view-switcher {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: var(--spacing-unit);
        margin-top: calc(var(--spacing-unit) * 3);
    }
    
    header .view-switcher button {
        padding: calc(var(--spacing-unit) * 1.25) calc(var(--spacing-unit) * 3);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        font-weight: 600;
        cursor: pointer;
        transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    header .view-switcher button.active {
        background-color: var(--color-primary);
        color: var(--color-surface);
        border-color: var(--color-primary);
    }
    
    header .view-switcher button:not(.active) {
        background-color: var(--color-surface);
        color: var(--color-text-body);
    }
    
    header .view-switcher button:not(.active):hover {
        background-color: var(--color-bg);
    }


    /*
    ============================================
    --- 5. General Card & Form Styles
    ============================================
    Shared styles for calculator, admin, and quote summary cards.
    */
    .card {
        background-color: var(--color-surface);
        border-radius: var(--border-radius);
        padding: calc(var(--spacing-unit) * 4);
        box-shadow: var(--shadow-md);
        margin-bottom: calc(var(--spacing-unit) * 3);
    }
    
    .card__title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--color-text-header);
        margin-bottom: calc(var(--spacing-unit) * 3);
        padding-bottom: calc(var(--spacing-unit) * 2);
        border-bottom: 1px solid var(--color-border);
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: calc(var(--spacing-unit) * 4);
    }

    .form-fieldset {
        border: none;
        display: flex;
        flex-direction: column;
        gap: calc(var(--spacing-unit) * 2);
    }

    .form-fieldset__legend {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-text-header);
        margin-bottom: var(--spacing-unit);
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group__label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-text-body);
        margin-bottom: var(--spacing-unit);
    }

    .form-group__input,
    .form-group__select {
        width: 100%;
        padding: calc(var(--spacing-unit) * 1.25);
        border: 1px solid var(--color-border);
        border-radius: calc(var(--border-radius) / 1.5);
        font-size: 1rem;
        background-color: var(--color-surface);
        transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
    }

    .form-group__input:focus,
    .form-group__select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgb(79 70 229 / 0.2);
    }
    
    .form-group--checkbox {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: var(--spacing-unit);
    }

    .form-group__checkbox {
        height: 1.25em;
        width: 1.25em;
        accent-color: var(--color-primary);
    }

    /*
    ============================================
    --- 6. Calculator Interface Specifics
    ============================================
    */
    #calculator-interface .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: calc(var(--spacing-unit) * 4);
    }

    #quote-summary.card {
        position: sticky;
        top: calc(var(--spacing-unit) * 3);
    }
    
    .quote-summary__placeholder {
        text-align: center;
        color: var(--color-text-muted);
        padding: calc(var(--spacing-unit) * 8) 0;
    }

    .quote-summary__table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .quote-summary__table td {
        padding: calc(var(--spacing-unit) * 1.5) var(--spacing-unit);
        border-bottom: 1px solid var(--color-border);
    }

    .quote-summary__table tr:last-child td {
        border-bottom: none;
    }

    .quote-summary__table .item-name {
        font-weight: 500;
    }
    
    .quote-summary__table .item-cost {
        text-align: right;
    }

    .quote-summary__table .subtotal-row td {
        font-weight: 600;
        color: var(--color-text-header);
        border-top: 2px solid var(--color-border);
        padding-top: calc(var(--spacing-unit) * 2);
    }
    
    .quote-summary__table .total-row td {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--color-primary);
        background-color: #f3f4f6;
    }

    #quote-chart-container {
        margin-top: calc(var(--spacing-unit) * 4);
        padding-top: calc(var(--spacing-unit) * 3);
        border-top: 1px solid var(--color-border);
    }


    /*
    ============================================
    --- 7. Admin Panel Specifics
    ============================================
    */
    #admin-panel .admin-group {
        display: grid;
        grid-template-columns: 1fr 200px;
        gap: calc(var(--spacing-unit) * 2);
        align-items: center;
        margin-bottom: var(--spacing-unit);
    }

    #admin-panel .data-management-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: calc(var(--spacing-unit) * 2);
    }

    #admin-panel .data-management-card {
         background-color: var(--color-bg);
         padding: calc(var(--spacing-unit) * 2);
         border-radius: var(--border-radius);
         border: 1px solid var(--color-border);
    }

    #admin-panel .data-management-card h4 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: var(--spacing-unit);
    }

     #admin-panel .data-management-card p {
        font-size: 0.875rem;
        color: var(--color-text-muted);
        margin-bottom: calc(var(--spacing-unit) * 2);
    }
    
    #admin-panel .admin-group__label {
        font-weight: 500;
    }

    #admin-panel .admin-section-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-top: calc(var(--spacing-unit) * 4);
        margin-bottom: calc(var(--spacing-unit) * 2);
        padding-bottom: var(--spacing-unit);
        border-bottom: 1px solid var(--color-border);
    }
    
    .admin-actions {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: calc(var(--spacing-unit) * 2);
        margin-top: calc(var(--spacing-unit) * 4);
    }
    
    .save-button, .admin-button {
        padding: calc(var(--spacing-unit) * 1.25) calc(var(--spacing-unit) * 3);
        background-color: var(--color-primary);
        color: var(--color-surface);
        border: none;
        border-radius: var(--border-radius);
        font-weight: 600;
        cursor: pointer;
        transition: background-color var(--transition-speed);
        display: inline-block;
        text-align: center;
    }
    
    .save-button:hover, .admin-button:hover {
        background-color: var(--color-primary-dark);
    }
    
    .admin-button.secondary {
        background-color: var(--color-text-muted);
    }

    .admin-button.secondary:hover {
        background-color: var(--color-text-body);
    }
    
    .admin-button.danger {
        background-color: var(--color-error);
    }

    .admin-button.danger:hover {
        background-color: #c82333;
    }


    #save-confirmation {
        color: var(--color-accent);
        font-weight: 600;
        transition: opacity 0.3s ease-in-out;
    }

    #admin-help-content ul {
        list-style-position: inside;
        padding-left: var(--spacing-unit);
    }
    #admin-help-content li {
        margin-bottom: var(--spacing-unit);
    }

    /*
    ============================================
    --- 8. Responsive Design
    ============================================
    */
    @media (max-width: 992px) {
        #calculator-interface .main-grid,
        #admin-panel .main-grid {
            grid-template-columns: 1fr;
        }
    }
    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        #admin-panel .admin-group {
            grid-template-columns: 1fr;
            gap: var(--spacing-unit);
        }

        .app-wrapper {
             padding: calc(var(--spacing-unit) * 2);
        }
    }
    @media (min-width: 768px) {
        #company-header {
            font-size: 2.5rem;
        }
    }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="password-prompt">
            <div>
                <h2>Admin Access</h2>
                <p>Enter password to access the calculator and admin panel.</p>
                <div>
                    <label for="password-input" class="hidden">Password</label>
                    <input id="password-input" name="password" type="password" required placeholder="Password">
                </div>
                <div>
                    <button id="submit-password">Unlock</button>
                </div>
                <p id="password-error" class="hidden">Incorrect password. Please try again.</p>
            </div>
        </div>
    </div>

    <div id="encrypted-payload" class="hidden"></div>


    <script>
    // --- START: MAIN APPLICATION LOGIC (IIFE Modules) ---
    // The modules are ordered to resolve dependencies: modules that are needed by others are defined first.

    /**
     * @module DataEngine
     * @description Handles all interactions with localStorage. No dependencies.
     */
    const DataEngine = (function() {
        const DB_KEY = 'businessCalculatorData';

        // Default data schema as per the blueprint
        function getDefaultData() {
            const commonCutouts = {
                undermount_sink: { name: "Undermount Sink", cost: 300 },
                dropin_sink: { name: "Drop-in Sink", cost: 150 },
                cooktop: { name: "Cooktop", cost: 200 },
                faucet_hole: { name: "Faucet Hole", cost: 20 }
            };

            const commonEdges = {
                eased: { name: "Eased (Standard)", cost_lnft: 0 },
                bevel: { name: "Bevel", cost_lnft: 10 },
                bullnose: { name: "Bullnose", cost_lnft: 15},
                ogee: { name: "Ogee", cost_lnft: 25 }
            };

            return {
                "version": "1.8.0", // Incremented for bug fixes and new features
                "settings": {
                    "companyName": "Hutchison Custom Fabrication",
                    "taxRate": 0.0875
                },
                "countertops": {
                    "plastic_laminate": { name: "Plastic Laminate", cost_sqft: 35.67, options: { brand: { name: "Brand/Finish", type: "select", values: { standard: { name: "Standard (Formica, Wilsonart)", multiplier: 1.0 }, premium: { name: "Premium Finish", multiplier: 1.25 } } } }, edges: commonEdges, cutouts: commonCutouts },
                    "granite": { name: "Granite", cost_sqft: 80.63, options: { grade: { name: "Grade", type: "select", values: { level_1: { name: "Level 1 (Standard)", multiplier: 1.0 }, level_2: { name: "Level 2 (Mid-Grade)", multiplier: 1.2 }, exotic: { name: "Exotic", multiplier: 1.5 } } } }, edges: commonEdges, cutouts: commonCutouts },
                    "quartz": { name: "Quartz", cost_sqft: 73.16, options: { brand: { name: "Brand", type: "select", values: { standard: { name: "Standard (e.g., Silestone)", multiplier: 1.0 }, premium: { name: "Premium (e.g., Cambria)", multiplier: 1.3 } } } }, edges: commonEdges, cutouts: commonCutouts },
                    "epoxy_resin": { name: "Epoxy Resin", cost_sqft: 100.00, options: { design: { name: "Design Complexity", type: "select", values: { simple: { name: "Simple (1-2 Colors)", multiplier: 1.0 }, complex: { name: "Complex (Metallics, Veining)", multiplier: 1.5 } } } }, edges: { square: { name: "Square Edge", cost_lnft: 0 } }, cutouts: commonCutouts },
                    "solid_surface": { name: "Solid Surface", cost_sqft: 49.27, options: { color: { name: "Color/Pattern", type: "select", values: { standard: { name: "Standard Color", multiplier: 1.0 }, premium: { name: "Premium Pattern", multiplier: 1.2 } } } }, edges: commonEdges, cutouts: { ...commonCutouts, integral_sink: { name: "Integral Sink", cost: 450 } } }
                },
                "casework": {
                    "base_cabinets": { 
                        name: "Base Cabinets", 
                        cost_lnft: 250, // Base cost per linear foot for standard base cabinets
                        options: {
                            awi_grade: {
                                name: "AWI Grade",
                                type: "select",
                                values: {
                                    economy: { name: "Economy", multiplier: 1.0 },
                                    custom: { name: "Custom", multiplier: 1.4 },
                                    premium: { name: "Premium", multiplier: 2.0 }
                                }
                            },
                            material: {
                                name: "Material",
                                type: "select",
                                values: {
                                    p_laminate: { name: "Plastic Laminate", multiplier: 1.0 },
                                    wood_veneer: { name: "Wood Veneer", multiplier: 1.8 }
                                }
                            },
                            construction: {
                                name: "Construction",
                                type: "select",
                                values: {
                                    frameless: { name: "Frameless", multiplier: 1.0 },
                                    face_frame: { name: "Face Frame", multiplier: 1.15 },
                                    inset: { name: "Inset", multiplier: 1.35 }
                                }
                            }
                        }
                    },
                    "wall_cabinets": {
                        name: "Wall Cabinets",
                        cost_lnft: 200, // Wall cabinets are typically less expensive
                        // Options are the same as base cabinets, they can be reused or customized
                        options: {
                             awi_grade: { name: "AWI Grade", type: "select", values: { economy: { name: "Economy", multiplier: 1.0 }, custom: { name: "Custom", multiplier: 1.4 }, premium: { name: "Premium", multiplier: 2.0 } } },
                             material: { name: "Material", type: "select", values: { p_laminate: { name: "Plastic Laminate", multiplier: 1.0 }, wood_veneer: { name: "Wood Veneer", multiplier: 1.8 } } },
                             construction: { name: "Construction", type: "select", values: { frameless: { name: "Frameless", multiplier: 1.0 }, face_frame: { name: "Face Frame", multiplier: 1.15 } } }
                        }
                    }
                },
                "misc_services": {
                    "design": {
                        "name": "Design Services",
                        "rate_hourly": 75
                    },
                    "cnc_machining": {
                        "name": "CNC Machining",
                        "rate_hourly": 90,
                        "setup_fee": 50
                    }
                }
            };
        }

        // Initialize data if it doesn't exist
        function init() {
            if (!localStorage.getItem(DB_KEY)) {
                console.log('No data found. Seeding with default values.');
                saveData(getDefaultData());
            } else {
                console.log('Existing data found in localStorage.');
            }
        }

        function getData() {
            try {
                return JSON.parse(localStorage.getItem(DB_KEY));
            } catch (e) {
                console.error("Error parsing data from localStorage:", e);
                return getDefaultData(); // Fallback to default
            }
        }

        function saveData(data) {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
            }
        }

        return { init, getData, saveData };
    })();

    /**
     * @module UIController
     * @description Manages DOM manipulation and view switching. Depends on Calculator and AdminPanel modules at runtime.
     */
    const UIController = (function() {
        let mainViews = {};
        let mainButtons = {};

        function init() {
            mainViews = {
                calculator: document.getElementById('calculator-interface'),
                admin: document.getElementById('admin-panel')
            };
            mainButtons = {
                calculator: document.getElementById('show-calculator-btn'),
                admin: document.getElementById('show-admin-btn')
            };
        }

        function showMainView(viewName) {
            Object.keys(mainViews).forEach(key => {
                const isActive = key === viewName;
                if (mainViews[key]) mainViews[key].classList.toggle('hidden', !isActive);
                if (mainButtons[key]) mainButtons[key].classList.toggle('active', isActive);
            });
            // When switching main views, trigger a render of the active category
            // These calls are safe because by the time this is executed, all modules are defined.
            if(viewName === 'calculator') Calculator.render();
            if(viewName === 'admin') AdminPanel.render();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        }

        return { init, showMainView, formatCurrency };
    })();
    
    /**
     * @module Calculator
     * @description Handles rendering and logic for the public-facing calculator.
     * @dependencies DataEngine, UIController
     */
    const Calculator = (function() {
        let container = null;
        let currentCategory = 'countertops';
        let quoteChart = null;

        function init() {
            container = document.getElementById('calculator-interface');
            if (container) {
                attachListeners();
            }
        }

        function render() {
             if(!container) container = document.getElementById('calculator-interface');
             if(!container) return; 
             let html = `
                <div id="calc-category-tabs" role="tablist" aria-label="Service Categories" class="view-switcher" style="justify-content: flex-start; margin-top: 0; margin-bottom: 24px; border-bottom: 1px solid var(--color-border); padding-bottom: 16px;">
                    <button id="tab-countertops" role="tab" aria-selected="${currentCategory === 'countertops'}" aria-controls="panel-countertops" data-category="countertops" class="${currentCategory === 'countertops' ? 'active' : ''}">Countertops</button>
                    <button id="tab-casework" role="tab" aria-selected="${currentCategory === 'casework'}" aria-controls="panel-casework" data-category="casework" class="${currentCategory === 'casework' ? 'active' : ''}">Casework</button>
                    <button id="tab-misc" role="tab" aria-selected="${currentCategory === 'misc_services'}" aria-controls="panel-misc" data-category="misc_services" class="${currentCategory === 'misc_services' ? 'active' : ''}">Misc Services</button>
                </div>
                <div id="calc-category-content"></div>`;
            container.innerHTML = html;
            renderCategoryContent(currentCategory);
        }

        function renderCategoryContent(category) {
            currentCategory = category;
            const contentContainer = container.querySelector('#calc-category-content');
            if (!contentContainer) return;
            
            contentContainer.innerHTML = ''; 
            
            if (category === 'countertops') {
                contentContainer.id = 'panel-countertops';
                contentContainer.setAttribute('role', 'tabpanel');
                contentContainer.setAttribute('aria-labelledby', 'tab-countertops');
                renderCountertopCalculator(contentContainer);
            } else if (category === 'casework') {
                contentContainer.id = 'panel-casework';
                contentContainer.setAttribute('role', 'tabpanel');
                contentContainer.setAttribute('aria-labelledby', 'tab-casework');
                renderCaseworkCalculator(contentContainer);
            } else if (category === 'misc_services') {
                 contentContainer.id = 'panel-misc';
                 contentContainer.setAttribute('role', 'tabpanel');
                 contentContainer.setAttribute('aria-labelledby', 'tab-misc');
                renderMiscServicesCalculator(contentContainer);
            }
        }
        
        function renderCountertopCalculator(container) {
            const data = DataEngine.getData();
            const allMaterials = data.countertops;
            
            let materialOptionsHTML = Object.keys(allMaterials).map(key => `<option value="${key}">${allMaterials[key].name}</option>`).join('');

            let html = `
                <div class="main-grid">
                    <section aria-labelledby="calculator-title">
                        <div class="card" style="margin-bottom: 0;">
                            <h2 id="calculator-title" class="card__title">Countertop Calculator</h2>
                            <div class="form-group">
                                <label for="calc-material-select" class="form-group__label">1. Select Material</label>
                                <select id="calc-material-select" class="form-group__select">${materialOptionsHTML}</select>
                            </div>
                            <div id="calc-options-container"></div>
                        </div>
                    </section>
                    <aside aria-labelledby="summary-title">
                        <div id="quote-summary" class="card">
                            <h2 id="summary-title" class="card__title">Quote Summary</h2>
                            <div id="quote-details" aria-live="polite">
                                <p class="quote-summary__placeholder">Select material and enter dimensions.</p>
                            </div>
                             <div id="quote-chart-container" class="hidden">
                                <canvas id="quote-chart" role="img" aria-label="Cost breakdown pie chart"></canvas>
                            </div>
                        </div>
                    </aside>
                </div>`;
             container.innerHTML = html;
             
             renderCountertopOptions(document.getElementById('calc-material-select').value);
        }
        
        function renderCountertopOptions(materialKey) {
            const optionsContainer = document.getElementById('calc-options-container');
            if(!optionsContainer) return;
            const data = DataEngine.getData();
            const materialData = data.countertops[materialKey];
            
            let optionsHTML = materialData.options ? Object.keys(materialData.options).map(optKey => {
                const option = materialData.options[optKey];
                return `<div class="form-group">
                            <label for="calc-option-${optKey}" class="form-group__label">${option.name}</label>
                            <select id="calc-option-${optKey}" data-option-key="${optKey}" class="form-group__select calc-input">
                                ${Object.keys(option.values).map(valKey => `<option value="${valKey}">${option.values[valKey].name}</option>`).join('')}
                            </select>
                        </div>`;
            }).join('') : '';

            let html = `
                <div class="form-grid" style="margin-top: 24px;">
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">2. Dimensions</legend>
                        <div class="form-group">
                            <label for="calc-length" class="form-group__label">Length (in)</label>
                            <input type="number" id="calc-length" class="form-group__input calc-input" placeholder="e.g., 120">
                        </div>
                        <div class="form-group">
                            <label for="calc-width" class="form-group__label">Width (in)</label>
                            <input type="number" id="calc-width" class="form-group__input calc-input" placeholder="e.g., 25.5">
                        </div>
                    </fieldset>

                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">3. Selections</legend>
                        ${optionsHTML}
                        <div class="form-group">
                            <label for="calc-edge" class="form-group__label">Edge Treatment</label>
                            <select id="calc-edge" class="form-group__select calc-input">
                                ${Object.keys(materialData.edges).map(key => `<option value="${key}">${materialData.edges[key].name}</option>`).join('')}
                            </select>
                        </div>
                    </fieldset>

                    <fieldset class="form-fieldset" style="grid-column: span 2;">
                         <legend class="form-fieldset__legend">4. Add-ons</legend>
                         <div class="form-group">
                            ${Object.keys(materialData.cutouts).map(key => `
                                <div class="form-group--checkbox">
                                    <input type="checkbox" id="calc-cutout-${key}" data-key="${key}" class="form-group__checkbox calc-input calc-cutout">
                                    <label for="calc-cutout-${key}" class="form-group__label">${materialData.cutouts[key].name}</label>
                                </div>`).join('')}
                         </div>
                    </fieldset>
                </div>
            `;
            optionsContainer.innerHTML = html;
            calculateQuote();
        }

        function renderCaseworkCalculator(container) {
            const data = DataEngine.getData();
            const allCasework = data.casework;
            let caseworkOptionsHTML = Object.keys(allCasework).map(key => `<option value="${key}">${allCasework[key].name}</option>`).join('');

             let html = `
                <div class="main-grid">
                    <section aria-labelledby="casework-calculator-title">
                        <div class="card" style="margin-bottom: 0;">
                            <h2 id="casework-calculator-title" class="card__title">Casework Calculator</h2>
                             <div class="form-group">
                                <label for="calc-casework-select" class="form-group__label">1. Select Casework Type</label>
                                <select id="calc-casework-select" class="form-group__select">${caseworkOptionsHTML}</select>
                            </div>
                            <div id="calc-casework-options-container"></div>
                        </div>
                    </section>
                    <aside aria-labelledby="casework-summary-title">
                        <div id="quote-summary" class="card">
                            <h2 id="casework-summary-title" class="card__title">Quote Summary</h2>
                            <div id="quote-details" aria-live="polite">
                                <p class="quote-summary__placeholder">Select casework type and enter length.</p>
                            </div>
                        </div>
                    </aside>
                </div>
             `;
             container.innerHTML = html;
             renderCaseworkOptions(document.getElementById('calc-casework-select').value);
        }

        function renderCaseworkOptions(caseworkKey) {
            const optionsContainer = document.getElementById('calc-casework-options-container');
            if(!optionsContainer) return;
            const data = DataEngine.getData();
            const caseworkData = data.casework[caseworkKey];

            let optionsHTML = Object.keys(caseworkData.options).map(optKey => {
                const option = caseworkData.options[optKey];
                return `<div class="form-group">
                            <label for="calc-casework-option-${optKey}" class="form-group__label">${option.name}</label>
                            <select id="calc-casework-option-${optKey}" data-option-key="${optKey}" class="form-group__select calc-input">
                                ${Object.keys(option.values).map(valKey => `<option value="${valKey}">${option.values[valKey].name}</option>`).join('')}
                            </select>
                        </div>`;
            }).join('');
            
            let html = `
                <div class="form-grid" style="margin-top: 24px;">
                     <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">2. Dimensions</legend>
                        <div class="form-group">
                            <label for="calc-length" class="form-group__label">Length (ft)</label>
                            <input type="number" id="calc-length" class="form-group__input calc-input" placeholder="e.g., 10">
                        </div>
                    </fieldset>
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">3. Selections</legend>
                        ${optionsHTML}
                    </fieldset>
                </div>
            `;
            optionsContainer.innerHTML = html;
            calculateQuote();
        }

        function renderMiscServicesCalculator(container) {
            const data = DataEngine.getData();
            const allMiscServices = data.misc_services;
            let serviceOptionsHTML = Object.keys(allMiscServices).map(key => `<option value="${key}">${allMiscServices[key].name}</option>`).join('');

             let html = `
                <div class="main-grid">
                    <section aria-labelledby="misc-calculator-title">
                         <div class="form-group">
                            <label id="misc-calculator-title" for="calc-misc-select" class="form-group__label">1. Select Service</label>
                            <select id="calc-misc-select" class="form-group__select">${serviceOptionsHTML}</select>
                        </div>
                        <div id="calc-misc-options-container"></div>
                    </section>
                    <aside aria-labelledby="misc-summary-title">
                        <div id="quote-summary" class="card">
                            <h2 id="misc-summary-title" class="card__title">Quote Summary</h2>
                            <div id="quote-details" aria-live="polite">
                                <p class="quote-summary__placeholder">Select a service to begin.</p>
                            </div>
                        </div>
                    </aside>
                </div>`;
             container.innerHTML = html;
             renderMiscServiceOptions(document.getElementById('calc-misc-select').value);
        }

        function renderMiscServiceOptions(serviceKey) {
            const optionsContainer = document.getElementById('calc-misc-options-container');
             if(!optionsContainer) return;
            const data = DataEngine.getData();
            const serviceData = data.misc_services[serviceKey];
            let html = '';

            if (serviceKey === 'design') {
                html = `
                    <div class="form-grid" style="margin-top: 24px;">
                         <fieldset class="form-fieldset"> <legend class="form-fieldset__legend">2. Enter Hours</legend>
                            <div class="form-group">
                                <label for="calc-hours" class="form-group__label">Estimated Hours</label>
                                <input type="number" id="calc-hours" class="form-group__input calc-input" placeholder="e.g., 5">
                            </div>
                        </fieldset>
                    </div>`;
            } else if (serviceKey === 'cnc_machining') {
                html = `
                     <div class="form-grid" style="margin-top: 24px;">
                         <fieldset class="form-fieldset"> <legend class="form-fieldset__legend">2. Enter Details</legend>
                            <div class="form-group">
                                <label for="calc-machine-time" class="form-group__label">Machine Time (Hours)</label>
                                <input type="number" id="calc-machine-time" class="form-group__input calc-input" placeholder="e.g., 2.5">
                            </div>
                             <div class="form-group">
                                <label for="calc-setup-fee" class="form-group__label">Setup Fee</label>
                                <input type="number" id="calc-setup-fee" class="form-group__input calc-input" value="${serviceData.setup_fee}" readonly aria-readonly="true">
                            </div>
                        </fieldset>
                    </div>`;
            }
            optionsContainer.innerHTML = html;
            calculateQuote();
        }

        function calculateQuote() {
            if(!container) return; 

            if (currentCategory === 'countertops') {
                calculateCountertopQuote();
            } else if (currentCategory === 'casework') {
                calculateCaseworkQuote();
            } else if (currentCategory === 'misc_services') {
                calculateMiscServicesQuote();
            }
        }

        function calculateCountertopQuote() {
            const data = DataEngine.getData();
            const materialKey = document.getElementById('calc-material-select')?.value;
            if(!materialKey) return;
            
            const materialData = data.countertops[materialKey];
            const settings = data.settings;

            const length = parseFloat(document.getElementById('calc-length')?.value) || 0;
            const width = parseFloat(document.getElementById('calc-width')?.value) || 0;
            const quoteDetailsContainer = document.getElementById('quote-details');
            const quoteChartContainer = document.getElementById('quote-chart-container');

            if (length === 0 || width === 0) {
                 quoteDetailsContainer.innerHTML = `<p class="quote-summary__placeholder">Enter dimensions to begin.</p>`;
                 quoteChartContainer.classList.add('hidden');
                 return;
            }

            const squareFeet = (length * width) / 144;
            const linearFeet = (length * 2 + width * 2) / 12;

            let optionMultiplier = 1;
            document.querySelectorAll('#calc-options-container select[data-option-key]').forEach(select => {
                const optKey = select.dataset.optionKey;
                const valKey = select.value;
                optionMultiplier *= materialData.options[optKey].values[valKey].multiplier;
            });
            
            const totalMaterialCost = squareFeet * materialData.cost_sqft * optionMultiplier;
            
            const selectedEdgeKey = document.getElementById('calc-edge').value;
            const edgeCost = linearFeet * materialData.edges[selectedEdgeKey].cost_lnft;

            let cutoutCost = 0;
            let cutoutItems = [];
            document.querySelectorAll('.calc-cutout:checked').forEach(checkbox => {
                const key = checkbox.dataset.key;
                const cost = materialData.cutouts[key].cost;
                cutoutCost += cost;
                cutoutItems.push({ name: materialData.cutouts[key].name, cost: cost });
            });

            const subtotal = totalMaterialCost + edgeCost + cutoutCost;
            const tax = subtotal * settings.taxRate;
            const total = subtotal + tax;

            let summaryHTML = `
                <table class="quote-summary__table">
                    <tbody>
                        <tr><td class="item-name">Material (${squareFeet.toFixed(2)} sq ft)</td><td class="item-cost">${UIController.formatCurrency(totalMaterialCost)}</td></tr>
                        <tr><td class="item-name">Edge (${linearFeet.toFixed(2)} ln ft)</td><td class="item-cost">${UIController.formatCurrency(edgeCost)}</td></tr>
                        ${cutoutItems.map(item => `<tr><td class="item-name">${item.name}</td><td class="item-cost">${UIController.formatCurrency(item.cost)}</td></tr>`).join('')}
                        <tr class="subtotal-row"><td>Subtotal</td><td class="item-cost">${UIController.formatCurrency(subtotal)}</td></tr>
                        <tr><td class="item-name">Tax (${(settings.taxRate * 100).toFixed(2)}%)</td><td class="item-cost">${UIController.formatCurrency(tax)}</td></tr>
                        <tr class="total-row"><td>Total</td><td class="item-cost">${UIController.formatCurrency(total)}</td></tr>
                    </tbody>
                </table>`;

            quoteDetailsContainer.innerHTML = summaryHTML;
            renderQuoteChart([totalMaterialCost, edgeCost, cutoutCost, tax]);
            quoteChartContainer.classList.remove('hidden');
        }

        function calculateCaseworkQuote() {
            const data = DataEngine.getData();
            const caseworkKey = document.getElementById('calc-casework-select')?.value;
            if(!caseworkKey) return;
            
            const caseworkData = data.casework[caseworkKey];
            const settings = data.settings;
            
            const linearFeet = parseFloat(document.getElementById('calc-length')?.value) || 0;
            const quoteDetailsContainer = document.getElementById('quote-details');
            
            if (linearFeet === 0) {
                quoteDetailsContainer.innerHTML = `<p class="quote-summary__placeholder">Enter length to begin.</p>`;
                return;
            }

            let optionMultiplier = 1;
            document.querySelectorAll('#calc-casework-options-container select[data-option-key]').forEach(select => {
                const optKey = select.dataset.optionKey;
                const valKey = select.value;
                const multiplier = caseworkData.options[optKey].values[valKey].multiplier;
                optionMultiplier *= multiplier;
            });

            const totalCost = (linearFeet * caseworkData.cost_lnft) * optionMultiplier;
            const subtotal = totalCost;
            const tax = subtotal * settings.taxRate;
            const total = subtotal + tax;

             let summaryHTML = `
                <table class="quote-summary__table">
                    <tbody>
                        <tr><td class="item-name">${caseworkData.name} (${linearFeet} ln ft)</td><td class="item-cost">${UIController.formatCurrency(totalCost)}</td></tr>
                        <tr class="subtotal-row"><td>Subtotal</td><td class="item-cost">${UIController.formatCurrency(subtotal)}</td></tr>
                        <tr><td class="item-name">Tax (${(settings.taxRate * 100).toFixed(2)}%)</td><td class="item-cost">${UIController.formatCurrency(tax)}</td></tr>
                        <tr class="total-row"><td>Total</td><td class="item-cost">${UIController.formatCurrency(total)}</td></tr>
                    </tbody>
                </table>`;
            quoteDetailsContainer.innerHTML = summaryHTML;
        }

        function calculateMiscServicesQuote() {
            const data = DataEngine.getData();
            const serviceKey = document.getElementById('calc-misc-select')?.value;
            if(!serviceKey) return;

            const serviceData = data.misc_services[serviceKey];
            const settings = data.settings;
            const quoteDetailsContainer = document.getElementById('quote-details');
            let subtotal = 0;
            let lineItems = [];

            if (serviceKey === 'design') {
                const hours = parseFloat(document.getElementById('calc-hours')?.value) || 0;
                if (hours > 0) {
                    subtotal = hours * serviceData.rate_hourly;
                    lineItems.push(`<tr><td class="item-name">Design Services (${hours} hrs)</td><td class="item-cost">${UIController.formatCurrency(subtotal)}</td></tr>`);
                }
            } else if (serviceKey === 'cnc_machining') {
                const machineTime = parseFloat(document.getElementById('calc-machine-time')?.value) || 0;
                const setupFee = serviceData.setup_fee;
                const machineCost = machineTime * serviceData.rate_hourly;
                subtotal = machineCost + setupFee;
                if (setupFee > 0) lineItems.push(`<tr><td class="item-name">Setup Fee</td><td class="item-cost">${UIController.formatCurrency(setupFee)}</td></tr>`);
                if (machineTime > 0) lineItems.push(`<tr><td class="item-name">Machine Time (${machineTime} hrs)</td><td class="item-cost">${UIController.formatCurrency(machineCost)}</td></tr>`);
            }
            
            if (subtotal === 0) {
                quoteDetailsContainer.innerHTML = `<p class="quote-summary__placeholder">Enter details to generate a quote.</p>`;
                return;
            }

            const tax = subtotal * settings.taxRate;
            const total = subtotal + tax;
            
            let summaryHTML = `<table class="quote-summary__table"><tbody>
                        ${lineItems.join('')}
                        <tr class="subtotal-row"><td>Subtotal</td><td class="item-cost">${UIController.formatCurrency(subtotal)}</td></tr>
                        <tr><td class="item-name">Tax (${(settings.taxRate * 100).toFixed(2)}%)</td><td class="item-cost">${UIController.formatCurrency(tax)}</td></tr>
                        <tr class="total-row"><td>Total</td><td class="item-cost">${UIController.formatCurrency(total)}</td></tr>
                    </tbody></table>`;
            quoteDetailsContainer.innerHTML = summaryHTML;
        }
        
        function renderQuoteChart(costData) {
            const ctx = document.getElementById('quote-chart')?.getContext('2d');
            if (!ctx) return;
            
            if (quoteChart) {
                quoteChart.destroy();
            }

            quoteChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Material', 'Edge Treatment', 'Cutouts / Add-ons', 'Tax'],
                    datasets: [{
                        label: 'Cost Breakdown',
                        data: costData.map(c => Math.max(0, c)), // Ensure no negative values from calculation errors
                        backgroundColor: [
                            'rgba(79, 70, 229, 0.7)',
                            'rgba(30, 64, 175, 0.7)',
                            'rgba(165, 180, 252, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                        ],
                        borderColor: [
                            'rgba(79, 70, 229, 1)',
                            'rgba(30, 64, 175, 1)',
                            'rgba(165, 180, 252, 1)',
                            'rgba(255, 99, 132, 1)',
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Visual Cost Breakdown'
                        }
                    }
                },
            });

        }

        /**
         * Attaches event listeners to the main calculator container using event delegation.
         * This is more efficient than attaching listeners to each individual element, especially
         * since the form content is re-rendered frequently.
         */
        function attachListeners() {
            if(!container) return;
            
            // Listener for clicks (tabs)
            container.addEventListener('click', function(e) {
                const tabButton = e.target.closest('button[data-category]');
                if (tabButton && container.querySelector('#calc-category-tabs')?.contains(tabButton)) {
                    const category = tabButton.dataset.category;
                    if (category !== currentCategory) {
                        currentCategory = category;
                        render();
                    }
                }
            });

            // Listener for inputs and changes (forms)
            container.addEventListener('input', calculateQuote);
            container.addEventListener('change', (e) => {
                if(e.target.matches('#calc-material-select')) {
                    renderCountertopOptions(e.target.value);
                } else if (e.target.matches('#calc-casework-select')) {
                    renderCaseworkOptions(e.target.value);
                } else if (e.target.matches('#calc-misc-select')) {
                    renderMiscServiceOptions(e.target.value);
                } else {
                    calculateQuote();
                }
            });
        }
        
        return { init, render };
    })();

    /**
     * @module AdminPanel
     * @description Handles rendering and logic for the admin panel.
     * @dependencies DataEngine, UIController, Calculator
     */
    const AdminPanel = (function() {
        let container = null;
        let currentCategory = 'settings';

        function init() {
            container = document.getElementById('admin-panel');
            if (container) {
                attachListeners();
            }
        }

        function render() {
            if(!container) container = document.getElementById('admin-panel');
            if(!container) return;
            
            let html = `
                <div id="admin-category-tabs" role="tablist" aria-label="Admin Sections" class="view-switcher" style="justify-content: flex-start; margin-top: 0; margin-bottom: 24px; border-bottom: 1px solid var(--color-border); padding-bottom: 16px;">
                    <button id="admin-tab-settings" role="tab" aria-selected="${currentCategory === 'settings'}" data-category="settings" class="${currentCategory === 'settings' ? 'active' : ''}">Settings & Data</button>
                    <button id="admin-tab-countertops" role="tab" aria-selected="${currentCategory === 'countertops'}" data-category="countertops" class="${currentCategory === 'countertops' ? 'active' : ''}">Countertops</button>
                    <button id="admin-tab-casework" role="tab" aria-selected="${currentCategory === 'casework'}" data-category="casework" class="${currentCategory === 'casework' ? 'active' : ''}">Casework</button>
                    <button id="admin-tab-misc" role="tab" aria-selected="${currentCategory === 'misc_services'}" data-category="misc_services" class="${currentCategory === 'misc_services' ? 'active' : ''}">Misc Services</button>
                    <button id="admin-tab-help" role="tab" aria-selected="${currentCategory === 'help'}" data-category="help" class="${currentCategory === 'help' ? 'active' : ''}">Help</button>
                </div>
                <div id="admin-category-content" role="region" aria-live="polite"></div>`;
            container.innerHTML = html;
            renderCategoryContent(currentCategory);
        }
        
        function renderCategoryContent(category) {
            currentCategory = category;
            const contentContainer = container.querySelector('#admin-category-content');
            if(!contentContainer) return;

            contentContainer.innerHTML = '';
            contentContainer.id = `admin-panel-${category}`;
            contentContainer.setAttribute('aria-labelledby', `admin-tab-${category}`);
            
            if(category === 'settings') {
                renderSettingsAdmin(contentContainer);
            } else if(category === 'countertops') {
                renderCountertopAdmin(contentContainer);
            } else if (category === 'casework') {
                 renderCaseworkAdmin(contentContainer);
            } else if (category === 'misc_services') {
                renderMiscServicesAdmin(contentContainer);
            } else if (category === 'help') {
                renderHelpAdmin(contentContainer);
            }
        }

        function renderSettingsAdmin(contentContainer) {
            const settings = DataEngine.getData().settings;

            let html = `
                <h2 class="card__title">Global Settings & Data Management</h2>
                <div class="form-grid">
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Business Info</legend>
                        <div class="admin-group">
                            <label for="admin-company-name" class="admin-group__label">Company Name</label>
                            <input type="text" id="admin-company-name" class="form-group__input" value="${settings.companyName}">
                        </div>
                         <div class="admin-group">
                            <label for="admin-tax-rate" class="admin-group__label">Tax Rate (%)</label>
                            <input type="number" id="admin-tax-rate" class="form-group__input" step="0.0001" value="${settings.taxRate * 100}">
                        </div>
                    </fieldset>
                </div>

                <h3 class="admin-section-title" style="margin-top: 40px;">Data Management</h3>
                <div class="data-management-grid">
                    <div class="data-management-card">
                        <h4>Export Data</h4>
                        <p>Save your current pricing configuration to a file.</p>
                        <button id="export-json-btn" class="admin-button">Export All (JSON)</button>
                    </div>
                     <div class="data-management-card">
                        <h4>Import Data</h4>
                        <p>Load a configuration from a JSON backup file.</p>
                        <label for="import-json-file" class="admin-button secondary">Import from JSON</label>
                        <input type="file" id="import-json-file" class="hidden" accept=".json">
                    </div>
                </div>


                <div class="admin-actions">
                    <span id="save-confirmation" class="hidden" aria-live="polite"></span>
                    <button class="save-button" data-save-type="settings">Save Settings</button>
                </div>
            `;
            contentContainer.innerHTML = html;
        }
        
        function renderCountertopAdmin(contentContainer) {
            const data = DataEngine.getData();
            const allMaterials = data.countertops;
            
            let materialOptionsHTML = Object.keys(allMaterials).map(key => `<option value="${key}">${allMaterials[key].name}</option>`).join('');

            let html = `
                <h2 class="card__title">Edit Countertop Pricing</h2>
                <div class="form-group">
                    <label for="admin-material-select" class="form-group__label">Select a Material to Edit</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="admin-material-select" class="form-group__select" style="flex-grow: 1;">${materialOptionsHTML}</select>
                        <button id="add-new-material-btn" class="admin-button secondary">Add New</button>
                        <button id="delete-material-btn" class="admin-button danger">Delete</button>
                    </div>
                </div>
                <div id="admin-material-form-container" class="mt-4"></div>
            `;
            contentContainer.innerHTML = html;
            
            renderCountertopAdminForm(contentContainer.querySelector('#admin-material-select').value);
        }

        function renderCountertopAdminForm(materialKey) {
            const formContainer = container.querySelector('#admin-material-form-container');
            if(!formContainer) return;

            const materialData = DataEngine.getData().countertops[materialKey];
            if(!materialData) {
                formContainer.innerHTML = '<p class="text-error">Could not load material data.</p>';
                return;
            }

            let optionsHTML = materialData.options ? Object.keys(materialData.options).map(optKey => {
                const option = materialData.options[optKey];
                return `
                    <h3 class="admin-section-title">${option.name} Multipliers</h3>
                    ${Object.keys(option.values).map(valKey => `
                        <div class="admin-group">
                             <label for="admin-ct-option-${optKey}-${valKey}" class="admin-group__label">${option.values[valKey].name}</label>
                             <input type="number" id="admin-ct-option-${optKey}-${valKey}" data-type="option" data-option-key="${optKey}" data-value-key="${valKey}" class="form-group__input" step="0.01" value="${option.values[valKey].multiplier}">
                        </div>`).join('')}
                `;
            }).join('') : '';

            let edgesHTML = materialData.edges ? Object.keys(materialData.edges).map(edgeKey => `
                <div class="admin-group">
                    <label for="admin-edge-${edgeKey}" class="admin-group__label">${materialData.edges[edgeKey].name}</label>
                    <input type="number" id="admin-edge-${edgeKey}" data-type="edge" data-key="${edgeKey}" class="form-group__input" step="0.01" value="${materialData.edges[edgeKey].cost_lnft}">
                </div>`).join('') : '';

            let cutoutsHTML = materialData.cutouts ? Object.keys(materialData.cutouts).map(cutoutKey => `
               <div class="admin-group">
                   <label for="admin-cutout-${cutoutKey}" class="admin-group__label">${materialData.cutouts[cutoutKey].name}</label>
                   <input type="number" id="admin-cutout-${cutoutKey}" data-type="cutout" data-key="${cutoutKey}" class="form-group__input" step="0.01" value="${materialData.cutouts[cutoutKey].cost}">
               </div>`).join('') : '';

            let html = `
                <div class="form-grid">
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Base Costs</legend>
                        <div class="admin-group">
                            <label for="admin-cost-sqft" class="admin-group__label">Cost per Sq. Ft.</label>
                            <input type="number" id="admin-cost-sqft" class="form-group__input" step="0.01" value="${materialData.cost_sqft}">
                        </div>
                    </fieldset>
                     <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Option Multipliers</legend>
                        <div id="admin-ct-options-wrapper">${optionsHTML}</div>
                    </fieldset>
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Edge Costs (per Ln. Ft.)</legend>
                        <div id="admin-edges-wrapper">${edgesHTML}</div>
                    </fieldset>
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Cutout Costs</legend>
                        <div id="admin-cutouts-wrapper">${cutoutsHTML}</div>
                    </fieldset>
                </div>
                <div class="admin-actions">
                    <span id="save-confirmation" class="hidden" aria-live="polite"></span>
                    <button class="save-button" data-save-type="countertop" data-material-key="${materialKey}">Save Changes</button>
                </div>`;
            formContainer.innerHTML = html;
        }

        function renderCaseworkAdmin(contentContainer) {
            const data = DataEngine.getData();
            const allCasework = data.casework;
            
            let caseworkOptionsHTML = Object.keys(allCasework).map(key => `<option value="${key}">${allCasework[key].name}</option>`).join('');

            let html = `
                <h2 class="card__title">Edit Casework Pricing</h2>
                <div class="form-group">
                    <label for="admin-casework-select" class="form-group__label">Select a Casework Type to Edit</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="admin-casework-select" class="form-group__select" style="flex-grow: 1;">${caseworkOptionsHTML}</select>
                        <button id="add-new-casework-btn" class="admin-button secondary">Add New</button>
                        <button id="delete-casework-btn" class="admin-button danger">Delete</button>
                    </div>
                </div>
                <div id="admin-casework-form-container" class="mt-4"></div>
            `;
            contentContainer.innerHTML = html;
            renderCaseworkAdminForm(contentContainer.querySelector('#admin-casework-select').value);
        }

        function renderCaseworkAdminForm(caseworkKey) {
            const formContainer = container.querySelector('#admin-casework-form-container');
            if(!formContainer) return;

            const caseworkData = DataEngine.getData().casework[caseworkKey];
            if (!caseworkData) {
                formContainer.innerHTML = '<p class="text-error">Could not load casework data.</p>';
                return;
            }

            let optionsHTML = Object.keys(caseworkData.options).map(optKey => {
                const option = caseworkData.options[optKey];
                return `
                    <h3 class="admin-section-title">${option.name} Multipliers</h3>
                    ${Object.keys(option.values).map(valKey => `
                        <div class="admin-group">
                             <label for="admin-cw-option-${optKey}-${valKey}" class="admin-group__label">${option.values[valKey].name}</label>
                             <input type="number" id="admin-cw-option-${optKey}-${valKey}" data-type="option" data-option-key="${optKey}" data-value-key="${valKey}" class="form-group__input" step="0.01" value="${option.values[valKey].multiplier}">
                        </div>`).join('')}
                `;
            }).join('');

            let html = `
                <div class="form-grid">
                    <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Base Costs</legend>
                        <div class="admin-group">
                            <label for="admin-cost-lnft" class="admin-group__label">Cost per Ln. Ft.</label>
                            <input type="number" id="admin-cost-lnft" class="form-group__input" step="0.01" value="${caseworkData.cost_lnft}">
                        </div>
                    </fieldset>
                     <fieldset class="form-fieldset">
                        <legend class="form-fieldset__legend">Option Multipliers</legend>
                        <div id="admin-cw-options-wrapper">${optionsHTML}</div>
                    </fieldset>
                </div>
                <div class="admin-actions">
                    <span id="save-confirmation" class="hidden" aria-live="polite"></span>
                    <button class="save-button" data-save-type="casework" data-casework-key="${caseworkKey}">Save Changes</button>
                </div>
            `;
            formContainer.innerHTML = html;
        }

        function renderMiscServicesAdmin(contentContainer) {
            const miscServices = DataEngine.getData().misc_services;
            
            let servicesHTML = Object.keys(miscServices).map(key => {
                const service = miscServices[key];
                return `
                    <h3 class="admin-section-title">${service.name}</h3>
                    ${Object.keys(service).filter(prop => prop !== 'name').map(prop => `
                        <div class="admin-group">
                            <label for="admin-misc-${key}-${prop}" class="admin-group__label">${prop.replace('_', ' ')}</label>
                            <input type="number" id="admin-misc-${key}-${prop}" data-service-key="${key}" data-property="${prop}" class="form-group__input" step="0.01" value="${service[prop]}">
                        </div>
                    `).join('')}
                `;
            }).join('');
            
            let html = `
                <h2 class="card__title">Edit Miscellaneous Services Pricing</h2>
                <div id="admin-misc-form-container">
                    ${servicesHTML}
                </div>
                <div class="admin-actions">
                    <span id="save-confirmation" class="hidden" aria-live="polite"></span>
                    <button class="save-button" data-save-type="misc">Save Changes</button>
                </div>
            `;
            contentContainer.innerHTML = html;
        }

        function renderHelpAdmin(contentContainer) {
             let html = `
                <h2 class="card__title">Help & Documentation</h2>
                <div id="admin-help-content">
                    <h3 class="admin-section-title">Using the Calculator</h3>
                    <p>The main calculator interface is divided into tabs for each major service category: Countertops, Casework, and Misc Services. Select the appropriate tab and fill in the fields to generate a real-time quote. The quote summary on the right will update automatically as you make changes.</p>
                    
                    <h3 class="admin-section-title">Managing Prices in the Admin Panel</h3>
                    <p>This admin panel gives you full control over the pricing logic.</p>
                    <ul>
                        <li><strong>Editing Prices:</strong> Navigate to the appropriate tab (e.g., "Countertops"). Select the item you wish to edit from the dropdown, change the values in the form fields, and click "Save Changes". The new prices will be active immediately.</li>
                        <li><strong>Adding New Items:</strong> Use the "Add New" button next to the dropdown in the "Countertops" or "Casework" sections to add a new material or type. You will be prompted for a name, and a new item will be created by copying the properties of an existing item.</li>
                        <li><strong>Deleting Items:</strong> Select an item from the dropdown and click the "Delete" button. You will be asked to confirm this action.</li>
                        <li><strong>Global Settings:</strong> In the "Settings & Data" tab, you can change the company name displayed on the header and the global tax rate applied to all quotes.</li>
                    </ul>

                    <h3 class="admin-section-title">Importing & Exporting Data</h3>
                    <p>You can back up and restore your entire pricing configuration using JSON files. This is useful for saving different pricing models or for recovery.</p>
                    <ul>
                        <li><strong>Export:</strong> Click the "Export All (JSON)" button in the "Settings & Data" tab. A file named <code>hutchison_calculator_backup.json</code> will be downloaded. Keep this file in a safe place.</li>
                        <li><strong>Import:</strong> Click the "Import from JSON" button and select a valid backup file. Your current data will be overwritten with the data from the file. The application will validate the file to prevent corruption.</li>
                    </ul>
                </div>
            `;
            contentContainer.innerHTML = html;
        }

        function saveChanges(button) {
            const saveType = button.dataset.saveType;
            const data = DataEngine.getData();
            let confirmationMessage = "Changes saved!";

            if (saveType === 'settings') {
                data.settings.companyName = container.querySelector('#admin-company-name').value;
                data.settings.taxRate = parseFloat(container.querySelector('#admin-tax-rate').value) / 100;
                confirmationMessage = "Settings saved!";
            } else if (saveType === 'countertop') {
                const materialKey = button.dataset.materialKey;
                const materialData = data.countertops[materialKey];
                materialData.cost_sqft = parseFloat(container.querySelector('#admin-cost-sqft').value);
                container.querySelectorAll('#admin-ct-options-wrapper input').forEach(input => {
                    materialData.options[input.dataset.optionKey].values[input.dataset.valueKey].multiplier = parseFloat(input.value);
                });
                container.querySelectorAll('#admin-edges-wrapper input').forEach(input => {
                    materialData.edges[input.dataset.key].cost_lnft = parseFloat(input.value);
                });
                container.querySelectorAll('#admin-cutouts-wrapper input').forEach(input => {
                    materialData.cutouts[input.dataset.key].cost = parseFloat(input.value);
                });
            } else if (saveType === 'casework') {
                const caseworkKey = button.dataset.caseworkKey;
                const caseworkData = data.casework[caseworkKey];
                caseworkData.cost_lnft = parseFloat(container.querySelector('#admin-cost-lnft').value);
                container.querySelectorAll('#admin-cw-options-wrapper input').forEach(input => {
                    caseworkData.options[input.dataset.optionKey].values[input.dataset.valueKey].multiplier = parseFloat(input.value);
                });
            } else if (saveType === 'misc') {
                container.querySelectorAll('#admin-misc-form-container input').forEach(input => {
                    data.misc_services[input.dataset.serviceKey][input.dataset.property] = parseFloat(input.value);
                });
            }

            DataEngine.saveData(data);
            
            const confirmation = container.querySelector('#save-confirmation');
            if(confirmation) {
                confirmation.textContent = confirmationMessage;
                confirmation.classList.remove('hidden');
                setTimeout(() => { confirmation.classList.add('hidden'); }, 3000);
            }
            
            Calculator.render();
        }

        function exportDataToJSON() {
            const data = DataEngine.getData();
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hutchison_calculator_backup.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importDataFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.version && importedData.settings && importedData.countertops) {
                        if(confirm("Are you sure you want to overwrite all existing data with this file? This action cannot be undone.")) {
                            DataEngine.saveData(importedData);
                            showAdminMessage("Data imported successfully!", 'info');
                            AdminPanel.render();
                            Calculator.render();
                        }
                    } else {
                        showAdminMessage("Error: Invalid or corrupted JSON file.", 'error');
                    }
                } catch (error) {
                    showAdminMessage("Error parsing JSON file: " + error.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function showAdminMessage(message, type = 'info') {
            const contentContainer = container.querySelector('#admin-category-content');
            if (!contentContainer) return;
            
            let messageEl = contentContainer.querySelector('.admin-message');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.className = 'admin-message';
                messageEl.style.padding = '12px';
                messageEl.style.borderRadius = 'var(--border-radius)';
                messageEl.style.marginBottom = '16px';
                messageEl.style.fontWeight = '600';
                messageEl.style.transition = 'opacity 0.5s';
                messageEl.setAttribute('role', 'alert');
                contentContainer.prepend(messageEl);
            }
            
            messageEl.textContent = message;
            messageEl.style.opacity = '1';
            
            if (type === 'error') {
                 messageEl.style.backgroundColor = '#f8d7da';
                 messageEl.style.color = '#721c24';
                 messageEl.style.borderColor = '#f5c6cb';
            } else { // info
                 messageEl.style.backgroundColor = '#d1ecf1';
                 messageEl.style.color = '#0c5460';
                 messageEl.style.borderColor = '#bee5eb';
            }
            
            setTimeout(() => {
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    messageEl.remove();
                }, 500);
            }, 4000);
        }

        function addNewItem(itemType) {
            const newName = prompt(`Enter the name for the new ${itemType}:`);
            if (!newName || newName.trim() === '') {
                showAdminMessage(`${itemType} name cannot be empty.`, 'error');
                return;
            }

            const data = DataEngine.getData();
            const dataCategory = itemType === 'material' ? 'countertops' : 'casework';
            const collection = data[dataCategory];

            const newKey = newName.trim().toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
            
            const nameExists = Object.values(collection).some(m => m.name.toLowerCase() === newName.trim().toLowerCase());
            if (nameExists) {
                showAdminMessage(`An item named "${newName}" already exists in this category.`, 'error');
                return;
            }

            const firstItemKey = Object.keys(collection)[0];
            const newItemData = JSON.parse(JSON.stringify(collection[firstItemKey]));
            newItemData.name = newName.trim();
            
            collection[newKey] = newItemData;
            DataEngine.saveData(data);

            showAdminMessage(`${itemType} "${newName}" added successfully. You can now edit its properties.`, 'info');
            currentCategory = dataCategory;
            render(); 
        }

        function deleteSelectedItem(itemType) {
            const dataCategory = itemType === 'material' ? 'countertops' : 'casework';
            const selectElement = document.getElementById(`admin-${itemType}-select`);
            const itemKeyToDelete = selectElement.value;

            if (!itemKeyToDelete) {
                showAdminMessage('No item selected to delete.', 'error');
                return;
            }

            const data = DataEngine.getData();
            const collection = data[dataCategory];
            const itemName = collection[itemKeyToDelete].name;
            
            if (Object.keys(collection).length <= 1) {
                showAdminMessage(`Cannot delete the last item. Add a new one before deleting "${itemName}".`, 'error');
                return;
            }

            if (confirm(`Are you sure you want to permanently delete "${itemName}"? This cannot be undone.`)) {
                delete collection[itemKeyToDelete];
                DataEngine.saveData(data);
                showAdminMessage(`"${itemName}" has been deleted.`, 'info');
                currentCategory = dataCategory;
                render();
            }
        }

        /**
         * Attaches event listeners to the admin panel using event delegation.
         */
        function attachListeners() {
            if (!container) return;
            
            container.addEventListener('click', (e) => {
                const target = e.target;
                
                // Handle tab switching
                const tabButton = target.closest('button[data-category]');
                 if (tabButton && container.querySelector('#admin-category-tabs').contains(tabButton)) {
                    const category = tabButton.dataset.category;
                    if (category !== currentCategory) {
                        currentCategory = category;
                        render();
                    }
                    return; // Prevent other actions from firing
                }

                // Handle other buttons
                if (target.classList.contains('save-button')) {
                    saveChanges(target);
                } else if (target.id === 'add-new-material-btn') {
                    addNewItem('material');
                } else if (target.id === 'add-new-casework-btn') {
                    addNewItem('casework');
                } else if (target.id === 'delete-material-btn') {
                    deleteSelectedItem('material');
                } else if (target.id === 'delete-casework-btn') {
                    deleteSelectedItem('casework');
                } else if (target.id === 'export-json-btn') {
                     exportDataToJSON();
                }
            });
            
            container.addEventListener('change', (e) => {
                const target = e.target;
                 if (target.id === 'import-json-file') {
                    importDataFromJSON(e);
                } else if(target.id === 'admin-material-select') {
                    renderCountertopAdminForm(target.value);
                } else if (target.id === 'admin-casework-select') {
                    renderCaseworkAdminForm(target.value);
                }
            });
        }
        
        return { init, render };
    })();
    
    /**
     * @module App
     * @description Main application controller. Initializes all other modules.
     * @dependencies DataEngine, UIController, Calculator, AdminPanel
     */
    const App = (function() {
        function init() {
            DataEngine.init();
            UIController.init();
            Calculator.init();
            AdminPanel.init();

            const header = document.querySelector('header');
            if (header) {
                header.addEventListener('click', (e) => {
                    if (e.target.id === 'show-calculator-btn') {
                        UIController.showMainView('calculator');
                    } else if (e.target.id === 'show-admin-btn') {
                        UIController.showMainView('admin');
                    }
                });
            }
            
            UIController.showMainView('calculator');
        }
        return { init };
    })();

    /**
     * @module CryptoController
     * @description Handles password protection and decryption.
     * @dependencies App
     */
    const CryptoController = (function() {
        const payloadContainer = document.getElementById('encrypted-payload');
        const passwordPrompt = document.getElementById('password-prompt');
        const passwordInput = document.getElementById('password-input');
        const submitButton = document.getElementById('submit-password');
        const passwordError = document.getElementById('password-error');
        const appContainer = document.getElementById('app-container');

        // This is the encrypted content of the application.
        // The default password is "admin123"
        let encryptedData = {};

        // The actual HTML content of the application that will be encrypted.
        const appHTML = `
            <div class="app-wrapper">
                <header>
                    <h1 id="company-header">Pricing Calculator</h1>
                    <p>A comprehensive business engine for quotes.</p>
                    <div class="view-switcher" role="navigation" aria-label="Main Views">
                        <button id="show-calculator-btn">Calculator</button>
                        <button id="show-admin-btn">Admin Panel</button>
                    </div>
                </header>

                <main>
                    <div id="calculator-interface" class="card" role="region" aria-labelledby="calculator-view-title">
                         <h2 id="calculator-view-title" class="hidden">Calculator View</h2>
                        </div>
                    <div id="admin-panel" class="card hidden" role="region" aria-labelledby="admin-view-title">
                         <h2 id="admin-view-title" class="hidden">Admin Panel View</h2>
                        </div>
                </main>
            </div>
        `;


        async function deriveKey(password, saltBuffer) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                { name: "PBKDF2" },
                false,
                ["deriveBits", "deriveKey"]
            );
            return window.crypto.subtle.deriveKey(
                {
                    "name": "PBKDF2",
                    salt: saltBuffer,
                    "iterations": 100000,
                    "hash": "SHA-256"
                },
                keyMaterial,
                { "name": "AES-GCM", "length": 256 },
                true,
                ["encrypt", "decrypt"]
            );
        }

        async function encrypt(data, password) {
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const key = await deriveKey(password, salt);
            const enc = new TextEncoder();
            const encodedData = enc.encode(data);

            const cipherText = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                key,
                encodedData
            );

            return {
                cipherText: btoa(String.fromCharCode.apply(null, new Uint8Array(cipherText))),
                iv: btoa(String.fromCharCode.apply(null, new Uint8Array(iv))),
                salt: btoa(String.fromCharCode.apply(null, new Uint8Array(salt)))
            };
        }


        async function decrypt(encryptedData, password) {
            try {
                const saltStr = atob(encryptedData.salt);
                const ivStr = atob(encryptedData.iv);
                const cipherTextStr = atob(encryptedData.cipherText);

                // Convert raw binary strings back to Uint8Arrays
                const saltBuffer = new Uint8Array(saltStr.split('').map(c => c.charCodeAt(0)));
                const ivBuffer = new Uint8Array(ivStr.split('').map(c => c.charCodeAt(0)));
                const cipherBuffer = new Uint8Array(cipherTextStr.split('').map(c => c.charCodeAt(0)));
                
                const key = await deriveKey(password, saltBuffer);
                const dec = new TextDecoder();
                
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: ivBuffer },
                    key,
                    cipherBuffer
                );

                return dec.decode(decrypted);
            } catch (e) {
                console.error("Decryption failed:", e);
                return null;
            }
        }
        
        async function handleUnlockAttempt() {
            const password = passwordInput.value;
            if (!password) return;

            const decryptedHTML = await decrypt(JSON.parse(payloadContainer.textContent), password);

            if (decryptedHTML) {
                passwordError.classList.add('hidden');
                appContainer.innerHTML = decryptedHTML;
                // This call is now safe because App is defined before CryptoController
                App.init(); 
            } else {
                passwordError.classList.remove('hidden');
            }
        }

        async function init() {
            // In a real build process, the payload would be pre-encrypted.
            // For this demo, we encrypt it now with a default password.
            const encryptedPayload = await encrypt(appHTML, "admin123");
            payloadContainer.textContent = JSON.stringify(encryptedPayload, null, 2);


            submitButton.addEventListener('click', handleUnlockAttempt);
            passwordInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    handleUnlockAttempt();
                }
            });
        }
        
        return { init };
    })();
    // --- END: ALL APPLICATION LOGIC ---


    // --- APPLICATION ENTRY POINT ---
    // This starts the password check process when the page loads.
    window.onload = function() {
        CryptoController.init();
    };

    </script>

</body>
</html>
